(function(){const Zt=document.createElement("link").relList;if(Zt&&Zt.supports&&Zt.supports("modulepreload"))return;for(const xt of document.querySelectorAll('link[rel="modulepreload"]'))Ri(xt);new MutationObserver(xt=>{for(const Gt of xt)if(Gt.type==="childList")for(const _s of Gt.addedNodes)_s.tagName==="LINK"&&_s.rel==="modulepreload"&&Ri(_s)}).observe(document,{childList:!0,subtree:!0});function di(xt){const Gt={};return xt.integrity&&(Gt.integrity=xt.integrity),xt.referrerPolicy&&(Gt.referrerPolicy=xt.referrerPolicy),xt.crossOrigin==="use-credentials"?Gt.credentials="include":xt.crossOrigin==="anonymous"?Gt.credentials="omit":Gt.credentials="same-origin",Gt}function Ri(xt){if(xt.ep)return;xt.ep=!0;const Gt=di(xt);fetch(xt.href,Gt)}})();var __=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function rU(Lt){return Lt&&Lt.__esModule&&Object.prototype.hasOwnProperty.call(Lt,"default")?Lt.default:Lt}var lv={exports:{}};(function(Lt,Zt){(function(di,Ri){Lt.exports=Ri()})(__,function(){function di(i,t){return t.forEach(function(e){e&&typeof e!="string"&&!Array.isArray(e)&&Object.keys(e).forEach(function(n){if(n!=="default"&&!(n in i)){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(i,n,s.get?s:{enumerable:!0,get:function(){return e[n]}})}})}),Object.freeze(i)}var Ri=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof __<"u"?__:typeof self<"u"?self:{};function xt(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Gt=function(i){try{return!!i()}catch{return!0}},_s=!Gt(function(){var i=(function(){}).bind();return typeof i!="function"||i.hasOwnProperty("prototype")}),m_=_s,f_=Function.prototype,ol=f_.call,mv=m_&&f_.bind.bind(ol,ol),De=m_?mv:function(i){return function(){return ol.apply(i,arguments)}},rn=De({}.isPrototypeOf),Qa=function(i){return i&&i.Math==Math&&i},$e=Qa(typeof globalThis=="object"&&globalThis)||Qa(typeof window=="object"&&window)||Qa(typeof self=="object"&&self)||Qa(typeof Ri=="object"&&Ri)||function(){return this}()||Ri||Function("return this")(),fv=_s,g_=Function.prototype,T_=g_.apply,S_=g_.call,al=typeof Reflect=="object"&&Reflect.apply||(fv?S_.bind(T_):function(){return S_.apply(T_,arguments)}),R_=De,gv=R_({}.toString),Tv=R_("".slice),Es=function(i){return Tv(gv(i),8,-1)},Sv=Es,Rv=De,Za=function(i){if(Sv(i)==="Function")return Rv(i)},cl=typeof document=="object"&&document.all,$a={all:cl,IS_HTMLDDA:cl===void 0&&cl!==void 0},Cv=$a.all,Ge=$a.IS_HTMLDDA?function(i){return typeof i=="function"||i===Cv}:function(i){return typeof i=="function"},jo={},Nn=!Gt(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),Iv=_s,tc=Function.prototype.call,li=Iv?tc.bind(tc):function(){return tc.apply(tc,arguments)},dl={},C_={}.propertyIsEnumerable,I_=Object.getOwnPropertyDescriptor,vv=I_&&!C_.call({1:2},1);dl.f=vv?function(i){var t=I_(this,i);return!!t&&t.enumerable}:C_;var ms,ec,er=function(i,t){return{enumerable:!(1&i),configurable:!(2&i),writable:!(4&i),value:t}},yv=Gt,Av=Es,ll=Object,bv=De("".split),ul=yv(function(){return!ll("z").propertyIsEnumerable(0)})?function(i){return Av(i)=="String"?bv(i,""):ll(i)}:ll,ic=function(i){return i==null},wv=ic,Ov=TypeError,Go=function(i){if(wv(i))throw Ov("Can't call method on "+i);return i},Nv=ul,Dv=Go,ir=function(i){return Nv(Dv(i))},v_=Ge,Pv=$a.all,on=$a.IS_HTMLDDA?function(i){return typeof i=="object"?i!==null:v_(i)||i===Pv}:function(i){return typeof i=="object"?i!==null:v_(i)},zn={},hl=zn,pl=$e,Lv=Ge,y_=function(i){return Lv(i)?i:void 0},Oi=function(i,t){return arguments.length<2?y_(hl[i])||y_(pl[i]):hl[i]&&hl[i][t]||pl[i]&&pl[i][t]},nr=typeof navigator<"u"&&String(navigator.userAgent)||"",A_=$e,_l=nr,b_=A_.process,w_=A_.Deno,O_=b_&&b_.versions||w_&&w_.version,N_=O_&&O_.v8;N_&&(ec=(ms=N_.split("."))[0]>0&&ms[0]<4?1:+(ms[0]+ms[1])),!ec&&_l&&(!(ms=_l.match(/Edge\/(\d+)/))||ms[1]>=74)&&(ms=_l.match(/Chrome\/(\d+)/))&&(ec=+ms[1]);var sr=ec,D_=sr,kv=Gt,Mv=$e.String,xr=!!Object.getOwnPropertySymbols&&!kv(function(){var i=Symbol();return!Mv(i)||!(Object(i)instanceof Symbol)||!Symbol.sham&&D_&&D_<41}),P_=xr&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Uv=Oi,xv=Ge,Vv=rn,Fv=Object,Wo=P_?function(i){return typeof i=="symbol"}:function(i){var t=Uv("Symbol");return xv(t)&&Vv(t.prototype,Fv(i))},Bv=String,Vr=function(i){try{return Bv(i)}catch{return"Object"}},jv=Ge,Gv=Vr,Wv=TypeError,an=function(i){if(jv(i))return i;throw Wv(Gv(i)+" is not a function")},Hv=an,Kv=ic,El=function(i,t){var e=i[t];return Kv(e)?void 0:Hv(e)},ml=li,fl=Ge,gl=on,Yv=TypeError,L_={exports:{}},k_=$e,qv=Object.defineProperty,Jv=function(i,t){try{qv(k_,i,{value:t,configurable:!0,writable:!0})}catch{k_[i]=t}return t},M_="__core-js_shared__",Tl=$e[M_]||Jv(M_,{}),U_=Tl;(L_.exports=function(i,t){return U_[i]||(U_[i]=t!==void 0?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var Fr=L_.exports,zv=Go,Xv=Object,fs=function(i){return Xv(zv(i))},Qv=fs,Zv=De({}.hasOwnProperty),ui=Object.hasOwn||function(i,t){return Zv(Qv(i),t)},$v=De,ty=0,ey=Math.random(),iy=$v(1 .toString),Sl=function(i){return"Symbol("+(i===void 0?"":i)+")_"+iy(++ty+ey,36)},ny=Fr,x_=ui,sy=Sl,ry=xr,oy=P_,Br=$e.Symbol,Rl=ny("wks"),ay=oy?Br.for||Br:Br&&Br.withoutSetter||sy,Ie=function(i){return x_(Rl,i)||(Rl[i]=ry&&x_(Br,i)?Br[i]:ay("Symbol."+i)),Rl[i]},cy=li,V_=on,F_=Wo,dy=El,ly=function(i,t){var e,n;if(t==="string"&&fl(e=i.toString)&&!gl(n=ml(e,i))||fl(e=i.valueOf)&&!gl(n=ml(e,i))||t!=="string"&&fl(e=i.toString)&&!gl(n=ml(e,i)))return n;throw Yv("Can't convert object to primitive value")},uy=TypeError,hy=Ie("toPrimitive"),py=function(i,t){if(!V_(i)||F_(i))return i;var e,n=dy(i,hy);if(n){if(t===void 0&&(t="default"),e=cy(n,i,t),!V_(e)||F_(e))return e;throw uy("Can't convert object to primitive value")}return t===void 0&&(t="number"),ly(i,t)},_y=Wo,nc=function(i){var t=py(i,"string");return _y(t)?t:t+""},B_=on,Cl=$e.document,Ey=B_(Cl)&&B_(Cl.createElement),Il=function(i){return Ey?Cl.createElement(i):{}},my=Il,j_=!Nn&&!Gt(function(){return Object.defineProperty(my("div"),"a",{get:function(){return 7}}).a!=7}),fy=Nn,gy=li,Ty=dl,Sy=er,Ry=ir,Cy=nc,Iy=ui,vy=j_,G_=Object.getOwnPropertyDescriptor;jo.f=fy?G_:function(i,t){if(i=Ry(i),t=Cy(t),vy)try{return G_(i,t)}catch{}if(Iy(i,t))return Sy(!gy(Ty.f,i,t),i[t])};var yy=Gt,Ay=Ge,by=/#|\.prototype\./,Ho=function(i,t){var e=Oy[wy(i)];return e==Dy||e!=Ny&&(Ay(t)?yy(t):!!t)},wy=Ho.normalize=function(i){return String(i).replace(by,".").toLowerCase()},Oy=Ho.data={},Ny=Ho.NATIVE="N",Dy=Ho.POLYFILL="P",W_=Ho,Py=an,Ly=_s,ky=Za(Za.bind),Ko=function(i,t){return Py(i),t===void 0?i:Ly?ky(i,t):function(){return i.apply(t,arguments)}},cn={},H_=Nn&&Gt(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),My=on,Uy=String,xy=TypeError,Sn=function(i){if(My(i))return i;throw xy(Uy(i)+" is not an object")},Vy=Nn,Fy=j_,By=H_,sc=Sn,K_=nc,jy=TypeError,vl=Object.defineProperty,Gy=Object.getOwnPropertyDescriptor,yl="enumerable",Al="configurable",bl="writable";cn.f=Vy?By?function(i,t,e){if(sc(i),t=K_(t),sc(e),typeof i=="function"&&t==="prototype"&&"value"in e&&bl in e&&!e[bl]){var n=Gy(i,t);n&&n[bl]&&(i[t]=e.value,e={configurable:Al in e?e[Al]:n[Al],enumerable:yl in e?e[yl]:n[yl],writable:!1})}return vl(i,t,e)}:vl:function(i,t,e){if(sc(i),t=K_(t),sc(e),Fy)try{return vl(i,t,e)}catch{}if("get"in e||"set"in e)throw jy("Accessors not supported");return"value"in e&&(i[t]=e.value),i};var Wy=cn,Hy=er,gs=Nn?function(i,t,e){return Wy.f(i,t,Hy(1,e))}:function(i,t,e){return i[t]=e,i},rc=$e,Ky=al,Yy=Za,qy=Ge,Jy=jo.f,zy=W_,jr=zn,Xy=Ko,Gr=gs,Y_=ui,Qy=function(i){var t=function(e,n,s){if(this instanceof t){switch(arguments.length){case 0:return new i;case 1:return new i(e);case 2:return new i(e,n)}return new i(e,n,s)}return Ky(i,this,arguments)};return t.prototype=i.prototype,t},zt=function(i,t){var e,n,s,r,o,a,c,d,l,u=i.target,p=i.global,_=i.stat,S=i.proto,f=p?rc:_?rc[u]:(rc[u]||{}).prototype,g=p?jr:jr[u]||Gr(jr,u,{})[u],C=g.prototype;for(r in t)n=!(e=zy(p?r:u+(_?".":"#")+r,i.forced))&&f&&Y_(f,r),a=g[r],n&&(c=i.dontCallGetSet?(l=Jy(f,r))&&l.value:f[r]),o=n&&c?c:t[r],n&&typeof a==typeof o||(d=i.bind&&n?Xy(o,rc):i.wrap&&n?Qy(o):S&&qy(o)?Yy(o):o,(i.sham||o&&o.sham||a&&a.sham)&&Gr(d,"sham",!0),Gr(g,r,d),S&&(Y_(jr,s=u+"Prototype")||Gr(jr,s,{}),Gr(jr[s],r,o),i.real&&C&&(e||!C[r])&&Gr(C,r,o)))},Zy=Math.ceil,$y=Math.floor,tA=Math.trunc||function(i){var t=+i;return(t>0?$y:Zy)(t)},wl=function(i){var t=+i;return t!=t||t===0?0:tA(t)},eA=wl,iA=Math.max,nA=Math.min,q_=function(i,t){var e=eA(i);return e<0?iA(e+t,0):nA(e,t)},sA=wl,rA=Math.min,oA=function(i){return i>0?rA(sA(i),9007199254740991):0},rr=function(i){return oA(i.length)},aA=ir,cA=q_,dA=rr,J_=function(i){return function(t,e,n){var s,r=aA(t),o=dA(r),a=cA(n,o);if(i&&e!=e){for(;o>a;)if((s=r[a++])!=s)return!0}else for(;o>a;a++)if((i||a in r)&&r[a]===e)return i||a||0;return!i&&-1}},Ol={includes:J_(!0),indexOf:J_(!1)},lA=Ol.includes;zt({target:"Array",proto:!0,forced:Gt(function(){return!Array(1).includes()})},{includes:function(i){return lA(this,i,arguments.length>1?arguments[1]:void 0)}});var uA=zn,Ts=function(i){return uA[i+"Prototype"]},hA=Ts("Array").includes,pA=on,_A=Es,EA=Ie("match"),mA=function(i){var t;return pA(i)&&((t=i[EA])!==void 0?!!t:_A(i)=="RegExp")},fA=TypeError,z_={};z_[Ie("toStringTag")]="z";var Nl=String(z_)==="[object z]",gA=Nl,TA=Ge,oc=Es,SA=Ie("toStringTag"),RA=Object,CA=oc(function(){return arguments}())=="Arguments",or=gA?oc:function(i){var t,e,n;return i===void 0?"Undefined":i===null?"Null":typeof(e=function(s,r){try{return s[r]}catch{}}(t=RA(i),SA))=="string"?e:CA?oc(t):(n=oc(t))=="Object"&&TA(t.callee)?"Arguments":n},IA=or,vA=String,Xn=function(i){if(IA(i)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return vA(i)},yA=Ie("match"),AA=zt,bA=function(i){if(mA(i))throw fA("The method doesn't accept regular expressions");return i},wA=Go,X_=Xn,OA=function(i){var t=/./;try{"/./"[i](t)}catch{try{return t[yA]=!1,"/./"[i](t)}catch{}}return!1},NA=De("".indexOf);AA({target:"String",proto:!0,forced:!OA("includes")},{includes:function(i){return!!~NA(X_(wA(this)),X_(bA(i)),arguments.length>1?arguments[1]:void 0)}});var DA=Ts("String").includes,Q_=rn,PA=hA,LA=DA,Dl=Array.prototype,Pl=String.prototype,q=xt(function(i){var t=i.includes;return i===Dl||Q_(Dl,i)&&t===Dl.includes?PA:typeof i=="string"||i===Pl||Q_(Pl,i)&&t===Pl.includes?LA:t});let Z_=!0,$_=!0;function ac(i,t,e){const n=i.match(t);return n&&n.length>=e&&parseInt(n[e],10)}function ar(i,t,e){if(!i.RTCPeerConnection)return;const n=i.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(o,a){if(o!==t)return s.apply(this,arguments);const c=d=>{const l=e(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),s.apply(this,[o,c])};const r=n.removeEventListener;n.removeEventListener=function(o,a){if(o!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(a))return r.apply(this,arguments);const c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,r.apply(this,[o,c])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(o){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),o&&this.addEventListener(t,this["_on"+t]=o)},enumerable:!0,configurable:!0})}function kA(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(Z_=i,i?"adapter.js logging disabled":"adapter.js logging enabled")}function MA(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):($_=!i,"adapter.js deprecation warnings "+(i?"disabled":"enabled"))}function tE(){if(typeof window=="object"){if(Z_)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Ll(i,t){$_&&console.warn(i+" is deprecated, please use "+t+" instead.")}function eE(i){return Object.prototype.toString.call(i)==="[object Object]"}function iE(i){return eE(i)?Object.keys(i).reduce(function(t,e){const n=eE(i[e]),s=n?iE(i[e]):i[e],r=n&&!Object.keys(s).length;return s===void 0||r?t:Object.assign(t,{[e]:s})},{}):i}function kl(i,t,e){t&&!e.has(t.id)&&(e.set(t.id,t),Object.keys(t).forEach(n=>{n.endsWith("Id")?kl(i,i.get(t[n]),e):n.endsWith("Ids")&&t[n].forEach(s=>{kl(i,i.get(s),e)})}))}function nE(i,t,e){const n=e?"outbound-rtp":"inbound-rtp",s=new Map;if(t===null)return s;const r=[];return i.forEach(o=>{o.type==="track"&&o.trackIdentifier===t.id&&r.push(o)}),r.forEach(o=>{i.forEach(a=>{a.type===n&&a.trackId===o.id&&kl(i,a,s)})}),s}const sE=tE;function rE(i,t){const e=i&&i.navigator;if(!e.mediaDevices)return;const n=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof o[c]=="object"?o[c]:{ideal:o[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const l=function(u,p){return u?u+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u])})}),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},s=function(o,a){if(t.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=n(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=t.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!e.mediaDevices.getSupportedConstraints||!e.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return e.mediaDevices.enumerateDevices().then(u=>{let p=(u=u.filter(_=>_.kind==="videoinput")).find(_=>l.some(S=>_.label.toLowerCase().includes(S)));return!p&&u.length&&l.includes("back")&&(p=u[u.length-1]),p&&(o.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),o.video=n(o.video),sE("chrome: "+JSON.stringify(o)),a(o)})}o.video=n(o.video)}return sE("chrome: "+JSON.stringify(o)),a(o)},r=function(o){return t.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(e.getUserMedia=(function(o,a,c){s(o,d=>{e.webkitGetUserMedia(d,a,l=>{c&&c(r(l))})})}).bind(e),e.mediaDevices.getUserMedia){const o=e.mediaDevices.getUserMedia.bind(e.mediaDevices);e.mediaDevices.getUserMedia=function(a){return s(a,c=>o(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return d},d=>Promise.reject(r(d))))}}}function oE(i){i.MediaStream=i.MediaStream||i.webkitMediaStream}function aE(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("ontrack"in i.RTCPeerConnection.prototype)){Object.defineProperty(i.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",n=>{let s;s=i.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.track.id):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=s,r.transceiver={receiver:s},r.streams=[e.stream],this.dispatchEvent(r)}),e.stream.getTracks().forEach(n=>{let s;s=i.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(o=>o.track&&o.track.id===n.id):{track:n};const r=new Event("track");r.track=n,r.receiver=s,r.transceiver={receiver:s},r.streams=[e.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else ar(i,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function cE(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("getSenders"in i.RTCPeerConnection.prototype)&&"createDTMFSender"in i.RTCPeerConnection.prototype){const t=function(s,r){return{track:r,get dtmf(){return this._dtmf===void 0&&(r.kind==="audio"?this._dtmf=s.createDTMFSender(r):this._dtmf=null),this._dtmf},_pc:s}};if(!i.RTCPeerConnection.prototype.getSenders){i.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const s=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(o,a){let c=s.apply(this,arguments);return c||(c=t(this,o),this._senders.push(c)),c};const r=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(o){r.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const e=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],e.apply(this,[s]),s.getTracks().forEach(r=>{this._senders.push(t(this,r))})};const n=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],n.apply(this,[s]),s.getTracks().forEach(r=>{const o=this._senders.find(a=>a.track===r);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof i=="object"&&i.RTCPeerConnection&&"getSenders"in i.RTCPeerConnection.prototype&&"createDTMFSender"in i.RTCPeerConnection.prototype&&i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)){const t=i.RTCPeerConnection.prototype.getSenders;i.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(n=>n._pc=this),e},Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function dE(i){if(!i.RTCPeerConnection)return;const t=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){const[e,n,s]=arguments;if(arguments.length>0&&typeof e=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof e!="function"))return t.apply(this,[]);const r=function(a){const c={};return a.result().forEach(d=>{const l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(u=>{l[u]=d.stat(u)}),c[l.id]=l}),c},o=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){const a=function(c){n(o(r(c)))};return t.apply(this,[a,e])}return new Promise((a,c)=>{t.apply(this,[function(d){a(o(r(d)))},c])}).then(n,s)}}function lE(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender&&i.RTCRtpReceiver))return;if(!("getStats"in i.RTCRtpSender.prototype)){const e=i.RTCPeerConnection.prototype.getSenders;e&&(i.RTCPeerConnection.prototype.getSenders=function(){const s=e.apply(this,[]);return s.forEach(r=>r._pc=this),s});const n=i.RTCPeerConnection.prototype.addTrack;n&&(i.RTCPeerConnection.prototype.addTrack=function(){const s=n.apply(this,arguments);return s._pc=this,s}),i.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(r=>nE(r,s.track,!0))}}if(!("getStats"in i.RTCRtpReceiver.prototype)){const e=i.RTCPeerConnection.prototype.getReceivers;e&&(i.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(s=>s._pc=this),n}),ar(i,"track",n=>(n.receiver._pc=n.srcElement,n)),i.RTCRtpReceiver.prototype.getStats=function(){const n=this;return this._pc.getStats().then(s=>nE(s,n.track,!1))}}if(!("getStats"in i.RTCRtpSender.prototype)||!("getStats"in i.RTCRtpReceiver.prototype))return;const t=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof i.MediaStreamTrack){const e=arguments[0];let n,s,r;return this.getSenders().forEach(o=>{o.track===e&&(n?r=!0:n=o)}),this.getReceivers().forEach(o=>(o.track===e&&(s?r=!0:s=o),o.track===e)),r||n&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function uE(i){i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(r=>this._shimmedLocalStreams[r][0])};const t=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(r,o){if(!o)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=t.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const e=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(r){this._shimmedLocalStreams=this._shimmedLocalStreams||{},r.getTracks().forEach(c=>{if(this.getSenders().find(d=>d.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();e.apply(this,arguments);const a=this.getSenders().filter(c=>o.indexOf(c)===-1);this._shimmedLocalStreams[r.id]=[r].concat(a)};const n=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[r.id],n.apply(this,arguments)};const s=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(r){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},r&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const a=this._shimmedLocalStreams[o].indexOf(r);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),s.apply(this,arguments)}}function hE(i,t){if(!i.RTCPeerConnection)return;if(i.RTCPeerConnection.prototype.addTrack&&t.version>=65)return uE(i);const e=i.RTCPeerConnection.prototype.getLocalStreams;i.RTCPeerConnection.prototype.getLocalStreams=function(){const c=e.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};const n=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(l=>l.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){const d=new i.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}n.apply(this,[c])};const s=i.RTCPeerConnection.prototype.removeStream;function r(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{const p=c._reverseStreams[u],_=c._streams[p.id];l=l.replace(new RegExp(_.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:l})}i.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},i.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const u=this._streams[d.id];if(u)u.addTrack(c),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const p=new i.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){const d=i.RTCPeerConnection.prototype[c],l={[c](){const u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[p=>{const _=r(this,p);u[0].apply(null,[_])},p=>{u[1]&&u[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then(p=>r(this,p))}};i.RTCPeerConnection.prototype[c]=l[c]});const o=i.RTCPeerConnection.prototype.setLocalDescription;i.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{const p=c._reverseStreams[u],_=c._streams[p.id];l=l.replace(new RegExp(p.id,"g"),_.id)}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(i.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(i.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:r(this,c)}}),i.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(u=>c.track===u)&&(d=this._streams[l])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ml(i,t){!i.RTCPeerConnection&&i.webkitRTCPeerConnection&&(i.RTCPeerConnection=i.webkitRTCPeerConnection),i.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){const n=i.RTCPeerConnection.prototype[e],s={[e](){return arguments[0]=new(e==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};i.RTCPeerConnection.prototype[e]=s[e]})}function pE(i,t){ar(i,"negotiationneeded",e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")||n.signalingState==="stable")return e})}var _E=Object.freeze({__proto__:null,fixNegotiationNeeded:pE,shimAddTrackRemoveTrack:hE,shimAddTrackRemoveTrackWithNative:uE,shimGetDisplayMedia:function(i,t){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(typeof t=="function"?i.navigator.mediaDevices.getDisplayMedia=function(e){return t(e).then(n=>{const s=e.video&&e.video.width,r=e.video&&e.video.height,o=e.video&&e.video.frameRate;return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:o||3}},s&&(e.video.mandatory.maxWidth=s),r&&(e.video.mandatory.maxHeight=r),i.navigator.mediaDevices.getUserMedia(e)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:cE,shimGetStats:dE,shimGetUserMedia:rE,shimMediaStream:oE,shimOnTrack:aE,shimPeerConnection:Ml,shimSenderReceiverGetStats:lE});function EE(i,t){const e=i&&i.navigator,n=i&&i.MediaStreamTrack;if(e.getUserMedia=function(s,r,o){Ll("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),e.mediaDevices.getUserMedia(s).then(r,o)},!(t.version>55&&"autoGainControl"in e.mediaDevices.getSupportedConstraints())){const s=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},r=e.mediaDevices.getUserMedia.bind(e.mediaDevices);if(e.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),s(o.audio,"autoGainControl","mozAutoGainControl"),s(o.audio,"noiseSuppression","mozNoiseSuppression")),r(o)},n&&n.prototype.getSettings){const o=n.prototype.getSettings;n.prototype.getSettings=function(){const a=o.apply(this,arguments);return s(a,"mozAutoGainControl","autoGainControl"),s(a,"mozNoiseSuppression","noiseSuppression"),a}}if(n&&n.prototype.applyConstraints){const o=n.prototype.applyConstraints;n.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),s(a,"autoGainControl","mozAutoGainControl"),s(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function mE(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ul(i,t){if(typeof i!="object"||!i.RTCPeerConnection&&!i.mozRTCPeerConnection)return;!i.RTCPeerConnection&&i.mozRTCPeerConnection&&(i.RTCPeerConnection=i.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(s){const r=i.RTCPeerConnection.prototype[s],o={[s](){return arguments[0]=new(s==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};i.RTCPeerConnection.prototype[s]=o[s]});const e={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){const[s,r,o]=arguments;return n.apply(this,[s||null]).then(a=>{if(t.version<53&&!r)try{a.forEach(c=>{c.type=e[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:e[d.type]||d.type}))})}return a}).then(r,o)}}function fE(i){if(typeof i!="object"||!i.RTCPeerConnection||!i.RTCRtpSender||i.RTCRtpSender&&"getStats"in i.RTCRtpSender.prototype)return;const t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(s=>s._pc=this),n});const e=i.RTCPeerConnection.prototype.addTrack;e&&(i.RTCPeerConnection.prototype.addTrack=function(){const n=e.apply(this,arguments);return n._pc=this,n}),i.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function gE(i){if(typeof i!="object"||!i.RTCPeerConnection||!i.RTCRtpSender||i.RTCRtpSender&&"getStats"in i.RTCRtpReceiver.prototype)return;const t=i.RTCPeerConnection.prototype.getReceivers;t&&(i.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(n=>n._pc=this),e}),ar(i,"track",e=>(e.receiver._pc=e.srcElement,e)),i.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function TE(i){i.RTCPeerConnection&&!("removeStream"in i.RTCPeerConnection.prototype)&&(i.RTCPeerConnection.prototype.removeStream=function(t){Ll("removeStream","removeTrack"),this.getSenders().forEach(e=>{e.track&&t.getTracks().includes(e.track)&&this.removeTrack(e)})})}function SE(i){i.DataChannel&&!i.RTCDataChannel&&(i.RTCDataChannel=i.DataChannel)}function RE(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const t=i.RTCPeerConnection.prototype.addTransceiver;t&&(i.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;e===void 0&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach(r=>{if("rid"in r&&!/^[a-z0-9]{0,16}$/i.test(r.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in r&&!(parseFloat(r.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in r&&!(parseFloat(r.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=t.apply(this,arguments);if(n){const{sender:r}=s,o=r.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=e,r.sendEncodings=e,this.setParametersPromises.push(r.setParameters(o).then(()=>{delete r.sendEncodings}).catch(()=>{delete r.sendEncodings})))}return s})}function CE(i){if(typeof i!="object"||!i.RTCRtpSender)return;const t=i.RTCRtpSender.prototype.getParameters;t&&(i.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function IE(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const t=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function vE(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const t=i.RTCPeerConnection.prototype.createAnswer;i.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var yE=Object.freeze({__proto__:null,shimAddTransceiver:RE,shimCreateAnswer:vE,shimCreateOffer:IE,shimGetDisplayMedia:function(i,t){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(i.navigator.mediaDevices.getDisplayMedia=function(e){if(!e||!e.video){const n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return e.video===!0?e.video={mediaSource:t}:e.video.mediaSource=t,i.navigator.mediaDevices.getUserMedia(e)})},shimGetParameters:CE,shimGetUserMedia:EE,shimOnTrack:mE,shimPeerConnection:Ul,shimRTCDataChannel:SE,shimReceiverGetStats:gE,shimRemoveStream:TE,shimSenderGetStats:fE});function AE(i){if(typeof i=="object"&&i.RTCPeerConnection){if("getLocalStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in i.RTCPeerConnection.prototype)){const t=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(n=>t.call(this,n,e)),e.getVideoTracks().forEach(n=>t.call(this,n,e))},i.RTCPeerConnection.prototype.addTrack=function(e,...n){return n&&n.forEach(s=>{this._localStreams?this._localStreams.includes(s)||this._localStreams.push(s):this._localStreams=[s]}),t.apply(this,arguments)}}"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const e=this._localStreams.indexOf(t);if(e===-1)return;this._localStreams.splice(e,1);const n=t.getTracks();this.getSenders().forEach(s=>{n.includes(s.track)&&this.removeTrack(s)})})}}function bE(i){if(typeof i=="object"&&i.RTCPeerConnection&&("getRemoteStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in i.RTCPeerConnection.prototype))){Object.defineProperty(i.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(s=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(s))return;this._remoteStreams.push(s);const r=new Event("addstream");r.stream=s,this.dispatchEvent(r)})})}});const t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(s=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(s)>=0)return;e._remoteStreams.push(s);const r=new Event("addstream");r.stream=s,e.dispatchEvent(r)})}),t.apply(e,arguments)}}}function wE(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const t=i.RTCPeerConnection.prototype,e=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,r=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=e.apply(this,[l]);return d?(u.then(c,d),Promise.resolve()):u},t.createAnswer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),Promise.resolve()):u};let a=function(c,d,l){const u=s.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u};t.setLocalDescription=a,a=function(c,d,l){const u=r.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u},t.setRemoteDescription=a,a=function(c,d,l){const u=o.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u},t.addIceCandidate=a}function OE(i){const t=i&&i.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=s=>n(NE(s))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(e,n,s){t.mediaDevices.getUserMedia(e).then(n,s)}).bind(t))}function NE(i){return i&&i.video!==void 0?Object.assign({},i,{video:iE(i.video)}):i}function DE(i){if(!i.RTCPeerConnection)return;const t=i.RTCPeerConnection;i.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const s=[];for(let r=0;r<e.iceServers.length;r++){let o=e.iceServers[r];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(Ll("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,s.push(o)):s.push(e.iceServers[r])}e.iceServers=s}return new t(e,n)},i.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(i.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function PE(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function LE(i){const t=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(e){if(e){e.offerToReceiveAudio!==void 0&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const n=this.getTransceivers().find(r=>r.receiver.track.kind==="audio");e.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):e.offerToReceiveAudio!==!0||n||this.addTransceiver("audio",{direction:"recvonly"}),e.offerToReceiveVideo!==void 0&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const s=this.getTransceivers().find(r=>r.receiver.track.kind==="video");e.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):e.offerToReceiveVideo!==!0||s||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function kE(i){typeof i!="object"||i.AudioContext||(i.AudioContext=i.webkitAudioContext)}var ME=Object.freeze({__proto__:null,shimAudioContext:kE,shimCallbacksAPI:wE,shimConstraints:NE,shimCreateOfferLegacy:LE,shimGetUserMedia:OE,shimLocalStreamsAPI:AE,shimRTCIceServerUrls:DE,shimRemoteStreamsAPI:bE,shimTrackEventTransceiver:PE}),UE={exports:{}};(function(i){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split(`
`).map(n=>n.trim())},t.splitSections=function(e){return e.split(`
m=`).map((n,s)=>(s>0?"m="+n:n).trim()+`\r
`)},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter(s=>s.indexOf(n)===0)},t.parseCandidate=function(e){let n;n=e.indexOf("a=candidate:")===0?e.substring(12).split(" "):e.substring(10).split(" ");const s={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let r=8;r<n.length;r+=2)switch(n[r]){case"raddr":s.relatedAddress=n[r+1];break;case"rport":s.relatedPort=parseInt(n[r+1],10);break;case"tcptype":s.tcpType=n[r+1];break;case"ufrag":s.ufrag=n[r+1],s.usernameFragment=n[r+1];break;default:s[n[r]]===void 0&&(s[n[r]]=n[r+1])}return s},t.writeCandidate=function(e){const n=[];n.push(e.foundation);const s=e.component;s==="rtp"?n.push(1):s==="rtcp"?n.push(2):n.push(s),n.push(e.protocol.toUpperCase()),n.push(e.priority),n.push(e.address||e.ip),n.push(e.port);const r=e.type;return n.push("typ"),n.push(r),r!=="host"&&e.relatedAddress&&e.relatedPort&&(n.push("raddr"),n.push(e.relatedAddress),n.push("rport"),n.push(e.relatedPort)),e.tcpType&&e.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(n.push("ufrag"),n.push(e.usernameFragment||e.ufrag)),"candidate:"+n.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let n=e.substring(9).split(" ");const s={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),s.name=n[0],s.clockRate=parseInt(n[1],10),s.channels=n.length===3?parseInt(n[2],10):1,s.numChannels=s.channels,s},t.writeRtpMap=function(e){let n=e.payloadType;e.preferredPayloadType!==void 0&&(n=e.preferredPayloadType);const s=e.channels||e.numChannels||1;return"a=rtpmap:"+n+" "+e.name+"/"+e.clockRate+(s!==1?"/"+s:"")+`\r
`},t.parseExtmap=function(e){const n=e.substring(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1],attributes:n.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+`\r
`},t.parseFmtp=function(e){const n={};let s;const r=e.substring(e.indexOf(" ")+1).split(";");for(let o=0;o<r.length;o++)s=r[o].trim().split("="),n[s[0].trim()]=s[1];return n},t.writeFmtp=function(e){let n="",s=e.payloadType;if(e.preferredPayloadType!==void 0&&(s=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const r=[];Object.keys(e.parameters).forEach(o=>{e.parameters[o]!==void 0?r.push(o+"="+e.parameters[o]):r.push(o)}),n+="a=fmtp:"+s+" "+r.join(";")+`\r
`}return n},t.parseRtcpFb=function(e){const n=e.substring(e.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},t.writeRtcpFb=function(e){let n="",s=e.payloadType;return e.preferredPayloadType!==void 0&&(s=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(r=>{n+="a=rtcp-fb:"+s+" "+r.type+(r.parameter&&r.parameter.length?" "+r.parameter:"")+`\r
`}),n},t.parseSsrcMedia=function(e){const n=e.indexOf(" "),s={ssrc:parseInt(e.substring(7,n),10)},r=e.indexOf(":",n);return r>-1?(s.attribute=e.substring(n+1,r),s.value=e.substring(r+1)):s.attribute=e.substring(n+1),s},t.parseSsrcGroup=function(e){const n=e.substring(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(s=>parseInt(s,10))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const n=e.substring(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,n){let s="a=setup:"+n+`\r
`;return e.fingerprints.forEach(r=>{s+="a=fingerprint:"+r.algorithm+" "+r.value+`\r
`}),s},t.parseCryptoLine=function(e){const n=e.substring(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+(typeof e.keyParams=="object"?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(e){if(e.indexOf("inline:")!==0)return null;const n=e.substring(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const s=t.matchPrefix(e+n,"a=ice-ufrag:")[0],r=t.matchPrefix(e+n,"a=ice-pwd:")[0];return s&&r?{usernameFragment:s.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let n="a=ice-ufrag:"+e.usernameFragment+`\r
a=ice-pwd:`+e.password+`\r
`;return e.iceLite&&(n+=`a=ice-lite\r
`),n},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=t.splitLines(e)[0].split(" ");n.profile=s[2];for(let o=3;o<s.length;o++){const a=s[o],c=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(c){const d=t.parseRtpMap(c),l=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(d.parameters=l.length?t.parseFmtp(l[0]):{},d.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),n.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(d.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach(o=>{n.headerExtensions.push(t.parseExtmap(o))});const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach(o=>{r.forEach(a=>{o.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||o.rtcpFeedback.push(a)})}),n},t.writeRtpDescription=function(e,n){let s="";s+="m="+e+" ",s+=n.codecs.length>0?"9":"0",s+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",s+=n.codecs.map(o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType).join(" ")+`\r
`,s+=`c=IN IP4 0.0.0.0\r
`,s+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(o=>{s+=t.writeRtpMap(o),s+=t.writeFmtp(o),s+=t.writeRtcpFb(o)});let r=0;return n.codecs.forEach(o=>{o.maxptime>r&&(r=o.maxptime)}),r>0&&(s+="a=maxptime:"+r+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(o=>{s+=t.writeExtmap(o)}),s},t.parseRtpEncodingParameters=function(e){const n=[],s=t.parseRtpParameters(e),r=s.fecMechanisms.indexOf("RED")!==-1,o=s.fecMechanisms.indexOf("ULPFEC")!==-1,a=t.matchPrefix(e,"a=ssrc:").map(p=>t.parseSsrcMedia(p)).filter(p=>p.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const l=t.matchPrefix(e,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(_=>parseInt(_,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),s.codecs.forEach(p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let _={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(_.rtx={ssrc:d}),n.push(_),r&&(_=JSON.parse(JSON.stringify(_)),_.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(_))}}),n.length===0&&c&&n.push({ssrc:c});let u=t.matchPrefix(e,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,n.forEach(p=>{p.maxBitrate=u})),n},t.parseRtcpParameters=function(e){const n={},s=t.matchPrefix(e,"a=ssrc:").map(a=>t.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];s&&(n.cname=s.value,n.ssrc=s.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=r.length>0,n.compound=r.length===0;const o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(e){let n="";return e.reducedSize&&(n+=`a=rtcp-rsize\r
`),e.mux&&(n+=`a=rtcp-mux\r
`),e.ssrc!==void 0&&e.cname&&(n+="a=ssrc:"+e.ssrc+" cname:"+e.cname+`\r
`),n},t.parseMsid=function(e){let n;const s=t.matchPrefix(e,"a=msid:");if(s.length===1)return n=s[0].substring(7).split(" "),{stream:n[0],track:n[1]};const r=t.matchPrefix(e,"a=ssrc:").map(o=>t.parseSsrcMedia(o)).filter(o=>o.attribute==="msid");return r.length>0?(n=r[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),s=t.matchPrefix(e,"a=max-message-size:");let r;s.length>0&&(r=parseInt(s[0].substring(19),10)),isNaN(r)&&(r=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:r};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,n){let s=[];return s=e.protocol!=="DTLS/SCTP"?["m="+e.kind+" 9 "+e.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:["m="+e.kind+" 9 "+e.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&s.push("a=max-message-size:"+n.maxMessageSize+`\r
`),s.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,s){let r;const o=n!==void 0?n:2;return r=e||t.generateSessionId(),`v=0\r
o=`+(s||"thisisadapterortc")+" "+r+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(e,n){const s=t.splitLines(e);for(let r=0;r<s.length;r++)switch(s[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return s[r].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return e.split(" ",2)[1]==="0"},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if(typeof e!="string"||e.length===0)return!1;const n=t.splitLines(e);for(let s=0;s<n.length;s++)if(n[s].length<2||n[s].charAt(1)!=="=")return!1;return!0},i.exports=t})(UE);var xE=UE.exports,Wr=xt(xE),UA=di({__proto__:null,default:Wr},[xE]);function cc(i){if(!i.RTCIceCandidate||i.RTCIceCandidate&&"foundation"in i.RTCIceCandidate.prototype)return;const t=i.RTCIceCandidate;i.RTCIceCandidate=function(e){if(typeof e=="object"&&e.candidate&&e.candidate.indexOf("a=")===0&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),s=Wr.parseCandidate(e.candidate),r=Object.assign(n,s);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},i.RTCIceCandidate.prototype=t.prototype,ar(i,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new i.RTCIceCandidate(e.candidate),writable:"false"}),e))}function xl(i){!i.RTCIceCandidate||i.RTCIceCandidate&&"relayProtocol"in i.RTCIceCandidate.prototype||ar(i,"icecandidate",t=>{if(t.candidate){const e=Wr.parseCandidate(t.candidate.candidate);e.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[e.priority>>24])}return t})}function dc(i,t){if(!i.RTCPeerConnection)return;"sctp"in i.RTCPeerConnection.prototype||Object.defineProperty(i.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const e=function(a){if(!a||!a.sdp)return!1;const c=Wr.splitSections(a.sdp);return c.shift(),c.some(d=>{const l=Wr.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},n=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},s=function(a){let c=65536;return t.browser==="firefox"&&(c=t.version<57?a===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),c},r=function(a,c){let d=65536;t.browser==="firefox"&&t.version===57&&(d=65535);const l=Wr.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(d=2147483637),d},o=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(e(arguments[0])){const a=n(arguments[0]),c=s(a),d=r(arguments[0],a);let l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const u={};Object.defineProperty(u,"maxMessageSize",{get:()=>l}),this._sctp=u}return o.apply(this,arguments)}}function lc(i){if(!i.RTCPeerConnection||!("createDataChannel"in i.RTCPeerConnection.prototype))return;function t(n,s){const r=n.send;n.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(n.readyState==="open"&&s.sctp&&a>s.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+s.sctp.maxMessageSize+" bytes)");return r.apply(n,arguments)}}const e=i.RTCPeerConnection.prototype.createDataChannel;i.RTCPeerConnection.prototype.createDataChannel=function(){const n=e.apply(this,arguments);return t(n,this),n},ar(i,"datachannel",n=>(t(n.channel,n.target),n))}function Vl(i){if(!i.RTCPeerConnection||"connectionState"in i.RTCPeerConnection.prototype)return;const t=i.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=s=>{const r=s.target;if(r._lastConnectionState!==r.connectionState){r._lastConnectionState=r.connectionState;const o=new Event("connectionstatechange",s);r.dispatchEvent(o)}return s},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function Fl(i,t){if(!i.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=n.sdp.split(`
`).filter(r=>r.trim()!=="a=extmap-allow-mixed").join(`
`);i.RTCSessionDescription&&n instanceof i.RTCSessionDescription?arguments[0]=new i.RTCSessionDescription({type:n.type,sdp:s}):n.sdp=s}return e.apply(this,arguments)}}function uc(i,t){if(!i.RTCPeerConnection||!i.RTCPeerConnection.prototype)return;const e=i.RTCPeerConnection.prototype.addIceCandidate;e&&e.length!==0&&(i.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():e.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function hc(i,t){if(!i.RTCPeerConnection||!i.RTCPeerConnection.prototype)return;const e=i.RTCPeerConnection.prototype.setLocalDescription;e&&e.length!==0&&(i.RTCPeerConnection.prototype.setLocalDescription=function(){let n=arguments[0]||{};if(typeof n!="object"||n.type&&n.sdp)return e.apply(this,arguments);if(n={type:n.type,sdp:n.sdp},!n.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":n.type="offer";break;default:n.type="answer"}return n.sdp||n.type!=="offer"&&n.type!=="answer"?e.apply(this,[n]):(n.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(s=>e.apply(this,[s]))})}var xA=Object.freeze({__proto__:null,removeExtmapAllowMixed:Fl,shimAddIceCandidateNullOrEmpty:uc,shimConnectionState:Vl,shimMaxMessageSize:dc,shimParameterlessSetLocalDescription:hc,shimRTCIceCandidate:cc,shimRTCIceCandidateRelayProtocol:xl,shimSendThrowTypeError:lc});(function({window:i}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const e=tE,n=function(r){const o={browser:null,version:null};if(r===void 0||!r.navigator)return o.browser="Not a browser.",o;const{navigator:a}=r;if(a.mozGetUserMedia)o.browser="firefox",o.version=ac(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||r.isSecureContext===!1&&r.webkitRTCPeerConnection)o.browser="chrome",o.version=ac(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!r.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=ac(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=r.RTCRtpTransceiver&&"currentDirection"in r.RTCRtpTransceiver.prototype}return o}(i),s={browserDetails:n,commonShim:xA,extractVersion:ac,disableLog:kA,disableWarnings:MA,sdp:UA};switch(n.browser){case"chrome":if(!_E||!Ml||!t.shimChrome)return e("Chrome shim is not included in this adapter release."),s;if(n.version===null)return e("Chrome shim can not determine version, not shimming."),s;e("adapter.js shimming chrome."),s.browserShim=_E,uc(i,n),hc(i),rE(i,n),oE(i),Ml(i,n),aE(i),hE(i,n),cE(i),dE(i),lE(i),pE(i,n),cc(i),xl(i),Vl(i),dc(i,n),lc(i),Fl(i,n);break;case"firefox":if(!yE||!Ul||!t.shimFirefox)return e("Firefox shim is not included in this adapter release."),s;e("adapter.js shimming firefox."),s.browserShim=yE,uc(i,n),hc(i),EE(i,n),Ul(i,n),mE(i),TE(i),fE(i),gE(i),SE(i),RE(i),CE(i),IE(i),vE(i),cc(i),Vl(i),dc(i,n),lc(i);break;case"safari":if(!ME||!t.shimSafari)return e("Safari shim is not included in this adapter release."),s;e("adapter.js shimming safari."),s.browserShim=ME,uc(i,n),hc(i),DE(i),LE(i),wE(i),AE(i),bE(i),PE(i),OE(i),kE(i),cc(i),xl(i),dc(i,n),lc(i),Fl(i,n);break;default:e("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var VE={exports:{}},VA=zt,FA=Nn,FE=cn.f;VA({target:"Object",stat:!0,forced:Object.defineProperty!==FE,sham:!FA},{defineProperty:FE});var BE=zn.Object,BA=VE.exports=function(i,t,e){return BE.defineProperty(i,t,e)};BE.defineProperty.sham&&(BA.sham=!0);var jA=xt(VE.exports),GA=Es,Bl=Array.isArray||function(i){return GA(i)=="Array"},WA=TypeError,HA=nc,KA=cn,YA=er,jE=function(i,t,e){var n=HA(t);n in i?KA.f(i,n,YA(0,e)):i[n]=e},qA=Ge,jl=Tl,JA=De(Function.toString);qA(jl.inspectSource)||(jl.inspectSource=function(i){return JA(i)});var GE=jl.inspectSource,zA=De,XA=Gt,WE=Ge,QA=or,ZA=GE,HE=function(){},$A=[],KE=Oi("Reflect","construct"),Gl=/^\s*(?:class|function)\b/,tb=zA(Gl.exec),eb=!Gl.exec(HE),Yo=function(i){if(!WE(i))return!1;try{return KE(HE,$A,i),!0}catch{return!1}},YE=function(i){if(!WE(i))return!1;switch(QA(i)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return eb||!!tb(Gl,ZA(i))}catch{return!0}};YE.sham=!0;var qE=!KE||XA(function(){var i;return Yo(Yo.call)||!Yo(Object)||!Yo(function(){i=!0})||i})?YE:Yo,JE=Bl,ib=qE,nb=on,sb=Ie("species"),zE=Array,rb=function(i){var t;return JE(i)&&(t=i.constructor,(ib(t)&&(t===zE||JE(t.prototype))||nb(t)&&(t=t[sb])===null)&&(t=void 0)),t===void 0?zE:t},XE=function(i,t){return new(rb(i))(t===0?0:t)},ob=Gt,ab=sr,cb=Ie("species"),db=zt,lb=Gt,ub=Bl,hb=on,pb=fs,_b=rr,QE=function(i){if(i>9007199254740991)throw WA("Maximum allowed index exceeded");return i},ZE=jE,Eb=XE,mb=function(i){return ab>=51||!ob(function(){var t=[];return(t.constructor={})[cb]=function(){return{foo:1}},t[i](Boolean).foo!==1})},fb=sr,$E=Ie("isConcatSpreadable"),gb=fb>=51||!lb(function(){var i=[];return i[$E]=!1,i.concat()[0]!==i}),Tb=function(i){if(!hb(i))return!1;var t=i[$E];return t!==void 0?!!t:ub(i)};db({target:"Array",proto:!0,arity:1,forced:!gb||!mb("concat")},{concat:function(i){var t,e,n,s,r,o=pb(this),a=Eb(o,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(Tb(r=t===-1?o:arguments[t]))for(s=_b(r),QE(c+s),e=0;e<s;e++,c++)e in r&&ZE(a,c,r[e]);else QE(c+1),ZE(a,c++,r);return a.length=c,a}});var Wl={},pc={},Hl=ui,Sb=ir,Rb=Ol.indexOf,Cb=pc,tm=De([].push),em=function(i,t){var e,n=Sb(i),s=0,r=[];for(e in n)!Hl(Cb,e)&&Hl(n,e)&&tm(r,e);for(;t.length>s;)Hl(n,e=t[s++])&&(~Rb(r,e)||tm(r,e));return r},Kl=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Ib=em,vb=Kl,Yl=Object.keys||function(i){return Ib(i,vb)},yb=Nn,Ab=H_,bb=cn,wb=Sn,Ob=ir,Nb=Yl;Wl.f=yb&&!Ab?Object.defineProperties:function(i,t){wb(i);for(var e,n=Ob(t),s=Nb(t),r=s.length,o=0;r>o;)bb.f(i,e=s[o++],n[e]);return i};var _c,im=Oi("document","documentElement"),Db=Sl,nm=Fr("keys"),Ec=function(i){return nm[i]||(nm[i]=Db(i))},Pb=Sn,Lb=Wl,sm=Kl,kb=pc,Mb=im,Ub=Il,ql="prototype",Jl="script",rm=Ec("IE_PROTO"),zl=function(){},om=function(i){return"<"+Jl+">"+i+"</"+Jl+">"},am=function(i){i.write(om("")),i.close();var t=i.parentWindow.Object;return i=null,t},mc=function(){try{_c=new ActiveXObject("htmlfile")}catch{}var i,t,e;mc=typeof document<"u"?document.domain&&_c?am(_c):(t=Ub("iframe"),e="java"+Jl+":",t.style.display="none",Mb.appendChild(t),t.src=String(e),(i=t.contentWindow.document).open(),i.write(om("document.F=Object")),i.close(),i.F):am(_c);for(var n=sm.length;n--;)delete mc[ql][sm[n]];return mc()};kb[rm]=!0;var fc=Object.create||function(i,t){var e;return i!==null?(zl[ql]=Pb(i),e=new zl,zl[ql]=null,e[rm]=i):e=mc(),t===void 0?e:Lb.f(e,t)},gc={},xb=em,Vb=Kl.concat("length","prototype");gc.f=Object.getOwnPropertyNames||function(i){return xb(i,Vb)};var cm={},dm=q_,Fb=rr,Bb=jE,jb=Array,Gb=Math.max,lm=function(i,t,e){for(var n=Fb(i),s=dm(t,n),r=dm(e===void 0?n:e,n),o=jb(Gb(r-s,0)),a=0;s<r;s++,a++)Bb(o,a,i[s]);return o.length=a,o},Wb=Es,Hb=ir,um=gc.f,Kb=lm,hm=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];cm.f=function(i){return hm&&Wb(i)=="Window"?function(t){try{return um(t)}catch{return Kb(hm)}}(i):um(Hb(i))};var Tc={};Tc.f=Object.getOwnPropertySymbols;var Yb=gs,qo=function(i,t,e,n){return n&&n.enumerable?i[t]=e:Yb(i,t,e),i},qb=cn,pm=function(i,t,e){return qb.f(i,t,e)},Hr={},Jb=Ie;Hr.f=Jb;var Sc,Jo,Rc,_m=zn,zb=ui,Xb=Hr,Qb=cn.f,ke=function(i){var t=_m.Symbol||(_m.Symbol={});zb(t,i)||Qb(t,i,{value:Xb.f(i)})},Zb=li,$b=Oi,tw=Ie,ew=qo,Em=function(){var i=$b("Symbol"),t=i&&i.prototype,e=t&&t.valueOf,n=tw("toPrimitive");t&&!t[n]&&ew(t,n,function(s){return Zb(e,this)},{arity:1})},iw=or,nw=Nl?{}.toString:function(){return"[object "+iw(this)+"]"},sw=Nl,rw=cn.f,ow=gs,aw=ui,cw=nw,mm=Ie("toStringTag"),Kr=function(i,t,e,n){if(i){var s=e?i:i.prototype;aw(s,mm)||rw(s,mm,{configurable:!0,value:t}),n&&!sw&&ow(s,"toString",cw)}},dw=Ge,fm=$e.WeakMap,lw=dw(fm)&&/native code/.test(String(fm)),gm=$e,uw=on,hw=gs,Xl=ui,Ql=Tl,pw=Ec,_w=pc,Tm="Object already initialized",Zl=gm.TypeError,Ew=gm.WeakMap;if(lw||Ql.state){var Dn=Ql.state||(Ql.state=new Ew);Dn.get=Dn.get,Dn.has=Dn.has,Dn.set=Dn.set,Sc=function(i,t){if(Dn.has(i))throw Zl(Tm);return t.facade=i,Dn.set(i,t),t},Jo=function(i){return Dn.get(i)||{}},Rc=function(i){return Dn.has(i)}}else{var Yr=pw("state");_w[Yr]=!0,Sc=function(i,t){if(Xl(i,Yr))throw Zl(Tm);return t.facade=i,hw(i,Yr,t),t},Jo=function(i){return Xl(i,Yr)?i[Yr]:{}},Rc=function(i){return Xl(i,Yr)}}var Cc={set:Sc,get:Jo,has:Rc,enforce:function(i){return Rc(i)?Jo(i):Sc(i,{})},getterFor:function(i){return function(t){var e;if(!uw(t)||(e=Jo(t)).type!==i)throw Zl("Incompatible receiver, "+i+" required");return e}}},mw=Ko,fw=ul,gw=fs,Tw=rr,Sw=XE,Sm=De([].push),Ss=function(i){var t=i==1,e=i==2,n=i==3,s=i==4,r=i==6,o=i==7,a=i==5||r;return function(c,d,l,u){for(var p,_,S=gw(c),f=fw(S),g=mw(d,l),C=Tw(f),y=0,A=u||Sw,k=t?A(c,C):e||o?A(c,0):void 0;C>y;y++)if((a||y in f)&&(_=g(p=f[y],y,S),i))if(t)k[y]=_;else if(_)switch(i){case 3:return!0;case 5:return p;case 6:return y;case 2:Sm(k,p)}else switch(i){case 4:return!1;case 7:Sm(k,p)}return r?-1:n||s?s:k}},Rw={forEach:Ss(0),map:Ss(1),filter:Ss(2),some:Ss(3),every:Ss(4),find:Ss(5),findIndex:Ss(6),filterReject:Ss(7)},Ic=zt,$l=$e,tu=li,Cw=De,qr=Nn,Jr=xr,Iw=Gt,ti=ui,vw=rn,eu=Sn,vc=ir,iu=nc,yw=Xn,nu=er,zo=fc,Rm=Yl,Aw=gc,Cm=cm,bw=Tc,Im=jo,vm=cn,ww=Wl,ym=dl,Am=qo,Ow=pm,su=Fr,bm=pc,wm=Sl,Nw=Ie,Dw=Hr,Pw=ke,Lw=Em,kw=Kr,Om=Cc,yc=Rw.forEach,Ni=Ec("hidden"),Ac="Symbol",Xo="prototype",Mw=Om.set,Nm=Om.getterFor(Ac),Rn=Object[Xo],cr=$l.Symbol,bc=cr&&cr[Xo],Uw=$l.TypeError,ru=$l.QObject,Dm=Im.f,dr=vm.f,Pm=Cm.f,xw=ym.f,Lm=Cw([].push),Qn=su("symbols"),Qo=su("op-symbols"),Vw=su("wks"),ou=!ru||!ru[Xo]||!ru[Xo].findChild,au=qr&&Iw(function(){return zo(dr({},"a",{get:function(){return dr(this,"a",{value:7}).a}})).a!=7})?function(i,t,e){var n=Dm(Rn,t);n&&delete Rn[t],dr(i,t,e),n&&i!==Rn&&dr(Rn,t,n)}:dr,cu=function(i,t){var e=Qn[i]=zo(bc);return Mw(e,{type:Ac,tag:i,description:t}),qr||(e.description=t),e},wc=function(i,t,e){i===Rn&&wc(Qo,t,e),eu(i);var n=iu(t);return eu(e),ti(Qn,n)?(e.enumerable?(ti(i,Ni)&&i[Ni][n]&&(i[Ni][n]=!1),e=zo(e,{enumerable:nu(0,!1)})):(ti(i,Ni)||dr(i,Ni,nu(1,{})),i[Ni][n]=!0),au(i,n,e)):dr(i,n,e)},du=function(i,t){eu(i);var e=vc(t),n=Rm(e).concat(xm(e));return yc(n,function(s){qr&&!tu(km,e,s)||wc(i,s,e[s])}),i},km=function(i){var t=iu(i),e=tu(xw,this,t);return!(this===Rn&&ti(Qn,t)&&!ti(Qo,t))&&(!(e||!ti(this,t)||!ti(Qn,t)||ti(this,Ni)&&this[Ni][t])||e)},Mm=function(i,t){var e=vc(i),n=iu(t);if(e!==Rn||!ti(Qn,n)||ti(Qo,n)){var s=Dm(e,n);return!s||!ti(Qn,n)||ti(e,Ni)&&e[Ni][n]||(s.enumerable=!0),s}},Um=function(i){var t=Pm(vc(i)),e=[];return yc(t,function(n){ti(Qn,n)||ti(bm,n)||Lm(e,n)}),e},xm=function(i){var t=i===Rn,e=Pm(t?Qo:vc(i)),n=[];return yc(e,function(s){!ti(Qn,s)||t&&!ti(Rn,s)||Lm(n,Qn[s])}),n};Jr||(cr=function(){if(vw(bc,this))throw Uw("Symbol is not a constructor");var i=arguments.length&&arguments[0]!==void 0?yw(arguments[0]):void 0,t=wm(i),e=function(n){this===Rn&&tu(e,Qo,n),ti(this,Ni)&&ti(this[Ni],t)&&(this[Ni][t]=!1),au(this,t,nu(1,n))};return qr&&ou&&au(Rn,t,{configurable:!0,set:e}),cu(t,i)},Am(bc=cr[Xo],"toString",function(){return Nm(this).tag}),Am(cr,"withoutSetter",function(i){return cu(wm(i),i)}),ym.f=km,vm.f=wc,ww.f=du,Im.f=Mm,Aw.f=Cm.f=Um,bw.f=xm,Dw.f=function(i){return cu(Nw(i),i)},qr&&Ow(bc,"description",{configurable:!0,get:function(){return Nm(this).description}})),Ic({global:!0,constructor:!0,wrap:!0,forced:!Jr,sham:!Jr},{Symbol:cr}),yc(Rm(Vw),function(i){Pw(i)}),Ic({target:Ac,stat:!0,forced:!Jr},{useSetter:function(){ou=!0},useSimple:function(){ou=!1}}),Ic({target:"Object",stat:!0,forced:!Jr,sham:!qr},{create:function(i,t){return t===void 0?zo(i):du(zo(i),t)},defineProperty:wc,defineProperties:du,getOwnPropertyDescriptor:Mm}),Ic({target:"Object",stat:!0,forced:!Jr},{getOwnPropertyNames:Um}),Lw(),kw(cr,Ac),bm[Ni]=!0;var Vm=xr&&!!Symbol.for&&!!Symbol.keyFor,Fw=zt,Bw=Oi,jw=ui,Gw=Xn,Fm=Fr,Ww=Vm,lu=Fm("string-to-symbol-registry"),Hw=Fm("symbol-to-string-registry");Fw({target:"Symbol",stat:!0,forced:!Ww},{for:function(i){var t=Gw(i);if(jw(lu,t))return lu[t];var e=Bw("Symbol")(t);return lu[t]=e,Hw[e]=t,e}});var Kw=zt,Yw=ui,qw=Wo,Jw=Vr,zw=Vm,Bm=Fr("symbol-to-string-registry");Kw({target:"Symbol",stat:!0,forced:!zw},{keyFor:function(i){if(!qw(i))throw TypeError(Jw(i)+" is not a symbol");if(Yw(Bm,i))return Bm[i]}});var jm=De([].slice),Gm=Bl,Xw=Ge,Wm=Es,Qw=Xn,Hm=De([].push),Zw=zt,Km=Oi,Ym=al,$w=li,Zo=De,qm=Gt,Jm=Ge,zm=Wo,Xm=jm,tO=function(i){if(Xw(i))return i;if(Gm(i)){for(var t=i.length,e=[],n=0;n<t;n++){var s=i[n];typeof s=="string"?Hm(e,s):typeof s!="number"&&Wm(s)!="Number"&&Wm(s)!="String"||Hm(e,Qw(s))}var r=e.length,o=!0;return function(a,c){if(o)return o=!1,c;if(Gm(this))return c;for(var d=0;d<r;d++)if(e[d]===a)return c}}},eO=xr,iO=String,Rs=Km("JSON","stringify"),Oc=Zo(/./.exec),Qm=Zo("".charAt),nO=Zo("".charCodeAt),sO=Zo("".replace),rO=Zo(1 .toString),oO=/[\uD800-\uDFFF]/g,Zm=/^[\uD800-\uDBFF]$/,$m=/^[\uDC00-\uDFFF]$/,tf=!eO||qm(function(){var i=Km("Symbol")();return Rs([i])!="[null]"||Rs({a:i})!="{}"||Rs(Object(i))!="{}"}),ef=qm(function(){return Rs("\uDF06\uD834")!=='"\\udf06\\ud834"'||Rs("\uDEAD")!=='"\\udead"'}),aO=function(i,t){var e=Xm(arguments),n=tO(t);if(Jm(n)||i!==void 0&&!zm(i))return e[1]=function(s,r){if(Jm(n)&&(r=$w(n,this,iO(s),r)),!zm(r))return r},Ym(Rs,null,e)},cO=function(i,t,e){var n=Qm(e,t-1),s=Qm(e,t+1);return Oc(Zm,i)&&!Oc($m,s)||Oc($m,i)&&!Oc(Zm,n)?"\\u"+rO(nO(i,0),16):i};Rs&&Zw({target:"JSON",stat:!0,arity:3,forced:tf||ef},{stringify:function(i,t,e){var n=Xm(arguments),s=Ym(tf?aO:Rs,null,n);return ef&&typeof s=="string"?sO(s,oO,cO):s}});var nf=Tc,dO=fs;zt({target:"Object",stat:!0,forced:!xr||Gt(function(){nf.f(1)})},{getOwnPropertySymbols:function(i){var t=nf.f;return t?t(dO(i)):[]}}),ke("asyncIterator"),ke("hasInstance"),ke("isConcatSpreadable"),ke("iterator"),ke("match"),ke("matchAll"),ke("replace"),ke("search"),ke("species"),ke("split");var lO=Em;ke("toPrimitive"),lO();var uO=Oi,hO=Kr;ke("toStringTag"),hO(uO("Symbol"),"Symbol"),ke("unscopables"),Kr($e.JSON,"JSON",!0);var lr,sf,rf,pO=zn.Symbol,zr={},uu=Nn,_O=ui,of=Function.prototype,EO=uu&&Object.getOwnPropertyDescriptor,hu=_O(of,"name"),af={EXISTS:hu,PROPER:hu&&(function(){}).name==="something",CONFIGURABLE:hu&&(!uu||uu&&EO(of,"name").configurable)},mO=!Gt(function(){function i(){}return i.prototype.constructor=null,Object.getPrototypeOf(new i)!==i.prototype}),fO=ui,gO=Ge,TO=fs,SO=mO,cf=Ec("IE_PROTO"),pu=Object,RO=pu.prototype,_u=SO?pu.getPrototypeOf:function(i){var t=TO(i);if(fO(t,cf))return t[cf];var e=t.constructor;return gO(e)&&t instanceof e?e.prototype:t instanceof pu?RO:null},CO=Gt,IO=Ge,vO=on,yO=fc,df=_u,AO=qo,Eu=Ie("iterator"),lf=!1;[].keys&&("next"in(rf=[].keys())?(sf=df(df(rf)))!==Object.prototype&&(lr=sf):lf=!0);var bO=!vO(lr)||CO(function(){var i={};return lr[Eu].call(i)!==i});IO((lr=bO?{}:yO(lr))[Eu])||AO(lr,Eu,function(){return this});var uf={IteratorPrototype:lr,BUGGY_SAFARI_ITERATORS:lf},wO=uf.IteratorPrototype,OO=fc,NO=er,DO=Kr,PO=zr,LO=function(){return this},kO=De,MO=an,UO=Ge,xO=String,VO=TypeError,FO=function(i,t,e){try{return kO(MO(Object.getOwnPropertyDescriptor(i,t)[e]))}catch{}},BO=Sn,jO=function(i){if(typeof i=="object"||UO(i))return i;throw VO("Can't set "+xO(i)+" as a prototype")},GO=Object.setPrototypeOf||("__proto__"in{}?function(){var i,t=!1,e={};try{(i=FO(Object.prototype,"__proto__","set"))(e,[]),t=e instanceof Array}catch{}return function(n,s){return BO(n),jO(s),t?i(n,s):n.__proto__=s,n}}():void 0),WO=zt,HO=li,KO=af,YO=function(i,t,e,n){var s=t+" Iterator";return i.prototype=OO(wO,{next:NO(+!n,e)}),DO(i,s,!1,!0),PO[s]=LO,i},qO=_u,JO=Kr,hf=qo,pf=zr,zO=uf,XO=KO.PROPER,Nc=zO.BUGGY_SAFARI_ITERATORS,mu=Ie("iterator"),_f="keys",Dc="values",Ef="entries",QO=function(){return this},mf=function(i,t,e,n,s,r,o){YO(e,t,n);var a,c,d,l=function(C){if(C===s&&f)return f;if(!Nc&&C in _)return _[C];switch(C){case _f:case Dc:case Ef:return function(){return new e(this,C)}}return function(){return new e(this)}},u=t+" Iterator",p=!1,_=i.prototype,S=_[mu]||_["@@iterator"]||s&&_[s],f=!Nc&&S||l(s),g=t=="Array"&&_.entries||S;if(g&&(a=qO(g.call(new i)))!==Object.prototype&&a.next&&(JO(a,u,!0,!0),pf[u]=QO),XO&&s==Dc&&S&&S.name!==Dc&&(p=!0,f=function(){return HO(S,this)}),s)if(c={values:l(Dc),keys:r?f:l(_f),entries:l(Ef)},o)for(d in c)(Nc||p||!(d in _))&&hf(_,d,c[d]);else WO({target:t,proto:!0,forced:Nc||p},c);return o&&_[mu]!==f&&hf(_,mu,f,{name:s}),pf[t]=f,c},ff=function(i,t){return{value:i,done:t}},ZO=ir,gf=zr,Tf=Cc;cn.f;var $O=mf,Sf=ff,Rf="Array Iterator",tN=Tf.set,eN=Tf.getterFor(Rf);$O(Array,"Array",function(i,t){tN(this,{type:Rf,target:ZO(i),index:0,kind:t})},function(){var i=eN(this),t=i.target,e=i.kind,n=i.index++;return!t||n>=t.length?(i.target=void 0,Sf(void 0,!0)):Sf(e=="keys"?n:e=="values"?t[n]:[n,t[n]],!1)},"values"),gf.Arguments=gf.Array;var iN={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},nN=$e,sN=or,rN=gs,Cf=zr,If=Ie("toStringTag");for(var fu in iN){var vf=nN[fu],gu=vf&&vf.prototype;gu&&sN(gu)!==If&&rN(gu,If,fu),Cf[fu]=Cf.Array}var oN=pO,aN=Ie,cN=cn.f,yf=aN("metadata"),Af=Function.prototype;Af[yf]===void 0&&cN(Af,yf,{value:null}),ke("dispose"),ke("metadata");var dN=oN;ke("asyncDispose");var lN=De,Tu=Oi("Symbol"),uN=Tu.keyFor,hN=lN(Tu.prototype.valueOf),bf=Tu.isRegisteredSymbol||function(i){try{return uN(hN(i))!==void 0}catch{return!1}};zt({target:"Symbol",stat:!0},{isRegisteredSymbol:bf});for(var pN=Fr,wf=Oi,_N=De,EN=Wo,mN=Ie,Pc=wf("Symbol"),Of=Pc.isWellKnownSymbol,Nf=wf("Object","getOwnPropertyNames"),fN=_N(Pc.prototype.valueOf),Df=pN("wks"),Su=0,Pf=Nf(Pc),gN=Pf.length;Su<gN;Su++)try{var Lf=Pf[Su];EN(Pc[Lf])&&mN(Lf)}catch{}var kf=function(i){if(Of&&Of(i))return!0;try{for(var t=fN(i),e=0,n=Nf(Df),s=n.length;e<s;e++)if(Df[n[e]]==t)return!0}catch{}return!1};zt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:kf}),ke("matcher"),ke("observable"),zt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:bf}),zt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:kf}),ke("metadataKey"),ke("patternMatch"),ke("replaceAll");var Xr=xt(dN),Ru=De,TN=wl,SN=Xn,RN=Go,CN=Ru("".charAt),Mf=Ru("".charCodeAt),IN=Ru("".slice),Uf=function(i){return function(t,e){var n,s,r=SN(RN(t)),o=TN(e),a=r.length;return o<0||o>=a?i?"":void 0:(n=Mf(r,o))<55296||n>56319||o+1===a||(s=Mf(r,o+1))<56320||s>57343?i?CN(r,o):n:i?IN(r,o,o+2):s-56320+(n-55296<<10)+65536}},vN={codeAt:Uf(!1),charAt:Uf(!0)}.charAt,yN=Xn,xf=Cc,AN=mf,Vf=ff,Ff="String Iterator",bN=xf.set,wN=xf.getterFor(Ff);AN(String,"String",function(i){bN(this,{type:Ff,string:yN(i),index:0})},function(){var i,t=wN(this),e=t.string,n=t.index;return n>=e.length?Vf(void 0,!0):(i=vN(e,n),t.index+=i.length,Vf(i,!1))});var Bf=xt(Hr.f("iterator"));function $o(i){return $o=typeof Xr=="function"&&typeof Bf=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Xr=="function"&&t.constructor===Xr&&t!==Xr.prototype?"symbol":typeof t},$o(i)}var ON=xt(Hr.f("toPrimitive"));function NN(i){var t=function(e,n){if($o(e)!=="object"||e===null)return e;var s=e[ON];if(s!==void 0){var r=s.call(e,n||"default");if($o(r)!=="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(e)}(i,"string");return $o(t)==="symbol"?t:String(t)}function h(i,t,e){return(t=NN(t))in i?jA(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}var DN=Ts("Array").keys,PN=or,LN=ui,kN=rn,MN=DN,Cu=Array.prototype,UN={DOMTokenList:!0,NodeList:!0},Di=xt(function(i){var t=i.keys;return i===Cu||kN(Cu,i)&&t===Cu.keys||LN(UN,PN(i))?MN:t}),jf=Vr,xN=TypeError,Gf=lm,VN=Math.floor,Iu=function(i,t){var e=i.length,n=VN(e/2);return e<8?FN(i,t):BN(i,Iu(Gf(i,0,n),t),Iu(Gf(i,n),t),t)},FN=function(i,t){for(var e,n,s=i.length,r=1;r<s;){for(n=r,e=i[r];n&&t(i[n-1],e)>0;)i[n]=i[--n];n!==r++&&(i[n]=e)}return i},BN=function(i,t,e,n){for(var s=t.length,r=e.length,o=0,a=0;o<s||a<r;)i[o+a]=o<s&&a<r?n(t[o],e[a])<=0?t[o++]:e[a++]:o<s?t[o++]:e[a++];return i},jN=Iu,GN=Gt,vu=function(i,t){var e=[][i];return!!e&&GN(function(){e.call(null,t||function(){return 1},1)})},Wf=nr.match(/firefox\/(\d+)/i),WN=!!Wf&&+Wf[1],HN=/MSIE|Trident/.test(nr),Hf=nr.match(/AppleWebKit\/(\d+)\./),KN=!!Hf&&+Hf[1],YN=zt,Kf=De,qN=an,JN=fs,Yf=rr,zN=function(i,t){if(!delete i[t])throw xN("Cannot delete property "+jf(t)+" of "+jf(i))},qf=Xn,yu=Gt,XN=jN,QN=vu,Jf=WN,ZN=HN,zf=sr,Xf=KN,Cs=[],Qf=Kf(Cs.sort),$N=Kf(Cs.push),t0=yu(function(){Cs.sort(void 0)}),e0=yu(function(){Cs.sort(null)}),i0=QN("sort"),Zf=!yu(function(){if(zf)return zf<70;if(!(Jf&&Jf>3)){if(ZN)return!0;if(Xf)return Xf<603;var i,t,e,n,s="";for(i=65;i<76;i++){switch(t=String.fromCharCode(i),i){case 66:case 69:case 70:case 72:e=3;break;case 68:case 71:e=4;break;default:e=2}for(n=0;n<47;n++)Cs.push({k:t+n,v:e})}for(Cs.sort(function(r,o){return o.v-r.v}),n=0;n<Cs.length;n++)t=Cs[n].k.charAt(0),s.charAt(s.length-1)!==t&&(s+=t);return s!=="DGBEFHACIJK"}});YN({target:"Array",proto:!0,forced:t0||!e0||!i0||!Zf},{sort:function(i){i!==void 0&&qN(i);var t=JN(this);if(Zf)return i===void 0?Qf(t):Qf(t,i);var e,n,s=[],r=Yf(t);for(n=0;n<r;n++)n in t&&$N(s,t[n]);for(XN(s,function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:qf(a)>qf(c)?1:-1}}(i)),e=Yf(s),n=0;n<e;)t[n]=s[n++];for(;n<r;)zN(t,n++);return t}});var n0=Ts("Array").sort,s0=rn,r0=n0,Au=Array.prototype,ta=xt(function(i){var t=i.sort;return i===Au||s0(Au,i)&&t===Au.sort?r0:t}),o0=Oi,a0=gc,c0=Tc,d0=Sn,l0=De([].concat),u0=o0("Reflect","ownKeys")||function(i){var t=a0.f(d0(i)),e=c0.f;return e?l0(t,e(i)):t},$f=ui,h0=u0,p0=jo,_0=cn,E0=on,m0=gs,tg=Error,f0=De("".replace),g0=String(tg("zxcasd").stack),eg=/\n\s*at [^:]*:[^\n]*/,T0=eg.test(g0),S0=er,R0=!Gt(function(){var i=Error("a");return!("stack"in i)||(Object.defineProperty(i,"stack",S0(1,7)),i.stack!==7)}),C0=gs,I0=function(i,t){if(T0&&typeof i=="string"&&!tg.prepareStackTrace)for(;t--;)i=f0(i,eg,"");return i},v0=R0,ig=Error.captureStackTrace,y0=zr,A0=Ie("iterator"),b0=Array.prototype,w0=or,ng=El,O0=ic,N0=zr,D0=Ie("iterator"),sg=function(i){if(!O0(i))return ng(i,D0)||ng(i,"@@iterator")||N0[w0(i)]},P0=li,L0=an,k0=Sn,M0=Vr,U0=sg,x0=TypeError,V0=li,rg=Sn,F0=El,B0=Ko,j0=li,G0=Sn,W0=Vr,H0=function(i){return i!==void 0&&(y0.Array===i||b0[A0]===i)},K0=rr,og=rn,Y0=function(i,t){var e=arguments.length<2?U0(i):t;if(L0(e))return k0(P0(e,i));throw x0(M0(i)+" is not iterable")},q0=sg,ag=function(i,t,e){var n,s;rg(i);try{if(!(n=F0(i,"return"))){if(t==="throw")throw e;return e}n=V0(n,i)}catch(r){s=!0,n=r}if(t==="throw")throw e;if(s)throw n;return rg(n),e},J0=TypeError,Lc=function(i,t){this.stopped=i,this.result=t},cg=Lc.prototype,ea=function(i,t,e){var n,s,r,o,a,c,d,l=e&&e.that,u=!(!e||!e.AS_ENTRIES),p=!(!e||!e.IS_RECORD),_=!(!e||!e.IS_ITERATOR),S=!(!e||!e.INTERRUPTED),f=B0(t,l),g=function(y){return n&&ag(n,"normal",y),new Lc(!0,y)},C=function(y){return u?(G0(y),S?f(y[0],y[1],g):f(y[0],y[1])):S?f(y,g):f(y)};if(p)n=i.iterator;else if(_)n=i;else{if(!(s=q0(i)))throw J0(W0(i)+" is not iterable");if(H0(s)){for(r=0,o=K0(i);o>r;r++)if((a=C(i[r]))&&og(cg,a))return a;return new Lc(!1)}n=Y0(i,s)}for(c=p?i.next:n.next;!(d=j0(c,n)).done;){try{a=C(d.value)}catch(y){ag(n,"throw",y)}if(typeof a=="object"&&a&&og(cg,a))return a}return new Lc(!1)},z0=Xn,X0=zt,Q0=rn,Z0=_u,kc=GO,$0=function(i,t,e){for(var n=h0(t),s=_0.f,r=p0.f,o=0;o<n.length;o++){var a=n[o];$f(i,a)||e&&$f(e,a)||s(i,a,r(t,a))}},dg=fc,bu=gs,wu=er,tD=function(i,t){E0(t)&&"cause"in t&&m0(i,"cause",t.cause)},eD=function(i,t,e,n){v0&&(ig?ig(i,t):C0(i,"stack",I0(e,n)))},iD=ea,nD=function(i,t){return i===void 0?arguments.length<2?"":t:z0(i)},sD=Ie("toStringTag"),Mc=Error,rD=[].push,Qr=function(i,t){var e,n=Q0(Ou,this);kc?e=kc(Mc(),n?Z0(this):Ou):(e=n?this:dg(Ou),bu(e,sD,"Error")),t!==void 0&&bu(e,"message",nD(t)),eD(e,Qr,e.stack,1),arguments.length>2&&tD(e,arguments[2]);var s=[];return iD(i,rD,{that:s}),bu(e,"errors",s),e};kc?kc(Qr,Mc):$0(Qr,Mc,{name:!0});var Ou=Qr.prototype=dg(Mc.prototype,{constructor:wu(1,Qr),message:wu(1,""),name:wu(1,"AggregateError")});X0({global:!0,constructor:!0,arity:2},{AggregateError:Qr});var ia,Zr,lg,Nu,na=typeof process<"u"&&Es(process)=="process",oD=Oi,aD=pm,cD=Nn,ug=Ie("species"),dD=rn,lD=TypeError,uD=qE,hD=Vr,pD=TypeError,hg=Sn,_D=function(i){if(uD(i))return i;throw pD(hD(i)+" is not a constructor")},ED=ic,mD=Ie("species"),pg=function(i,t){var e,n=hg(i).constructor;return n===void 0||ED(e=hg(n)[mD])?t:_D(e)},fD=TypeError,_g=/(?:ipad|iphone|ipod).*applewebkit/i.test(nr),Yi=$e,gD=al,TD=Ko,Eg=Ge,SD=ui,mg=Gt,fg=im,RD=jm,gg=Il,CD=function(i,t){if(i<t)throw fD("Not enough arguments");return i},ID=_g,vD=na,Du=Yi.setImmediate,Pu=Yi.clearImmediate,yD=Yi.process,Lu=Yi.Dispatch,AD=Yi.Function,Tg=Yi.MessageChannel,bD=Yi.String,ku=0,sa={},Sg="onreadystatechange";mg(function(){ia=Yi.location});var Mu=function(i){if(SD(sa,i)){var t=sa[i];delete sa[i],t()}},Uu=function(i){return function(){Mu(i)}},Rg=function(i){Mu(i.data)},Cg=function(i){Yi.postMessage(bD(i),ia.protocol+"//"+ia.host)};Du&&Pu||(Du=function(i){CD(arguments.length,1);var t=Eg(i)?i:AD(i),e=RD(arguments,1);return sa[++ku]=function(){gD(t,void 0,e)},Zr(ku),ku},Pu=function(i){delete sa[i]},vD?Zr=function(i){yD.nextTick(Uu(i))}:Lu&&Lu.now?Zr=function(i){Lu.now(Uu(i))}:Tg&&!ID?(Nu=(lg=new Tg).port2,lg.port1.onmessage=Rg,Zr=TD(Nu.postMessage,Nu)):Yi.addEventListener&&Eg(Yi.postMessage)&&!Yi.importScripts&&ia&&ia.protocol!=="file:"&&!mg(Cg)?(Zr=Cg,Yi.addEventListener("message",Rg,!1)):Zr=Sg in gg("script")?function(i){fg.appendChild(gg("script"))[Sg]=function(){fg.removeChild(this),Mu(i)}}:function(i){setTimeout(Uu(i),0)});var Ig={set:Du,clear:Pu},vg=function(){this.head=null,this.tail=null};vg.prototype={add:function(i){var t={item:i,next:null},e=this.tail;e?e.next=t:this.head=t,this.tail=t},get:function(){var i=this.head;if(i)return(this.head=i.next)===null&&(this.tail=null),i.item}};var $r,xu,Vu,Fu,yg,Ag=vg,wD=/ipad|iphone|ipod/i.test(nr)&&typeof Pebble<"u",OD=/web0s(?!.*chrome)/i.test(nr),ur=$e,bg=Ko,ND=jo.f,Bu=Ig.set,DD=Ag,PD=_g,LD=wD,kD=OD,ju=na,wg=ur.MutationObserver||ur.WebKitMutationObserver,Og=ur.document,Ng=ur.process,Uc=ur.Promise,Dg=ND(ur,"queueMicrotask"),Gu=Dg&&Dg.value;if(!Gu){var xc=new DD,Vc=function(){var i,t;for(ju&&(i=Ng.domain)&&i.exit();t=xc.get();)try{t()}catch(e){throw xc.head&&$r(),e}i&&i.enter()};PD||ju||kD||!wg||!Og?!LD&&Uc&&Uc.resolve?((Fu=Uc.resolve(void 0)).constructor=Uc,yg=bg(Fu.then,Fu),$r=function(){yg(Vc)}):ju?$r=function(){Ng.nextTick(Vc)}:(Bu=bg(Bu,ur),$r=function(){Bu(Vc)}):(xu=!0,Vu=Og.createTextNode(""),new wg(Vc).observe(Vu,{characterData:!0}),$r=function(){Vu.data=xu=!xu}),Gu=function(i){xc.head||$r(),xc.add(i)}}var MD=Gu,to=function(i){try{return{error:!1,value:i()}}catch(t){return{error:!0,value:t}}},hr=$e.Promise,Pg=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",UD=!Pg&&!na&&typeof window=="object"&&typeof document=="object",xD=$e,ra=hr,VD=Ge,FD=W_,BD=GE,jD=Ie,GD=UD,WD=Pg,Wu=sr,Lg=ra&&ra.prototype,HD=jD("species"),kg=!1,Mg=VD(xD.PromiseRejectionEvent),KD=FD("Promise",function(){var i=BD(ra),t=i!==String(ra);if(!t&&Wu===66||!Lg.catch||!Lg.finally)return!0;if(!Wu||Wu<51||!/native code/.test(i)){var e=new ra(function(s){s(1)}),n=function(s){s(function(){},function(){})};if((e.constructor={})[HD]=n,!(kg=e.then(function(){})instanceof n))return!0}return!t&&(GD||WD)&&!Mg}),oa={CONSTRUCTOR:KD,REJECTION_EVENT:Mg,SUBCLASSING:kg},Pn={},Ug=an,YD=TypeError,qD=function(i){var t,e;this.promise=new i(function(n,s){if(t!==void 0||e!==void 0)throw YD("Bad Promise constructor");t=n,e=s}),this.resolve=Ug(t),this.reject=Ug(e)};Pn.f=function(i){return new qD(i)};var Hu,xg,JD=zt,Fc=na,Is=$e,aa=li,zD=qo,XD=Kr,QD=function(i){var t=oD(i);cD&&t&&!t[ug]&&aD(t,ug,{configurable:!0,get:function(){return this}})},ZD=an,Ku=Ge,$D=on,tP=function(i,t){if(dD(t,i))return i;throw lD("Incorrect invocation")},eP=pg,Vg=Ig.set,Yu=MD,iP=function(i,t){try{arguments.length==1?console.error(i):console.error(i,t)}catch{}},nP=to,sP=Ag,Fg=Cc,qu=hr,Bg=oa,jg=Pn,Bc="Promise",Gg=Bg.CONSTRUCTOR,rP=Bg.REJECTION_EVENT,Ju=Fg.getterFor(Bc),oP=Fg.set,aP=qu&&qu.prototype,ca=qu,zu=aP,Wg=Is.TypeError,Xu=Is.document,Qu=Is.process,Zu=jg.f,cP=Zu,dP=!!(Xu&&Xu.createEvent&&Is.dispatchEvent),Hg="unhandledrejection",Kg=function(i){var t;return!(!$D(i)||!Ku(t=i.then))&&t},Yg=function(i,t){var e,n,s,r=t.value,o=t.state==1,a=o?i.ok:i.fail,c=i.resolve,d=i.reject,l=i.domain;try{a?(o||(t.rejection===2&&uP(t),t.rejection=1),a===!0?e=r:(l&&l.enter(),e=a(r),l&&(l.exit(),s=!0)),e===i.promise?d(Wg("Promise-chain cycle")):(n=Kg(e))?aa(n,e,c,d):c(e)):d(r)}catch(u){l&&!s&&l.exit(),d(u)}},qg=function(i,t){i.notified||(i.notified=!0,Yu(function(){for(var e,n=i.reactions;e=n.get();)Yg(e,i);i.notified=!1,t&&!i.rejection&&lP(i)}))},Jg=function(i,t,e){var n,s;dP?((n=Xu.createEvent("Event")).promise=t,n.reason=e,n.initEvent(i,!1,!0),Is.dispatchEvent(n)):n={promise:t,reason:e},!rP&&(s=Is["on"+i])?s(n):i===Hg&&iP("Unhandled promise rejection",e)},lP=function(i){aa(Vg,Is,function(){var t,e=i.facade,n=i.value;if(zg(i)&&(t=nP(function(){Fc?Qu.emit("unhandledRejection",n,e):Jg(Hg,e,n)}),i.rejection=Fc||zg(i)?2:1,t.error))throw t.value})},zg=function(i){return i.rejection!==1&&!i.parent},uP=function(i){aa(Vg,Is,function(){var t=i.facade;Fc?Qu.emit("rejectionHandled",t):Jg("rejectionhandled",t,i.value)})},eo=function(i,t,e){return function(n){i(t,n,e)}},io=function(i,t,e){i.done||(i.done=!0,e&&(i=e),i.value=t,i.state=2,qg(i,!0))},$u=function(i,t,e){if(!i.done){i.done=!0,e&&(i=e);try{if(i.facade===t)throw Wg("Promise can't be resolved itself");var n=Kg(t);n?Yu(function(){var s={done:!1};try{aa(n,t,eo($u,s,i),eo(io,s,i))}catch(r){io(s,r,i)}}):(i.value=t,i.state=1,qg(i,!1))}catch(s){io({done:!1},s,i)}}};Gg&&(zu=(ca=function(i){tP(this,zu),ZD(i),aa(Hu,this);var t=Ju(this);try{i(eo($u,t),eo(io,t))}catch(e){io(t,e)}}).prototype,(Hu=function(i){oP(this,{type:Bc,done:!1,notified:!1,parent:!1,reactions:new sP,rejection:!1,state:0,value:void 0})}).prototype=zD(zu,"then",function(i,t){var e=Ju(this),n=Zu(eP(this,ca));return e.parent=!0,n.ok=!Ku(i)||i,n.fail=Ku(t)&&t,n.domain=Fc?Qu.domain:void 0,e.state==0?e.reactions.add(n):Yu(function(){Yg(n,e)}),n.promise}),xg=function(){var i=new Hu,t=Ju(i);this.promise=i,this.resolve=eo($u,t),this.reject=eo(io,t)},jg.f=Zu=function(i){return i===ca||i===void 0?new xg(i):cP(i)}),JD({global:!0,constructor:!0,wrap:!0,forced:Gg},{Promise:ca}),XD(ca,Bc,!1,!0),QD(Bc);var Xg=Ie("iterator"),Qg=!1;try{var hP=0,Zg={next:function(){return{done:!!hP++}},return:function(){Qg=!0}};Zg[Xg]=function(){return this},Array.from(Zg,function(){throw 2})}catch{}var pP=hr,_P=function(i,t){if(!t&&!Qg)return!1;var e=!1;try{var n={};n[Xg]=function(){return{next:function(){return{done:e=!0}}}},i(n)}catch{}return e},jc=oa.CONSTRUCTOR||!_P(function(i){pP.all(i).then(void 0,function(){})}),EP=li,mP=an,fP=Pn,gP=to,TP=ea;zt({target:"Promise",stat:!0,forced:jc},{all:function(i){var t=this,e=fP.f(t),n=e.resolve,s=e.reject,r=gP(function(){var o=mP(t.resolve),a=[],c=0,d=1;TP(i,function(l){var u=c++,p=!1;d++,EP(o,t,l).then(function(_){p||(p=!0,a[u]=_,--d||n(a))},s)}),--d||n(a)});return r.error&&s(r.value),e.promise}});var SP=zt,RP=oa.CONSTRUCTOR;hr&&hr.prototype,SP({target:"Promise",proto:!0,forced:RP,real:!0},{catch:function(i){return this.then(void 0,i)}});var CP=li,IP=an,vP=Pn,yP=to,AP=ea;zt({target:"Promise",stat:!0,forced:jc},{race:function(i){var t=this,e=vP.f(t),n=e.reject,s=yP(function(){var r=IP(t.resolve);AP(i,function(o){CP(r,t,o).then(e.resolve,n)})});return s.error&&n(s.value),e.promise}});var bP=li,wP=Pn;zt({target:"Promise",stat:!0,forced:oa.CONSTRUCTOR},{reject:function(i){var t=wP.f(this);return bP(t.reject,void 0,i),t.promise}});var OP=Sn,NP=on,DP=Pn,$g=function(i,t){if(OP(i),NP(t)&&t.constructor===i)return t;var e=DP.f(i);return(0,e.resolve)(t),e.promise},PP=zt,LP=hr,kP=oa.CONSTRUCTOR,MP=$g,UP=Oi("Promise"),xP=!kP;PP({target:"Promise",stat:!0,forced:!0},{resolve:function(i){return MP(xP&&this===UP?LP:this,i)}});var VP=li,FP=an,BP=Pn,jP=to,GP=ea;zt({target:"Promise",stat:!0,forced:jc},{allSettled:function(i){var t=this,e=BP.f(t),n=e.resolve,s=e.reject,r=jP(function(){var o=FP(t.resolve),a=[],c=0,d=1;GP(i,function(l){var u=c++,p=!1;d++,VP(o,t,l).then(function(_){p||(p=!0,a[u]={status:"fulfilled",value:_},--d||n(a))},function(_){p||(p=!0,a[u]={status:"rejected",reason:_},--d||n(a))})}),--d||n(a)});return r.error&&s(r.value),e.promise}});var WP=li,HP=an,KP=Oi,YP=Pn,qP=to,JP=ea,tT="No one promise resolved";zt({target:"Promise",stat:!0,forced:jc},{any:function(i){var t=this,e=KP("AggregateError"),n=YP.f(t),s=n.resolve,r=n.reject,o=qP(function(){var a=HP(t.resolve),c=[],d=0,l=1,u=!1;JP(i,function(p){var _=d++,S=!1;l++,WP(a,t,p).then(function(f){S||u||(u=!0,s(f))},function(f){S||u||(S=!0,c[_]=f,--l||r(new e(c,tT)))})}),--l||r(new e(c,tT))});return o.error&&r(o.value),n.promise}});var zP=zt,th=hr,XP=Gt,QP=Oi,ZP=Ge,$P=pg,eT=$g,tL=th&&th.prototype;zP({target:"Promise",proto:!0,real:!0,forced:!!th&&XP(function(){tL.finally.call({then:function(){}},function(){})})},{finally:function(i){var t=$P(this,QP("Promise")),e=ZP(i);return this.then(e?function(n){return eT(t,i()).then(function(){return n})}:i,e?function(n){return eT(t,i()).then(function(){throw n})}:i)}});var iT=zn.Promise,P=xt(iT);const eL=()=>{};function da(){const i={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:eL};return i.promise=new P((t,e)=>{i.resolve=n=>{i.isFinished||(i.isResolved=!0,i.isFinished=!0,t(n),i.value=n)},i.reject=n=>{i.isFinished||(i.isRejected=!0,i.isFinished=!0,e(n))}}),i}const Gc=new Map,Wc=new Map,Ln=new Map;var _e,Rt;(function(i){i.WIN_10="Windows 10",i.WIN_81="Windows 8.1",i.WIN_8="Windows 8",i.WIN_7="Windows 7",i.WIN_VISTA="Windows Vista",i.WIN_SERVER_2003="Windows Server 2003",i.WIN_XP="Windows XP",i.WIN_2000="Windows 2000",i.ANDROID="Android",i.HARMONY_OS="HarmonyOS",i.OPEN_BSD="Open BSD",i.SUN_OS="Sun OS",i.LINUX="Linux",i.IOS="iOS",i.MAC_OS="Mac OS",i.CHROMIUM_OS="Chromium OS",i.QNX="QNX",i.UNIX="UNIX",i.BEOS="BeOS",i.OS_2="OS/2",i.SEARCH_BOT="Search Bot"})(_e||(_e={})),function(i){i.CHROME="Chrome",i.SAFARI="Safari",i.EDGE="Edge",i.FIREFOX="Firefox",i.OPERA="OPR",i.QQ="QQBrowser",i.WECHAT="MicroMessenger"}(Rt||(Rt={}));var eh={exports:{}};(function(i,t){(function(e,n){var s="function",r="undefined",o="object",a="string",c="major",d="model",l="name",u="type",p="vendor",_="version",S="architecture",f="console",g="mobile",C="tablet",y="smarttv",A="wearable",k="embedded",O="Amazon",N="Apple",L="ASUS",D="BlackBerry",F="Browser",j="Chrome",it="Firefox",ct="Google",Ut="Huawei",he="LG",Bt="Microsoft",Ai="Motorola",x="Opera",G="Samsung",Y="Sharp",st="Sony",gt="Xiaomi",W="Zebra",m="Facebook",I="Chromium OS",b="Mac OS",B=function(ee){for(var pe={},jt=0;jt<ee.length;jt++)pe[ee[jt].toUpperCase()]=ee[jt];return pe},rt=function(ee,pe){return typeof ee===a&&Vt(pe).indexOf(Vt(ee))!==-1},Vt=function(ee){return ee.toLowerCase()},je=function(ee,pe){if(typeof ee===a)return ee=ee.replace(/^\s\s*/,""),typeof pe===r?ee:ee.substring(0,350)},bi=function(ee,pe){for(var jt,wi,qn,ie,Tt,Si,$s=0;$s<pe.length&&!Tt;){var On=pe[$s],dv=pe[$s+1];for(jt=wi=0;jt<On.length&&!Tt&&On[jt];)if(Tt=On[jt++].exec(ee))for(qn=0;qn<dv.length;qn++)Si=Tt[++wi],typeof(ie=dv[qn])===o&&ie.length>0?ie.length===2?typeof ie[1]==s?this[ie[0]]=ie[1].call(this,Si):this[ie[0]]=ie[1]:ie.length===3?typeof ie[1]!==s||ie[1].exec&&ie[1].test?this[ie[0]]=Si?Si.replace(ie[1],ie[2]):n:this[ie[0]]=Si?ie[1].call(this,Si,ie[2]):n:ie.length===4&&(this[ie[0]]=Si?ie[3].call(this,Si.replace(ie[1],ie[2])):n):this[ie]=Si||n;$s+=2}},ps=function(ee,pe){for(var jt in pe)if(typeof pe[jt]===o&&pe[jt].length>0){for(var wi=0;wi<pe[jt].length;wi++)if(rt(pe[jt][wi],ee))return jt==="?"?n:jt}else if(rt(pe[jt],ee))return jt==="?"?n:jt;return ee},sl={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},rl={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[_,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[_,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,_],[/opios[\/ ]+([\w\.]+)/i],[_,[l,x+" Mini"]],[/\bopr\/([\w\.]+)/i],[_,[l,x]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,_],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[_,[l,"UC"+F]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[_,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[_,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[_,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[_,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[_,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+F],_],[/\bfocus\/([\w\.]+)/i],[_,[l,it+" Focus"]],[/\bopt\/([\w\.]+)/i],[_,[l,x+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[_,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[_,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[_,[l,x+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[_,[l,"MIUI "+F]],[/fxios\/([-\w\.]+)/i],[_,[l,it]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+F]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+F],_],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],_],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,_],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,m],_],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,_],[/\bgsa\/([\w\.]+) .*safari\//i],[_,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[_,[l,j+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,j+" WebView"],_],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[_,[l,"Android "+F]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,_],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[_,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[_,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[_,ps,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,_],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],_],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[_,[l,it+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,_],[/(cobalt)\/([\w\.]+)/i],[l,[_,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[S,"amd64"]],[/(ia32(?=;))/i],[[S,Vt]],[/((?:i[346]|x)86)[;\)]/i],[[S,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[S,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[S,"armhf"]],[/windows (ce|mobile); ppc;/i],[[S,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[S,/ower/,"",Vt]],[/(sun4\w)[;\)]/i],[[S,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[S,Vt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,G],[u,C]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,G],[u,g]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[p,N],[u,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,N],[u,C]],[/(macintosh);/i],[d,[p,N]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,Y],[u,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[p,Ut],[u,C]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,Ut],[u,g]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[p,gt],[u,g]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[p,gt],[u,C]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,"OPPO"],[u,g]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[u,g]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[u,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,Ai],[u,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,Ai],[u,C]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,he],[u,C]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,he],[u,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[p,"Lenovo"],[u,C]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[p,"Nokia"],[u,g]],[/(pixel c)\b/i],[d,[p,ct],[u,C]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,ct],[u,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,st],[u,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,st],[u,C]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,"OnePlus"],[u,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,O],[u,C]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,O],[u,g]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[u,C]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,D],[u,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,L],[u,C]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,L],[u,g]],[/(nexus 9)/i],[d,[p,"HTC"],[u,C]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[u,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[u,C]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[u,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[u,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[u,C]],[/(surface duo)/i],[d,[p,Bt],[u,C]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[u,g]],[/(u304aa)/i],[d,[p,"AT&T"],[u,g]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[u,g]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[u,C]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[u,C]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[u,C]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[u,C]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[u,C]],[/\b(k88) b/i],[d,[p,"ZTE"],[u,C]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[u,g]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[u,g]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[u,C]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[u,C]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[u,C]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[u,C]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[u,C]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[u,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[u,g]],[/\b(ph-1) /i],[d,[p,"Essential"],[u,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[u,C]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[u,C]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[u,C]],[/(shield[\w ]+) b/i],[d,[p,"Nvidia"],[u,C]],[/(sprint) (\w+)/i],[p,d,[u,g]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,Bt],[u,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,W],[u,C]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,W],[u,g]],[/smart-tv.+(samsung)/i],[p,[u,y]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,G],[u,y]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,he],[u,y]],[/(apple) ?tv/i],[p,[d,N+" TV"],[u,y]],[/crkey/i],[[d,j+"cast"],[p,ct],[u,y]],[/droid.+aft(\w)( bui|\))/i],[d,[p,O],[u,y]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,Y],[u,y]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,st],[u,y]],[/(mitv-\w{5}) bui/i],[d,[p,gt],[u,y]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[u,y]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,je],[d,je],[u,y]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,y]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[u,f]],[/droid.+; (shield) bui/i],[d,[p,"Nvidia"],[u,f]],[/(playstation [345portablevi]+)/i],[d,[p,st],[u,f]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,Bt],[u,f]],[/((pebble))app/i],[p,d,[u,A]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,N],[u,A]],[/droid.+; (glass) \d/i],[d,[p,ct],[u,A]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,W],[u,A]],[/(quest( 2| pro)?)/i],[d,[p,m],[u,A]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[u,k]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[u,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,C]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,C]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,g]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[_,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[_,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,_],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[_,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,_],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[_,ps,sl]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[_,ps,sl]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[_,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,b],[_,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[_,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,_],[/\(bb(10);/i],[_,[l,D]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[_,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[_,[l,it+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[_,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[_,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[_,[l,j+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,I],_],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,_],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],_],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,_]]},sn=function(ee,pe){if(typeof ee===o&&(pe=ee,ee=n),!(this instanceof sn))return new sn(ee,pe).getResult();var jt=typeof e!==r&&e.navigator?e.navigator:n,wi=ee||(jt&&jt.userAgent?jt.userAgent:""),qn=jt&&jt.userAgentData?jt.userAgentData:n,ie=pe?function(Tt,Si){var $s={};for(var On in Tt)Si[On]&&Si[On].length%2==0?$s[On]=Si[On].concat(Tt[On]):$s[On]=Tt[On];return $s}(rl,pe):rl;return this.getBrowser=function(){var Tt={};return Tt[l]=n,Tt[_]=n,bi.call(Tt,wi,ie.browser),Tt[c]=function(Si){return typeof Si===a?Si.replace(/[^\d\.]/g,"").split(".")[0]:n}(Tt[_]),jt&&jt.brave&&typeof jt.brave.isBrave==s&&(Tt[l]="Brave"),Tt},this.getCPU=function(){var Tt={};return Tt[S]=n,bi.call(Tt,wi,ie.cpu),Tt},this.getDevice=function(){var Tt={};return Tt[p]=n,Tt[d]=n,Tt[u]=n,bi.call(Tt,wi,ie.device),!Tt[u]&&qn&&qn.mobile&&(Tt[u]=g),Tt[d]=="Macintosh"&&jt&&typeof jt.standalone!==r&&jt.maxTouchPoints&&jt.maxTouchPoints>2&&(Tt[d]="iPad",Tt[u]=C),Tt},this.getEngine=function(){var Tt={};return Tt[l]=n,Tt[_]=n,bi.call(Tt,wi,ie.engine),Tt},this.getOS=function(){var Tt={};return Tt[l]=n,Tt[_]=n,bi.call(Tt,wi,ie.os),!Tt[l]&&qn&&qn.platform!="Unknown"&&(Tt[l]=qn.platform.replace(/chrome os/i,I).replace(/macos/i,b)),Tt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return wi},this.setUA=function(Tt){return wi=typeof Tt===a&&Tt.length>350?je(Tt,350):Tt,this},this.setUA(wi),this};sn.VERSION="0.7.34",sn.BROWSER=B([l,_,c]),sn.CPU=B([S]),sn.DEVICE=B([d,p,u,f,g,y,C,A,k]),sn.ENGINE=sn.OS=B([l,_]),i.exports&&(t=i.exports=sn),t.UAParser=sn;var Zs=typeof e!==r&&(e.jQuery||e.Zepto);if(Zs&&!Zs.ua){var Vo=new sn;Zs.ua=Vo.getResult(),Zs.ua.get=function(){return Vo.getUA()},Zs.ua.set=function(ee){Vo.setUA(ee);var pe=Vo.getResult();for(var jt in pe)Zs.ua[jt]=pe[jt]}}})(typeof window=="object"?window:Ri)})(eh,eh.exports);const ih=new(xt(eh.exports));let Zn=ih.getResult(),nh=null;function ft(i){if(!nh){i&&ih.setUA(i),Zn=ih.getResult();const t=function(r){if(r.engine.name==="Blink"&&r.browser.name!=="WeChat")return Rt.CHROME;switch(r.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Rt.CHROME;case"Safari":case"Mobile Safari":return Rt.SAFARI;case"Edge":return Rt.EDGE;case"Firefox":return Rt.FIREFOX;case"QQBrowser":return Rt.QQ;case"Opera":return Rt.OPERA;case"WeChat":return Rt.WECHAT;default:return r.browser.name||""}}(Zn),e=function(r){let o;return o=r.engine.name==="Blink"?r.engine.version||"":r.browser.version||"",o.split(".")[0]}(Zn),n=function(r){return r.os.name==="Windows"?r.os.version?r.os.name+" "+r.os.version:r.os.name:r.os.name||""}(Zn),s=Zn.os.version;if(!(t&&e&&n&&s))return{name:t,version:e,os:n,osVersion:s};nh={name:t,version:e,os:n,osVersion:s}}return nh}function Hc(){return ft().os}function nT(){const i=ft();return"".concat(i.os," ").concat(i.osVersion)}function Kc(){const i=ft();return!!(Zn.engine.name==="WebKit"&&i.os===_e.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&i.name!==Rt.SAFARI||Qe()&&i.name!==Rt.SAFARI)}function iL(){const i=ft();if(Kc()){if(i.os===_e.MAC_OS)return!0;if(i.os===_e.IOS){const t=Zn.os.version&&Zn.os.version.split(".");if(t&&Number(t[0])===14&&t[1]&&Number(t[1])>=3||t&&Number(t[0])>14)return!0}}return!1}function nL(){return Zn.engine.name==="WebKit"}function la(){return ft().name===Rt.CHROME}function Xe(){return ft().name===Rt.SAFARI}function Nt(){return ft().name===Rt.FIREFOX}function Qe(){return ft().os===_e.IOS}function sh(i){const t=ft();return!(t.name!==Rt.CHROME||!t.osVersion)&&Number(t.version)>=i}function sT(i){const t=ft();return!(t.name!==Rt.EDGE||!t.osVersion)&&Number(t.version)>=i}function rT(i){const t=ft();return!(t.name!==Rt.OPERA||!t.osVersion)&&Number(t.version)>=i}function oT(){const i=ft();return!(i.name!==Rt.CHROME||!i.osVersion)&&Number(i.version)<=90}function aT(){const i=ft();if(i.os!==_e.IOS||!i.osVersion)return!1;const t=i.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function no(){const i=ft();if(i.os!==_e.IOS||!i.osVersion)return!1;const t=i.osVersion.split(".");return Number(t[0])===15}function rh(){const i=ft();if(i.os!==_e.IOS||!i.osVersion)return!1;const t=i.osVersion.split(".");return Number(t[0])===16}function cT(){const i=ft();if(i.os!==_e.IOS||!i.osVersion)return!1;const t=i.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function kn(){return Xe()&&navigator.maxTouchPoints>0}function dT(){return ft().name===Rt.WECHAT}function lT(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function vs(){const i=ft();return i.name===Rt.EDGE||i.name===Rt.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Yc(){return Hc()===_e.ANDROID}function ua(){const i=ft();return Yc()&&(i.name===Rt.CHROME||i.name===Rt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}var R;(function(i){i.UNEXPECTED_ERROR="UNEXPECTED_ERROR",i.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",i.TIMEOUT="TIMEOUT",i.INVALID_PARAMS="INVALID_PARAMS",i.NOT_READABLE="NOT_READABLE",i.NOT_SUPPORTED="NOT_SUPPORTED",i.INVALID_OPERATION="INVALID_OPERATION",i.OPERATION_ABORTED="OPERATION_ABORTED",i.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",i.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",i.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",i.DATACHANNEL_FAILED="DATACHANNEL_FAILED",i.NETWORK_ERROR="NETWORK_ERROR",i.NETWORK_TIMEOUT="NETWORK_TIMEOUT",i.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",i.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",i.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",i.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",i.ELECTRON_IS_NULL="ELECTRON_IS_NULL",i.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",i.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",i.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",i.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",i.PERMISSION_DENIED="PERMISSION_DENIED",i.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",i.TRACK_IS_DISABLED="TRACK_IS_DISABLED",i.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",i.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",i.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",i.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",i.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",i.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",i.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",i.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",i.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",i.UID_CONFLICT="UID_CONFLICT",i.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",i.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",i.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",i.INVALID_TRACK="INVALID_TRACK",i.SENDER_NOT_FOUND="SENDER_NOT_FOUND",i.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",i.SET_ANSWER_FAILED="SET_ANSWER_FAILED",i.ICE_FAILED="ICE_FAILED",i.PC_CLOSED="PC_CLOSED",i.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",i.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",i.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",i.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",i.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",i.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",i.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",i.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",i.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",i.INVALID_REMOTE_USER="INVALID_REMOTE_USER",i.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",i.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",i.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",i.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",i.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",i.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",i.WS_ABORT="WS_ABORT",i.WS_DISCONNECT="WS_DISCONNECT",i.WS_ERR="WS_ERR",i.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",i.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",i.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",i.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",i.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",i.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",i.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",i.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",i.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",i.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",i.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",i.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",i.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",i.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",i.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",i.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",i.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",i.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",i.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",i.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",i.INVALID_PLUGIN="INVALID_PLUGIN",i.DISCONNECT_P2P="DISCONNECT_P2P",i.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",i.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",i.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",i.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",i.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",i.PROHIBITED_OPERATION="PROHIBITED_OPERATION",i.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",i.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED"})(R||(R={}));let M=class extends Error{constructor(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",e=arguments.length>2?arguments[2]:void 0;super(t),h(this,"code",void 0),h(this,"message",void 0),h(this,"data",void 0),h(this,"name","AgoraRTCException"),this.code=i,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=e}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return i==="error"&&(t||console).error(this.toString()),i==="warning"&&(t||console).warn(this.toString()),this}throw(i){throw this.print("error",i),this}};function ys(i,t){if(typeof i!="boolean")throw new M(R.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Ee(i,t,e){if(!q(e).call(e,i))throw new M(R.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(e)))}function bt(i,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(i<e||i>n||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(s){return typeof s=="number"&&s%1==0}(i))throw new M(R.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(e,", ").concat(n,"]. integer only"))}function oh(i,t){if(typeof i!="number"){if(!(i.min||i.max||i.ideal||i.exact))throw new M(R.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));i.min!==void 0&&bt(i.min,"".concat(t,".min"),0,1/0),i.max!==void 0&&bt(i.max,"".concat(t,".max"),1,1/0),i.exact!==void 0&&bt(i.exact,"".concat(t,".exact"),1,1/0),i.ideal!==void 0&&bt(i.ideal,"".concat(t,".ideal"),1,1/0)}else bt(i,t,1,1/0)}function Me(i,t){let e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,s=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(i==null)throw new M(R.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!uT(i,e,n,s))throw new M(R.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(e,",").concat(n,"].").concat(s?" ASCII characters only.":""))}function $n(i,t){if(!Array.isArray(i))throw new M(R.INVALID_PARAMS,"".concat(t," should be an array"))}function Kt(i){return i==null}function uT(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,n=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof i=="string"&&i.length<=e&&i.length>=t&&(!n||function(s){if(typeof s!="string")return!1;for(let r=0;r<s.length;r+=1){const o=s.charCodeAt(r);if(o<0||o>255)return!1}return!0}(i))}function hT(i,t,e){if("getBigUint64"in DataView.prototype)return i.getBigUint64(t,e);const n=i.getUint32(t,e),s=i.getUint32(t+4,e),r=+!!e,o=+!e;return BigInt(n*o+s*r)<<BigInt(32)|BigInt(n*r+s*o)}function pT(i,t,e,n){if("setBigUint64"in DataView.prototype)return i.setBigUint64(t,e,n);const s=Number(e>>BigInt(32)),r=Number(e&BigInt(4294967295));n?(i.setUint32(t+4,s,n),i.setUint32(t,r,n)):(i.setUint32(t,s,n),i.setUint32(t+4,r,n))}var so,qc;(function(i){i.COVERED="COVERED",i.POSITION="POSITION",i.SIZE="SIZE",i.STYLE="STYLE"})(so||(so={})),function(i){i.UNMOUNTED="UNMOUNTED",i.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT"}(qc||(qc={}));const _T=new class{constructor(){h(this,"_clientSize",null),h(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),h(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),h(this,"getStyle",i=>window.getComputedStyle(i,null)),h(this,"checkCssVisibleProperty",i=>{var t;let e=!0;const n=this.getStyle(i),{display:s,visibility:r,opacity:o,filter:a}=n;return(s==="none"||q(t=["hidden","collapse"]).call(t,r)||Number(o)<.1)&&(e=!1),e?(a&&a.split(" ").filter(c=>{var d;const l=c.split("(")[0];return q(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{const[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{const[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(e=!1);break;case"blur":l>3&&(e=!1);break;case"opacity":l<.1&&(e=!1)}}),e):!1}),h(this,"checkPropertyUpToAllParentNodes",(i,t)=>{let e=!0,n=!0;const s=o=>t(o);let r=i;for(;r&&n;)s(r)||(e=!1,n=!1),r=r.parentElement,r||(n=!1);return e}),h(this,"checkActualCssVisibleIncludeInherit",i=>this.checkPropertyUpToAllParentNodes(i,this.checkCssVisibleProperty)),h(this,"getSizeAboutClient",i=>{const{width:t,height:e,left:n,right:s,top:r,bottom:o}=i.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:e,left:n,right:s,top:r,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),h(this,"checkActualSize",()=>{const{width:i,height:t,clientMin:e}=this._clientSize;return this.checkSizeIsVisible(i,t,e)}),h(this,"elementFromPoint",(i,t)=>document.elementFromPoint?document.elementFromPoint(i,t):null),h(this,"checkCoverForAPoint",(i,t,e)=>{const n=this.elementFromPoint(i,t);return n!==null&&n!==e}),h(this,"getPointPositionList",()=>{const{width:i,height:t,left:e,top:n}=this._clientSize,s=i/6,r=t/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const l=(e*a+(c===0?.1:c===4?(s*c*a-1e5)/a:s*c)*a)/a,u=(n*a+(d===0?.1:d===4?(r*d*a-1e5)/a:r*d)*a)/a;o.push({x:l,y:u})}return[...o]}),h(this,"checkElementCover",i=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,i)).filter(t=>!!t).length>6),h(this,"checkSizeIsVisible",(i,t,e)=>(i>50||e/i<=10)&&(t>50||e/t<=10)),h(this,"checkSizeOfPartInClient",()=>{const{left:i,right:t,top:e,bottom:n,clientHeight:s,clientWidth:r,clientMin:o}=this._clientSize;let a,c,d,l;if(i<0)a=0;else{if(!(i<r))return!1;a=i}if(t<0)return!1;if(c=t<r?t:r,e<0)d=0;else{if(!(e<s))return!1;d=e}if(n<0)return!1;l=n<s?n:s;const u=c-a,p=l-d;return this.checkSizeIsVisible(u,p,o)}),h(this,"returnHiddenResult",i=>(this._clientSize=null,{visible:!1,reason:i})),h(this,"checkOneElementVisible",i=>{if(i instanceof HTMLElement){if(this.checkElementIsMountedOnDom(i)){if(this.checkActualCssVisibleIncludeInherit(i)){if(this._clientSize=this.getSizeAboutClient(i),this.checkElementCover(i))return this.returnHiddenResult(so.COVERED);{const t=this.checkActualSize(),e=this.checkSizeOfPartInClient();return t&&!e?this.returnHiddenResult(so.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(so.SIZE)}}return this.returnHiddenResult(so.STYLE)}return this.returnHiddenResult(qc.UNMOUNTED)}return this.returnHiddenResult(qc.INVALID_HTML_ELEMENT)}),h(this,"checkElementIsMountedOnDom",i=>this.checkPropertyUpToAllParentNodes(i,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function ah(i){return new TextEncoder().encode(i)}const ET=function(i,t){const e=new Uint8Array(i.byteLength+t.byteLength);return e.set(new Uint8Array(i),0),e.set(new Uint8Array(t),i.byteLength),e},sL=async i=>{const t=function(r){const o=window.atob(r),a=new Uint8Array(new ArrayBuffer(o.length));for(let c=0;c<o.length;c+=1)a[c]=o.charCodeAt(c);return a}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),e=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),n=ah(i),s=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,n);return function(r){let o="";for(let a=0;a<r.length;a+=1)o+=String.fromCharCode(r[a]);return window.btoa(o)}(new Uint8Array(s))},ch=async i=>function(t,e){let n="";return new Uint8Array(t).forEach(s=>{n+=s.toString(e).padStart(2,"0")}),n}(await crypto.subtle.digest("SHA-256",ah(i)),16);class Wt{constructor(){h(this,"_events",{}),h(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const n=this._events[t],s=this._indexOfListener(n,e);s!==-1&&n.splice(s,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map(o=>o);for(var n=arguments.length,s=new Array(n>1?n-1:0),r=1;r<n;r++)s[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){const a=e[o];a.once&&this.off(t,a.listener),a.listener.apply(this,s||[])}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),s=1;s<e;s++)n[s-1]=arguments[s];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,n)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return-1}}let ha=null;function mT(){if(ha)return ha;if(window.electron)return ha=window.electron;if(!window.require)return null;try{return ha=window.require("electron"),ha}catch{return null}}var le,Yt,dh,pt,_t,ve,Ze,ts;function fT(i){return bt(i.timeout,"config.timeout",0,1e5),bt(i.timeoutFactor,"config.timeoutFactor",0,100,!1),bt(i.maxRetryCount,"config.maxRetryConfig",0,1/0),bt(i.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function ro(i){if(!Array.isArray(i)||i.length<1)return!1;try{i.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function gT(i){return Me(i.turnServerURL,"turnServerURL"),Me(i.username,"username"),Me(i.password,"password"),i.udpport&&bt(i.udpport,"udpport",1,99999,!0),i.forceturn&&ys(i.forceturn,"forceturn"),i.security&&ys(i.security,"security"),i.tcpport&&bt(i.tcpport,"tcpport",1,99999,!0),!0}function TT(i){return i.level!==void 0&&Ee(i.level,"level",[1,2,3]),i.delay!==void 0&&bt(i.delay,"delay",0,3e3,!0),!0}function re(i,t){for(var e=arguments.length,n=new Array(e>2?e-2:0),s=2;s<e;s++)n[s-2]=arguments[s];return i.getListeners(t).length===0?P.reject(new M(R.UNEXPECTED_ERROR,"can not emit promise")):new P((r,o)=>{i.emit(t,...n,r,o)})}function Dt(i,t){if(i.getListeners(t).length===0)return P.resolve();for(var e=arguments.length,n=new Array(e>2?e-2:0),s=2;s<e;s++)n[s-2]=arguments[s];return re(i,t,...n)}function Ci(i,t){if(i.getListeners(t).length===0)return null;for(var e=arguments.length,n=new Array(e>2?e-2:0),s=2;s<e;s++)n[s-2]=arguments[s];return pr(i,t,...n)}function pr(i,t){let e=null,n=null;for(var s=arguments.length,r=new Array(s>2?s-2:0),o=2;o<s;o++)r[o-2]=arguments[o];if(i.emit(t,...r,a=>{e=a},a=>{n=a}),n!==null)throw n;if(e===null)throw new M(R.UNEXPECTED_ERROR,"handler is not sync");return e}(function(i){i.CREATE_CLIENT="createClient",i.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",i.SET_AREA="setArea",i.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",i.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",i.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",i.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",i.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",i.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",i.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",i.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",i.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",i.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",i.START_PROXY_SERVER="Client.startProxyServer",i.STOP_PROXY_SERVER="Client.stopProxyServer",i.SET_PROXY_SERVER="Client.setProxyServer",i.SET_TURN_SERVER="Client.setTurnServer",i.SET_CLIENT_ROLE="Client.setClientRole",i.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",i.ENABLE_DUAL_STREAM="Client.enableDualStream",i.DISABLE_DUAL_STREAM="Client.disableDualStream",i.JOIN="Client.join",i.LEAVE="Client.leave",i.PUBLISH="Client.publish",i.UNPUBLISH="Client.unpublish",i.SUBSCRIBE="Client.subscribe",i.MASS_SUBSCRIBE="Client.massSubscribe",i.MASS_UNSUBSCRIBE="Client.massUnsubscribe",i.UNSUBSCRIBE="Client.unsubscribe",i.RENEW_TOKEN="Client.renewToken",i.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",i.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",i.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",i.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",i.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",i.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",i.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",i.DATACHANNEL_FAILBACK="Client._datachannelFailback",i.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",i.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",i.START_LIVE_STREAMING="Client.startLiveStreaming",i.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",i.STOP_LIVE_STREAMING="Client.stopLiveStreaming",i.ADD_INJECT_STREAM_URL="Client.addInjectStreamUrl",i.REMOVE_INJECT_STREAM_URL="Client.removeInjectStreamUrl",i.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",i.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",i.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",i.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",i.SET_CONFIG_DISTRIBUTE="_configDistribute",i.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",i.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",i.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",i.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",i.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",i.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",i.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",i.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",i.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",i.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",i.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",i.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",i.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",i.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",i.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",i.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",i.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",i.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",i.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",i.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",i.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",i.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",i.STREAM_TYPE_CHANGE="streamTypeChange",i.CONNECTION_STATE_CHANGE="connectionStateChange",i.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",i.IMAGE_MODERATION_UPLOAD="imageModerationUpload"})(le||(le={})),function(i){i.TRACER="tracer"}(Yt||(Yt={})),function(i){i[i.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",i[i.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",i[i.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}(dh||(dh={})),function(i){i.LEAVE="LEAVE",i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.UID_BANNED="UID_BANNED",i.IP_BANNED="IP_BANNED",i.CHANNEL_BANNED="CHANNEL_BANNED",i.FALLBACK="FALLBACK",i.LICENSE_MISSING="LICENSE_MISSING",i.LICENSE_EXPIRED="LICENSE_EXPIRED",i.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",i.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",i.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",i.LICENSE_ILLEGAL="LICENSE_ILLEGAL",i.TOKEN_EXPIRE="TOKEN_EXPIRE"}(pt||(pt={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.MEDIA_RECONNECT_START="media-reconnect-start",i.MEDIA_RECONNECT_END="media-reconnect-end",i.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",i.USER_JOINED="user-joined",i.USER_LEAVED="user-left",i.USER_PUBLISHED="user-published",i.USER_UNPUBLISHED="user-unpublished",i.USER_INFO_UPDATED="user-info-updated",i.CLIENT_BANNED="client-banned",i.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",i.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",i.VOLUME_INDICATOR="volume-indicator",i.CRYPT_ERROR="crypt-error",i.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",i.NETWORK_QUALITY="network-quality",i.STREAM_TYPE_CHANGED="stream-type-changed",i.STREAM_FALLBACK="stream-fallback",i.RECEIVE_METADATA="receive-metadata",i.STREAM_MESSAGE="stream-message",i.LIVE_STREAMING_ERROR="live-streaming-error",i.LIVE_STREAMING_WARNING="live-streaming-warning",i.INJECT_STREAM_STATUS="stream-inject-status",i.EXCEPTION="exception",i.ERROR="error",i.P2P_LOST="p2p_lost",i.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",i.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",i.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",i.PUBLISHED_USER_LIST="published-user-list",i.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",i.CONTENT_INSPECT_ERROR="content-inspect-error",i.CONTENT_INSPECT_RESULT="content-inspect-result",i.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change"}(_t||(_t={})),function(i){i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.MULTI_IP="MULTI_IP",i.TIMEOUT="TIMEOUT",i.OFFLINE="OFFLINE",i.LEAVE="LEAVE",i.P2P_FAILED="P2P_FAILED",i.FALLBACK="FALLBACK"}(ve||(ve={})),function(i){i.ONLINE="ONLINE",i.OFFLINE="OFFLINE"}(Ze||(Ze={})),function(i){i.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",i.ONLINE="ONLINE",i.OFFLINE="OFFLINE"}(ts||(ts={}));const oe=new class extends Wt{set networkState(i){this.emit(ts.NETWORK_STATE_CHANGE,i,this._networkState),i===Ze.ONLINE?this.emit(ts.ONLINE):i===Ze.OFFLINE&&(this.onlineWaiter=new P(t=>{this.once(ts.ONLINE,()=>{this.onlineWaiter=void 0,t(Ze.ONLINE)})}),this.emit(ts.OFFLINE)),this._networkState=i}get networkState(){return this._networkState}get isOnline(){return this._networkState===Ze.ONLINE}constructor(){super(),h(this,"_moduleName","network-indicator"),h(this,"_networkState",Ze.ONLINE),h(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Ze.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Ze.OFFLINE})}};function ST(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function _r(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?ST(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):ST(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function Jc(i,t){const e=i.indexOf(t);e!==-1&&i.splice(e,1)}function oo(i){const t=[];return i.forEach(e=>{t.indexOf(e)===-1&&t.push(e)}),t}function zc(i){P!==void 0?P.resolve().then(i):setTimeout(i,0)}function kt(i){return JSON.parse(JSON.stringify(i))}function Er(i){try{return kt(i)}catch{return i}}const RT={};function pa(i,t){RT[t]||(RT[t]=!0,i())}function Xc(i){const t=window.atob(i),e=new Uint8Array(new ArrayBuffer(t.length));for(let n=0;n<t.length;n+=1)e[n]=t.charCodeAt(n);return e}function ao(i){let t="";for(let e=0;e<i.length;e+=1)t+=String.fromCharCode(i[e]);return window.btoa(t)}function Mn(i){return window.TextEncoder?new TextEncoder().encode(i).length:i.length}function CT(i){let t=0;return/DingTalk/i.test(navigator.userAgent)&&i.realFormData&&(i=i.realFormData),i.forEach(e=>{t+=typeof e=="string"?Mn(e):e.size}),t+138}function rL(i){const t=new M(R.TIMEOUT,"timeout");return new P((e,n)=>{window.setTimeout(()=>n(t),i)})}function ye(i){return new P(t=>{window.setTimeout(t,i)})}function Pt(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const e=Math.random().toString(16).substr(2,i).toLowerCase();return e.length===i?"".concat(t).concat(e):"".concat(t).concat(e)+Pt(i-e.length,"")}function lh(){return Pt(32,"").toUpperCase()}const Qc=()=>{},IT=new class{constructor(){h(this,"fnMap",new Map)}throttleByKey(i,t,e,n){for(var s=arguments.length,r=new Array(s>4?s-4:0),o=4;o<s;o++)r[o-4]=arguments[o];if(this.fnMap.has(t)){const a=this.fnMap.get(t);if(a.threshold!==e){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},e);this.fnMap.set(t,{fn:i,threshold:e,timer:c,args:r,skipFn:n})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(t,_r(_r({},a),{},{fn:i,args:r,skipFn:n}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(t);c&&c.fn(...c.args),this.fnMap.delete(t)},e);this.fnMap.set(t,{fn:i,threshold:e,timer:a,args:r,skipFn:n})}}},vT=IT.throttleByKey.bind(IT);function yT(i){return typeof i=="object"&&i!==null&&!(i instanceof RegExp)}function uh(i,t){if(!yT(i)||!yT(t)||Array.isArray(i)&&!Array.isArray(t)||!Array.isArray(i)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(i)){const e=[...i];for(let n=0;n<t.length;n++)e[n]=uh(i[n],t[n]);return e}{const e=_r({},i);for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(i,n)?e[n]=uh(i[n],t[n]):e[n]=t[n]);return e}}let oL=1,Zc=console;class Ae{static setLogger(t){Zc=t}constructor(t){h(this,"lockingPromise",P.resolve()),h(this,"locks",0),h(this,"name",""),h(this,"lockId",void 0),this.lockId=oL++,t&&(this.name=t),Zc.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,Zc.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));const n=new P(r=>{e=()=>{this.locks-=1,Zc.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),r()}}),s=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),s}}function co(i,t){return function(e,n,s){const r=s.value;if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return s.value=async function(){const o=this[t];if(!o)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(i));const a=await o.lock("From ".concat(i,".").concat(n));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await r.apply(this,d)}finally{a()}},s}}const ae={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function $c(i,t){const e=Math.floor(t.timeout*Math.pow(t.timeoutFactor,i));return Math.min(t.maxRetryTimeout,e)}function Cn(i,t,e,n){const s=Object.assign({},ae,n);let r=s.timeout;const o=async()=>{await function(d){return new P(l=>{window.setTimeout(l,d)})}(r),r*=s.timeoutFactor,r=Math.min(s.maxRetryTimeout,r)};let a=!1;const c=new P(async(d,l)=>{t=t||(()=>!1),e=e||(()=>!0);for(let u=0;u<s.maxRetryCount;u+=1){if(a)return l(new M(R.OPERATION_ABORTED));try{const p=await i();if(!t(p,u)||u+1===s.maxRetryCount)return d(p);await o()}catch(p){if(!e(p,u)||u+1===s.maxRetryCount)return l(p);await o()}}});return c.cancel=()=>a=!0,c}var aL=an,cL=fs,dL=ul,lL=rr,uL=TypeError,AT=function(i){return function(t,e,n,s){aL(e);var r=cL(t),o=dL(r),a=lL(r),c=i?a-1:0,d=i?-1:1;if(n<2)for(;;){if(c in o){s=o[c],c+=d;break}if(c+=d,i?c<0:a<=c)throw uL("Reduce of empty array with no initial value")}for(;i?c>=0:a>c;c+=d)c in o&&(s=e(s,o[c],c,r));return s}},hL={left:AT(!1),right:AT(!0)}.left;zt({target:"Array",proto:!0,forced:!na&&sr>79&&sr<83||!vu("reduce")},{reduce:function(i){var t=arguments.length;return hL(this,i,t,t>1?arguments[1]:void 0)}});var pL=Ts("Array").reduce,_L=rn,EL=pL,hh=Array.prototype,mr=xt(function(i){var t=i.reduce;return i===hh||_L(hh,i)&&t===hh.reduce?EL:t});let ph=class{constructor(i){h(this,"input",[]),h(this,"size",void 0),this.size=i}add(i){this.input.push(i),this.input.length>this.size&&this.input.splice(0,1)}mean(){var i;return this.input.length===0?0:mr(i=this.input).call(i,(t,e)=>t+e)/this.input.length}};var _h,Eh={exports:{}},bT=function(i,t){return function(){for(var e=new Array(arguments.length),n=0;n<e.length;n++)e[n]=arguments[n];return i.apply(t,e)}},mL=bT,mh=Object.prototype.toString,fh=(_h=Object.create(null),function(i){var t=mh.call(i);return _h[t]||(_h[t]=t.slice(8,-1).toLowerCase())});function fr(i){return i=i.toLowerCase(),function(t){return fh(t)===i}}function gh(i){return Array.isArray(i)}function td(i){return i===void 0}var wT=fr("ArrayBuffer");function OT(i){return i!==null&&typeof i=="object"}function ed(i){if(fh(i)!=="object")return!1;var t=Object.getPrototypeOf(i);return t===null||t===Object.prototype}var fL=fr("Date"),gL=fr("File"),TL=fr("Blob"),SL=fr("FileList");function Th(i){return mh.call(i)==="[object Function]"}var RL=fr("URLSearchParams");function Sh(i,t){if(i!=null)if(typeof i!="object"&&(i=[i]),gh(i))for(var e=0,n=i.length;e<n;e++)t.call(null,i[e],e,i);else for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&t.call(null,i[s],s,i)}var Rh,CL=(Rh=typeof Uint8Array<"u"&&Object.getPrototypeOf(Uint8Array),function(i){return Rh&&i instanceof Rh}),oi={isArray:gh,isArrayBuffer:wT,isBuffer:function(i){return i!==null&&!td(i)&&i.constructor!==null&&!td(i.constructor)&&typeof i.constructor.isBuffer=="function"&&i.constructor.isBuffer(i)},isFormData:function(i){var t="[object FormData]";return i&&(typeof FormData=="function"&&i instanceof FormData||mh.call(i)===t||Th(i.toString)&&i.toString()===t)},isArrayBufferView:function(i){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(i):i&&i.buffer&&wT(i.buffer)},isString:function(i){return typeof i=="string"},isNumber:function(i){return typeof i=="number"},isObject:OT,isPlainObject:ed,isUndefined:td,isDate:fL,isFile:gL,isBlob:TL,isFunction:Th,isStream:function(i){return OT(i)&&Th(i.pipe)},isURLSearchParams:RL,isStandardBrowserEnv:function(){return(typeof navigator>"u"||navigator.product!=="ReactNative"&&navigator.product!=="NativeScript"&&navigator.product!=="NS")&&typeof window<"u"&&typeof document<"u"},forEach:Sh,merge:function i(){var t={};function e(r,o){ed(t[o])&&ed(r)?t[o]=i(t[o],r):ed(r)?t[o]=i({},r):gh(r)?t[o]=r.slice():t[o]=r}for(var n=0,s=arguments.length;n<s;n++)Sh(arguments[n],e);return t},extend:function(i,t,e){return Sh(t,function(n,s){i[s]=e&&typeof n=="function"?mL(n,e):n}),i},trim:function(i){return i.trim?i.trim():i.replace(/^\s+|\s+$/g,"")},stripBOM:function(i){return i.charCodeAt(0)===65279&&(i=i.slice(1)),i},inherits:function(i,t,e,n){i.prototype=Object.create(t.prototype,n),i.prototype.constructor=i,e&&Object.assign(i.prototype,e)},toFlatObject:function(i,t,e){var n,s,r,o={};t=t||{};do{for(s=(n=Object.getOwnPropertyNames(i)).length;s-- >0;)o[r=n[s]]||(t[r]=i[r],o[r]=!0);i=Object.getPrototypeOf(i)}while(i&&(!e||e(i,t))&&i!==Object.prototype);return t},kindOf:fh,kindOfTest:fr,endsWith:function(i,t,e){i=String(i),(e===void 0||e>i.length)&&(e=i.length),e-=t.length;var n=i.indexOf(t,e);return n!==-1&&n===e},toArray:function(i){if(!i)return null;var t=i.length;if(td(t))return null;for(var e=new Array(t);t-- >0;)e[t]=i[t];return e},isTypedArray:CL,isFileList:SL},lo=oi;function NT(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var DT=function(i,t,e){if(!t)return i;var n;if(e)n=e(t);else if(lo.isURLSearchParams(t))n=t.toString();else{var s=[];lo.forEach(t,function(o,a){o!=null&&(lo.isArray(o)?a+="[]":o=[o],lo.forEach(o,function(c){lo.isDate(c)?c=c.toISOString():lo.isObject(c)&&(c=JSON.stringify(c)),s.push(NT(a)+"="+NT(c))}))}),n=s.join("&")}if(n){var r=i.indexOf("#");r!==-1&&(i=i.slice(0,r)),i+=(i.indexOf("?")===-1?"?":"&")+n}return i},IL=oi;function id(){this.handlers=[]}id.prototype.use=function(i,t,e){return this.handlers.push({fulfilled:i,rejected:t,synchronous:!!e&&e.synchronous,runWhen:e?e.runWhen:null}),this.handlers.length-1},id.prototype.eject=function(i){this.handlers[i]&&(this.handlers[i]=null)},id.prototype.forEach=function(i){IL.forEach(this.handlers,function(t){t!==null&&i(t)})};var PT,LT,vL=id,yL=oi;function uo(){if(LT)return PT;LT=1;var i=oi;function t(s,r,o,a,c){Error.call(this),this.message=s,this.name="AxiosError",r&&(this.code=r),o&&(this.config=o),a&&(this.request=a),c&&(this.response=c)}i.inherits(t,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var e=t.prototype,n={};return["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach(function(s){n[s]={value:s}}),Object.defineProperties(t,n),Object.defineProperty(e,"isAxiosError",{value:!0}),t.from=function(s,r,o,a,c,d){var l=Object.create(e);return i.toFlatObject(s,l,function(u){return u!==Error.prototype}),t.call(l,s.message,r,o,a,c),l.name=s.name,d&&Object.assign(l,d),l},PT=t}var Ch,kT,MT,UT,Ih,xT,VT={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function FT(){if(kT)return Ch;kT=1;var i=oi;return Ch=function(t,e){e=e||new FormData;var n=[];function s(r){return r===null?"":i.isDate(r)?r.toISOString():i.isArrayBuffer(r)||i.isTypedArray(r)?typeof Blob=="function"?new Blob([r]):Buffer.from(r):r}return function r(o,a){if(i.isPlainObject(o)||i.isArray(o)){if(n.indexOf(o)!==-1)throw Error("Circular reference detected in "+a);n.push(o),i.forEach(o,function(c,d){if(!i.isUndefined(c)){var l,u=a?a+"."+d:d;if(c&&!a&&typeof c=="object"){if(i.endsWith(d,"{}"))c=JSON.stringify(c);else if(i.endsWith(d,"[]")&&(l=i.toArray(c)))return void l.forEach(function(p){!i.isUndefined(p)&&e.append(u,s(p))})}r(c,u)}}),n.pop()}else e.append(a,s(o))}(t),e},Ch}function AL(){if(UT)return MT;UT=1;var i=uo();return MT=function(t,e,n){var s=n.config.validateStatus;n.status&&s&&!s(n.status)?e(new i("Request failed with status code "+n.status,[i.ERR_BAD_REQUEST,i.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):t(n)}}function bL(){if(xT)return Ih;xT=1;var i=oi;return Ih=i.isStandardBrowserEnv()?{write:function(t,e,n,s,r,o){var a=[];a.push(t+"="+encodeURIComponent(e)),i.isNumber(n)&&a.push("expires="+new Date(n).toGMTString()),i.isString(s)&&a.push("path="+s),i.isString(r)&&a.push("domain="+r),o===!0&&a.push("secure"),document.cookie=a.join("; ")},read:function(t){var e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove:function(t){this.write(t,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},Ih}var vh,BT,jT,GT,WT,HT,KT,YT,yh,qT,JT,zT,wL=function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)},OL=function(i,t){return t?i.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):i},XT=function(i,t){return i&&!wL(t)?OL(i,t):t};function NL(){if(BT)return vh;BT=1;var i=oi,t=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];return vh=function(e){var n,s,r,o={};return e&&i.forEach(e.split(`
`),function(a){if(r=a.indexOf(":"),n=i.trim(a.substr(0,r)).toLowerCase(),s=i.trim(a.substr(r+1)),n){if(o[n]&&t.indexOf(n)>=0)return;o[n]=n==="set-cookie"?(o[n]?o[n]:[]).concat([s]):o[n]?o[n]+", "+s:s}}),o},vh}function DL(){if(GT)return jT;GT=1;var i=oi;return jT=i.isStandardBrowserEnv()?function(){var t,e=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");function s(r){var o=r;return e&&(n.setAttribute("href",o),o=n.href),n.setAttribute("href",o),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:n.pathname.charAt(0)==="/"?n.pathname:"/"+n.pathname}}return t=s(window.location.href),function(r){var o=i.isString(r)?s(r):r;return o.protocol===t.protocol&&o.host===t.host}}():function(){return!0}}function nd(){if(HT)return WT;HT=1;var i=uo();function t(e){i.call(this,e??"canceled",i.ERR_CANCELED),this.name="CanceledError"}return oi.inherits(t,i,{__CANCEL__:!0}),WT=t}function PL(){return YT||(YT=1,KT=function(i){var t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(i);return t&&t[1]||""}),KT}function LL(){if(qT)return yh;qT=1;var i=oi,t=AL(),e=bL(),n=DT,s=XT,r=NL(),o=DL(),a=VT,c=uo(),d=nd(),l=PL();return yh=function(u){return new Promise(function(p,_){var S,f=u.data,g=u.headers,C=u.responseType;function y(){u.cancelToken&&u.cancelToken.unsubscribe(S),u.signal&&u.signal.removeEventListener("abort",S)}i.isFormData(f)&&i.isStandardBrowserEnv()&&delete g["Content-Type"];var A=new XMLHttpRequest;if(u.auth){var k=u.auth.username||"",O=u.auth.password?unescape(encodeURIComponent(u.auth.password)):"";g.Authorization="Basic "+btoa(k+":"+O)}var N=s(u.baseURL,u.url);function L(){if(A){var j="getAllResponseHeaders"in A?r(A.getAllResponseHeaders()):null,it={data:C&&C!=="text"&&C!=="json"?A.response:A.responseText,status:A.status,statusText:A.statusText,headers:j,config:u,request:A};t(function(ct){p(ct),y()},function(ct){_(ct),y()},it),A=null}}if(A.open(u.method.toUpperCase(),n(N,u.params,u.paramsSerializer),!0),A.timeout=u.timeout,"onloadend"in A?A.onloadend=L:A.onreadystatechange=function(){A&&A.readyState===4&&(A.status!==0||A.responseURL&&A.responseURL.indexOf("file:")===0)&&setTimeout(L)},A.onabort=function(){A&&(_(new c("Request aborted",c.ECONNABORTED,u,A)),A=null)},A.onerror=function(){_(new c("Network Error",c.ERR_NETWORK,u,A,A)),A=null},A.ontimeout=function(){var j=u.timeout?"timeout of "+u.timeout+"ms exceeded":"timeout exceeded",it=u.transitional||a;u.timeoutErrorMessage&&(j=u.timeoutErrorMessage),_(new c(j,it.clarifyTimeoutError?c.ETIMEDOUT:c.ECONNABORTED,u,A)),A=null},i.isStandardBrowserEnv()){var D=(u.withCredentials||o(N))&&u.xsrfCookieName?e.read(u.xsrfCookieName):void 0;D&&(g[u.xsrfHeaderName]=D)}"setRequestHeader"in A&&i.forEach(g,function(j,it){f===void 0&&it.toLowerCase()==="content-type"?delete g[it]:A.setRequestHeader(it,j)}),i.isUndefined(u.withCredentials)||(A.withCredentials=!!u.withCredentials),C&&C!=="json"&&(A.responseType=u.responseType),typeof u.onDownloadProgress=="function"&&A.addEventListener("progress",u.onDownloadProgress),typeof u.onUploadProgress=="function"&&A.upload&&A.upload.addEventListener("progress",u.onUploadProgress),(u.cancelToken||u.signal)&&(S=function(j){A&&(_(!j||j&&j.type?new d:j),A.abort(),A=null)},u.cancelToken&&u.cancelToken.subscribe(S),u.signal&&(u.signal.aborted?S():u.signal.addEventListener("abort",S))),f||(f=null);var F=l(N);F&&["http","https","file"].indexOf(F)===-1?_(new c("Unsupported protocol "+F+":",c.ERR_BAD_REQUEST,u)):A.send(f)})},yh}var ei=oi,QT=function(i,t){yL.forEach(i,function(e,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(i[t]=e,delete i[n])})},ZT=uo(),kL=VT,ML=FT(),UL={"Content-Type":"application/x-www-form-urlencoded"};function $T(i,t){!ei.isUndefined(i)&&ei.isUndefined(i["Content-Type"])&&(i["Content-Type"]=t)}var tS,sd={transitional:kL,adapter:((typeof XMLHttpRequest<"u"||typeof process<"u"&&Object.prototype.toString.call(process)==="[object process]")&&(tS=LL()),tS),transformRequest:[function(i,t){if(QT(t,"Accept"),QT(t,"Content-Type"),ei.isFormData(i)||ei.isArrayBuffer(i)||ei.isBuffer(i)||ei.isStream(i)||ei.isFile(i)||ei.isBlob(i))return i;if(ei.isArrayBufferView(i))return i.buffer;if(ei.isURLSearchParams(i))return $T(t,"application/x-www-form-urlencoded;charset=utf-8"),i.toString();var e,n=ei.isObject(i),s=t&&t["Content-Type"];if((e=ei.isFileList(i))||n&&s==="multipart/form-data"){var r=this.env&&this.env.FormData;return ML(e?{"files[]":i}:i,r&&new r)}return n||s==="application/json"?($T(t,"application/json"),function(o,a,c){if(ei.isString(o))try{return(a||JSON.parse)(o),ei.trim(o)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(o)}(i)):i}],transformResponse:[function(i){var t=this.transitional||sd.transitional,e=t&&t.silentJSONParsing,n=t&&t.forcedJSONParsing,s=!e&&this.responseType==="json";if(s||n&&ei.isString(i)&&i.length)try{return JSON.parse(i)}catch(r){if(s)throw r.name==="SyntaxError"?ZT.from(r,ZT.ERR_BAD_RESPONSE,this,null,this.response):r}return i}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:zT?JT:(zT=1,JT=null)},validateStatus:function(i){return i>=200&&i<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};ei.forEach(["delete","get","head"],function(i){sd.headers[i]={}}),ei.forEach(["post","put","patch"],function(i){sd.headers[i]=ei.merge(UL)});var eS,iS,Ah=sd,xL=oi,VL=Ah;function nS(){return iS?eS:(iS=1,eS=function(i){return!(!i||!i.__CANCEL__)})}var sS=oi,bh=function(i,t,e){var n=this||VL;return xL.forEach(e,function(s){i=s.call(n,i,t)}),i},FL=nS(),BL=Ah,jL=nd();function wh(i){if(i.cancelToken&&i.cancelToken.throwIfRequested(),i.signal&&i.signal.aborted)throw new jL}var rS,oS,qi=oi,aS=function(i,t){t=t||{};var e={};function n(d,l){return qi.isPlainObject(d)&&qi.isPlainObject(l)?qi.merge(d,l):qi.isPlainObject(l)?qi.merge({},l):qi.isArray(l)?l.slice():l}function s(d){return qi.isUndefined(t[d])?qi.isUndefined(i[d])?void 0:n(void 0,i[d]):n(i[d],t[d])}function r(d){if(!qi.isUndefined(t[d]))return n(void 0,t[d])}function o(d){return qi.isUndefined(t[d])?qi.isUndefined(i[d])?void 0:n(void 0,i[d]):n(void 0,t[d])}function a(d){return d in t?n(i[d],t[d]):d in i?n(void 0,i[d]):void 0}var c={url:r,method:r,data:r,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a};return qi.forEach(Object.keys(i).concat(Object.keys(t)),function(d){var l=c[d]||s,u=l(d);qi.isUndefined(u)&&l!==a||(e[d]=u)}),e};function cS(){return oS?rS:(oS=1,rS={version:"0.27.2"})}var GL=cS().version,As=uo(),Oh={};["object","boolean","number","function","string","symbol"].forEach(function(i,t){Oh[i]=function(e){return typeof e===i||"a"+(t<1?"n ":" ")+i}});var dS={};Oh.transitional=function(i,t,e){function n(s,r){return"[Axios v"+GL+"] Transitional option '"+s+"'"+r+(e?". "+e:"")}return function(s,r,o){if(i===!1)throw new As(n(r," has been removed"+(t?" in "+t:"")),As.ERR_DEPRECATED);return t&&!dS[r]&&(dS[r]=!0,console.warn(n(r," has been deprecated since v"+t+" and will be removed in the near future"))),!i||i(s,r,o)}};var lS,uS,hS,pS,_S,ES,WL={assertOptions:function(i,t,e){if(typeof i!="object")throw new As("options must be an object",As.ERR_BAD_OPTION_VALUE);for(var n=Object.keys(i),s=n.length;s-- >0;){var r=n[s],o=t[r];if(o){var a=i[r],c=a===void 0||o(a,r,i);if(c!==!0)throw new As("option "+r+" must be "+c,As.ERR_BAD_OPTION_VALUE)}else if(e!==!0)throw new As("Unknown option "+r,As.ERR_BAD_OPTION)}},validators:Oh},mS=oi,HL=DT,fS=vL,gS=function(i){return wh(i),i.headers=i.headers||{},i.data=bh.call(i,i.data,i.headers,i.transformRequest),i.headers=sS.merge(i.headers.common||{},i.headers[i.method]||{},i.headers),sS.forEach(["delete","get","head","post","put","patch","common"],function(t){delete i.headers[t]}),(i.adapter||BL.adapter)(i).then(function(t){return wh(i),t.data=bh.call(i,t.data,t.headers,i.transformResponse),t},function(t){return FL(t)||(wh(i),t&&t.response&&(t.response.data=bh.call(i,t.response.data,t.response.headers,i.transformResponse))),Promise.reject(t)})},rd=aS,KL=XT,TS=WL,ho=TS.validators;function po(i){this.defaults=i,this.interceptors={request:new fS,response:new fS}}po.prototype.request=function(i,t){typeof i=="string"?(t=t||{}).url=i:t=i||{},(t=rd(this.defaults,t)).method?t.method=t.method.toLowerCase():this.defaults.method?t.method=this.defaults.method.toLowerCase():t.method="get";var e=t.transitional;e!==void 0&&TS.assertOptions(e,{silentJSONParsing:ho.transitional(ho.boolean),forcedJSONParsing:ho.transitional(ho.boolean),clarifyTimeoutError:ho.transitional(ho.boolean)},!1);var n=[],s=!0;this.interceptors.request.forEach(function(u){typeof u.runWhen=="function"&&u.runWhen(t)===!1||(s=s&&u.synchronous,n.unshift(u.fulfilled,u.rejected))});var r,o=[];if(this.interceptors.response.forEach(function(u){o.push(u.fulfilled,u.rejected)}),!s){var a=[gS,void 0];for(Array.prototype.unshift.apply(a,n),a=a.concat(o),r=Promise.resolve(t);a.length;)r=r.then(a.shift(),a.shift());return r}for(var c=t;n.length;){var d=n.shift(),l=n.shift();try{c=d(c)}catch(u){l(u);break}}try{r=gS(c)}catch(u){return Promise.reject(u)}for(;o.length;)r=r.then(o.shift(),o.shift());return r},po.prototype.getUri=function(i){i=rd(this.defaults,i);var t=KL(i.baseURL,i.url);return HL(t,i.params,i.paramsSerializer)},mS.forEach(["delete","get","head","options"],function(i){po.prototype[i]=function(t,e){return this.request(rd(e||{},{method:i,url:t,data:(e||{}).data}))}}),mS.forEach(["post","put","patch"],function(i){function t(e){return function(n,s,r){return this.request(rd(r||{},{method:i,headers:e?{"Content-Type":"multipart/form-data"}:{},url:n,data:s}))}}po.prototype[i]=t(),po.prototype[i+"Form"]=t(!0)});var SS=oi,YL=bT,od=po,qL=aS,Pi=function i(t){var e=new od(t),n=YL(od.prototype.request,e);return SS.extend(n,od.prototype,e),SS.extend(n,e),n.create=function(s){return i(qL(t,s))},n}(Ah);Pi.Axios=od,Pi.CanceledError=nd(),Pi.CancelToken=function(){if(uS)return lS;uS=1;var i=nd();function t(e){if(typeof e!="function")throw new TypeError("executor must be a function.");var n;this.promise=new Promise(function(r){n=r});var s=this;this.promise.then(function(r){if(s._listeners){var o,a=s._listeners.length;for(o=0;o<a;o++)s._listeners[o](r);s._listeners=null}}),this.promise.then=function(r){var o,a=new Promise(function(c){s.subscribe(c),o=c}).then(r);return a.cancel=function(){s.unsubscribe(o)},a},e(function(r){s.reason||(s.reason=new i(r),n(s.reason))})}return t.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},t.prototype.subscribe=function(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]},t.prototype.unsubscribe=function(e){if(this._listeners){var n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}},t.source=function(){var e;return{token:new t(function(n){e=n}),cancel:e}},lS=t}(),Pi.isCancel=nS(),Pi.VERSION=cS().version,Pi.toFormData=FT(),Pi.AxiosError=uo(),Pi.Cancel=Pi.CanceledError,Pi.all=function(i){return Promise.all(i)},Pi.spread=pS?hS:(pS=1,hS=function(i){return function(t){return i.apply(null,t)}}),Pi.isAxiosError=function(){if(ES)return _S;ES=1;var i=oi;return _S=function(t){return i.isObject(t)&&t.isAxiosError===!0}}(),Eh.exports=Pi,Eh.exports.default=Pi;var hi=xt(Eh.exports);function RS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function CS(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?RS(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):RS(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}let ad,cd=0,Nh=0;function Dh(i,t,e,n){return new P((s,r)=>{t.responseType=t.responseType||"json",t.data&&!e?(t.data=JSON.stringify(t.data),cd+=Mn(t.data)):e&&(t.data.size?cd+=t.data.size:t.data instanceof FormData?cd+=CT(t.data):cd+=Mn(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=i,hi.request(t).then(o=>{typeof o.data=="string"?Nh+=Mn(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?Nh+=o.data.byteLength:Nh+=Mn(JSON.stringify(o.data)),n&&s({data:o.data,headers:o.headers}),s(o.data)}).catch(o=>{hi.isCancel(o)?r(new M(R.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?r(new M(R.NETWORK_TIMEOUT,o.message)):o.response?r(new M(R.NETWORK_RESPONSE_ERROR,o.response.status)):r(new M(R.NETWORK_ERROR,o.message))})})}async function JL(i,t){const e=new Blob([t.data],{type:"buffer"});return await Dh(i,CS(CS({},t),{},{data:e,headers:{"Content-Type":"application/octet-stream"}}),!0)}const zL=()=>(ad||ad||(ad=(window.location.protocol.split(":")[0]||"").toUpperCase(),ad))==="HTTPS",IS=()=>window.isSecureContext!==void 0,Ji=function(i){if(i.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return i;const t=i.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const n=t[1],s=t[2];return"".concat(n,".").concat(s)}const e=i.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(e&&e[1]&&e[2]){const n=e[1],s=e[2];return"".concat(n,".").concat(100*(Number(s)+1))}return"4.0.0.999"}("4.20.0"),Ph=function(){try{return JSON.parse("true")===!0}catch{return!0}}();var es;(function(i){i.Default="default",i.Auto="auto",i.Relay="relay",i.SdRtn="sd-rtn"})(es||(es={}));const Lh="v4.20.0-0-g334e514b-dirty(12/8/2023, 3:48:29 PM)",ii={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!0,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function wt(i,t,e){var n,s;q(n=Object.keys(ii)).call(n,i)&&(!e&&q(s=Object.keys(bs)).call(s,i)||(ii[i]=t))}function v(i){return ii[i]}const bs={};function vS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function X(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?vS(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):vS(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}var ut;(function(i){i.SET_SESSION_ID="SET_SESSION_ID",i.SET_P2P_ID="SET_P2P_id",i.SET_DC_ID="SET_DC_id",i.SET_UID="SET_UID",i.SET_INT_UID="SET_INT_UID",i.SET_PUB_ID="SET_PUB_ID",i.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",i.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",i.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",i.AVOID_JOIN_START="AVOID_JOIN_START",i.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",i.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",i.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",i.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",i.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",i.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",i.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",i.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",i.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",i.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",i.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",i.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",i.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",i.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",i.RESET_KEY_METRICS="RESET_KEY_METRICS",i.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",i.SET_USE_P2P="SET_USE_P2P",i.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE"})(ut||(ut={}));class XL{constructor(t,e,n,s){h(this,"state",void 0),this.state={codec:t,audioCodec:e,mode:n,clientId:s,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:es.Default}}dispatch(t){this.state=function(e,n){switch(n.type){case ut.SET_SESSION_ID:return X(X({},e),{},{sessionId:n.sessionId});case ut.SET_P2P_ID:return X(X({},e),{},{p2pId:n.p2pId});case ut.SET_UID:return X(X({},e),{},{uid:n.uid});case ut.SET_INT_UID:return X(X({},e),{},{intUid:n.intUid});case ut.SET_PUB_ID:return X(X({},e),{},{pubId:n.pubId});case ut.KEY_METRIC_CLIENT_CREATED:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{clientCreated:n.metric})});case ut.KEY_METRIC_JOIN_START:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{joinStart:n.metric})});case ut.AVOID_JOIN_START:return X(X({},e),{},{avoidJoinStart:n.avoidJoinStart});case ut.KEY_METRIC_JOIN_END:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{joinEnd:n.metric})});case ut.KEY_METRIC_REQUEST_AP_START:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{requestAPStart:n.metric})});case ut.KEY_METRIC_REQUEST_AP_END:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{requestAPEnd:n.metric})});case ut.KEY_METRIC_JOIN_GATEWAY_START:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{joinGatewayStart:n.metric})});case ut.KEY_METRIC_JOIN_GATEWAY_END:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{joinGatewayEnd:n.metric})});case ut.KEY_METRIC_PEER_CONNECTION_START:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{peerConnectionStart:n.metric})});case ut.KEY_METRIC_PEER_CONNECTION_END:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{peerConnectionEnd:n.metric})});case ut.KEY_METRIC_DESCRIPTION_START:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{descriptionStart:n.metric})});case ut.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{signalChannelOpen:n.metric})});case ut.KEY_METRIC_ICE_CONNECTION_END:return X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{iceConnectionEnd:n.metric})});case ut.KEY_METRIC_PUBLISH:{const s=e.keyMetrics.publish,r=s.findIndex(o=>o.trackId===n.metric.trackId);return r!==-1?(s[r]=X(X({},s[r]),n.metric),X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{publish:[...s]})})):X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,n.metric]})})}case ut.KEY_METRIC_SUBSCRIBE:{const s=e.keyMetrics.subscribe,r=s.findIndex(o=>o.userId===n.metric.userId&&o.type===n.metric.type);return r!==-1?(s[r]=X(X({},s[r]),n.metric),X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{subscribe:[...s]})})):X(X({},e),{},{keyMetrics:X(X({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,n.metric]})})}case ut.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=n.mode,e;case ut.RECORD_JOIN_CHANNEL_SERVICE:return typeof n.index!="number"?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,n.record]:(e.joinChannelServiceRecords[n.index]=X(X({},e.joinChannelServiceRecords[n.index]),n.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case ut.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case ut.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case ut.SET_USE_DATACHANNEL:return X(X({},e),{},{useDataChannel:n.val});case ut.SET_USE_P2P:return X(X({},e),{},{useP2P:n.val});case ut.SET_TRANSPORT_TYPE:return X(X({},e),{},{p2pTransport:n.val});default:return e}}(this.state,t)}set sessionId(t){this.dispatch({type:ut.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:ut.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:ut.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:ut.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:ut.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:ut.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:ut.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:ut.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:ut.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:ut.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:ut.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:ut.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:ut.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:ut.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:ut.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:ut.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:ut.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:ut.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:ut.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:ut.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:ut.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:ut.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,e,n,s){this.dispatch({type:ut.KEY_METRIC_PUBLISH,metric:X(X({trackId:t,type:e},n&&{publishStart:n}),s&&{publishEnd:s})})}subscribe(t,e,n,s,r,o,a){this.dispatch({type:ut.KEY_METRIC_SUBSCRIBE,metric:X(X(X(X(X({userId:t,type:e},n&&{subscribeStart:n}),s&&{subscribeEnd:s}),r&&{firstFrame:r}),o&&{streamAdded:o}),a&&{firstDecoded:a})})}massSubscribe(t,e,n,s){t.forEach(r=>{this.dispatch({type:ut.KEY_METRIC_SUBSCRIBE,metric:X(X(X({userId:r.userId,type:r.type},e&&{subscribeStart:e}),n&&{subscribeEnd:n}),s&&{firstFrame:s})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,e){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(n=>n.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof e!="number"?(this.dispatch({type:ut.RECORD_JOIN_CHANNEL_SERVICE,record:X(X({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(e<0||e>=this.state.joinChannelServiceRecords.length||this.dispatch({type:ut.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:e}),e)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:ut.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:ut.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:ut.AVOID_JOIN_START,avoidJoinStart:t})}}var ws,yS;(function(i){i.h264="h264",i.h265="h265",i.vp8="vp8",i.vp9="vp9",i.av1="av1"})(ws||(ws={})),function(i){i.opus="opus",i.pcma="pcma",i.pcmu="pcmu",i.g722="g722"}(yS||(yS={}));const dd=new class extends Wt{reportLogUploadError(i){this.emit("REPORT_LOG_UPLOAD",i)}};class QL{constructor(t){h(this,"logger",void 0),h(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function kh(){const i=new Date;return i.toTimeString().split(" ")[0]+":"+i.getMilliseconds()}function AS(){const i=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+i.getUTCMilliseconds():i.toTimeString().split(" ")[0]+":"+i.getMilliseconds()}const zi={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},ld=Date.now(),_a=i=>{for(const t in zi)if(Object.prototype.hasOwnProperty.call(zi,t)&&zi[t]===i)return t;return"DEFAULT"},E=new class{constructor(){h(this,"proxyServerURL",void 0),h(this,"logLevel",zi.DEBUG),h(this,"uploadState","collecting"),h(this,"uploadLogWaitingList",[]),h(this,"uploadLogUploadingList",[]),h(this,"uploadErrorCount",0),h(this,"currentLogID",0),h(this,"url",void 0),h(this,"extLog",(i,t)=>{this.appendLogToWaitingList(i,...t)})}debug(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];const n=[zi.DEBUG].concat(t);this.log.apply(this,n)}info(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];const n=[zi.INFO].concat(t);this.log.apply(this,n)}warning(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];const n=[zi.WARNING].concat(t);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];const n=[zi.ERROR].concat(t);this.log.apply(this,n)}upload(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];const n=[zi.DEBUG].concat(t);this.uploadLog.apply(this,n)}setLogLevel(i){i=Math.min(Math.max(0,i),4),this.logLevel=i}enableLogUpload(){wt("UPLOAD_LOG",!0)}disableLogUpload(){wt("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(i){this.proxyServerURL=i}prefix(i){return new QL(this).prefix(i)}log(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];if(Date.now()-ld<100)return void setTimeout(()=>{this.log(...t)},Date.now()-ld);const n=Math.max(0,Math.min(4,t[0]));if(t[0]=kh()+" Agora-SDK [".concat(_a(n),"]:"),this.appendLogToWaitingList(n,...t),n<this.logLevel)return;const s=kh()+" %cAgora-SDK [".concat(_a(n),"]:");let r=[];if(!v("USE_NEW_LOG"))switch(n){case zi.DEBUG:r=[s,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,r);break;case zi.INFO:r=[s,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,r);break;case zi.WARNING:r=[s,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,r);break;case zi.ERROR:r=[s,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,r)}}uploadLog(){for(var i=arguments.length,t=new Array(i),e=0;e<i;e++)t[e]=arguments[e];if(Date.now()-ld<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-ld);const n=Math.max(0,Math.min(4,t[0]));t[0]=kh()+" Agora-SDK [".concat(_a(n),"]:"),this.appendLogToWaitingList(n,...t)}appendLogToWaitingList(i){if(!v("UPLOAD_LOG"))return;for(var t=arguments.length,e=new Array(t>1?t-1:0),n=1;n<t;n++)e[n-1]=arguments[n];Array.isArray(e[0])?e[0][0]=AS()+" Agora-SDK [".concat(_a(i),"]:"):e[0]=AS()+" Agora-SDK [".concat(_a(i),"]:");let s="";e.forEach(r=>{typeof r=="object"&&(r=JSON.stringify(r)),s+="".concat(r," ")}),this.uploadLogWaitingList.push({payload_str:s,log_level:i,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const i=this.uploadLogUploadingList,t={sdk_version:Ji,process_id:v("PROCESS_ID"),payload:JSON.stringify(i)};return Cn(async()=>{const e=await hi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(v("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(v("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(e.data!=="OK"){const n=new Error("unexpected upload log response");throw n.response=e,n}},()=>(this.uploadLogUploadingList=[],!1),e=>(e.response?dd.reportLogUploadError({status:e.response.status,data:e.response.data,headers:e.response.headers,message:e.message}):e.request?dd.reportLogUploadError({status:e.request.status,message:e.message}):dd.reportLogUploadError({status:-1,message:e.message}),!0),{timeout:v("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:v("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,v("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_INTERVAL"))}).catch(i=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),v("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var bS,wS;function ZL(i){return Me(i.reportId,"params.reportId",0,100,!1),Me(i.category,"params.category",0,100,!1),Me(i.event,"params.event",0,100,!1),Me(i.label,"params.label",0,100,!1),bt(i.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(function(i){i.FREE="free",i.UPLOADING="uploading"})(bS||(bS={})),function(i){i[i.MISC=0]="MISC",i[i.INTERNAL_EVENT=1]="INTERNAL_EVENT",i[i.PUBLIC_EVENT=2]="PUBLIC_EVENT",i[i.WEB_EVENT=3]="WEB_EVENT",i[i.INTERNAL_API=4]="INTERNAL_API",i[i.WEB_API=5]="WEB_API",i[i.PUBLIC_API=6]="PUBLIC_API"}(wS||(wS={}));const $L={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};var me,Ft,OS,NS;function DS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function ot(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?DS(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):DS(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}(function(i){i.PUBLISH="publish",i.SUBSCRIBE="subscribe",i.WS_COMPRESSOR_INIT="ws_compressor_init",i.SESSION_INIT="session_init",i.JOIN_CHOOSE_SERVER="join_choose_server",i.REQ_USER_ACCOUNT="req_user_account",i.JOIN_GATEWAY="join_gateway",i.REJOIN_GATEWAY="rejoin_gateway",i.STREAM_SWITCH="stream_switch",i.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",i.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",i.FIRST_VIDEO_RECEIVED="first_video_received",i.FIRST_AUDIO_RECEIVED="first_audio_received",i.FIRST_VIDEO_DECODE="first_video_decode",i.FIRST_AUDIO_DECODE="first_audio_decode",i.ON_ADD_AUDIO_STREAM="on_add_audio_stream",i.ON_ADD_VIDEO_STREAM="on_add_video_stream",i.ON_UPDATE_STREAM="on_update_stream",i.ON_REMOVE_STREAM="on_remove_stream",i.USER_ANALYTICS="req_user_analytics",i.PC_STATS="pc_stats",i.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities"})(me||(me={})),function(i){i.SESSION="io.agora.pb.Wrtc.Session",i.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",i.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",i.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",i.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",i.PUBLISH="io.agora.pb.Wrtc.Publish",i.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",i.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",i.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",i.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",i.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",i.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",i.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",i.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",i.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",i.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",i.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",i.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",i.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",i.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",i.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",i.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",i.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",i.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",i.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",i.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",i.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",i.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",i.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",i.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",i.PC_STATS="io.agora.pb.Wrtc.PCStats",i.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities"}(Ft||(Ft={})),function(i){i[i.WORKER_EVENT=156]="WORKER_EVENT",i[i.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}(OS||(OS={})),function(i){i[i.SESSION=26]="SESSION",i[i.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",i[i.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",i[i.JOIN_GATEWAY=28]="JOIN_GATEWAY",i[i.PUBLISH=30]="PUBLISH",i[i.SUBSCRIBE=29]="SUBSCRIBE",i[i.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",i[i.STREAM_SWITCH=32]="STREAM_SWITCH",i[i.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",i[i.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",i[i.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",i[i.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",i[i.API_INVOKE=41]="API_INVOKE",i[i.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",i[i.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",i[i.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",i[i.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",i[i.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",i[i.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",i[i.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",i[i.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",i[i.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",i[i.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",i[i.WORKER_EVENT=156]="WORKER_EVENT",i[i.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",i[i.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",i[i.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",i[i.USER_ANALYTICS=1e4]="USER_ANALYTICS",i[i.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}(NS||(NS={}));class Ea{constructor(){h(this,"baseInfoMap",new Map),h(this,"proxyServer",void 0),h(this,"eventUploadTimer",void 0),h(this,"setSessionIdTimer",void 0),h(this,"url",void 0),h(this,"backupUrl",void 0),h(this,"_appId",void 0),h(this,"keyEventUploadPendingItems",[]),h(this,"normalEventUploadPendingItems",[]),h(this,"apiInvokeUploadPendingItems",[]),h(this,"apiInvokeCount",0),h(this,"ltsList",[]),h(this,"lastSendNormalEventTime",Date.now()),h(this,"customReportCounterTimer",void 0),h(this,"customReportCount",0),h(this,"extApiInvoke",async t=>{for(const e of t){const n=ot(ot({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Yt.TRACER});this.sendApiInvoke(n)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),v("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),v("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void E.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),n=Date.now(),s=e.startTime;e.startTime=n,E.debug("rewrite session ".concat(t," startTime: ").concat(n," , ").concat(n-s,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,n){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const s=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,o=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:s,options:e.options,states:e.states||null}),a=!!v("SHOW_REPORT_INVOKER_LOG");a&&E.info("".concat(e.name," start"),e.options);let c=!1;ye(e.timeout).then(()=>{c||(this.sendApiInvoke(ot(ot({},o()),{},{error:R.API_INVOKE_TIMEOUT,success:!1})),E.debug("".concat(e.name," timeout")))});const d=new M(R.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:l=>{const u=()=>{if(c)throw d;return c=!0,this.sendApiInvoke(ot(ot({},o()),{},{success:!0},e.reportResult&&{result:l})),a&&E.info("".concat(e.name," onSuccess")),l};return n?vT(u,e.name+"Success",n,()=>c=!0):u()},onError:l=>{const u=()=>{if(c)throw l;c=!0,this.sendApiInvoke(ot(ot({},o()),{},{success:!1,error:l})),a&&E.info("".concat(e.name," onFailure"),l.toString())};return n?vT(u,e.name+"Error",n,()=>c=!0):u()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const n=Date.now(),s=this.createBaseInfo(t,n);s.cname=e.cname;const r=Object.assign({},{willUploadConsoleLog:v("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Ph?"global":"oversea",areas:v("AREAS")&&v("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientRole:u}=e,p=Date.now(),_=ot(ot({},s),{},{eventType:me.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,build:Lh,lts:p,elapse:p-n,extend:JSON.stringify(r),mode:e.mode,process:v("PROCESS_ID"),appType:v("APP_TYPE"),success:!0,version:Ji,stringUid:o,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientType:20,clientRole:u,serviceId:v("PROCESS_ID"),extensionID:v("PLUGIN_INFO").join(",")||""});this.send({type:Ft.SESSION,data:_},!0)}joinChooseServer(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.JOIN_CHOOSE_SERVER,lts:r,eventElapse:r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-n.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:Ft.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:r-n.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:Ft.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info;e.vid&&(s.vid=e.vid),s.uid=e.uid,s.cid=e.cid;const r=Date.now(),{firstSuccess:o,avoidJoinStartTime:a,isProxy:c,addr:d}=e,l=r-(o&&a?a:n.startTime),u=ot(ot({},s),{},{eventType:me.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:l,eventElapse:r-e.lts,firstSuccess:o,signalChannel:e.signalChannel}),p=u.success?1:0;if(e.succ&&(n.lastJoinSuccessTime=r),o)this.send({type:Ft.JOIN_GATEWAY,data:u},!0);else{let _;if(d)if(c){const f=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),g=d.match(/p=[0-9]{1,6}/g);_={isSuccess:p,gatewayIp:f&&f.length?f[0].split("=")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split("=")[1]:"",isProxy:c?1:0}}else{const f=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),g=d.match(/(:|p=)[0-9]{1,6}/g);_={isSuccess:p,gatewayIp:f&&f.length?f[0].split("//")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split(/:|p=/g)[1]:"",isProxy:c?1:0}}else _={isSuccess:p,gatewayIp:"",port:"",isProxy:c?1:0};delete u.success,delete u.eventType,delete u.firstSuccess,u.vid=Number(u.vid);const S=Object.assign({},u,_,{eventType:me.REJOIN_GATEWAY});this.send({type:Ft.RE_JOIN_GATEWAY,data:S},!0)}}joinChannelTimeout(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=Date.now(),r=ot(ot({},n.info),{},{lts:s,timeout:e,elapse:s-n.startTime});this.send({type:Ft.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-n.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:Ft.PUBLISH,data:o},!0)}subscribe(t,e,n){const s=this.baseInfoMap.get(t);if(!s)return;const r=s.info,o=Date.now(),a=ot(ot({},r),{},{eventType:me.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-s.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?a.peerSuid=e.peerid:a.peer=e.peerid,this.send({type:Ft.SUBSCRIBE,data:a},!0)}wsCompressorInit(t){var e;const n=[...Di(e=this.baseInfoMap).call(e)],s=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(s);if(!r)return;const o=r.info,a=Date.now(),c=ot(ot({},o),{},{eventType:me.WS_COMPRESSOR_INIT,lts:a,eventElapse:t.eventElapse,elapse:a-r.startTime,status:t.status?1:2});this.send({type:Ft.WS_COMPRESSOR_INIT,data:c},!0)}firstRemoteVideoDecode(t,e,n,s){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,a=Date.now(),c=ot(ot(ot({},o),s),{},{elapse:a-r.startTime,eventType:e,lts:a,firstDecodeFrame:Math.max(a-r.startTime,0),apEnd:Math.max(s.apEnd-r.startTime,0),apStart:Math.max(s.apStart-r.startTime,0),joinGwEnd:Math.max(s.joinGwEnd-r.startTime,0),joinGwStart:Math.max(s.joinGwStart-r.startTime,0),pcEnd:Math.max(s.pcEnd-r.startTime,0),pcStart:Math.max(s.pcStart-r.startTime,0),subscriberEnd:Math.max(s.subscriberEnd-r.startTime,0),subscriberStart:Math.max(s.subscriberStart-r.startTime,0),videoAddNotify:Math.max(s.videoAddNotify-r.startTime,0)});this.send({type:n,data:c},!0)}firstRemoteFrame(t,e,n,s){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,a=Date.now(),c=ot(ot(ot({},o),s),{},{elapse:a-r.startTime,eventType:e,lts:a});this.send({type:n,data:c},!0)}pcStats(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot(ot({},s),e),{},{vid:s.vid===void 0?0:Number(s.vid),elapse:r-n.startTime,eventType:me.PC_STATS,lts:r});this.send({type:Ft.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot(ot({},s),e),{},{vid:s.vid===void 0?0:Number(s.vid),eventType:me.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Ft.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,n,s){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,a=Date.now(),c=ot(ot(ot({},o),s),{},{eventType:e,lts:a});this.send({type:n,data:c},!0)}streamSwitch(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-n.startTime,success:e.succ});this.send({type:Ft.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ft.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{eventType:me.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:Ft.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?E.debug("reportProxyServerurl: ".concat(t)):E.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot({},s),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:Ft.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now();(function(a,c,d){const l=a[c];if(!l||typeof l!="string")return[a];a[c]="";const u=Mn(JSON.stringify(a));let p=0;const _=[];let S=0;for(let f=0;f<l.length;f++)S+=l.charCodeAt(f)<=127?1:3,S<=d-u||(_[_.length]=_r(_r({},a),{},{[c]:l.substring(p,f)}),p=f,S=l.charCodeAt(f)<=127?1:3);return p!==l.length-1&&(_[_.length]=_r(_r({},a),{},{[c]:l.substring(p)})),_})(ot(ot(ot({},s),e),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(a=>this.send({type:Ft.WORKER_EVENT,data:a},!0))}apworkerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot(ot({},s),e),{},{elapse:r-n.startTime,lts:r});this.send({type:Ft.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot(ot({},s),e),{},{elapse:r-n.startTime,lts:r,extend:e.extend||void 0});this.send({type:Ft.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const s=n.info,r=Date.now(),o=ot(ot(ot({},s),e),{},{elapse:r-n.startTime,lts:r});this.send({type:Ft.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>v("CUSTOM_REPORT_LIMIT"))throw new M(R.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const n=Date.now(),s=e.map(r=>({type:Ft.USER_ANALYTICS,data:ot(ot({sid:t},r),{},{lts:n})}));try{v("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(s):await this.postDataToStatsCollector(s)}catch(r){throw E.error("send custom report message failed",r.toString()),new M(R.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(t){const e=v("NOT_REPORT_EVENT");if(t.tag&&q(e)&&q(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const n=this.baseInfoMap.get(t.sid);if(!n)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:s,uid:r,cid:o}=n.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof M){const{code:d,message:l}=t.error;a=d||l||t.error.toString()}else a=t.error.toString();const c={invokeId:t.invokeId,sid:t.sid,cname:s,cid:o,uid:r,lts:t.lts,success:t.success,elapse:t.lts-n.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Ft.API_INVOKE,data:c},!1),!0}appendSessionId(){Ea.__CLIENT_LIST__.forEach(t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let n=0;n<e;n++){const s=this.apiInvokeUploadPendingItems.shift();s&&(s.sid=t._sessionId,this.sendApiInvoke(Object.assign({},s)))}}})}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>v("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const n=[],s=[];for(;t.length;){const o=t.shift();n.length<20?n.push(o):s.push(o)}t.push(...s);for(const o of[...n]){var r;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),ta(r=this.ltsList).call(r,(a,c)=>a-c))}return e||(this.lastSendNormalEventTime=Date.now()),v("ENABLE_EVENT_REPORT")&&n.length&&(v("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((o=>a=>{v("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>v("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-v("NORMAL_EVENT_QUEUE_CAPACITY")),E.warning("report: drop normal events"))))})(n)),t}async postDataToStatsCollector2(t){oe.networkState===Ze.OFFLINE&&await P.race([oe.onlineWaiter,ye(2*ae.maxRetryTimeout)]);const e=r=>{let o=new Uint8Array;return r.forEach(a=>{const c=ah(JSON.stringify(a.data)),d=new ArrayBuffer(5),l=(p=>{let _=0;return Object.entries(Ft).forEach(S=>{let[f,g]=S;g===p.type&&(_=EventNameToID[f])}),_})(a),u=new DataView(d);u.setUint16(0,c.byteLength,!0),u.setUint8(2,255&l),u.setUint8(3,l>>>8&255),u.setUint8(4,l>>>16&255),o=ET(o,new Uint8Array(d)),o=ET(o,c)}),o},n="event";let s=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(v("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){r===1&&(s=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(v("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await Dh(s,{timeout:1e4,data:e(t),headers:ot(ot({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(r===1)throw o;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(o=>JSON.stringify(o)),vid:(o=>{const a=o&&o.data.sid&&this.baseInfoMap.get(o.data.sid);return a&&a.info.vid&&+a.info.vid||0})(t[0])};oe.networkState===Ze.OFFLINE&&await P.race([oe.onlineWaiter,ye(2*ae.maxRetryTimeout)]);const s=e?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("EVENT_REPORT_DOMAIN"),"&p=").concat(v("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(v("EVENT_REPORT_DOMAIN"),":").concat(v("STATS_COLLECTOR_PORT")).concat(s));for(let o=0;o<2;o+=1){o===1&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(v("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(v("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(v("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(v("STATS_COLLECTOR_PORT")).concat(s)));try{e?await JL(r,{timeout:1e4,data:n}):await Dh(r,{timeout:1e4,data:n})}catch(a){if(o===1)throw a;continue}return}}createBaseInfo(t,e){const n=Object.assign({},$L);return n.sid=t,this.baseInfoMap.set(t,{info:n,startTime:e}),n}reportResourceTiming(t,e){const n=performance.getEntriesByName(t),s=n[n.length-1];s&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:s,tag:Yt.TRACER}).onSuccess()}}function $(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,e,n){const s=n.value;if(typeof s=="function"){const r=i.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);n.value=function(){for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];let d=a;if(i.argsMap)try{d=i.argsMap(this,...a)}catch(u){E.warning(u),d=[]}try{JSON.stringify(d)}catch{E.warning("arguments for method ".concat(r,".").concat(String(e)," not serializable for apiInvoke.")),d=[]}const l=(i.report||z).reportApiInvoke(this._sessionId||null,{name:"".concat(r,".").concat(String(e)),options:d,tag:Yt.TRACER,reportResult:i.reportResult},i.throttleTime);try{const u=s.apply(this,a);return u instanceof P?u.then(p=>(l.onSuccess(i.reportResult&&p),p)).catch(p=>{throw l.onError(p),p}):(l.onSuccess(i.reportResult&&u),u)}catch(u){throw l.onError(u),u}}}return n}}h(Ea,"__CLIENT_LIST__",[]);const z=new Ea;dd.on("REPORT_LOG_UPLOAD",i=>{i.networkState=oe.networkState,z.reportApiInvoke(null,{name:"logUploadError",options:i,tag:Yt.TRACER})});const tk=["CHINA","GLOBAL"],ni=function(){const i="us".concat("erna","me"),t="pa".concat("sswo","rd"),e=["t","s","t"];e.splice(1,0,"e");const n=e.join(""),s=[];for(let a=0;a<6;a++)s.push("1");const r=s.join(""),o={};return o[i]=n,o[t]=r,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=ni,Ph||(ii.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ii.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ii.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ii.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ii.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ii.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ii.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ii.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ii.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ii.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ii.AREAS=["NORTH_AMERICA","OVERSEA"]);const PS=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Os=[];function gr(i,t){return!!t&&Os.some(e=>e.uid===i&&e.channelName===t)}Ea.__CLIENT_LIST__=Os;var Mh,pi,_o,ma,Li,We,Z,lt,H,Q,is,nt,LS,He,et,fe,Ns,ek=Ts("Array").values,ik=or,nk=ui,sk=rn,rk=ek,Uh=Array.prototype,ok={DOMTokenList:!0,NodeList:!0},In=xt(function(i){var t=i.values;return i===Uh||sk(Uh,i)&&t===Uh.values||nk(ok,ik(i))?rk:t});function U(i,t,e,n){var s,r=arguments.length,o=r<3?t:n===null?n=Object.getOwnPropertyDescriptor(t,e):n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(i,t,e,n);else for(var a=i.length-1;a>=0;a--)(s=i[a])&&(o=(r<3?s(o):r>3?s(t,e,o):s(t,e))||o);return r>3&&o&&Object.defineProperty(t,e,o),o}function T(i,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(i,t)}(function(i){i.L1T1="L1T1",i.L1T2="L1T2",i.L1T3="L1T3",i.L2T1_KEY="L2T1_KEY",i.L2T2_KEY="L2T2_KEY",i.L2T3_KEY="L2T3_KEY",i.L3T1_KEY="L3T1_KEY",i.L3T2_KEY="L3T2_KEY",i.L3T3_KEY="L3T3_KEY"})(Mh||(Mh={})),function(i){i.CERTIFICATE="certificate",i.CODEC="codec",i.CANDIDATE_PAIR="candidate-pair",i.LOCAL_CANDIDATE="local-candidate",i.REMOTE_CANDIDATE="remote-candidate",i.INBOUND="inbound-rtp",i.TRACK="track",i.OUTBOUND="outbound-rtp",i.PC="peer-connection",i.REMOTE_INBOUND="remote-inbound-rtp",i.REMOTE_OUTBOUND="remote-outbound-rtp",i.TRANSPORT="transport",i.CSRC="csrc",i.DATA_CHANNEL="data-channel",i.STREAM="stream",i.SENDER="sender",i.RECEIVER="receiver"}(pi||(pi={})),function(i){i[i.ACCESS_POINT=101]="ACCESS_POINT",i[i.UNILBS=201]="UNILBS",i[i.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(_o||(_o={})),function(i){i[i.IIIEGAL_APPID=1]="IIIEGAL_APPID",i[i.IIIEGAL_UID=2]="IIIEGAL_UID",i[i.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(ma||(ma={})),function(i){i[i.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",i[i.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",i[i.INTERNAL_ERROR=8]="INTERNAL_ERROR",i[i.NO_AUTHORIZED=9]="NO_AUTHORIZED",i[i.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",i[i.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",i[i.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",i[i.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",i[i.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",i[i.USER_OVERLOAD=16]="USER_OVERLOAD",i[i.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",i[i.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(Li||(Li={})),function(i){i[i.NO_FLAG_SET=100]="NO_FLAG_SET",i[i.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",i[i.INVALID_FALG_SET=102]="INVALID_FALG_SET",i[i.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",i[i.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",i[i.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",i[i.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",i[i.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",i[i.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",i[i.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",i[i.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",i[i.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",i[i.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",i[i.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",i[i.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",i[i.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",i[i.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",i[i.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",i[i.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(We||(We={})),function(i){i[i.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",i[i.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",i[i.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",i[i.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",i[i.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",i[i.K_TICKET_INVALID=7]="K_TICKET_INVALID",i[i.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",i[i.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",i[i.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",i[i.K_UID_BANNED=14]="K_UID_BANNED",i[i.K_IP_BANNED=15]="K_IP_BANNED",i[i.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",i[i.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",i[i.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",i[i.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",i[i.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",i[i.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",i[i.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",i[i.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",i[i.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",i[i.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",i[i.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",i[i.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",i[i.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",i[i.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",i[i.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",i[i.ERR_INVALID_UID=117]="ERR_INVALID_UID",i[i.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",i[i.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",i[i.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",i[i.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",i[i.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",i[i.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",i[i.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",i[i.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",i[i.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",i[i.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",i[i.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",i[i.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",i[i.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",i[i.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",i[i.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",i[i.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",i[i.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",i[i.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",i[i.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",i[i.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",i[i.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",i[i.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",i[i.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",i[i.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",i[i.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",i[i.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",i[i.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",i[i.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",i[i.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",i[i.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",i[i.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",i[i.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",i[i.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",i[i.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",i[i.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",i[i.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",i[i.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(Z||(Z={})),function(i){i.CONNECTING="connecting",i.CONNECTED="connected",i.RECONNECTING="reconnecting",i.CLOSED="closed"}(lt||(lt={})),function(i){i.WS_CONNECTED="ws_connected",i.WS_RECONNECTING="ws_reconnecting",i.WS_CLOSED="ws_closed",i.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",i.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",i.ON_BINARY_DATA="on_binary_data",i.REQUEST_RECOVER="request_recover",i.REQUEST_JOIN_INFO="request_join_info",i.REQUEST_REJOIN_INFO="req_rejoin_info",i.IS_P2P_DISCONNECTED="is_p2p_dis",i.DISCONNECT_P2P="dis_p2p",i.ABORT_P2P_EXECUTION="abort_p2p_execution",i.NEED_RENEW_SESSION="need-sid",i.REPORT_JOIN_GATEWAY="report_join_gateway",i.REQUEST_TIMEOUT="request_timeout",i.REQUEST_SUCCESS="request_success",i.JOIN_RESPONSE="join_response",i.DATACHANNEL_PRECONNECT="datachannel_preconnect",i.DATACHANNEL_CONNECTING="datachannel_connecting",i.DATACHANNEL_FAILBACK="datachannel_failback",i.P2P_CONNECTION="p2p_connection",i.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",i.P2P_SUBSCRIBE="p2p_subscribe",i.P2P_UNSUBSCRIBE="p2p_unsubscribe",i.P2P_EXCHANGE_SDP="p2p_exchange_sdp",i.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",i.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(H||(H={})),function(i){i.PING="ping",i.PING_BACK="ping_back",i.JOIN="join_v3",i.REJOIN="rejoin_v3",i.LEAVE="leave",i.SET_CLIENT_ROLE="set_client_role",i.PUBLISH="publish",i.PUBLISH_DATASTREAM="publish_datastream",i.UNPUBLISH="unpublish",i.UNPUBLISH_DATASTREAM="unpublish_datastream",i.SUBSCRIBE="subscribe",i.PRE_SUBSCRIBE="pre_subscribe",i.SUBSCRIBE_DATASTREAM="subscribe_datastream",i.SUBSCRIBE_STREAMS="subscribe_streams",i.UNSUBSCRIBE="unsubscribe",i.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",i.UNSUBSCRIBE_STREAMS="unsubscribe_streams",i.SUBSCRIBE_CHANGE="subscribe_change",i.TRAFFIC_STATS="traffic_stats",i.RENEW_TOKEN="renew_token",i.SWITCH_VIDEO_STREAM="switch_video_stream",i.DEFAULT_VIDEO_STREAM="default_video_stream",i.SET_FALLBACK_OPTION="set_fallback_option",i.GATEWAY_INFO="gateway_info",i.CONTROL="control",i.SEND_METADATA="send_metadata",i.DATA_STREAM="data_stream",i.PICK_SVC_LAYER="pick_svc_layer",i.RESTART_ICE="restart_ice",i.CONNECT_PC="connect_pc",i.SET_VIDEO_PROFILE="set_video_profile",i.SET_PARAMETER="set_parameter",i.SET_RTM2_FLAG="set_rtm2_flag"}(Q||(Q={})),function(i){i.WRTC_STATS="wrtc_stats",i.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",i.DENOISER_STATS="denoiser_stats",i.EXTENSION_USAGE_STATS="extension_usage_stats"}(is||(is={})),function(i){i.ON_USER_ONLINE="on_user_online",i.ON_USER_OFFLINE="on_user_offline",i.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",i.ON_PUBLISH_STREAM="on_publish_stream",i.ON_UPLINK_STATS="on_uplink_stats",i.ON_P2P_LOST="on_p2p_lost",i.ON_REMOVE_STREAM="on_remove_stream",i.ON_ADD_AUDIO_STREAM="on_add_audio_stream",i.ON_ADD_VIDEO_STREAM="on_add_video_stream",i.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",i.ON_USER_BANNED="on_user_banned",i.ON_USER_LICENSE_BANNED="on_user_license_banned",i.ON_NOTIFICATION="on_notification",i.ON_CRYPT_ERROR="on_crypt_error",i.MUTE_AUDIO="mute_audio",i.MUTE_VIDEO="mute_video",i.UNMUTE_AUDIO="unmute_audio",i.UNMUTE_VIDEO="unmute_video",i.ON_P2P_OK="on_p2p_ok",i.RECEIVE_METADATA="receive_metadata",i.ON_DATA_STREAM="on_data_stream",i.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",i.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",i.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",i.ENABLE_LOCAL_VIDEO="enable_local_video",i.DISABLE_LOCAL_VIDEO="disable_local_video",i.ENABLE_LOCAL_AUDIO="enable_local_audio",i.DISABLE_LOCAL_AUDIO="disable_local_audio",i.ON_PUBLISHED_USER_LIST="on_published_user_list"}(nt||(nt={})),function(i){i.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",i.NEED_ANSWER="NEED_ANSWER",i.NEED_RENEGOTIATE="NEED_RENEGOTIATE",i.P2P_LOST="P2P_LOST",i.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",i.NEED_UNPUB="NEED_UNPUB",i.NEED_UNSUB="NEED_UNSUB",i.NEED_UPLOAD="NEED_UPLOAD",i.NEED_CONTROL="NEED_CONTROL",i.START_RECONNECT="START_RECONNECT",i.END_RECONNECT="END_RECONNECT",i.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(LS||(LS={})),function(i){i.SEND_ONLY="SEND_ONLY",i.RECEIVE_ONLY="RECEIVE_ONLY"}(He||(He={})),function(i){i.CONNECTED="websocket:connected",i.RECONNECTING="websocket:reconnecting",i.WILL_RECONNECT="websocket:will_reconnect",i.CLOSED="websocket:closed",i.FAILED="websocket:failed",i.ON_MESSAGE="websocket:on_message",i.REQUEST_NEW_URLS="websocket:request_new_urls",i.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",i.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(et||(et={}));class w extends M{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),h(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,E)}throw(){super.throw(E)}}function xh(i){if(typeof i!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(i))throw E.error("Invalid Channel Name ".concat(i)),new w(R.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Vh(i){if(t=i,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||uT(i,1,255)))throw new w(R.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof i=="string"&&E.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}(function(i){i.TRANSCODE="mix_streaming",i.RAW="raw_streaming",i.INJECT="inject_streaming"})(fe||(fe={})),function(i){i[i.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",i[i.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",i[i.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",i[i.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",i[i.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",i[i.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",i[i.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",i[i.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",i[i.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",i[i.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",i[i.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(Ns||(Ns={}));const ak={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Fh={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Bh(i,t){Me(i.url,"".concat(t,".url"),1,1e3,!1),Kt(i.x)||bt(i.x,"".concat(t,".x"),0,1e4),Kt(i.y)||bt(i.y,"".concat(t,".y"),0,1e4),Kt(i.width)||bt(i.width,"".concat(t,".width"),0,1e4),Kt(i.height)||bt(i.height,"".concat(t,".height"),0,1e4),Kt(i.zOrder)||bt(i.zOrder,"".concat(t,".zOrder"),0,255),Kt(i.alpha)||bt(i.alpha,"".concat(t,".alpha"),0,1,!1)}const ck={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},dk={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var dn,Eo,ne,kS,Ke,vn,si,Ds,St,qt,Tr,ue,ud,mt;function MS(i){if(!i.channelName)throw new w(R.INVALID_PARAMS,"invalid channelName in info");if(typeof i.uid!="number")throw new w(R.INVALID_PARAMS,"invalid uid in info, uid must be a number");return i.token&&Me(i.token,"info.token",1,2047),Vh(i.uid),xh(i.channelName),!0}(function(i){i.WARNING="@live_uap-warning",i.ERROR="@line_uap-error",i.PUBLISH_STREAM_STATUS="@live_uap-publish-status",i.INJECT_STREAM_STATUS="@live_uap-inject-status",i.WORKER_STATUS="@live_uap-worker-status",i.REQUEST_NEW_ADDRESS="@live_uap-request-address"})(dn||(dn={})),function(i){i.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(Eo||(Eo={})),function(i){i[i.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",i[i.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",i[i.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",i[i.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",i[i.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",i[i.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",i[i.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",i[i.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",i[i.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",i[i.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",i[i.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",i[i.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",i[i.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",i[i.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",i[i.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",i[i.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",i[i.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",i[i.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",i[i.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(ne||(ne={})),function(i){i.CONNECT_FAILED="connect failed",i.CONNECT_TIMEOUT="connect timeout",i.WS_DISCONNECTED="websocket disconnected",i.REQUEST_TIMEOUT="request timeout",i.REQUEST_FAILED="request failed",i.WAIT_STATUS_TIMEOUT="wait status timeout",i.WAIT_STATUS_ERROR="wait status error",i.BAD_STATE="bad state",i.WS_ABORT="ws abort",i.AP_REQUEST_TIMEOUT="AP request timeout",i.AP_JSON_PARSE_ERROR="AP json parse error",i.AP_REQUEST_ERROR="AP request error",i.AP_REQUEST_ABORT="AP request abort"}(kS||(kS={})),function(i){i[i.SetSdkProfile=0]="SetSdkProfile",i[i.SetSourceChannel=1]="SetSourceChannel",i[i.SetSourceUserId=2]="SetSourceUserId",i[i.SetDestChannel=3]="SetDestChannel",i[i.StartPacketTransfer=4]="StartPacketTransfer",i[i.StopPacketTransfer=5]="StopPacketTransfer",i[i.UpdateDestChannel=6]="UpdateDestChannel",i[i.Reconnect=7]="Reconnect",i[i.SetVideoProfile=8]="SetVideoProfile"}(Ke||(Ke={})),function(i){i.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",i.NETWORK_CONNECTED="NETWORK_CONNECTED",i.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",i.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",i.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",i.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",i.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",i.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",i.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",i.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(vn||(vn={})),function(i){i.RELAY_STATE_IDLE="RELAY_STATE_IDLE",i.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",i.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",i.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(si||(si={})),function(i){i.RELAY_OK="RELAY_OK",i.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",i.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",i.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Ds||(Ds={})),function(i){i.High="high",i.Low="low",i.Audio="audio",i.Screen="screen",i.ScreenLow="screen_low"}(St||(St={})),function(i){i.DISCONNECT="disconnect",i.CONNECTION_STATE_CHANGE="connection-state-change",i.NETWORK_QUALITY="network-quality",i.STREAM_TYPE_CHANGE="stream-type-change",i.IS_P2P_DISCONNECTED="is-p2p-dis",i.DISCONNECT_P2P="dis-p2p",i.REQUEST_NEW_GATEWAY_LIST="req-gate-url",i.NEED_RENEW_SESSION="need-sid",i.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",i.JOIN_RESPONSE="join-response",i.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",i.RESET_CONNECTION_EVENTS="reset-connection-events",i.DATACHANNEL_PRECONNECT="datachannel_preconnect",i.DATACHANNEL_FAILBACK="datachannel_failback",i.RESET_SIGNAL="reset-signal"}(qt||(qt={})),function(i){i.P2P_DISCONNECTED="P2P_DISCONNECTED",i.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",i.TIMEOUT="TIMEOUT",i.UNKNOWN_REASON="UNKNOWN_REASON"}(Tr||(Tr={})),function(i){i[i.Nothing=0]="Nothing",i[i.Audio=1]="Audio",i[i.LwoVideo=2]="LwoVideo",i[i.Video=4]="Video",i[i.Data=8]="Data",i[i.DataStream0=256]="DataStream0",i[i.DataStream1=512]="DataStream1",i[i.DataStream2=1024]="DataStream2",i[i.DataStream3=2048]="DataStream3",i[i.DataStream4=4096]="DataStream4",i[i.DataStream5=8192]="DataStream5",i[i.DataStream6=16384]="DataStream6",i[i.DataStream7=32768]="DataStream7"}(ue||(ue={})),function(i){i[i.websocket=0]="websocket",i[i.datachannel=1]="datachannel"}(ud||(ud={})),function(i){i.CHINA="CHINA",i.ASIA="ASIA",i.NORTH_AMERICA="NORTH_AMERICA",i.EUROPE="EUROPE",i.JAPAN="JAPAN",i.INDIA="INDIA",i.KOREA="KOREA",i.HKMC="HKMC",i.US="US",i.OCEANIA="OCEANIA",i.SOUTH_AMERICA="SOUTH_AMERICA",i.AFRICA="AFRICA",i.OVERSEA="OVERSEA",i.GLOBAL="GLOBAL",i.EXTENSIONS="EXTENSIONS"}(mt||(mt={}));const US=[mt.AFRICA,mt.ASIA,mt.CHINA,mt.EUROPE,mt.GLOBAL,mt.INDIA,mt.JAPAN,mt.NORTH_AMERICA,mt.OCEANIA,mt.OVERSEA,mt.SOUTH_AMERICA];var Pe;(function(i){i.CHINA="CN",i.ASIA="AS",i.NORTH_AMERICA="NA",i.EUROPE="EU",i.JAPAN="JP",i.INDIA="IN",i.KOREA="KR",i.HKMC="HK",i.US="US",i.OCEANIA="OC",i.SOUTH_AMERICA="SA",i.AFRICA="AF",i.OVERSEA="OVERSEA",i.GLOBAL="GLOBAL",i.EXTENSIONS="GLOBAL"})(Pe||(Pe={}));const hd={CHINA:{},ASIA:{CODE:Pe.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Pe.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Pe.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Pe.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Pe.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Pe.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Pe.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Pe.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Pe.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Pe.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Pe.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Pe.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Pe.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var fa,xS,J,Ue,yn,V,vt,tt,VS,ki,Mi,ge,Un,$t,ln,FS,Ii,Xi,Ps,Jt,Ls,xn,BS,jh;Ph&&(hd.CHINA={CODE:Pe.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(i){i.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(fa||(fa={}));class jS extends Wt{constructor(t,e){super(),h(this,"onICEConnectionStateChange",void 0),h(this,"onConnectionStateChange",void 0),h(this,"onDTLSTransportStateChange",void 0),h(this,"onDTLSTransportError",void 0),h(this,"onICETransportStateChange",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoReceived",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0)}}class pd extends jS{constructor(t,e){super(t,e)}}(function(i){i.SEND="sendonly",i.RECV="recvonly",i.SENDRECV="sendrecv",i.INACTIVE="inactive"})(xS||(xS={})),function(i){i.VIDEO="video",i.AUDIO="audio"}(J||(J={})),function(i){i[i.UDP=0]="UDP",i[i.TCP=1]="TCP",i[i.RELAY=2]="RELAY"}(Ue||(Ue={})),function(i){i[i.FIRST_CONNECTION=0]="FIRST_CONNECTION",i[i.TCP_RESTART=1]="TCP_RESTART",i[i.RELAY_RESTART=2]="RELAY_RESTART",i[i.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",i[i.OLD_RESTART=11]="OLD_RESTART",i[i.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(yn||(yn={})),function(i){i.LocalVideoTrack="videoTrack",i.LocalAudioTrack="audioTrack",i.LocalVideoLowTrack="videoLowTrack"}(V||(V={})),function(i){i.New="new",i.Connected="connected",i.Reconnecting="reconnecting",i.Disconnected="disconnected"}(vt||(vt={})),function(i){i.StateChange="stateChange",i.IceConnectionStateChange="iceConnectionStateChange",i.RequestMuteLocal="requestMuteLocal",i.RequestUnmuteLocal="requestUnmuteLocal",i.RequestRePublish="requestRePublish",i.RequestRePublishDataChannel="requestRePublishDataChannel",i.RequestReSubscribe="requestReSubscribe",i.RequestUploadStats="requestUploadStats",i.RequestUpload="requestUpload",i.MediaReconnectStart="MediaReconnectStart",i.MediaReconnectEnd="MediaReconnectEnd",i.NeedSignalRTT="NeedSignalRTT",i.RequestRestartICE="RequestRestartIce",i.PeerConnectionStateChange="PeerConnectionStateChange",i.RequestReconnect="RequestReconnect",i.RequestReconnectPC="RequestReconnectPC",i.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",i.P2PLost="P2PLost",i.UpdateVideoEncoder="UpdateVideoEncoder",i.ConnectionTypeChange="ConnectionTypeChange",i.RequestLowStreamParameter="RequestLowStreamParameter",i.QueryClientConnectionState="QueryClientConnectionState",i.LocalCandidate="LocalCandidate",i.RequestP2PMuteLocal="requestP2PMuteLocal",i.RequestP2PUnPublish="RequestP2PUnPublish",i.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",i.RequestP2PMuteRemote="RequestP2PMuteRemote",i.RequestP2PRestartICE="RequestP2PRestartICE"}(tt||(tt={})),function(i){i.MUTE_LOCAL_VIDEO="mute_local_video",i.MUTE_LOCAL_AUDIO="mute_local_audio",i.UNMUTE_LOCAL_VIDEO="unmute_local_video",i.UNMUTE_LOCAL_AUDIO="unmute_local_audio",i.MUTE_REMOTE_VIDEO="mute_remote_video",i.MUTE_REMOTE_AUDIO="mute_remote_audio",i.UNMUTE_REMOTE_VIDEO="unmute_remote_video",i.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(VS||(VS={})),function(i){i.CONNECTING="CONNECTING",i.RECONNECTING="RECONNECTING",i.CONNECTED="CONNECTED",i.CLOSED="CLOSED"}(ki||(ki={})),function(i){i[i.CONNECT_AP=0]="CONNECT_AP",i[i.AP_CONNECTED=1]="AP_CONNECTED",i[i.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",i[i.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",i[i.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",i[i.CONNECT_WORKER=5]="CONNECT_WORKER",i[i.WORKER_CONNECTED=6]="WORKER_CONNECTED",i[i.CLOSED=7]="CLOSED"}(Mi||(Mi={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.STATE_CHANGE="state-change",i.INSPECT_RESULT="inspect-result",i.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",i.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(ge||(ge={})),function(i){i.NETWORK_ERROR="NETWORK_ERROR",i.SERVER_ERROR="SERVER_ERROR",i.MULTI_IP="MULTI_IP",i.TIMEOUT="TIMEOUT",i.OFFLINE="OFFLINE",i.LEAVE="LEAVE",i.P2P_FAILED="P2P_FAILED",i.FALLBACK="FALLBACK"}(Un||(Un={})),function(i){i.CONNECTED="transmitter:connected",i.RECONNECTING="transmitter:reconnecting",i.WILL_RECONNECT="transmitter:will_reconnect",i.CLOSED="transmitter:closed",i.FAILED="transmitter:failed",i.ON_MESSAGE="transmitter:on_message",i.REQUEST_NEW_URLS="transmitter:request_new_urls",i.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",i.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",i.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",i.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",i.FAILBACK="transmitter:failback"}($t||($t={})),function(i){i.CAMERA_CHANGED="camera-changed",i.MICROPHONE_CHANGED="microphone-changed",i.PLAYBACK_DEVICE_CHANGED="playback-device-changed",i.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",i.AUTOPLAY_FAILED="autoplay-failed",i.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",i.SECURITY_POLICY_VIOLATION="security-policy-violation"}(ln||(ln={})),function(i){i[i.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",i[i.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",i[i.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",i[i.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",i[i.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",i[i.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",i[i.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",i[i.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",i[i.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",i[i.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",i[i.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",i[i.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",i[i.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",i[i.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",i[i.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",i[i.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",i[i.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",i[i.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",i[i.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",i[i.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(FS||(FS={})),function(i){i.CONNECTING="CONNECTING",i.RECONNECTING="RECONNECTING",i.CONNECTED="CONNECTED",i.CLOSED="CLOSED"}(Ii||(Ii={})),function(i){i.CONNECTION_STATE_CHANGE="connection-state-change",i.STATE_CHANGE="state-change",i.INSPECT_RESULT="inspect-result",i.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",i.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Xi||(Xi={})),function(i){i[i.CONNECT_AP=0]="CONNECT_AP",i[i.AP_CONNECTED=1]="AP_CONNECTED",i[i.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",i[i.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",i[i.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",i[i.CONNECT_WORKER=5]="CONNECT_WORKER",i[i.WORKER_CONNECTED=6]="WORKER_CONNECTED",i[i.CLOSED=7]="CLOSED"}(Ps||(Ps={})),function(i){i.CALL="call",i.CANDIDATE="candidate",i.PUBLISH="publish",i.UNPUBLISH="unpublish",i.CONTROL="control",i.RESTART_ICE="restart_ice",i.ACK="ack",i.RESPONSE="response",i.JOIN="join",i.CHECK="check"}(Jt||(Jt={})),function(i){i.ABORT="abort"}(Ls||(Ls={})),function(i){i.MUTE_LOCAL_AUDIO="mute_local_audio",i.MUTE_LOCAL_VIDEO="mute_local_video",i.UNMUTE_LOCAL_AUDIO="unmute_local_audio",i.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(xn||(xn={})),function(i){i[i.SUCCESS=1]="SUCCESS",i[i.FAILED=0]="FAILED"}(BS||(BS={})),function(i){i.P2P_TOKEN_TIMEOUT="p2p_token_timeout",i.P2P_TOKEN_CHANGED="p2p_token_changed"}(jh||(jh={}));const lk={[_o.ACCESS_POINT]:{[We.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[We.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[We.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[We.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[We.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[We.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[We.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[We.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[We.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[We.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[We.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[We.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[We.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[We.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[We.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[We.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[We.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[We.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[_o.UNILBS]:{[Li.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Li.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Li.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Li.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Li.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Li.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Li.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Li.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Li.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Li.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Li.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Li.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[_o.STRING_UID_ALLOCATOR]:{[ma.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ma.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ma.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function _d(i){const t=lk[Math.floor(i/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const e=t[i%1e4];if(!e){if(Math.floor(i/1e4)===_o.ACCESS_POINT){const n=i%1e4;if(n.toString()[0]==="1")return{desc:i.toString(),retry:!1};if(n.toString()[0]==="2")return{desc:i.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return e}const uk={[Z.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Z.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Z.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Z.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Z.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Z.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Z.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Z.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Z.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Z.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Z.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Z.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Z.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Z.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Z.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Z.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Z.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Z.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Z.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Z.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Z.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Z.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Z.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Z.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Z.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Z.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Z.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Z.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Z.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Z.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Z.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Z.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Z.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Z.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Z.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Z.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Z.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Z.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Z.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Z.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Z.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Z.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Z.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Z.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Z.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Z.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Z.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Z.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Z.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Z.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Z.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Z.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Z.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Z.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Z.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Z.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Z.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Z.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Z.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Z.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Z.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Z.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Z.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Sr(i){return uk[i]||{desc:"UNKNOW_ERROR_".concat(i),action:"failed"}}function GS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Gh(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?GS(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):GS(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function WS(i){return i.every(t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)}function HS(i,t){if(typeof i=="string")return i;const{proxy:e,host:n,port:s}=i;if(t){const r=v("JOIN_GATEWAY_FALLBACK_PORT")||443;return r===443?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(r,"/ws/?p=").concat(Number(s)+150)}return e?"wss://".concat(e,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const hk=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,pk=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,_k=/wss:\/\/(.+):([0-9]+)\/?/,Ek=/wss:\/\/(.[^\/]+)\/?/;let mk=0;class fk{constructor(t,e){h(this,"id",0),h(this,"store",void 0),h(this,"recordIndex",void 0),h(this,"websockets",[]),h(this,"try443PortDuration",2e3),h(this,"forceCloseWSDuration",5e3),h(this,"try443PortTimeout",null),h(this,"forceCloseTimeout",null),h(this,"isTry443PortFailed",!1),h(this,"isNormalPortFailed",!1),h(this,"useDoubleDomain",!1),h(this,"useProxy",!1),h(this,"startTime",Date.now()),this.id=++mk,this.try443PortDuration=v("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=e}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;const e=Date.now()-this.startTime;for(var n=arguments.length,s=new Array(n),r=0;r<n;r++)s[r]=arguments[r];E.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(e,"ms:"),...s)}createWebSocket(t,e,n){this.logger("createWebSocket:",t,{isTry443Port:e,hasTimeoutDetection:n});const s=v("GATEWAY_DOMAINS"),r=Date.now(),o=[],a=s.find(l=>{var u;return q(u=t.host).call(u,l)});a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)s.forEach(l=>{c.push(HS(Gh(Gh({},t),{},{host:t.host.replace(a,l)}),e))});else{const l=Gh({},t);if(e&&a){const u=s.find(p=>p!==a);u&&(l.host=l.host.replace(a,u))}c.push(HS(l,e))}try{c.forEach(l=>{const u=new WebSocket(l);u.binaryType="arraybuffer",o.push(u),this.logger("ws is connecting:",u.url)})}catch(l){if(this.logger("ws create failed"),o.forEach(u=>u.close()),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,e,n);if(!e&&Number(t.port)!==443)return this.createWebSocket(t,!0,n);throw new w(R.WS_ERR,"init websocket failed! Error: ".concat(l.toString()))}const d=da();return this.store&&this.store.recordJoinChannelService({urls:o.map(l=>l.url),service:"gateway"},this.recordIndex),o.forEach(l=>{l.onopen=()=>{this.logger("onopen: ws ".concat(l.url," open cost ").concat(Date.now()-r,"ms")),this.websockets.forEach(u=>{u!==l&&(u.onopen=null,u.onclose=null,u.onmessage=null,u.close(),this.logger("close backup websocket: ".concat(u.url)))}),this.websockets.length=0,d.resolve(l)},l.onclose=u=>{this.logger("onclose: ws ".concat(l.url," closed cost ").concat(Date.now()-r,"ms state: ").concat(l.readyState)),e?this.isTry443PortFailed=WS(o):this.isNormalPortFailed=WS(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(e&&this.isTry443PortFailed||!e&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(u.reason)),d.reject({code:u.code,reason:Tr.A_ROUND_WS_FAILED}))},l.onmessage=u=>this.logger("".concat(l.url," onmessage: ").concat(u.data))}),this.websockets.push(...o),n||(()=>{const l=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(u=>u.readyState!==WebSocket.OPEN&&u.close())};if(e||this.useProxy)return this.logger("add 5s timeout at ".concat(e?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return l();ft().os===_e.MAC_OS&&Nt()&&l(),this.createWebSocket(t,!0,!0).then(u=>d.resolve(u)).catch(u=>{this.isNormalPortFailed&&d.reject(u),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration)},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(t,e,n,s){return this.useDoubleDomain=!!e,typeof t=="string"&&(t=function(r){let o,a,c;return[,o,a,c]=r.match(hk)||[],o||([,a,c]=r.match(pk)||[]),a&&c||([,a,c]=r.match(_k)||[]),a&&c||([,a]=r.match(Ek)||[]),a||E.warning("un-destructible url: ",r),{proxy:o,host:a,port:c||"443"}}(t)),this.recordIndex=s,this.useProxy=!!t.proxy,n&&this.useProxy&&(E.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(t,!!n,!1).finally(()=>this.clearTimeout())}}function KS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}class YS extends Wt{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;q(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(et.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(et.CONNECTED):this._state==="closed"?this.emit(et.CLOSED):this._state==="failed"&&this.emit(et.FAILED))}resetReconnectCount(t){E.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],s=arguments.length>3&&arguments[3]!==void 0&&arguments[3],r=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"urls",[]),h(this,"_reconnectMode","tryNext"),h(this,"reconnectReason",void 0),h(this,"_initMutex",new Ae("websocket")),h(this,"name",void 0),h(this,"_state","closed"),h(this,"reconnectInterrupter",void 0),h(this,"websocket",void 0),h(this,"retryConfig",void 0),h(this,"reconnectCount",0),h(this,"forceCloseTimeout",5e3),h(this,"onlineReconnectListener",void 0),h(this,"useCompress",void 0),h(this,"tryDoubleDomain",!1),h(this,"use443PortOnly",!1),h(this,"wsInflateLength",0),h(this,"wsDeflateLength",0),h(this,"closeEstablishingWs",()=>{}),h(this,"store",void 0),h(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=function(u){for(var p=1;p<arguments.length;p++){var _=arguments[p]!=null?arguments[p]:{};p%2?KS(Object(_),!0).forEach(function(S){h(u,S,_[S])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(_)):KS(Object(_)).forEach(function(S){Object.defineProperty(u,S,Object.getOwnPropertyDescriptor(_,S))})}return u}({},e),this.useCompress=n,this.tryDoubleDomain=s,this.use443PortOnly=r;const{timeout:a,timeoutFactor:c}=e,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Ze.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),oe.on(ts.NETWORK_STATE_CHANGE,(u,p)=>{u!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(u)),u===Ze.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=await this._initMutex.lock();this.forceCloseTimeout=e,this.urls=t,this.state="connecting";try{const s=da(),r=this.urls[this.currentURLIndex];this.createWebSocketConnection(r).then(s.resolve).catch(s.reject),this.once(et.CLOSED,()=>{s.reject(new M(R.WS_DISCONNECT))}),this.once(et.CONNECTED,s.resolve),await s.promise}catch{}finally{n()}}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const n=this.websocket;e?setTimeout(()=>n.close(),500):n.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,e){if(!this.websocket)return void E.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),E.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(e)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:e})}sendMessage(t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new M(R.WS_ABORT,"websocket is not ready");try{e||(t=JSON.stringify(t)),this.websocket.send(t)}catch(n){throw new M(R.WS_ERR,"send websocket message error"+n.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,e=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:e}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var e;const n=da();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),E.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},r=async l=>{var u;if(E.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new M(R.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const p=Ci(this,et.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,_=await this.reconnectWithAction(p);if(this.state==="closed")return void E.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!_)return n.reject(new M(R.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);n.resolve()}},o=l=>{this.emit(et.ON_MESSAGE,l)},a=l=>{E.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),v("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=v("GATEWAY_WSS_ADDRESS")),E.debug("[".concat(this.name,"] start connect, url:"),t);const c=(e=this.store)===null||e===void 0?void 0:e.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const l=await this.chooseBestWebsocketConnection(t);this.websocket=l,s&&s(this.websocket.url),this.websocket.onclose=r,this.websocket.onmessage=o,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){const u=this.state==="closed",p=l instanceof M,_=p&&l.code===R.WS_ABORT,S=p&&l.code===R.WS_ERR,f=p?l.message:l&&(l.reason||l.toString());E.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(f)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:_?"aborted":"error",errors:[l]},c),u||S?(n.reject(u?new M(R.WS_DISCONNECT,"websocket is closed: ".concat(f)):new M(R.WS_ERR,"init websocket failed: ".concat(f))),S&&E.error("[".concat(this.name,"] init websocket failed: ").concat(f))):r&&r(l)}return n.promise}async reconnectWithAction(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;E.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||oe.isOnline||!oe.onlineWaiter||(this.onlineReconnectListener=oe.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let n=!0;if(this.reconnectInterrupter=()=>n=!1,e){const o=$c(this.reconnectCount,this.retryConfig);E.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(t)),await P.race([ye(o),this.onlineReconnectListener||new P(()=>{})])}if(this._state==="closed"||!n)return!1;this.reconnectCount+=1;const s=async(o,a)=>{this.emit(et.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(t==="retry")this.emit(et.RECONNECT_WAITTING_FINISH,t),await s(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);E.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(et.RECONNECT_WAITTING_FINISH,t),await s(this.urls[this.currentURLIndex],t)}else t==="recover"&&(E.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(et.RECONNECT_WAITTING_FINISH,t),this.urls=await re(this,et.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],t))}catch(o){var r;E.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(r=o.data)===null||r===void 0?void 0:r.desc;return Array.isArray(a)&&q(a).call(a,"dynamic key expired")?(this.emit(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,e)}return!0}}class ga extends YS{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){const n=da(),s=function(o,a){return new fk(o,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{E.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new M(R.WS_ABORT,"choose best websocket aborted"))};const r=v("GATEWAY_DOMAINS");return E.debug("[choose-best-ws] currentDomain: ",t,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,e).then(n.resolve).catch(n.reject),n.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Ta extends YS{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,e){return new P((n,s)=>{let r=!1;const o=[];this.closeEstablishingWs=()=>{E.debug("[choose-best-ws] close establishing websockets"),o.forEach(S=>{S.onclose=null,S.onopen=null,S.onmessage=null,S.close()}),s(new M(R.WS_ABORT,"choose best websocket aborted"))};const a=v("GATEWAY_DOMAINS");let c;const d=t.indexOf("?h="),l=a.find(S=>d!==-1?q(t).call(t,S,d):q(t).call(t,S));E.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var p;const S=Date.now();try{a.forEach(f=>{const g=d===-1?t.replace(l,f):t.substr(0,d)+t.substr(d).replace(l,f),C=new WebSocket(g);C.binaryType="arraybuffer",o.push(C),E.debug("[choose-best-ws] ws is connecting:",C.url)})}catch{for(E.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach(g=>g.close());o.length;)o.pop();u=!0}(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:o.map(f=>f.url),service:"gateway"},e),o.forEach(f=>{f.onopen=()=>{if(r)return;const g=Date.now()-S;E.debug("[choose-best-ws] ws open cost ".concat(g,"ms")),o.filter(C=>C!==f).forEach(C=>{E.debug("[choose-best-ws]close backup websocket: ".concat(C.url)),C.close()}),r=!0,n(f)},f.onclose=g=>{c=g,!r&&(o.find(C=>!(C.readyState===WebSocket.CLOSED||C.readyState===WebSocket.CLOSING))||(E.debug("[choose-best-ws] all websocket is closed"),r=!0,s(c)))},f.onmessage=g=>{E.debug("[choose-best-ws]".concat(f.url," onmessage: ").concat(g.data))}}),ye(this.forceCloseTimeout).then(()=>{o.forEach(f=>{f.readyState!==WebSocket.OPEN&&f.close()})})}if(u){var _;let S;E.debug("[choose-best-ws] use single url: ",t),(_=this.store)===null||_===void 0||_.recordJoinChannelService({urls:[t],service:"gateway"},e);try{S=new WebSocket(t),o.push(S),S.binaryType="arraybuffer"}catch(f){const g=new M(R.WS_ERR,"init websocket failed! Error: ".concat(f.toString()));return E.error("[".concat(this.name,"]").concat(g)),void s(g)}S.onopen=()=>{n(S)},S.onclose=f=>{s(f)},S.onmessage=f=>{E.debug("[choose-best-ws]".concat(S.url," onmessage: ").concat(f.data))},ye(this.forceCloseTimeout).then(()=>{S&&S.readyState!==WebSocket.OPEN&&S.close()})}}).then(n=>(this.closeEstablishingWs=void 0,n)).catch(n=>{throw this.closeEstablishingWs=void 0,n})}}class qS extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===lt.CONNECTED?this.emit(H.WS_CONNECTED):t===lt.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===lt.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",lt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new ph(5)),h(this,"pingpongTimer",void 0),h(this,"wsInflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,n.data);const s=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(s,"_id")){const r="res-@".concat(s._id);this.emit(r,s._result,s._message)}else if(Object.prototype.hasOwnProperty.call(s,"_type")){if(this.emit(s._type,s._message),s._type===nt.ON_NOTIFICATION&&this.handleNotification(s._message),s._type===nt.ON_USER_BANNED)switch(s._message.error_code){case 14:this.close(pt.UID_BANNED);break;case 15:this.close(pt.IP_BANNED);break;case 16:this.close(pt.CHANNEL_BANNED)}if(s._type===nt.ON_USER_LICENSE_BANNED)switch(s._message.error_code){case Z.ERR_LICENSE_MISSING:this.close(pt.LICENSE_MISSING);break;case Z.ERR_LICENSE_EXPIRED:this.close(pt.LICENSE_EXPIRED);break;case Z.ERR_LICENSE_MINUTES_EXCEEDED:this.close(pt.LICENSE_MINUTES_EXCEEDED);break;case Z.ERR_LICENSE_PERIOD_INVALID:this.close(pt.LICENSE_PERIOD_INVALID);break;case Z.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(pt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Z.ERR_LICENSE_ILLEGAL:this.close(pt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new ga("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===lt.CONNECTED&&this.reconnect("retry",ve.OFFLINE)})}async request(t,e,n,s){const r=Pt(6,""),o={_id:r,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new P((S,f)=>{if(this.connectionState===lt.CONNECTED)return S();const g=()=>{this.off(H.WS_CLOSED,C),S()},C=()=>{this.off(H.WS_CONNECTED,g),f(new w(R.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,C),t!==Q.PUBLISH&&t!==Q.SUBSCRIBE&&t!==Q.UNSUBSCRIBE&&t!==Q.UNPUBLISH&&t!==Q.CONTROL&&t!==Q.RESTART_ICE||this.once(H.DISCONNECT_P2P,()=>{f(new w(R.DISCONNECT_P2P))}),t!==Q.PUBLISH&&t!==Q.RESTART_ICE||this.once(H.ABORT_P2P_EXECUTION,()=>{f(new w(R.DISCONNECT_P2P))})});if(this.connectionState!==lt.CONNECTING&&this.connectionState!==lt.RECONNECTING||t===Q.JOIN||t===Q.REJOIN||await c(),this.websocket.sendMessage(o,!0),s)return;const d=new P((S,f)=>{let g=!1;const C=(A,k)=>{g=!0,S({isSuccess:A==="success",message:k||{}}),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.emit(H.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(r),C);const y=()=>{f(new w(R.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.off("res-@".concat(r),C)};this.once(H.WS_CLOSED,y),this.once(H.WS_RECONNECTING,y),ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(H.REQUEST_TIMEOUT,t,e))})});let l=null;try{l=await d}catch(S){if(this.connectionState===lt.CLOSED||t===Q.LEAVE)throw new w(R.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?S.throw():t===Q.JOIN||t===Q.REJOIN?null:(await c(),await this.request(t,e))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=Sr(u),_=new w(R.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return p.action==="success"?l.message:(E.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===Z.ERR_TOO_MANY_BROADCASTERS?((t===Q.JOIN||t===Q.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(u===Z.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ve.MULTI_IP)):this.reconnect(p.action,ve.SERVER_ERROR),t===Q.JOIN||t===Q.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new P(n=>{const s=r=>{(!e||e(r))&&(this.off(t,s),n(r))};this.on(t,s)})}uploadWRTCStats(t){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(is.WRTC_STATS,e)}upload(t,e){const n={_type:t,_message:e};try{this.websocket.sendMessage(n)}catch{const r=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==lt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},v("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const n={_type:t,_message:e};this.websocket.sendMessage(n)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new P((n,s)=>{this.once(H.WS_CONNECTED,()=>n(this.joinResponse)),this.once(H.WS_CLOSED,()=>s(this.initError||new w(R.WS_ABORT))),this.connectionState=lt.CONNECTING,this.websocket.init(t).catch(s),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||pt.LEAVE,this.connectionState=lt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===pt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new ga("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await re(this,H.REQUEST_JOIN_INFO),e=await this.request(Q.JOIN,t);if(!e)return this.emit(H.REPORT_JOIN_GATEWAY,Tr.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=lt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new w(R.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=pr(this,H.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Q.REJOIN,t);return!!e&&(this.connectionState=lt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach(n=>{this.emit(nt.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(nt.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(nt.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(nt.MUTE_AUDIO,{uid:n.uid}):this.emit(nt.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(nt.MUTE_VIDEO,{uid:n.uid}):this.emit(nt.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(nt.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(nt.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(nt.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(nt.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(nt.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){E.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Sr(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(pt.UID_BANNED),void this.close()):void this.reconnect(e.action,ve.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=v("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(E.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",ve.TIMEOUT):this.request(Q.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-e;this.rttRolling.add(n),v("REPORT_STATS")&&this.send(Q.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:e}=this.websocket.getWsInflateData();t!==0&&e!==0&&this.upload(is.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(et.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(et.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(et.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(et.CLOSED,()=>{this.connectionState=lt.CLOSED}),this.websocket.on(et.FAILED,()=>{this._disconnectedReason=pt.NETWORK_ERROR,this.connectionState=lt.CLOSED}),this.websocket.on(et.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===lt.CONNECTED?this.connectionState=lt.RECONNECTING:this.connectionState=lt.CONNECTING}),this.websocket.on(et.WILL_RECONNECT,(t,e,n)=>{const s=pr(this,H.IS_P2P_DISCONNECTED),r=s||t!=="retry";s&&t==="retry"&&(E.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",e=Tr.P2P_DISCONNECTED),r&&(E.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(H.REPORT_JOIN_GATEWAY,e||Tr.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION),this.emit(H.DISCONNECT_P2P)),n(t)}),this.websocket.on(et.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{E.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",ve.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code||Tr.UNKNOWN_REASON,this.url||""),t instanceof w&&t.code===R.UNEXPECTED_RESPONSE&&t.data.code===Z.ERR_NO_AUTHORIZED)return E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ve.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ve.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(et.REQUEST_NEW_URLS,(t,e)=>{re(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var JS=`	
\v\f\r Â áââââââââââââ¯âã\u2028\u2029\uFEFF`,gk=Go,Tk=Xn,Wh=JS,zS=De("".replace),Sk=RegExp("^["+Wh+"]+"),Rk=RegExp("(^|[^"+Wh+"])["+Wh+"]+$"),Hh=function(i){return function(t){var e=Tk(gk(t));return 1&i&&(e=zS(e,Sk,"")),2&i&&(e=zS(e,Rk,"$1")),e}},Ck={start:Hh(1),end:Hh(2),trim:Hh(3)},Ik=af.PROPER,vk=Gt,XS=JS,yk=Ck.trim;zt({target:"String",proto:!0,forced:function(i){return vk(function(){return!!XS[i]()||"âÂá "[i]()!=="âÂá "||Ik&&XS[i].name!==i})}("trim")},{trim:function(){return yk(this)}});var be,Qi,Ak=Ts("String").trim,bk=rn,wk=Ak,Kh=String.prototype,Yh=xt(function(i){var t=i.trim;return typeof i=="string"||i===Kh||bk(Kh,i)&&t===Kh.trim?wk:t});function QS(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Ed(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?QS(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):QS(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function ks(i){return i.match(/^[\.\:\d]+$/)?"".concat(i.replace(/[^\d]/g,"-"),".").concat(v("TURN_DOMAIN")):(E.info("Unidentified as ip: ".concat(i,", use as host")),i)}function ZS(i,t){i.addresses||(i.addresses=[]);const e=function(r,o){if(v("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return r.map(d=>{let{ip:l,port:u}=d;return{address:"".concat(l,":").concat(u)}});const a=v("GATEWAY_DOMAINS");let c=a[1]&&q(o).call(o,a[1])?1:0;return r.map(d=>{let{domain_prefix:l,port:u,ip:p}=d;if(l)return{address:"".concat(l,".").concat(a[c++%a.length],":").concat(u)};const _=/^[\.\:\d]+$/.test(p),S=_?"".concat(p.replace(/[^\d]/g,"-"),".").concat(a[c++%a.length],":").concat(u):"".concat(p,":").concat(u);return _||E.info("Unidentified as ip: ".concat(p,", use as host")),{ip:p,port:u,address:S}})}(i.addresses,t),n=Array.isArray(i.detail)&&i.detail[18];if(n&&typeof n=="string"){const r=n.split(";");for(let o=0;o<r.length;o++){var s;const a=Yh(s=r[o]).call(s);e[o]&&a&&(e[o].ip6=a)}}return{gatewayAddrs:e,uid:i.uid,cid:i.cid,cert:i.cert,vid:i.detail&&i.detail[8],uni_lbs_ip:i.detail&&i.detail[1],res:i,csIp:i.detail&&i.detail[502]}}function Ui(i){return typeof i=="number"?i:i.exact||i.ideal||i.max||i.min||0}function $S(i){const t=i._encoderConfig;if(!t)return{};const e={resolution:t.width&&t.height?"".concat(Ui(t.width),"x").concat(Ui(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(e.maxFrameRate=t.frameRate,e.minFrameRate=t.frameRate):t.frameRate&&(e.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,e.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),e}function tR(i){return i>=0&&i<.17?1:i>=.17&&i<.36?2:i>=.36&&i<.59?3:i>=.59&&i<=1?4:i>1?5:0}function qh(i,t){let e,n,s;switch(t){case be.CHOOSE_SERVER:n=4096,s="choose server";break;case be.CLOUD_PROXY:n=1048576,s="proxy";break;case be.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case be.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new w(R.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:i.detail&&i.detail[502],retry:!1})}if(i.response_body.forEach(r=>{r.buffer&&r.buffer.flag===n&&(e={code:r.buffer.code,addresses:(r.buffer.edges_services||[]).map(o=>Ed(Ed({},o),{},{ticket:r.buffer.cert})),server_ts:i.enter_ts,uid:r.buffer.uid,cid:r.buffer.cid,cname:r.buffer.cname,detail:Ed(Ed({},r.buffer.detail),i.detail),flag:r.buffer.flag,opid:i.opid,cert:r.buffer.cert})}),!e)throw new w(R.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:i.detail&&i.detail[502]});return e}async function Ok(i,t){return await P.all(i.addresses.map(async e=>({address:ks(e.ip),tcpport:e.port,udpport:e.port,username:t&&v("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():ni.username,password:t&&v("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await ch(t.toString()):ni.password})))}function Jh(i,t){const e=t._videoHeight||t.getMediaStreamTrack(!0).getSettings().height;return e?Math.max(e/Ui(i.height),1):(E.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Ms(i){let{candidateType:t,relayProtocol:e,type:n,address:s,port:r,protocol:o}=i;return n==="local-candidate"?{candidateType:t,relayProtocol:e,protocol:o}:{candidateType:t,relayProtocol:e,address:s,port:r,protocol:o}}function eR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}(function(i){i[i.CHOOSE_SERVER=11]="CHOOSE_SERVER",i[i.CLOUD_PROXY=18]="CLOUD_PROXY",i[i.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",i[i.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"})(be||(be={}));class Nk extends Wt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var e;q(e=["tryNext","recover"]).call(e,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit($t.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit($t.CONNECTED):this._state==="closed"?this.emit($t.CLOSED):this._state==="failed"&&this.emit($t.FAILED))}constructor(t,e,n,s){super(),h(this,"connectionID",0),h(this,"currentURLIndex",0),h(this,"reconnectReason",void 0),h(this,"_reconnectMode","tryNext"),h(this,"_name",void 0),h(this,"_state","closed"),h(this,"_retryConfig",void 0),h(this,"_reconnectCount",0),h(this,"_forceCloseTimeout",5e3),h(this,"_onlineReconnectListener",void 0),h(this,"_closeEstablishingTransmitter",()=>{}),h(this,"_store",void 0),h(this,"_joinChannelServiceRecordIndex",void 0),h(this,"_useCompress",void 0),h(this,"_inflateLength",0),h(this,"_deflateLength",0),this._store=s,this._name=t,this._retryConfig=function(r){for(var o=1;o<arguments.length;o++){var a=arguments[o]!=null?arguments[o]:{};o%2?eR(Object(a),!0).forEach(function(c){h(r,c,a[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):eR(Object(a)).forEach(function(c){Object.defineProperty(r,c,Object.getOwnPropertyDescriptor(a,c))})}return r}({},e),this._useCompress=n}resetReconnectCount(t){E.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,e){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const n=this._transmitter;e?setTimeout(()=>n.close(),500):n.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,e){if(!this._transmitter)return void E.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;t!==void 0&&(this.reconnectMode=t),E.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((n=this._store)===null||n===void 0||n.recordJoinChannelService({status:"error",errors:[new Error(e)]},this._joinChannelServiceRecordIndex));const s=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),s&&s.bind(this._transmitter)({code:9999,reason:e})}getInflateData(){const t=this._inflateLength,e=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:e}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}(function(i){i[i.Default=0]="Default",i[i.Ack=1]="Ack"})(Qi||(Qi={}));class Dk{constructor(t,e,n){h(this,"version",1),h(this,"initialRTO",void 0),h(this,"maxBatchAckCount",void 0),h(this,"maxRTO",void 0),h(this,"initialRTT",void 0),h(this,"ID",void 0),h(this,"rtt",void 0),h(this,"packetNumber",1),h(this,"rtoRatioMap",new Map),h(this,"timeoutMap",new Map),h(this,"unorderedPacketQueue",[]),h(this,"batchAckPacketQueue",[]),h(this,"lastOrderedPacketNumber",0),h(this,"batchAckTimer",void 0),h(this,"sendImpl",void 0),h(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=e,this.ID=Pt(7,"transmitter-"),this.initialRTO=(n==null?void 0:n.initialRTO)!==void 0?n.initialRTO:v("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:v("TRANSMITTER_INITIAL_RTT"),this.rtt=(n==null?void 0:n.initialRTT)!==void 0?n.initialRTT:v("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(n==null?void 0:n.maxBatchAckCount)!==void 0?n.maxBatchAckCount:v("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(n==null?void 0:n.maxRTO)!==void 0?n.maxRTO:v("TRANSMITTER_MAX_RTO")}packetize(t,e){return{type:Qi.Default,version:this.version,packetNumber:e,payload:t}}serialize(t){switch(t.type){case Qi.Default:{let e;typeof t.payload=="string"?e=new TextEncoder().encode(t.payload):e=t.payload;const n=new ArrayBuffer(e.length+15),s=new DataView(n);return s.setUint16(0,t.version),s.setUint8(2,t.type),s.setUint32(3,t.packetNumber),pT(s,7,BigInt(t.sendTs)),new Uint8Array(s.buffer).set(e,15),n}case Qi.Ack:{const e=new ArrayBuffer(16),n=new DataView(e);return n.setUint16(0,t.version),n.setUint8(2,t.type),n.setUint32(3,t.maxAckPacketNumber),n.setUint8(7,t.shift),pT(n,8,BigInt(t.ackSendTs)),e}}}deserialize(t){const e=new DataView(t),n=e.getUint16(0),s=e.getUint8(2);switch(s){case Qi.Default:{const r=e.getUint32(3),o=hT(e,7),a=t.slice(15),c=new TextDecoder().decode(a);return{version:n,type:s,packetNumber:r,sendTs:Number(o),payload:c}}case Qi.Ack:{const r=e.getUint32(3),o=e.getUint8(7),a=hT(e,8);return{version:n,type:s,maxAckPacketNumber:r,shift:o,ackSendTs:Number(a)}}default:throw E.error("[".concat(this.ID,"] Unrecognized packet type ").concat(s)),new Error("Unrecognized packet type ".concat(s))}}sendMessage(t){const e=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const n=this.calculateRTO(e),s=window.setTimeout(()=>{this.resendMessage(e)},n);this.timeoutMap.set(e.packetNumber,s),this.sendPacket(e)}onData(t){const e=this.deserialize(t);e.type===Qi.Default?this.ack(e):e.type===Qi.Ack&&(this.updateRTT(e,Math.round(performance.now())),this.clearRTO(e))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[e,n]=t;window.clearTimeout(n)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const e=this.calculateRTO(t),n=window.setTimeout(()=>{this.resendMessage(t)},e);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}calculateRTO(t){const e=this.rtoRatioMap.get(t.packetNumber);if(e===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*e;return this.rtoRatioMap.set(t.packetNumber,e+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(t,e){const n=t.ackSendTs;this.rtt=this.rtt*(7/8)+(e-n-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Qi.Ack,version:this.version};this.sendPacket(e)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const e={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Qi.Ack,version:this.version};this.sendPacket(e)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Qi.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Qi.Default&&(t.sendTs=Math.round(performance.now()));const e=this.serialize(t);this.sendImpl(e)}clearRTO(t){for(let e=t.maxAckPacketNumber-t.shift;e<=t.maxAckPacketNumber;e++){const n=this.timeoutMap.get(e);n!==void 0&&window.clearTimeout(n),this.timeoutMap.delete(e),this.rtoRatioMap.delete(e)}}}class iR extends Nk{constructor(t,e){super(t,e,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),h(this,"_initMutex",void 0),h(this,"_reconnectInterrupter",void 0),h(this,"_url",void 0),h(this,"_transmitter",void 0),h(this,"_addresses",void 0),h(this,"_reliableTransmission",void 0),this._initMutex=new Ae("datachannel");const{timeout:n,timeoutFactor:s}=e,r=Math.max(300,Math.floor(3*n/5)),o=Math.max(1.2,Math.floor(8*s)/10);Ze.ONLINE&&(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o),oe.on(ts.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===Ze.ONLINE?(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=s))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=e;const n=(s,r)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||v("FINGERPRINT"));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(s).catch(r),this.once($t.CLOSED,()=>r(new w(R.WS_DISCONNECT))),this.once($t.CONNECTED,()=>s())};return this._initMutex.lock().then(s=>new P((r,o)=>{n(r,o)}).then(()=>{s()}).catch(()=>{s()}))}sendMessage(t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new w(R.WS_ABORT,"datachannel is not ready");try{e||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(n){throw new w(R.WS_ERR,"send datachannel signal message error"+n.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const e=JSON.stringify(t);return{compressed:e,compressedLength:e.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new P((e,n)=>{var s;const r=()=>{E.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),e()},o=async l=>{var u;if((u=this._closeEstablishingTransmitter)===null||u===void 0||u.call(this),E.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const p=Ci(this,$t.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,_=await this.reconnectWithAction(p);if(this.state==="closed")return void E.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!_)return n(new w(R.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);e()}else n(new w(R.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=l=>{var u;(u=this._reliableTransmission)===null||u===void 0||u.onData(l.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),E.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=(s=this._store)===null||s===void 0?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();re(this,$t.TO_CONNECT_DATACHANNEL,t).then(l=>{var u,p;if(!l)throw new Error("transmissonInfo not exist yet");const{transmitter:_,close:S}=l;this._transmitter=_,(u=this._store)===null||u===void 0||u.signalChannelOpen();const f=Date.now()-d;E.debug("[choose dc] dc open cost ".concat(f,"ms")),this._reliableTransmission=new Dk(g=>{var C;this._transmitter&&this._transmitter.readyState==="open"&&((C=this._transmitter)===null||C===void 0||C.send(g))},g=>{typeof g=="string"&&this.emit($t.ON_MESSAGE,g)}),this._closeEstablishingTransmitter=()=>{var g;(g=this._reliableTransmission)===null||g===void 0||g.close(),this._reliableTransmission=void 0,S()},r&&r(),_.onclose=o,_.onmessage=a,(p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(l=>{var u;if((u=this._store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:l instanceof w&&l.code===R.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof w&&l.code===R.WS_ERR){const p=new w(R.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return E.error("[".concat(this._name,"]").concat(p)),void n(p)}o&&o(l)}else n(new w(R.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))})})}async reconnectWithAction(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||oe.networkState!==Ze.OFFLINE||(this._onlineReconnectListener=oe.onlineWaiter&&oe.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},e){const a=$c(this._reconnectCount,this._retryConfig);E.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(t)),await P.race([ye(a),this._onlineReconnectListener||new P(()=>{})])}if(this.state==="closed"||!n)return!1;this._reconnectCount+=1;const s=async(a,c)=>{this.emit($t.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(t==="retry"){const a=this._addresses[this.currentURLIndex];this.emit($t.RECONNECT_WAITTING_FINISH,t),await s(a,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||v("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return E.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);E.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];this.emit($t.RECONNECT_WAITTING_FINISH,t),await s(a,t)}else t==="recover"&&(E.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit($t.RECONNECT_WAITTING_FINISH,t),this.emit($t.FAILBACK));return!0}catch(a){var r,o;return E.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(r=a.data)!==null&&r!==void 0&&r.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&q(o=a.data.desc).call(o,"dynamic key expired")?(this.emit($t.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,e)}}}class ns extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===lt.CONNECTED?this.emit(H.WS_CONNECTED):t===lt.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===lt.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",lt.CLOSED),h(this,"reconnectToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new ph(5)),h(this,"pingpongTimer",void 0),h(this,"inflateDataTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"onWebsocketMessage",n=>{if(n instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,n);const s=JSON.parse(n);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(s,"_id")){const r="res-@".concat(s._id);this.emit(r,s._result,s._message)}else if(Object.prototype.hasOwnProperty.call(s,"_type")&&(this.emit(s._type,s._message),s._type===nt.ON_NOTIFICATION&&this.handleNotification(s._message),s._type===nt.ON_USER_BANNED))switch(s._message.error_code){case 14:this.close(pt.UID_BANNED);break;case 15:this.close(pt.IP_BANNED);break;case 16:this.close(pt.CHANNEL_BANNED)}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new iR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===lt.CONNECTED&&this.reconnect("retry",Un.OFFLINE)})}async request(t,e,n,s){const r=Pt(6,""),o={_id:r,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new P((S,f)=>{if(this.connectionState===lt.CONNECTED)return S();const g=()=>{this.off(H.WS_CLOSED,C),S()},C=()=>{this.off(H.WS_CONNECTED,g),f(new w(R.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,C),t!==Q.PUBLISH&&t!==Q.SUBSCRIBE&&t!==Q.UNSUBSCRIBE&&t!==Q.UNPUBLISH&&t!==Q.CONTROL&&t!==Q.RESTART_ICE||this.once(H.DISCONNECT_P2P,()=>{f(new w(R.DISCONNECT_P2P))}),t!==Q.PUBLISH&&t!==Q.RESTART_ICE||this.once(H.ABORT_P2P_EXECUTION,()=>{f(new w(R.DISCONNECT_P2P))})});if(this.connectionState!==lt.CONNECTING&&this.connectionState!==lt.RECONNECTING||t===Q.JOIN||t===Q.REJOIN||await c(),t===Q.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),this.websocket.sendMessage(o,!0,!1),s)return;const d=new P((S,f)=>{let g=!1;const C=(A,k)=>{g=!0,S({isSuccess:A==="success",message:k||{}}),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.emit(H.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(r),C);const y=()=>{f(new w(R.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.off("res-@".concat(r),C)};this.once(H.WS_CLOSED,y),this.once(H.WS_RECONNECTING,y),ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("dc request timeout, type: ".concat(t)),this.emit(H.REQUEST_TIMEOUT,t,e))})});let l=null;try{l=await d}catch(S){if(this.connectionState===lt.CLOSED||t===Q.LEAVE)throw new w(R.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?S.throw():t===Q.JOIN||t===Q.REJOIN?null:(await c(),await this.request(t,e))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=Sr(u),_=new w(R.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return p.action==="success"?l.message:(E.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===Z.ERR_TOO_MANY_BROADCASTERS?((t===Q.JOIN||t===Q.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(u===Z.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Un.MULTI_IP)):this.reconnect(p.action,Un.SERVER_ERROR),t===Q.JOIN||t===Q.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new P(n=>{const s=r=>{(!e||e(r))&&(this.off(t,s),n(r))};this.on(t,s)})}uploadWRTCStats(t){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(is.WRTC_STATS,e)}upload(t,e){const n={_type:t,_message:e};try{this.websocket.sendMessage(n)}catch{const r=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==lt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},v("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const n={_type:t,_message:e};this.websocket.sendMessage(n)}init(t,e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new P((n,s)=>{this.once(H.WS_CONNECTED,()=>n(this.joinResponse)),this.once(H.WS_CLOSED,()=>s(this.initError||new w(R.WS_ABORT))),this.connectionState=lt.CONNECTING,this.websocket.init(t).catch(s),this.websocket.once($t.FAILBACK,()=>{this.openConnectionTime===void 0&&s(new w(R.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{e&&this.openConnectionTime===void 0&&(E.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),s(new w(R.INIT_DATACHANNEL_TIMEOUT)))},v("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||pt.LEAVE,this.connectionState=lt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===pt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new iR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await re(this,H.DATACHANNEL_CONNECTING),e=await this.request(Q.JOIN,t);if(!e)return this.emit(H.REPORT_JOIN_GATEWAY,R.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=lt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new w(R.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=pr(this,H.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const e=await this.request(Q.REJOIN,t);return!!e&&(this.connectionState=lt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),e.peers&&e.peers.forEach(n=>{this.emit(nt.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(nt.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(nt.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(nt.MUTE_AUDIO,{uid:n.uid}):this.emit(nt.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(nt.MUTE_VIDEO,{uid:n.uid}):this.emit(nt.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(nt.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(nt.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(nt.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(nt.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(nt.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleNotification(t){E.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Sr(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(pt.UID_BANNED),void this.close()):void this.reconnect(e.action,Un.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=v("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(E.warning("PINGPONG Timeout. Last Socket Message: ".concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Un.TIMEOUT):this.request(Q.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-e;this.rttRolling.add(n),v("REPORT_STATS")&&this.send(Q.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleInflateData(){const{inflateLength:t,deflateLength:e}=this.websocket.getInflateData();t!==0&&e!==0&&this.upload(is.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:e,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on($t.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on($t.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on($t.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on($t.CLOSED,()=>{this.connectionState=lt.CLOSED}),this.websocket.on($t.FAILED,()=>{this._disconnectedReason=pt.NETWORK_ERROR,this.connectionState=lt.CLOSED}),this.websocket.on($t.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===lt.CONNECTED?this.connectionState=lt.RECONNECTING:this.connectionState=lt.CONNECTING}),this.websocket.on($t.WILL_RECONNECT,(t,e)=>{if(pr(this,H.IS_P2P_DISCONNECTED)&&t==="retry")return E.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION),this.emit(H.DISCONNECT_P2P),e("tryNext");t!=="retry"&&(E.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION),this.emit(H.DISCONNECT_P2P)),e(t)}),this.websocket.on($t.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{E.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Un.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof w&&t.code===R.UNEXPECTED_RESPONSE&&t.data.code===Z.ERR_NO_AUTHORIZED)return E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Un.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Un.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on($t.REQUEST_NEW_URLS,(t,e)=>{re(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on($t.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on($t.TO_CONNECT_DATACHANNEL,async(t,e,n)=>re(this,H.DATACHANNEL_PRECONNECT,t).then(e).catch(n)),this.websocket.on($t.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(H.DATACHANNEL_FAILBACK)})}}class Rr extends Wt{constructor(t,e){super(),h(this,"signal",void 0),h(this,"token",void 0),h(this,"tokenTimeout",void 0),h(this,"tokenInterval",void 0),h(this,"_sequence",0),h(this,"userMap",new Map),h(this,"encoder",new TextEncoder),this.signal=t,this.token=e;const n=()=>{this.signal.connectionState===lt.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*v("P2P_TOKEN_INTERVAL"))};n()}async send(t,e,n,s,r){var o,a,c;if(this.userMap.size===0)return;const d=Array.from(In(o=this.userMap).call(o))[0].token;typeof e!="string"&&(e=JSON.stringify(e)),s=(a=s)!==null&&a!==void 0?a:Pt(6,""),r=(c=r)!==null&&c!==void 0?c:this._sequence++;const l={_id:s,_type:t,_seq:r,_message:e,token:"".concat(this.token,"_").concat(d)};v("SHOW_P2P_LOG")&&E.debug("send message",l,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(l)).forEach(p=>{this.signal.request(Q.DATA_STREAM,{payload:ao(this.encoder.encode(p))})});const u=new P((p,_)=>{const S=window.setTimeout(()=>{this.off("res-@".concat(s,"_ack"),f),this.off("res-@".concat(s),C),this.off(Ls.ABORT,g),E.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(s)),this.userMap.size===0?_(new M(R.INVALID_REMOTE_USER)):_(new M(R.TIMEOUT))},v("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),f=()=>{S&&window.clearTimeout(S),this.off(Ls.ABORT,g),n&&p()},g=()=>{S&&window.clearTimeout(S),this.off("res-@".concat(s,"_ack"),f),this.off("res-@".concat(s),C),_(new M(R.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(s)))};this.once(Ls.ABORT,g),this.once("res-@".concat(s,"_ack"),f);const C=(A,k)=>{y=!0,S&&window.clearTimeout(S),this.off("res-@".concat(s,"_ack"),f),this.off(Ls.ABORT,g),A==="success"?p(k):_(new M(R.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(s)))};let y=!1;n||(this.once("res-@".concat(s),C),ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{y||E.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(s,", ").concat(l))}))});try{return await u}catch(p){if(p.code===R.TIMEOUT)return await this.send(t,e,n,s,r);throw p}}onMessage(t){var e;const{_uid:n}=t;let s,r=this.userMap.get(n);if(r)s=r.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Jt.CHECK)return;const{token:d}=t;s=new Map,r={uid:n,isStart:!0,token:d,splitMessageMap:s,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,r),this.signal.emit(nt.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:d,total:l}=t,u=(o=s.get(d))!==null&&o!==void 0?o:[];if(u.push(t),s.has(d)||s.set(d,u),u.length!==l)return;{const p=ta(u).call(u,(_,S)=>_.index-S.index).map(_=>_.payload).join("");s.delete(d),(t=JSON.parse(p))._uid=n}}const{_type:a,token:c}=t;if(q(e=[Jt.ACK,Jt.CHECK]).call(e,a))return a===Jt.CHECK&&this.handleCheckToken(r,c),void this.receiveMessage(t);c==="".concat(r.token,"_").concat(this.token)?this.handleReceivedMessage(t):E.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(r.token,"_").concat(this.token),t)}check(){const t={_id:Pt(6,""),token:this.token,_type:Jt.CHECK};v("SHOW_P2P_LOG")&&E.debug("send message",t),this.signal.request(Q.DATA_STREAM,{payload:ao(this.encoder.encode(JSON.stringify(t)))})}ack(t){const e={_id:t,_type:Jt.ACK,token:this.token};v("SHOW_P2P_LOG")&&E.debug("send message",e),this.signal.request(Q.DATA_STREAM,{payload:ao(this.encoder.encode(JSON.stringify(e)))})}response(t,e,n){this.send(Jt.RESPONSE,JSON.stringify({success:!n,message:e}),!0,t)}handleReceivedMessage(t){const e=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){const p=l.get(u);l.delete(u),this.receiveMessage(p),d.nextExpectedSequenceNumber++}})};if(!t)return void e();const{_uid:n,_seq:s}=t,r=this.userMap.get(n),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=r;if(s<c)return this.ack(t._id),void E.debug("[external-signal] receive old message, seq: ".concat(s,", ").concat(t._message));o.set(s,t),a&&s===c&&(this.receiveMessage(t),o.delete(c),r.nextExpectedSequenceNumber++,e())}receiveMessage(t){const{_id:e,_type:n,_message:s,_uid:r}=t;if(v("SHOW_P2P_LOG")&&E.debug("receive message",t),e){let o;switch(t._type!==Jt.ACK&&(s&&(o=JSON.parse(s)),this.ack(t._id)),t._type){case Jt.CANDIDATE:case Jt.CONTROL:this.signal.emit(n,o,r);break;case Jt.PUBLISH:case Jt.UNPUBLISH:case Jt.RESTART_ICE:case Jt.CALL:o.uid=r,re(this.signal,n,o).then(a=>{this.response(t._id,a)}).catch(()=>{this.response(t._id,void 0,!0)});break;case Jt.ACK:this.getListeners("res-@".concat(e,"_ack")).length>0&&this.emit("res-@".concat(e,"_ack"));break;case Jt.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(e),a?"success":"failed",c);break}}}}splitMessage(t){if(t.length<Rr.MAX_MESSAGE_SIZE)return[t];const e=[],{remoteToken:n}=JSON.parse(t),s=Pt(6,"");let r=0,o=800;const a=Math.ceil(t.length/o);for(;t.length>0;){r++;const c={id:s,index:r,total:a,payload:t.slice(0,o),token:"".concat(this.token,"_").concat(n)};JSON.stringify(c).length>Rr.MAX_MESSAGE_SIZE?o-=50:(e.push(c),t=t.slice(o))}return e.map(c=>JSON.stringify(c))}handleCheckToken(t,e){return t.token!==e?(E.debug("token changed, from ".concat(t.token," to ").concat(e)),this.reset(t.uid,e),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{E.debug("token timeout, ".concat(e)),this.reset(t.uid)},v("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await re(this.signal,Jt.CALL,void 0),e=await this.send(Jt.CALL,t);this.signal.emit(H.P2P_CONNECTION,e,!0)}async reset(t,e){const n=this.userMap.get(t);n&&(this.emit(Ls.ABORT),this.signal.emit(nt.ON_USER_OFFLINE,{uid:n.uid,reason:jh.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),e||(E.debug("change local token from ".concat(e," to ").concat(e)),this.token=Pt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Ls.ABORT)}}h(Rr,"MAX_SIZE",1),h(Rr,"MAX_MESSAGE_SIZE",1024);class nR extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===lt.CONNECTED?this.emit(H.WS_CONNECTED):t===lt.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===lt.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,e){super(),h(this,"_disconnectedReason",void 0),h(this,"_websocketReconnectReason",void 0),h(this,"_connectionState",lt.CLOSED),h(this,"reconnectToken",void 0),h(this,"p2pToken",void 0),h(this,"websocket",void 0),h(this,"openConnectionTime",void 0),h(this,"clientId",void 0),h(this,"lastMsgTime",Date.now()),h(this,"uploadCache",[]),h(this,"uploadCacheInterval",void 0),h(this,"rttRolling",new ph(5)),h(this,"pingpongTimer",void 0),h(this,"pingpongTimeoutCount",0),h(this,"joinResponse",void 0),h(this,"multiIpOption",void 0),h(this,"initError",void 0),h(this,"spec",void 0),h(this,"store",void 0),h(this,"_external_signal",void 0),h(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,n.data);const s=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(s,"_id")){const r="res-@".concat(s._id);this.emit(r,s._result,s._message)}else if(Object.prototype.hasOwnProperty.call(s,"_type")){switch(s._type){case nt.ON_DATA_STREAM:return void this.handleDataStream(s._message);case nt.MUTE_AUDIO:case nt.MUTE_VIDEO:case nt.ON_P2P_LOST:case nt.ON_USER_ONLINE:return;case nt.ON_USER_OFFLINE:const{uid:r}=s._message;return E.debug("[".concat(this.clientId,"] user-offline uid: ").concat(r)),void this._external_signal.reset(r)}if(this.emit(s._type,s._message),s._type===nt.ON_NOTIFICATION&&this.handleNotification(s._message),s._type===nt.ON_USER_BANNED)switch(s._message.error_code){case 14:this.close(pt.UID_BANNED);break;case 15:this.close(pt.IP_BANNED);break;case 16:this.close(pt.CHANNEL_BANNED)}if(s._type===nt.ON_USER_LICENSE_BANNED)switch(s._message.error_code){case Z.ERR_LICENSE_MISSING:this.close(pt.LICENSE_MISSING);break;case Z.ERR_LICENSE_EXPIRED:this.close(pt.LICENSE_EXPIRED);break;case Z.ERR_LICENSE_MINUTES_EXCEEDED:this.close(pt.LICENSE_MINUTES_EXCEEDED);break;case Z.ERR_LICENSE_PERIOD_INVALID:this.close(pt.LICENSE_PERIOD_INVALID);break;case Z.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(pt.LICENSE_MULTIPLE_SDK_SERVICE);break;case Z.ERR_LICENSE_ILLEGAL:this.close(pt.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=e,this.websocket=new ga("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),e),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===lt.CONNECTED&&this.reconnect("retry",ve.OFFLINE)}),this.p2pToken=Pt(6,""),this._external_signal=new Rr(this,this.p2pToken)}async request(t,e,n,s){const r=Pt(6,""),o={_id:r,_type:t,_message:e},a=this.websocket.connectionID,c=()=>new P((S,f)=>{if(this.connectionState===lt.CONNECTED)return S();const g=()=>{this.off(H.WS_CLOSED,C),S()},C=()=>{this.off(H.WS_CONNECTED,g),f(new M(R.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,C)});if(this.connectionState!==lt.CONNECTING&&this.connectionState!==lt.RECONNECTING||t===Q.JOIN||t===Q.REJOIN||await c(),this.websocket.sendMessage(o,!0),s)return;const d=new P((S,f)=>{let g=!1;const C=(A,k)=>{g=!0,S({isSuccess:A==="success",message:k||{}}),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.emit(H.REQUEST_SUCCESS,t,e)};this.once("res-@".concat(r),C);const y=()=>{f(new M(R.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,y),this.off(H.WS_RECONNECTING,y),this.off("res-@".concat(r),C)};this.once(H.WS_CLOSED,y),this.once(H.WS_RECONNECTING,y),ye(v("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(E.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(H.REQUEST_TIMEOUT,t,e))})});let l=null;try{l=await d}catch(S){if(this.connectionState===lt.CLOSED||t===Q.LEAVE)throw new M(R.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?S.throw():t===Q.JOIN||t===Q.REJOIN?null:(await c(),await this.request(t,e))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=Sr(u),_=new M(R.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return p.action==="success"?l.message:(E.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===Z.ERR_TOO_MANY_BROADCASTERS?((t===Q.JOIN||t===Q.REJOIN)&&(this.initError=_,this.close()),_.throw()):p.action==="failed"?_.throw():p.action==="quit"?(this.initError=_,this.close(),_.throw()):(u===Z.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,E.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ve.MULTI_IP)):this.reconnect(p.action,ve.SERVER_ERROR),t===Q.JOIN||t===Q.REJOIN?null:await this.request(t,e)))}waitMessage(t,e){return new P(n=>{const s=r=>{(!e||e(r))&&(this.off(t,s),n(r))};this.on(t,s)})}uploadWRTCStats(t){if(!this.store.sessionId)return void E.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const e={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(is.WRTC_STATS,e)}upload(t,e){const n={_type:t,_message:e};try{this.websocket.sendMessage(n)}catch{const r=v("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>r&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==lt.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},v("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,e){const n={_type:t,_message:e};this.websocket.sendMessage(n)}async sendExtensionMessage(t,e,n){return await this._external_signal.send(t,e,n)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new P((e,n)=>{this.once(H.WS_CONNECTED,()=>e(this.joinResponse)),this.once(H.WS_CLOSED,()=>n(this.initError||new M(R.WS_ABORT))),this.connectionState=lt.CONNECTING,this.websocket.init(t).catch(n)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||pt.LEAVE,this.connectionState=lt.CLOSED,E.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===pt.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new ga("gateway-".concat(this.clientId),this.spec.retryConfig,!0,v("JOIN_GATEWAY_USE_DUAL_DOMAIN"),v("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=Pt(6,""),this._external_signal.clear(),this._external_signal=new Rr(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await re(this,H.REQUEST_JOIN_INFO),e=await this.request(Q.JOIN,t);if(!e)return this.emit(H.REPORT_JOIN_GATEWAY,R.TIMEOUT,this.url||""),!1;this.joinResponse=e,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=lt.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,e)}handleDataStream(t){try{var e;const n=Xc(t.payload),s=new TextDecoder().decode(n),r=JSON.parse(s);"total"in r&&"id"in r||q(e=Object.values(Jt)).call(e,r._type)?(r._uid=t.uid,this._external_signal.onMessage(r)):this.emit(nt.ON_DATA_STREAM,t)}catch{this.emit(nt.ON_DATA_STREAM,t)}}handleNotification(t){E.debug("[".concat(this.clientId,"] receive notification: "),t);const e=Sr(t.code);if(e.action!=="success"){if(e.action!=="failed")return e.action==="quit"?(e.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(pt.UID_BANNED),void this.close()):void this.reconnect(e.action,ve.SERVER_ERROR);E.error("[".concat(this.clientId,"] ignore error: "),e.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=v("PING_PONG_TIME_OUT"),e=Date.now();this.pingpongTimeoutCount>=t&&(E.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(e-this.lastMsgTime,"ms")),e-this.lastMsgTime>v("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",ve.TIMEOUT):this.request(Q.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const n=Date.now()-e;this.rttRolling.add(n),v("REPORT_STATS")&&this.send(Q.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWebsocketEvents(){this.websocket.on(et.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(et.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(et.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(et.CLOSED,()=>{this.connectionState=lt.CLOSED}),this.websocket.on(et.FAILED,()=>{this._disconnectedReason=pt.NETWORK_ERROR,this.connectionState=lt.CLOSED}),this.websocket.on(et.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===lt.CONNECTED?this.connectionState=lt.RECONNECTING:this.connectionState=lt.CONNECTING}),this.websocket.on(et.WILL_RECONNECT,(t,e,n)=>{t!=="retry"?(E.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION)):E.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(t)}),this.websocket.on(et.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof M&&t.code===R.UNEXPECTED_RESPONSE&&t.data.code===Z.ERR_NO_AUTHORIZED)return E.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ve.SERVER_ERROR);E.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ve.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(et.REQUEST_NEW_URLS,(t,e)=>{re(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(e)}),this.websocket.on(et.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function sR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function un(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?sR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):sR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}const zh=new Map;class Pk extends Wt{get state(){return this._state}set state(t){if(t===this._state)return;const e=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(qt.CONNECTION_STATE_CHANGE,t,e,this._disconnectedReason):this.emit(qt.CONNECTION_STATE_CHANGE,t,e)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){E.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,e){super(),h(this,"store",void 0),h(this,"joinInfo",void 0),h(this,"key",void 0),h(this,"ntpOffset",0),h(this,"signal",void 0),h(this,"role",void 0),h(this,"inChannelInfo",{joinAt:null,duration:0}),h(this,"spec",void 0),h(this,"_state","DISCONNECTED"),h(this,"_statsCollector",void 0),h(this,"_disconnectedReason",void 0),h(this,"isSignalRecover",!1),h(this,"hasChangeBGPAddress",!1),h(this,"trafficStatsInterval",void 0),h(this,"networkQualityInterval",void 0),h(this,"_joinGatewayStartTime",0),h(this,"_signalTimeout",!1),h(this,"_clientRoleOptions",void 0),h(this,"_isProactiveJoin",!1),this.store=t,this.spec=e,this.signal=this.store.useP2P?new nR(un(un({},e),{},{retryConfig:e.websocketRetryConfig}),t):this.store.useDataChannel?new ns(un(un({},e),{},{retryConfig:e.websocketRetryConfig}),t):new qS(un(un({},e),{},{retryConfig:e.websocketRetryConfig}),t),this._statsCollector=e.statsCollector,this.role=e.role||"audience",this._clientRoleOptions=e.clientRoleOptions,this.handleSignalEvents()}async join(t,e,n){if(this.signal instanceof ns){let c=!1;t.cloudProxyServer!=="disabled"?(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),c=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):t.apResponse.addresses.some(d=>d.fingerprint)||v("FINGERPRINT")||(E.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const s=Date.now();let r=zh.get(t.cname);if(r||(r=new Map,zh.set(t.cname,r)),this._isProactiveJoin=!0,r.has(t.uid)){const c=new w(R.UID_CONFLICT);throw z.joinGateway(t.sid,{lts:s,succ:!1,ec:c.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof ns?"1":"0"}),this._isProactiveJoin=!1,c}r.set(t.uid,!0),this.joinInfo=t,this.key=e;let o=0;this.joinGatewayStartTime=s;const a=t.proxyServer;try{let c;if(E.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof ns?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof ns)c=await this.signal.init(t.apResponse.addresses,n);else{const d=t.gatewayAddrs.map(l=>{let{address:u}=l;const[p,_]=u.split(":"),S={host:p,port:_};return t.proxyServer&&(S.proxy=t.proxyServer),S});c=await this.signal.init(d,n)}o=c.uid,E.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof ns?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(c){throw c&&c.code===R.INIT_WEBSOCKET_TIMEOUT?(E.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===R.INIT_DATACHANNEL_TIMEOUT?(E.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(E.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),z.joinGateway(t.sid,{lts:s,succ:!1,ec:c.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof ns?"1":"0"}),this._isProactiveJoin=!1,r.delete(t.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),E.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{E.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(qt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(qt.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(qt.NETWORK_QUALITY,{uplinkNetworkQuality:tR(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:tR(this._statsCollector.trafficStats.B_dnq)}):this.emit(qt.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],e=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){e!==pt.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==lt.CONNECTED||await function(n,s){return s===1/0?n:P.race([n,rL(s)])}(this.signal.request(Q.LEAVE,void 0,!0),3e3)}catch(n){E.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),n)}this.signal.close(e),e!==pt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:e,mode:this.spec.mode,extend:v("PUB_EXTEND"),twcc:!!v("PUBLISH_TWCC"),rtx:!!v("USE_PUB_RTX")};try{return(await this.signal.request(Q.PUBLISH,s,!0))._message}catch(r){if(n&&r.data&&r.data.code===Z.ERR_PUBLISH_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),r.toString()),await this.tryUnpubBeforeRepub(t,e),this.publish(t,e,!1);throw r}}async publishDataChannel(t,e,n){var s;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={stream_id:e.streamId,ordered:e.ordered?1:0,max_retrans_times:(s=e.maxRetransmits)!==null&&s!==void 0?s:10,channel_id:e.channelId,metadata:e.metadata};try{await this.signal.request(Q.PUBLISH_DATASTREAM,r,!0)}catch(o){if(n&&o.data&&o.data.code===Z.ERR_PUBLISH_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(t,e),this.publishDataChannel(t,e,!1);throw o}}async unpublish(t,e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Q.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(n){E.warning("[".concat(this.store.clientId,"] unpublish warning: "),n)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await P.all(t.map(e=>this.signal.request(Q.UNPUBLISH_DATASTREAM,{channel_id:e},!0)))}catch(e){E.warning("unpublish datachannels warning: ",e)}}async presubscribe(t,e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const s={stream_id:t,stream_type:e,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!v("SUBSCRIBE_TWCC"),rtx:!!v("USE_SUB_RTX")||void 0,extend:v("SUB_EXTEND"),svc:Array.isArray(v("SVC"))&&v("SVC").length!==0?v("SVC"):void 0};try{return await this.signal.request(Q.PRE_SUBSCRIBE,s,!0)}catch(r){if(n&&r.data&&r.data.code===Z.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),r.toString()),this.presubscribe(t,e,!1);throw r}}async subscribe(t,e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:t,stream_type:e.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!v("SUBSCRIBE_TWCC"),rtx:!!v("USE_SUB_RTX"),extend:v("SUB_EXTEND"),ssrcId:e.ssrcId,svc:Array.isArray(v("SVC"))&&v("SVC").length!==0?v("SVC"):void 0};try{return(await this.signal.request(Q.SUBSCRIBE,s,!0))._message}catch(r){if(n&&r.data&&r.data.code===Z.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),r.toString()),await this.tryUnsubBeforeResub(t,e),await this.subscribe(t,e,!1);throw r}}async subscribeDataChannel(t,e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:t,stream_id:e.id,channel_id:e.datachannelId};try{return void await this.signal.request(Q.SUBSCRIBE_DATASTREAM,s,!0)}catch(r){if(n&&r.data&&r.data.code===Z.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),r.toString()),await this.tryUnsubDataChannelBeforeResub(t,e),await this.subscribeDataChannel(t,e,!1);throw r}}async subscribeAll(t,e){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!v("USE_SUB_RTX")};try{return await this.signal.request(Q.SUBSCRIBE_STREAMS,n,!0)}catch(s){if(e&&s.data&&s.data.code===Z.ERR_SUBSCRIBE_REQUEST_INVALID)return E.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),s.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw s}}async setVideoProfile(t){const e=function(n){if(!(n.bitrateMax&&n.bitrateMin&&n.frameRate&&n.height&&n.width))return;let s=n.frameRate,r=n.width,o=n.height,a=!0;return typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,s||(a=!1)),a?{stream_type:0,width:r,height:o,fps:s,start_bps:1e3*n.bitrateMax,min_bps:1e3*n.bitrateMin,target_bps:1e3*n.bitrateMax}:void 0}(t);if(e)return this.signal.request(Q.SET_VIDEO_PROFILE,e);E.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,e){try{await this.signal.request(Q.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:e},!0)}catch(n){E.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),n)}}async unsubscribeDataChannel(t,e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await P.all(t.map(n=>this.signal.request(Q.UNSUBSCRIBE_DATASTREAM,{stream_id:n,uid:e},!0)))}catch(n){E.warning("unsubscribeDataChannel warning: ",n)}}async massUnsubscribe(t){try{await this.signal.request(Q.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){E.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(t){const{iceParameters:e,dtlsParameters:n,rtpCapabilities:s}=t;return{gatewayEstablishParams:await this.signal.request(Q.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:e,dtlsParameters:n,rtpCapabilities:s}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Q.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Q.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,e){if(e&&(this._clientRoleOptions=Object.assign({},e)),this.state!=="CONNECTED")return void(this.role=t);let n,s=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,s=1):s=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:s=0,await this.signal.request(Q.SET_CLIENT_ROLE,{role:t,level:s,delay:n,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,e){await this.signal.request(Q.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:e})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Q.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,e){await this.signal.request(Q.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:e})}async pickSVCLayer(t,e){await this.signal.request(Q.PICK_SVC_LAYER,{stream_id:t,spatial_layer:e.spatialLayer,temporal_layer:e.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Q.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,e,n){if(this.signal instanceof nR)return this.signal.sendExtensionMessage(t,e,n)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),un({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Q.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=zh.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(e){let n;return n=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),n?{username:ni.username,password:ni.password,turnServerURL:n[2],tcpport:parseInt(n[3])+30,udpport:parseInt(n[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(un(un({},ni),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(Q.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(e=>{const n=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(s=>s.peer_uid===e.peer_uid);n&&n.B_st!==e.B_st&&zc(()=>{this.emit(qt.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new w(R.UNEXPECTED_ERROR,"can not generate join message, no join info");const e=Object.assign({},this.joinInfo.apResponse);let n=v("REPORT_APP_SCENARIO");if(typeof n!="string")try{n=JSON.stringify(n)}catch{n=void 0}n&&n.length>128&&(n=void 0);const s=un({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Ji,browser:navigator.userAgent,process_id:v("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:e,extend:v("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:n,attributes:{userAttributes:{enablePublishedUserList:v("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:v("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof v("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?v("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof v("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?v("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof v("ENABLE_USER_LICENSE_CHECK")=="boolean"?v("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:v("USE_PUB_RTX")===!0||v("USE_SUB_RTX")===!0||void 0,disableFEC:v("DISABLE_FEC"),enableNTPReport:!!v("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!v("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof v("ENABLE_DATASTREAM_2")=="boolean"?v("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!v("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof v("USE_XR")=="boolean"?v("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(s.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(s.aes_mode=this.joinInfo.aesmode,v("ENCRYPT_AES")?(s.aes_secret=this.joinInfo.aespassword,s.aes_encrypt=!0):s.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(s.aes_salt=this.joinInfo.aessalt)),e.addresses[this.signal.websocket.currentURLIndex]&&(s.ap_response.ticket=e.addresses[this.signal.websocket.currentURLIndex].ticket,delete e.addresses),this.joinInfo.defaultVideoStream!==void 0&&(s.default_video_stream=this.joinInfo.defaultVideoStream),s}getRejoinMessage(){if(!this.joinInfo)throw new w(R.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(H.WS_RECONNECT_WAITTING_FINISH,t=>{var e;q(e=["tryNext","recover"]).call(e,t)&&this.joinInfo&&z.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(H.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(H.WS_RECONNECTING,t=>{this.joinInfo&&z.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||ve.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",z.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(H.WS_CLOSED,t=>{let e;switch(t){case pt.LEAVE:e=ve.LEAVE;break;case pt.UID_BANNED:case pt.IP_BANNED:case pt.CHANNEL_BANNED:case pt.SERVER_ERROR:e=ve.SERVER_ERROR;break;case pt.FALLBACK:e=ve.FALLBACK;break;case pt.LICENSE_MISSING:case pt.LICENSE_EXPIRED:case pt.LICENSE_MINUTES_EXCEEDED:case pt.LICENSE_PERIOD_INVALID:case pt.LICENSE_MULTIPLE_SDK_SERVICE:case pt.LICENSE_ILLEGAL:case pt.TOKEN_EXPIRE:e=t;break;default:e=ve.NETWORK_ERROR}E.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(e||"undefined -> "+ve.NETWORK_ERROR)),this.joinInfo&&z.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===pt.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e}),this._disconnectedReason=t,t!==pt.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(H.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(E.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),z.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof ns?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void E.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));wt("EVENT_REPORT_DOMAIN",t[1]),wt("EVENT_REPORT_BACKUP_DOMAIN",t[1]),wt("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}),this.signal.on(nt.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(H.REQUEST_RECOVER,(t,e,n)=>{if(!this.joinInfo)return n(new w(R.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,re(this,qt.REQUEST_NEW_GATEWAY_LIST).then(e).catch(n)}),this.signal.on(H.REQUEST_JOIN_INFO,async t=>{var e;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const{iceParameters:n,dtlsParameters:s,rtpCapabilities:r}=await re(this,qt.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(e=this.joinInfo)===null||e===void 0?void 0:e.turnServer});t(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:s,rtpCapabilities:r,version:"2"}}))}),this.signal.on(H.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(H.REPORT_JOIN_GATEWAY,(t,e)=>{this.joinInfo&&(z.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:e,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof ns?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(H.IS_P2P_DISCONNECTED,t=>{t(pr(this,qt.IS_P2P_DISCONNECTED))}),this.signal.on(H.DISCONNECT_P2P,()=>{this.emit(qt.DISCONNECT_P2P)}),this.signal.on(H.NEED_RENEW_SESSION,()=>{this.emit(qt.NEED_RENEW_SESSION)}),this.signal.on(H.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(H.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(H.JOIN_RESPONSE,t=>{const e=this.getCurrentGatewayAddress();this.emit(qt.JOIN_RESPONSE,t,e)}),this.signal.on(H.DATACHANNEL_PRECONNECT,async(t,e,n)=>{this.updateTurnConfigFromSignal();const s=this.getCurrentGatewayAddress();return re(this,qt.DATACHANNEL_PRECONNECT,t,s).then(e).catch(n)}),this.signal.on(H.DATACHANNEL_CONNECTING,async t=>{const{iceParameters:e,dtlsParameters:n,rtpCapabilities:s}=await re(this,qt.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:e,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))}),this.signal.on(H.DATACHANNEL_FAILBACK,()=>{E.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(qt.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,e){try{await this.signal.request(Q.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[e]},!0)}catch(n){throw E.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),n),n}}async tryUnsubDataChannelBeforeResub(t,e){try{await this.signal.request(Q.UNSUBSCRIBE,{stream_id:e.id},!0)}catch(n){throw E.warning("unsubscribe datachannel warning",n),n}}async tryUnpubBeforeRepub(t,e){try{await this.signal.request(Q.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(n){throw E.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),n),n}}async tryUnpubDataChannelBeforeRepub(t,e){try{await this.signal.request(Q.UNPUBLISH_DATASTREAM,{channnel_id:e.channelId},!0)}catch(n){throw E.warning("unpublish datastream warning: ",n),n}}async tryMassUnsubBeforeResub(t){const e={users:t.map(n=>({stream_id:n.stream_id,stream_type:n.stream_type}))};try{await this.signal.request(Q.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){throw E.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),n),n}}async muteLocal(t,e){const n={action:t.find(s=>s.stream_type===St.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Q.CONTROL,n,!0,!0)}catch(s){throw E.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),s),s}}async unmuteLocal(t,e){const n={action:t.find(s=>s.stream_type===St.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:e};try{await this.signal.request(Q.CONTROL,n,!0,!0)}catch(s){throw E.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),s),s}}async muteRemote(t,e){const n={action:t===J.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(Q.CONTROL,n,!0,!0)}catch(s){throw E.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),s),s}}async unmuteRemote(t,e){const n={action:t===J.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:e};try{await this.signal.request(Q.CONTROL,n,!0,!0)}catch(s){throw E.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),s),s}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,e){this.signal.upload(t,e)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const e={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Q.RESTART_ICE,e,!0)}catch(n){throw E.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),n),n}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,ve.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!v("GATEWAY_WSS_ADDRESS"))return(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Q.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(pt.FALLBACK)),this.store.useDataChannel=!1,this.signal=new qS(un(un({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(qt.RESET_SIGNAL,ud.websocket)}}let md=0,Xh=0;function ss(i,t,e,n){return new P((s,r)=>{t.timeout=t.timeout||v("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!e?(t.data=JSON.stringify(t.data),md+=Mn(t.data)):e&&(t.data.size?md+=t.data.size:t.data instanceof FormData?md+=CT(t.data):md+=Mn(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=i,hi.request(t).then(o=>{typeof o.data=="string"?Xh+=Mn(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?Xh+=o.data.byteLength:Xh+=Mn(JSON.stringify(o.data)),n&&s({data:o.data,headers:o.headers}),s(o.data)}).catch(o=>{hi.isCancel(o)?r(new w(R.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?r(new w(R.NETWORK_TIMEOUT,o.message)):o.response?r(new w(R.NETWORK_RESPONSE_ERROR,o.response.status)):r(new w(R.NETWORK_ERROR,o.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var i;function t(x){var G=0;return function(){return G<x.length?{done:!1,value:x[G++]}:{done:!0}}}var e=typeof Object.defineProperties=="function"?Object.defineProperty:function(x,G,Y){return x==Array.prototype||x==Object.prototype||(x[G]=Y.value),x},n,s=function(x){x=[typeof globalThis=="object"&&globalThis,x,typeof window=="object"&&window,typeof self=="object"&&self,typeof Ri=="object"&&Ri];for(var G=0;G<x.length;++G){var Y=x[G];if(Y&&Y.Math==Math)return Y}throw Error("Cannot find global object")}(this);function r(x,G){if(G)t:{var Y=s;x=x.split(".");for(var st=0;st<x.length-1;st++){var gt=x[st];if(!(gt in Y))break t;Y=Y[gt]}(G=G(st=Y[x=x[x.length-1]]))!=st&&G!=null&&e(Y,x,{configurable:!0,writable:!0,value:G})}}function o(x){return(x={next:x})[Symbol.iterator]=function(){return this},x}function a(x){var G=typeof Symbol<"u"&&Symbol.iterator&&x[Symbol.iterator];return G?G.call(x):{next:t(x)}}if(r("Symbol",function(x){function G(gt,W){this.A=gt,e(this,"description",{configurable:!0,writable:!0,value:W})}if(x)return x;G.prototype.toString=function(){return this.A};var Y="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",st=0;return function gt(W){if(this instanceof gt)throw new TypeError("Symbol is not a constructor");return new G(Y+(W||"")+"_"+st++,W)}}),r("Symbol.iterator",function(x){if(x)return x;x=Symbol("Symbol.iterator");for(var G="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),Y=0;Y<G.length;Y++){var st=s[G[Y]];typeof st=="function"&&typeof st.prototype[x]!="function"&&e(st.prototype,x,{configurable:!0,writable:!0,value:function(){return o(t(this))}})}return x}),typeof Object.setPrototypeOf=="function")n=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}n=c?function(x,G){if(x.__proto__=G,x.__proto__!==G)throw new TypeError(x+" is not extensible");return x}:null}var l=n;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(x){if(x.m)throw new TypeError("Generator is already running");x.m=!0}function _(x,G){return x.h=3,{value:G}}function S(x){this.g=new u,this.G=x}function f(x,G,Y,st){try{var gt=G.call(x.g.j,Y);if(!(gt instanceof Object))throw new TypeError("Iterator result "+gt+" is not an object");if(!gt.done)return x.g.m=!1,gt;var W=gt.value}catch(m){return x.g.j=null,x.g.s(m),g(x)}return x.g.j=null,st.call(x.g,W),g(x)}function g(x){for(;x.g.h;)try{var G=x.G(x.g);if(G)return x.g.m=!1,{value:G.value,done:!1}}catch(Y){x.g.v=void 0,x.g.s(Y)}if(x.g.m=!1,x.g.l){if(G=x.g.l,x.g.l=null,G.F)throw G.D;return{value:G.return,done:!0}}return{value:void 0,done:!0}}function C(x){this.next=function(G){return x.o(G)},this.throw=function(G){return x.s(G)},this.return=function(G){return function(Y,st){p(Y.g);var gt=Y.g.j;return gt?f(Y,"return"in gt?gt.return:function(W){return{value:W,done:!0}},st,Y.g.return):(Y.g.return(st),g(Y))}(x,G)},this[Symbol.iterator]=function(){return this}}function y(x,G){return G=new C(new S(G)),l&&x.prototype&&l(G,x.prototype),G}if(u.prototype.o=function(x){this.v=x},u.prototype.s=function(x){this.l={D:x,F:!0},this.h=this.C||this.u},u.prototype.return=function(x){this.l={return:x},this.h=this.u},S.prototype.o=function(x){return p(this.g),this.g.j?f(this,this.g.j.next,x,this.g.o):(this.g.o(x),g(this))},S.prototype.s=function(x){return p(this.g),this.g.j?f(this,this.g.j.throw,x,this.g.o):(this.g.s(x),g(this))},r("Array.prototype.entries",function(x){return x||function(){return function(G,Y){G instanceof String&&(G+="");var st=0,gt=!1,W={next:function(){if(!gt&&st<G.length){var m=st++;return{value:Y(m,G[m]),done:!1}}return gt=!0,{done:!0,value:void 0}}};return W[Symbol.iterator]=function(){return W},W}(this,function(G,Y){return[G,Y]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var A=function(x,G){for(var Y=0;Y<x.length;Y++)G(x[Y])},k=function(x){return x.replace(/\r?\n|\r/g,`\r
`)},O=function(x,G,Y){return G instanceof Blob?(Y=Y!==void 0?Y+"":typeof G.name=="string"?G.name:"blob",G.name===Y&&Object.prototype.toString.call(G)!=="[object Blob]"||(G=new File([G],Y)),[String(x),G]):[String(x),String(G)]},N=function(x,G){if(x.length<G)throw new TypeError(G+" argument required, but only "+x.length+" present.")},L=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,D=L.FormData,F=L.XMLHttpRequest&&L.XMLHttpRequest.prototype.send,j=L.Request&&L.fetch,it=L.navigator&&L.navigator.sendBeacon,ct=L.Element&&L.Element.prototype,Ut=L.Symbol&&Symbol.toStringTag;Ut&&(Blob.prototype[Ut]||(Blob.prototype[Ut]="Blob"),"File"in L&&!File.prototype[Ut]&&(File.prototype[Ut]="File"));try{new File([],"")}catch{L.File=function(G,Y,st){return G=new Blob(G,st||{}),Object.defineProperties(G,{name:{value:Y},lastModified:{value:+(st&&st.lastModified!==void 0?new Date(st.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ut&&Object.defineProperty(G,Ut,{value:"File"}),G}}var he=function(x){return x.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Bt=function(x){this.i=[];var G=this;x&&A(x.elements,function(Y){if(Y.name&&!Y.disabled&&Y.type!=="submit"&&Y.type!=="button"&&!Y.matches("form fieldset[disabled] *"))if(Y.type==="file"){var st=Y.files&&Y.files.length?Y.files:[new File([],"",{type:"application/octet-stream"})];A(st,function(gt){G.append(Y.name,gt)})}else Y.type==="select-multiple"||Y.type==="select-one"?A(Y.options,function(gt){!gt.disabled&&gt.selected&&G.append(Y.name,gt.value)}):Y.type==="checkbox"||Y.type==="radio"?Y.checked&&G.append(Y.name,Y.value):(st=Y.type==="textarea"?k(Y.value):Y.value,G.append(Y.name,st))})};if((i=Bt.prototype).append=function(x,G,Y){N(arguments,2),this.i.push(O(x,G,Y))},i.delete=function(x){N(arguments,1);var G=[];x=String(x),A(this.i,function(Y){Y[0]!==x&&G.push(Y)}),this.i=G},i.entries=function x(){var G,Y=this;return y(x,function(st){if(st.h==1&&(G=0),st.h!=3)return G<Y.i.length?st=_(st,Y.i[G]):(st.h=0,st=void 0),st;G++,st.h=2})},i.forEach=function(x,G){N(arguments,1);for(var Y=a(this),st=Y.next();!st.done;st=Y.next()){var gt=a(st.value);st=gt.next().value,gt=gt.next().value,x.call(G,gt,st,this)}},i.get=function(x){N(arguments,1);var G=this.i;x=String(x);for(var Y=0;Y<G.length;Y++)if(G[Y][0]===x)return G[Y][1];return null},i.getAll=function(x){N(arguments,1);var G=[];return x=String(x),A(this.i,function(Y){Y[0]===x&&G.push(Y[1])}),G},i.has=function(x){N(arguments,1),x=String(x);for(var G=0;G<this.i.length;G++)if(this.i[G][0]===x)return!0;return!1},i.keys=function x(){var G,Y,st,gt,W=this;return y(x,function(m){if(m.h==1&&(G=a(W),Y=G.next()),m.h!=3)return Y.done?void(m.h=0):(st=Y.value,gt=a(st),_(m,gt.next().value));Y=G.next(),m.h=2})},i.set=function(x,G,Y){N(arguments,2),x=String(x);var st=[],gt=O(x,G,Y),W=!0;A(this.i,function(m){m[0]===x?W&&(W=!st.push(gt)):st.push(m)}),W&&st.push(gt),this.i=st},i.values=function x(){var G,Y,st,gt,W=this;return y(x,function(m){if(m.h==1&&(G=a(W),Y=G.next()),m.h!=3)return Y.done?void(m.h=0):(st=Y.value,(gt=a(st)).next(),_(m,gt.next().value));Y=G.next(),m.h=2})},Bt.prototype._asNative=function(){for(var x=new D,G=a(this),Y=G.next();!Y.done;Y=G.next()){var st=a(Y.value);Y=st.next().value,st=st.next().value,x.append(Y,st)}return x},Bt.prototype._blob=function(){var x="----formdata-polyfill-"+Math.random(),G=[],Y="--"+x+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(st,gt){return typeof st=="string"?G.push(Y+he(k(gt))+`"\r
\r
`+k(st)+`\r
`):G.push(Y+he(k(gt))+'"; filename="'+he(st.name)+`"\r
Content-Type: `+(st.type||"application/octet-stream")+`\r
\r
`,st,`\r
`)}),G.push("--"+x+"--"),new Blob(G,{type:"multipart/form-data; boundary="+x})},Bt.prototype[Symbol.iterator]=function(){return this.entries()},Bt.prototype.toString=function(){return"[object FormData]"},ct&&!ct.matches&&(ct.matches=ct.matchesSelector||ct.mozMatchesSelector||ct.msMatchesSelector||ct.oMatchesSelector||ct.webkitMatchesSelector||function(x){for(var G=(x=(this.document||this.ownerDocument).querySelectorAll(x)).length;0<=--G&&x.item(G)!==this;);return-1<G}),Ut&&(Bt.prototype[Ut]="FormData"),F){var Ai=L.XMLHttpRequest.prototype.setRequestHeader;L.XMLHttpRequest.prototype.setRequestHeader=function(x,G){Ai.call(this,x,G),x.toLowerCase()==="content-type"&&(this.B=!0)},L.XMLHttpRequest.prototype.send=function(x){x instanceof Bt?(x=x._blob(),this.B||this.setRequestHeader("Content-Type",x.type),F.call(this,x)):F.call(this,x)}}j&&(L.fetch=function(x,G){return G&&G.body&&G.body instanceof Bt&&(G.body=G.body._blob()),j.call(this,x,G)}),it&&(L.navigator.sendBeacon=function(x,G){return G instanceof Bt&&(G=G._asNative()),it.call(this,x,G)}),L.FormData=Bt}})();const fd=()=>{const i=v("AREAS");return i.length===0&&i.push(mt.GLOBAL),mr(i).call(i,(t,e,n)=>{const s=rR(e);return s?n===0?s:"".concat(t,",").concat(s):t},"")},rR=i=>i===mt.OVERSEA?"".concat(Pe.ASIA,",").concat(Pe.EUROPE,",").concat(Pe.AFRICA,",").concat(Pe.NORTH_AMERICA,",").concat(Pe.SOUTH_AMERICA,",").concat(Pe.OCEANIA):Pe[i],Lk=i=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return i.map(e=>{const n=hd[e],s=Object.keys(n);s&&s.map(r=>{r!=="CODE"&&(t[r]=t[r].concat(n[r]))})}),t},gd={GLOBAL:{ASIA:[mt.CHINA,mt.JAPAN,mt.INDIA,mt.KOREA,mt.HKMC],EUROPE:[],NORTH_AMERICA:[mt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Td=Object.keys(gd[mt.GLOBAL]),Qh=[mt.CHINA,mt.NORTH_AMERICA,mt.EUROPE,mt.ASIA,mt.JAPAN,mt.INDIA,mt.OCEANIA,mt.SOUTH_AMERICA,mt.AFRICA,mt.KOREA,mt.HKMC,mt.US],kk=function(i,t){let e=[];if(q(i).call(i,mt.GLOBAL)){const r=[mt.GLOBAL,mt.OVERSEA],o=Object.keys(hd);if(t===mt.GLOBAL)throw new w(R.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===mt.CHINA)e=[mt.OVERSEA];else if(s=t,q(Td).call(Td,s)){const a=(n=t,gd[mt.GLOBAL][n]||[]),c=[...r,t,...a];e=o.filter(d=>!q(c).call(c,d))}else if(function(a){let c=!1;return Td.forEach(d=>{var l;q(l=gd[mt.GLOBAL][d]).call(l,a)&&(c=!0)}),c}(t)){const a=function(d){let l;return Td.forEach(u=>{var p;q(p=gd[mt.GLOBAL][u]).call(p,d)&&(l=u)}),l}(t),c=[...r,a,t];e=o.filter(d=>!q(c).call(c,d))}else e=i;e=function(a){const c=[];return Qh.forEach(d=>{q(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!q(Qh).call(Qh,d)))}(e)}else e=i;var n,s;return e};function oR(i){var t,e;if(!i&&q(t=v("AREAS")).call(t,mt.EXTENSIONS))return E.debug("update area from ap : reset"),void Zh(tk,!0);if(!q(e=v("AREAS")).call(e,mt.GLOBAL)||!i)return;let n=hd.EXTENSIONS;n&&(n={CODE:rR(mt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(i,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(i,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(i,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(i,".agora.io"),"cds-ap-web-2-".concat(i,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(i,".agora.io"),"sua-ap-web-2-".concat(i,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(i,".agora.io"),"uap-ap-web-2-".concat(i,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(i,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(i,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(i,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(i,".agora.io")]},E.debug("update area from ap success: ".concat(i,",config is "),n),wt("AREAS",[mt.EXTENSIONS],!0),Object.keys(n).map(s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?wt(s,n[s][0]):wt(s,n[s])}))}function Zh(i){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const e=z.reportApiInvoke(null,{name:le.SET_AREA,options:i,tag:Yt.TRACER});try{let n=[];if(typeof i=="string"&&(n=[i]),Array.isArray(i)&&(i.forEach(r=>{if(!q(US).call(US,r))throw new w(R.INVALID_PARAMS,"invalid area code")}),n=i),Object.prototype.toString.call(i)==="[object Object]"){const{areaCode:r,excludedArea:o}=i;if(!r)throw new w(R.INVALID_PARAMS,"area code is needed");let a=r;typeof r=="string"&&(a=[r]),n=o?kk(a,o):a}if(!t){if(bs.AREAS){const r=new w(R.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return e.onError(r),void E.warning("setArea is prohibited because of config-distribute")}if(q(n).call(n,mt.GLOBAL)&&v("AREAS")===mt.EXTENSIONS){const r=new w(R.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return e.onError(r),void E.warning("setArea is prohibited because of ap extensions")}}wt("AREAS",n,t);const s=Lk(n);Object.keys(s).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?wt(r,s[r][0]):wt(r,s[r])}),E.debug("set area success:",n.join(","))}catch(n){throw e.onError(n),n}e.onSuccess()}function aR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function $h(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?aR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):aR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}let tp=1;function Mk(i,t,e,n,s){tp+=1;const r={sid:e.sid,command:"convergeAllocateEdge",uid:"666",appId:e.appId,ts:Math.floor(Date.now()/1e3),seq:tp,requestId:tp,version:Ji,cname:e.cname},o={service_name:t,json_body:JSON.stringify(r)};let a,c,d=i[0];return Cn(async()=>{a=Date.now();const l=await ss(d,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){const _=new w(R.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw E.error(_.toString()),_}const u=JSON.parse(l.json_body);if(u.code!==200){const _=new w(R.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw E.error(_.toString()),_}if(!u.servers||u.servers.length===0){const _=new w(R.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw E.error(_.toString()),_}const p=function(_,S){return{addressList:_.servers.map(f=>"wss://".concat(f.address.replace(/\./g,"-"),".").concat(v("WORKER_DOMAIN"),":").concat(f.wss,"?serviceName=").concat(encodeURIComponent(S))),workerToken:_.workerToken,vid:_.vid}}(u,t);return v("LIVE_STREAMING_ADDRESS")&&(p.addressList=v("LIVE_STREAMING_ADDRESS")instanceof Array?v("LIVE_STREAMING_ADDRESS"):[v("LIVE_STREAMING_ADDRESS")]),$h($h({},p),{},{responseTime:c})},(l,u)=>(z.apworkerEvent(e.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:i[u%i.length]}),!1),(l,u)=>(z.apworkerEvent(e.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:t,responseTime:c,serverIp:i[u%i.length]}),!!(l.code!==R.OPERATION_ABORTED&&l.code!==R.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=i[(u+1)%i.length],!0)),s)}let ep=1;function cR(i,t,e,n){let{url:s,areaCode:r}=i;const o=Date.now();let a;const[c,d]=hR(t,r,[be.CHOOSE_SERVER]);let l=oe.networkState;return Cn(async()=>{l&&oe.networkState===Ze.OFFLINE&&oe.onlineWaiter&&await P.race([oe.onlineWaiter,ye(n&&n.maxRetryTimeout||ae.maxRetryTimeout)]),l=oe.networkState;const{data:u,headers:p}=await ss(s,{data:c,cancelToken:e,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a=p.http3==="1"?1:-1,z.reportResourceTiming(s,t.sid),lR(u,s,t,o,[be.CHOOSE_SERVER],a);const _=qh(u,be.CHOOSE_SERVER);return uR(_),ZS(_,s)},u=>(u&&z.joinChooseServer(t.sid,{lts:o,succ:!0,csAddr:s,opid:d,serverList:u.gatewayAddrs.map(p=>p.address),ec:null,cid:u.cid.toString(),uid:u.uid.toString(),csIp:u.csIp,unilbsServerIds:[be.CHOOSE_SERVER].toString(),isHttp3:a}),!1),u=>u.code!==R.OPERATION_ABORTED&&(u.code===R.CAN_NOT_GET_GATEWAY_SERVER?u.data.retry:(z.joinChooseServer(t.sid,{lts:o,succ:!1,csAddr:s,serverList:null,opid:d,ec:u.code,csIp:u.data&&u.data.csIp,unilbsServerIds:[be.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:l}),isHttp3:a}),E.warning("[".concat(t.clientId,"] Choose server network error, retry"),u),!0)),n)}function dR(i,t,e,n){let s,{url:r,areaCode:o,serviceIds:a}=i;const c=Date.now(),[d,l]=hR(t,o,a);let u;return Cn(async()=>{u&&oe.networkState===Ze.OFFLINE&&oe.onlineWaiter&&await P.race([oe.onlineWaiter,ye(n&&n.maxRetryTimeout||ae.maxRetryTimeout)]),u=oe.networkState;const{data:p,headers:_}=await ss(r,{data:d,cancelToken:e,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s=_.http3==="1"?1:-1,z.reportResourceTiming(r,t.sid),lR(p,r,t,c,a,s);const S=qh(p,be.CHOOSE_SERVER),f=qh(p,t.cloudProxyServer==="proxy5"?be.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?be.CLOUD_PROXY:be.CLOUD_PROXY_FALLBACK);return uR(S),{gatewayInfo:ZS(S,r),proxyInfo:f,url:r}},p=>(p.gatewayInfo&&z.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:r,serverList:p.gatewayInfo.gatewayAddrs.map(_=>_.address),ec:null,opid:l,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:s}),p.proxyInfo&&z.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:r,turnServerAddrList:p.proxyInfo.addresses.map(_=>_.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==R.OPERATION_ABORTED&&(p.code===R.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(z.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:r,turnServerAddrList:null,errorCode:p.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:u})}),E.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),p),!0)),n)}const lR=(i,t,e,n,s,r)=>{const o=[],a=c=>{c.flag===4096?z.joinChooseServer(e.sid,{lts:n,succ:!1,csAddr:t,opid:i.opid,serverList:null,ec:c.error.message,csIp:c.error.data&&c.error.data.csIp,unilbsServerIds:s.toString(),isHttp3:r}):c.flag!==1048576&&c.flag!==4194304&&c.flag!==4194310||z.joinWebProxyAP(e.sid,{lts:n,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:c.error.code,eventType:e.cloudProxyServer,unilbsServerIds:s.toString()})};if(i.response_body.forEach(c=>{const d=c.buffer.code;if(c.uri===23&&d===0&&!c.buffer.edges_services)if(c.buffer.flag===4194310)E.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),c.buffer.edges_services=[];else{const l={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:i.detail[502]}),flag:c.buffer.flag};o.push(l),a(l)}if(d!==0){const l=_d(d),u={error:new w(R.CAN_NOT_GET_GATEWAY_SERVER,l.desc,{desc:l.desc,retry:l.retry,csIp:i.detail[502]}),flag:c.buffer.flag};c.buffer.flag===4194310?E.warning(u.error.toString()):o.push(u),a(u)}}),o.length)throw E.warning("[".concat(e.clientId,"] multi unilbs ").concat(t," failed, ").concat(o.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message,", retry: ").concat(c.error.data.retry)).join(" | "))),new w(R.CAN_NOT_GET_GATEWAY_SERVER,o.map(c=>"flag: ".concat(c.flag,", message: ").concat(c.error.message)).join(" | "),{retry:!!o.find(c=>c.error.data.retry),csIp:i.detail[502],desc:[...new Set(o.map(c=>{var d;return c==null||(d=c.error)===null||d===void 0||(d=d.data)===null||d===void 0?void 0:d.desc}).filter(c=>!!c))]})},uR=i=>{var t,e,n,s;if(i.addresses&&i.addresses.length===0&&i.code===0)throw new w(R.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:i.detail&&i.detail[502]});if(v("AP_AREA")&&((n=i.detail)!==null&&n!==void 0&&n[23]&&typeof((s=i.detail)===null||s===void 0?void 0:s[23])=="string"?oR(i.detail[23].toLowerCase()):oR()),(t=i.detail)!==null&&t!==void 0&&t[19]&&typeof((e=i.detail)===null||e===void 0?void 0:e[19])=="string"){const o=i.detail[19],a=o==null?void 0:o.split(";");for(let c=0;c<a.length;c++){var r;const d=Yh(r=a[c]).call(r);i.addresses[c]&&a&&(i.addresses[c].fingerprint=d)}}if(v("GATEWAY_ADDRESS")&&v("GATEWAY_ADDRESS").length>0){E.debug("assign gateway address to",v("GATEWAY_ADDRESS"));const o=v("GATEWAY_ADDRESS").map(a=>{var c,d;const l=(c=(d=i.addresses.find(u=>u.ip===a.ip&&u.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:i.addresses[0]&&i.addresses[0].ticket,fingerprint:l}});i.addresses=o}},Uk=(i,t)=>{if(i.response_body&&i.response_body.length){const e=i.response_body[0];if(e.buffer.code!==0){const n=_d(e.buffer.code);throw new w(R.UPDATE_TICKET_FAILED,"[".concat(e.buffer.code,"]: ").concat(n.desc),{retry:n.retry})}return e.buffer.ticket}throw E.debug("update ticket request received ap response without response body:",t),new w(R.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},hR=(i,t,e)=>{const n=Math.floor(Math.random()*1e12),s={appid:i.appId,client_ts:Date.now(),opid:n,sid:i.sid,request_bodies:[{uri:22,buffer:{cname:i.cname,detail:$h({6:i.stringUid,11:t,12:v("USE_NEW_TOKEN")?"1":void 0,22:t},i.apRTM?{26:"RTM2"}:{}),key:i.token,service_ids:e,uid:i.uid||0}}]};s.request_bodies.forEach(o=>{i.multiIP&&i.multiIP.gateway_ip&&(o.buffer.detail[5]=JSON.stringify({vocs_ip:[i.multiIP.uni_lbs_ip],vos_ip:[i.multiIP.gateway_ip]}))});const r=new FormData;return r.append("request",JSON.stringify(s)),[r,n]},xk=(i,t)=>{const e=Math.floor(Math.random()*1e12),n={appid:i.appId,client_ts:Date.now(),opid:e,sid:i.sid,request_bodies:[{uri:28,buffer:{cname:i.cname,detail:{1:"",6:i.stringUid,12:"1"},token:i.token,service_ids:t,uid:i.uid||0,edges_services:i.apResponse.addresses.map(r=>({ip:r.ip,port:r.port}))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,e]};let mo=0;function fo(i){return P.all(i.map(t=>t.then(e=>{throw e},e=>e))).then(t=>{throw t},t=>t)}const Sa=async i=>{let{fragementLength:t,referenceList:e,asyncMapHandler:n,allFailedhandler:s,promisesCollector:r}=i,o=0;const a=t;let c,d=0;const l=async()=>{const u=(()=>{const p=o*a,_=p+a;return e.slice(p,_).map(n)})();r&&r.push(...u);try{c=await fo(u)}catch(p){if(d+=a,o++,!(d>=e.length))return void await l();s(p)}u.forEach(p=>p.cancel())};return await l(),c};async function ip(i,t,e,n){return{gatewayInfo:await async function(r,o,a,c){let d=null;const l=[],u=async()=>{const _=v("WEBCS_DOMAIN").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(g=>({url:r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:fd()})),S=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(g=>g.url)}),f=await Sa({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:g=>(E.debug("[".concat(r.clientId,"] Connect to choose_server:"),g.url),cR(g,r,o,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},S),g[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},S),f},p=async()=>{if(await ye(1e3),d!==null)return d;const _=v("WEBCS_DOMAIN_BACKUP_LIST").map(g=>({url:r.proxyServer?"https://".concat(r.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:fd()})),S=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(g=>g.url)}),f=await Sa({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:g=>(E.debug("[".concat(r.clientId,"] Connect to backup choose_server:"),g.url),cR(g,r,o,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},S),g[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},S),f};try{return d=await fo([u(),p()]),l.length&&l.forEach(_=>_.cancel&&typeof _.cancel=="function"&&_.cancel()),d}catch(_){throw _[0]}}(i,t,e,n)}}async function pR(i,t,e,n,s){const r=i.cloudProxyServer;if(r==="disabled"){if(!n)return;if(i.useLocalAccessPoint)return await ip(i,t,e,s);if(v("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:p,proxyInfo:_}=await ER(i,t,e,s);if(i.turnServer&&i.turnServer.mode!=="auto")return{gatewayInfo:p};const S=_.map(f=>({turnServerURL:f.address,tcpport:f.tcpport||ni.tcpport,udpport:f.udpport||ni.udpport,username:f.username||ni.username,password:f.password||ni.password,forceturn:!1,security:!0}));if(s.useP2P){var o;const f=(o=i.uid)!==null&&o!==void 0?o:p.uid,g="glb:".concat(f.toString()),C=await ch(g),y=_.map(A=>({turnServerURL:A.address,tcpport:A.tcpport||ni.tcpport,udpport:A.udpport||ni.udpport,username:g,password:C,forceturn:!1,security:!0}));S.push(...y)}return i.turnServer={mode:"manual",servers:S},{gatewayInfo:p}}return await ip(i,t,e,s)}const{proxyInfo:a,gatewayInfo:c}=await ER(i,t,e,s),d={gatewayInfo:c},l=a.map(p=>({turnServerURL:p.address,tcpport:r==="proxy3"?void 0:p.tcpport?p.tcpport:ni.tcpport,udpport:r==="proxy4"?void 0:p.udpport?p.udpport:ni.udpport,username:p.username||ni.username,password:p.password||ni.password,forceturn:r!=="proxy4",security:r==="proxy5"}));if(s.useP2P){var u;const p=(u=i.uid)!==null&&u!==void 0?u:c.uid,_="glb:".concat(p.toString()),S=await ch(_),f=a.map(g=>({turnServerURL:g.address,tcpport:r==="proxy3"?void 0:g.tcpport||ni.tcpport,udpport:r==="proxy4"?void 0:g.udpport||ni.udpport,username:_,password:S,forceturn:r!=="proxy4",security:r==="proxy5"}));l.push(...f)}return i.turnServer={mode:"manual",servers:l},E.debug("[".concat(i.clientId,"] set proxy server: ").concat(i.proxyServer,", mode: ").concat(r)),d}async function _R(i,t,e,n,s){const r=v("ACCOUNT_REGISTER").slice(0,v("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?r.map(c=>"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1")):r.map(c=>"https://".concat(c,"/api/v1"));const a=s==null?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await async function(d,l,u,p,_){const S=Date.now(),f={sid:u.sid,opid:10,appid:u.appId,string_uid:l};let g=d[0];const C=await Cn(()=>ss(g+"".concat(g.indexOf("?")===-1?"?":"&","action=stringuid"),{data:f,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(y,A)=>{if(y.code===0){if(y.uid<=0||y.uid>=Math.pow(2,32))throw E.error("Invalid Uint Uid ".concat(l," => ").concat(y.uid),y),z.reqUserAccount(f.sid,{lts:S,success:!1,serverAddr:g,stringUid:f.string_uid,uid:y.uid,errorCode:R.INVALID_UINT_UID_FROM_STRING_UID,extend:f}),new w(R.INVALID_UINT_UID_FROM_STRING_UID);return z.reqUserAccount(f.sid,{lts:S,success:!0,serverAddr:g,stringUid:f.string_uid,uid:y.uid,errorCode:null,extend:f}),!1}const k=_d(y.code);return k.retry&&(g=d[(A+1)%d.length]),z.reqUserAccount(f.sid,{lts:S,success:!1,serverAddr:g,stringUid:f.string_uid,uid:y.uid,errorCode:k.desc,extend:f}),k.retry},(y,A)=>y.code!==R.OPERATION_ABORTED&&(z.reqUserAccount(f.sid,{lts:S,success:!1,serverAddr:g,stringUid:f.string_uid,uid:null,errorCode:y.code,extend:f}),g=d[(A+1)%d.length],!0),_);if(C.code!==0){const y=_d(C.code);throw new w(R.UNEXPECTED_RESPONSE,y.desc)}return C}(o,i,t,e,n);return s==null||s.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw s==null||s.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function Vk(i,t,e){const n=v("CDS_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(a=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(a+"/api/v1"):"https://".concat(a,"/api/v1?action=config")).map(a=>function(c,d,l,u){const p=ft(),_={flag:64,cipher_method:0,features:{device:p.name,system:p.os,system_general:navigator.userAgent,vendor:d.appId,version:Ji,cname:d.cname,sid:d.sid,session_id:d.sid,detail:"",proxyServer:d.proxyServer}};return Cn(()=>ss(c,{data:_,timeout:1e3,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,S=>S.code!==R.OPERATION_ABORTED,u)}(a,i,t,e));let s=null,r=null,o={};try{s=await fo(n)}catch(a){if(a.code===R.OPERATION_ABORTED)throw a;r=a}if(n.forEach(a=>a.cancel()),z.reportApiInvoke(i.sid,{name:le.REQUEST_CONFIG_DISTRIBUTE,options:{error:r,res:s}}).onSuccess(),s&&s.test_tags)try{o=function(a){if(!a.test_tags)return{};const c=a.test_tags,d=Object.keys(c),l={};return d.forEach(u=>{var p;const _=Yh(p=u.slice(4)).call(p),S=JSON.parse(c[u])[1];l[_]=S}),l}(s)}catch{}return o}async function ER(i,t,e,n){const s=v("PROXY_SERVER_TYPE3"),r=(_,S,f)=>{let g=f||s;return Array.isArray(g)&&(g=S%2==0?s[1]:s[0]),"https://".concat(g,"/ap/?url=").concat(_)};let o=null;const a=[],c=async()=>{const _=v("WEBCS_DOMAIN").slice(0,v("AJAX_REQUEST_CONCURRENT")).map((g,C)=>{let y;return y=i.cloudProxyServer==="disabled"&&i.proxyServer?r("".concat(g,"/api/v2/transpond/webrtc?v=2"),C,i.proxyServer):i.cloudProxyServer==="disabled"||i.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):r("".concat(g,"/api/v2/transpond/webrtc?v=2"),C),{url:y,areaCode:fd(),serviceIds:[be.CHOOSE_SERVER,i.cloudProxyServer==="proxy5"?be.CLOUD_PROXY_5:i.cloudProxyServer==="proxy3"||i.cloudProxyServer==="proxy4"?be.CLOUD_PROXY:be.CLOUD_PROXY_FALLBACK]}}),S=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(g=>g.url)}),f=await Sa({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:g=>(E.debug("[".concat(i.clientId,"] Connect to choose_server:"),g.url),dR(g,i,t,e)),allFailedhandler:g=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},S),g[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},S),f},d=async()=>{if(await ye(1e3),o!==null)return o;const _=v("WEBCS_DOMAIN_BACKUP_LIST").map((g,C)=>{let y;return y=i.cloudProxyServer==="disabled"&&i.proxyServer?r("".concat(g,"/api/v2/transpond/webrtc?v=2"),C,i.proxyServer):i.cloudProxyServer==="disabled"||i.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):r("".concat(g,"/api/v2/transpond/webrtc?v=2"),C),{url:y,areaCode:fd(),serviceIds:[be.CHOOSE_SERVER,i.cloudProxyServer==="proxy5"?be.CLOUD_PROXY_5:i.cloudProxyServer==="proxy3"||i.cloudProxyServer==="proxy4"?be.CLOUD_PROXY:be.CLOUD_PROXY_FALLBACK]}}),S=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:_.map(g=>g.url)}),f=await Sa({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:_,asyncMapHandler:g=>(E.debug("[".concat(i.clientId,"] Connect to backup choose_server:"),g.url),dR(g,i,t,e)),allFailedhandler:g=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},S),g[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},S),f};let l,u,p;try{({gatewayInfo:l,proxyInfo:u,url:p}=await fo([c(),d()]))}catch(_){throw _[0]}if(a.length&&a.forEach(_=>_.cancel&&typeof _.cancel=="function"&&_.cancel()),!l||!u)throw new w(R.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(i.apUrl=p,i.cloudProxyServer!=="disabled"&&Array.isArray(s)&&p){const _=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];q(s).call(s,_)&&(i.proxyServer=_,E.setProxyServer(_),z.setProxyServer(_))}return o={gatewayInfo:l,proxyInfo:await Ok(u,l.uid)},o}async function mR(i,t,e,n){const s=v("UAP_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(r=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(r+"/api/v1?action=uap"):"https://".concat(r,"/api/v1?action=uap"));return await Mk(s,i,t,e,n)}async function Fk(i,t,e){const n=v("UAP_AP").slice(0,v("AJAX_REQUEST_CONCURRENT")).map(s=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap")).map(s=>function(r,o,a,c){const d={command:"convergeAllocateEdge",sid:o.sid,appId:o.appId,token:o.token,ts:Date.now(),version:Ji,cname:o.cname,uid:o.uid.toString(),requestId:ep,seq:ep};ep+=1;const l={service_name:"tele_channel",json_body:JSON.stringify(d)};return Cn(async()=>{const u=await ss(r,{data:l,cancelToken:a,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(u.code!==0){const _=new w(R.UNEXPECTED_RESPONSE,"cross channel ap error, code"+u.code,{retry:!0});throw E.error(_.toString()),_}const p=JSON.parse(u.json_body);if(p.code!==200){const _=new w(R.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw E.error(_.toString()),_}if(!p.servers||p.servers.length===0){const _=new w(R.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw E.error(_.toString()),_}return{vid:p.vid,workerToken:p.workerToken,addressList:(v("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(_=>"wss://".concat(_.address.replace(/\./g,"-"),".").concat(v("WORKER_DOMAIN"),":").concat(_.wss))}},void 0,u=>!!(u.code!==R.OPERATION_ABORTED&&u.code!==R.UNEXPECTED_RESPONSE||u.data&&u.data.retry),c)}(s,i,t,e));try{const s=await fo(n);return n.forEach(r=>r.cancel()),s}catch(s){throw s[0]}}async function Bk(i,t,e){let n=null;const s=[],r=async o=>{const a=v(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>i.proxyServer?"https://".concat(i.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return o&&(await ye(1e3),n!==null)?n:await Sa({fragementLength:v("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(E.debug("[".concat(i.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),function(d,l,u,p){const[_]=xk(l,[be.CHOOSE_SERVER]);let S=oe.networkState;return Cn(async()=>{S&&oe.networkState===Ze.OFFLINE&&oe.onlineWaiter&&await P.race([oe.onlineWaiter,ye(p&&p.maxRetryTimeout||ae.maxRetryTimeout)]),S=oe.networkState;const f=await ss(d,{data:_,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return Uk(f,d)},()=>!1,f=>f.code!==R.OPERATION_ABORTED&&(f.code===R.UPDATE_TICKET_FAILED?f.data.retry:(E.warning("[".concat(l.clientId,"] update ticket network error, retry"),f),!0)),p)}(c,i,t,e)),allFailedhandler:c=>{throw c[0]},promisesCollector:s})};try{return n=await fo([r(!1),r(!0)]),s.length&&s.forEach(o=>o.cancel&&typeof o.cancel=="function"&&o.cancel()),n}catch(o){throw o[0]}}function fR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function gR(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?fR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):fR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class jk extends Wt{get isSuccess(){return!!this.configs}constructor(){super(),h(this,"configs",void 0),h(this,"joinInfo",void 0),h(this,"cancelToken",void 0),h(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),h(this,"interval",void 0),h(this,"mutex",new Ae("config-distribute")),h(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,e){this.joinInfo=t,this.cancelToken=e,this.interval&&this.stopGetConfigDistribute(),v("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},v("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,z.reportApiInvoke(null,{options:void 0,name:le.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Yt.TRACER}).onSuccess(JSON.stringify(bs))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void E.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const e=await this.mutex.lock();try{t=await Vk(this.joinInfo,this.cancelToken,this.retryConfig),E.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(n){const s=new w(R.NETWORK_RESPONSE_ERROR,n);E.warning("[config-distribute] ".concat(s.toString()))}finally{e()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var e;(e=t)&&e.uplink&&e.id&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(fa.UPDATE_BITRATE_LIMIT,t):this.emit(fa.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&gR({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var e;const n=ta(e=Object.keys(t).filter(r=>/^webrtc_ng_global_parameter/.test(r))).call(e);for(let r=0;r<n.length;r++)for(let o=n.length-1;o>r;o--){const a=n[o];if(typeof t[a].__priority=="number"){const c=t[a].__priority,d=n[o-1];if(typeof t[d].__priority=="number"){if(!(c>t[d].__priority))continue;{const l=a;n[o]=n[o-1],n[o-1]=l}}else{const l=a;n[o]=n[o-1],n[o-1]=l}}}const s={};n.forEach(r=>{const o=t[r],a=o.__expires;Object.keys(o).forEach(c=>{c==="__priority"||c==="__expires"||Object.prototype.hasOwnProperty.call(s,c)||(s[c]=gR({value:o[c]},a&&{expires:a}))})});try{(function(a){try{const c=Date.now();Object.keys(a).forEach(d=>{switch(d){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(ii,d)){const{value:l,expires:u}=a[d];if(u&&u<=c)return;bs[d]=l,ii[d]=l,E.debug("Update global parameters from config distribute",d,l)}}})}catch(c){E.error("Error update config immediately: ".concat(a),c.message)}})(s);const r=JSON.stringify(s),o=window.btoa(r);window.localStorage.setItem("websdk_ng_global_parameter",o),E.debug("Caching global parameters ".concat(r))}catch(r){E.error("Error caching global parameters:",r.message)}}}const Ye={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function Ot(){return Ye}var Re;function go(i,t,e){return{sampleRate:i,stereo:t,bitrate:e}}function Et(i,t,e,n,s){return{width:i,height:t,frameRate:e,bitrateMin:n,bitrateMax:s}}function hn(i,t,e,n,s){return{width:{max:i},height:{max:t},frameRate:e,bitrateMin:n,bitrateMax:s}}function np(i,t){return{numSpatialLayers:i,numTemporalLayers:t}}(function(i){i.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",i.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",i.IOS_INTERRUPTION_START="ios-interruption-start",i.IOS_INTERRUPTION_END="ios-interruption-end",i.STATE_CHANGE="state-change"})(Re||(Re={}));const Gk={"90p":Et(160,90),"90p_1":Et(160,90),"120p":Et(160,120,15,30,65),"120p_1":Et(160,120,15,30,65),"120p_3":Et(120,120,15,30,50),"120p_4":Et(212,120),"180p":Et(320,180,15,30,140),"180p_1":Et(320,180,15,30,140),"180p_3":Et(180,180,15,30,100),"180p_4":Et(240,180,15,30,120),"240p":Et(320,240,15,40,200),"240p_1":Et(320,240,15,40,200),"240p_3":Et(240,240,15,40,140),"240p_4":Et(424,240,15,40,220),"360p":Et(640,360,15,80,400),"360p_1":Et(640,360,15,80,400),"360p_3":Et(360,360,15,80,260),"360p_4":Et(640,360,30,80,600),"360p_6":Et(360,360,30,80,400),"360p_7":Et(480,360,15,80,320),"360p_8":Et(480,360,30,80,490),"360p_9":Et(640,360,15,80,800),"360p_10":Et(640,360,24,80,800),"360p_11":Et(640,360,24,80,1e3),"480p":Et(640,480,15,100,500),"480p_1":Et(640,480,15,100,500),"480p_2":Et(640,480,30,100,1e3),"480p_3":Et(480,480,15,100,400),"480p_4":Et(640,480,30,100,750),"480p_6":Et(480,480,30,100,600),"480p_8":Et(848,480,15,100,610),"480p_9":Et(848,480,30,100,930),"480p_10":Et(640,480,10,100,400),"720p":Et(1280,720,15,120,1130),"720p_auto":Et(1280,720,30,900,3e3),"720p_1":Et(1280,720,15,120,1130),"720p_2":Et(1280,720,30,120,2e3),"720p_3":Et(1280,720,30,120,1710),"720p_5":Et(960,720,15,120,910),"720p_6":Et(960,720,30,120,1380),"1080p":Et(1920,1080,15,120,2080),"1080p_1":Et(1920,1080,15,120,2080),"1080p_2":Et(1920,1080,30,120,3e3),"1080p_3":Et(1920,1080,30,120,3150),"1080p_5":Et(1920,1080,60,120,4780),"1440p":Et(2560,1440,30,120,4850),"1440p_1":Et(2560,1440,30,120,4850),"1440p_2":Et(2560,1440,60,120,7350),"4k":Et(3840,2160,30,120,8910),"4k_1":Et(3840,2160,30,120,8910),"4k_3":Et(3840,2160,60,120,13500)},Sd=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],Wk={"480p":hn(640,480,5),"480p_1":hn(640,480,5),"480p_2":hn(640,480,30),"480p_3":hn(640,480,15),"720p":hn(1280,720,5),"720p_auto":Et(1280,720,30,900,3e3),"720p_1":hn(1280,720,5),"720p_2":hn(1280,720,30),"720p_3":hn(1280,720,15),"1080p":hn(1920,1080,5),"1080p_1":hn(1920,1080,5),"1080p_2":hn(1920,1080,30),"1080p_3":hn(1920,1080,15)},Hk={"1SL1TL":np(1,1),"3SL3TL":np(3,3),"2SL3TL":np(2,3)};function Vn(i){return i||(i="480p_1"),typeof i=="string"?Object.assign({},Gk[i]):i}function sp(i){return typeof i=="string"?Object.assign({},Wk[i]):i}function Rd(i){return typeof i=="string"?Object.assign({},Hk[i]):i}const Kk={speech_low_quality:go(16e3,!1),speech_standard:go(32e3,!1,18),music_standard:go(48e3,!1),standard_stereo:go(48e3,!0,56),high_quality:go(48e3,!1,128),high_quality_stereo:go(48e3,!0,192)};function Cd(i){return typeof i=="string"?Object.assign({},Kk[i]):i}const To=[];function TR(i){return Ee(i,"mediaSource",["screen","window","application"]),!0}var K,Mt,Us,rp,op,So,xs,Cr,_i,Id;(function(i){i.NEED_RENEGOTIATE="@need_renegotiate",i.NEED_REPLACE_TRACK="@need_replace_track",i.NEED_CLOSE="@need_close",i.NEED_ENABLE_TRACK="@need_enable_track",i.NEED_DISABLE_TRACK="@need_disable_track",i.NEED_SESSION_ID="@need_sid",i.SET_OPTIMIZATION_MODE="@set_optimization_mode",i.GET_STATS="@get_stats",i.GET_RTC_STATS="@get_rtc_stats",i.GET_LOW_VIDEO_TRACK="@get_low_video_track",i.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",i.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",i.NEED_MUTE_TRACK="@need_mute_track",i.NEED_UNMUTE_TRACK="@need_unmute_track"})(K||(K={})),function(i){i.SCREEN_TRACK="screen_track",i.CUSTOM_TRACK="custome_track",i.LOW_STREAM="low_stream"}(Mt||(Mt={})),function(i){i[i.HIGH_STREAM=0]="HIGH_STREAM",i[i.LOW_STREAM=1]="LOW_STREAM"}(Us||(Us={})),function(i){i[i.HIGH_STREAM=0]="HIGH_STREAM",i[i.LOW_STREAM=1]="LOW_STREAM"}(rp||(rp={})),function(i){i[i.DISABLE=0]="DISABLE",i[i.LOW_STREAM=1]="LOW_STREAM",i[i.AUDIO_ONLY=2]="AUDIO_ONLY"}(op||(op={})),function(i){i.TRANSCEIVER_UPDATED="transceiver-updated"}(So||(So={})),function(i){i.SOURCE_STATE_CHANGE="source-state-change",i.TRACK_ENDED="track-ended",i.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",i.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",i.CLOSED="closed"}(xs||(xs={})),function(i){i.FIRST_FRAME_DECODED="first-frame-decoded",i.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status"}(Cr||(Cr={})),function(i){i.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",i.RECEIVE_TRACK_BUFFER="receive_track_buffer",i.ON_AUDIO_BUFFER="on_audio_buffer",i.UPDATE_SOURCE="update_source"}(_i||(_i={})),function(i){i.UPDATE_TRACK_SOURCE="update-track-source"}(Id||(Id={}));const ap={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},cp={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},SR={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},Yk={uplinkNetworkQuality:0,downlinkNetworkQuality:0},RR={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};var qe,Ei,Ir,rs,Je;(function(i){i.ON_TRACK="on_track",i.ON_NODE="on_node"})(qe||(qe={})),function(i){i.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",i.REQUEST_CONSTRAINTS="request_constraints"}(Ei||(Ei={})),function(i){i.IDLE="IDLE",i.INITING="INITING",i.INITEND="INITEND"}(Ir||(Ir={})),function(i){i.STATE_CHANGE="state_change",i.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",i.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",i.CAMERA_DEVICE_CHANGED="cameraDeviceChanged"}(rs||(rs={})),function(i){i.NONE="none",i.INIT="init",i.CANPLAY="canplay",i.PLAYING="playing",i.PAUSED="paused",i.SUSPEND="suspend",i.STALLED="stalled",i.WAITING="waiting",i.ERROR="error",i.DESTROYED="destroyed",i.ABORT="abort",i.ENDED="ended",i.EMPTIED="emptied",i.LOADEDDATA="loadeddata"}(Je||(Je={}));const dp={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};var Ro;(function(i){i.OPEN="open",i.MESSAGE="message",i.CLOSE="close",i.CLOSING="closing",i.ERROR="error"})(Ro||(Ro={}));class CR extends Wt{constructor(t,e){super(),h(this,"_ID",void 0),h(this,"_rtpTransceiver",void 0),h(this,"_lowRtpTransceiver",void 0),h(this,"_hints",[]),h(this,"_isClosed",!1),h(this,"_originMediaStreamTrack",void 0),h(this,"_mediaStreamTrack",void 0),h(this,"_external",{}),this._ID=e||Pt(8,"track-"),this._originMediaStreamTrack=t,this._mediaStreamTrack=t,function(n){q(To).call(To,n)||To.push(n)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){if(!t){const e=z.reportApiInvoke(null,{name:le.GET_MEDIA_STREAM_TRACK,options:[],tag:Yt.TRACER});this._mediaStreamTrack&&typeof this._mediaStreamTrack.label=="string"?e.onSuccess(this._mediaStreamTrack.label):e.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===Us.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const e=To.indexOf(t);e!==-1&&To.splice(e,1)}(this),this.emit(xs.CLOSED)}_updateRtpTransceiver(t,e){if(e===Us.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(So.TRANSCEIVER_UPDATED,t,e)}}class xe extends CR{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}constructor(t,e){super(t,e),h(this,"_enabled",!0),h(this,"_muted",!1),h(this,"_isExternalTrack",!1),h(this,"_isClosed",!1),h(this,"_enabledMutex",void 0),h(this,"processor",void 0),h(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Ae("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,e;return(t=(e=this._originMediaStreamTrack)===null||e===void 0?void 0:e.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,E.debug("[".concat(this.getTrackId(),"] close")),this.emit(K.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=n,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Dt(this,K.NEED_REPLACE_TRACK,this),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(xs.TRACK_ENDED)}stateCheck(t,e){if(E.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(e,"]")),ys(e,t),this._enabled&&this._muted&&t==="enabled"&&e===!1)throw new M(R.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",E);if(!this._enabled&&!this._muted&&t==="muted"&&e===!0)throw new M(R.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",E)}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}function IR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}const vR=window.AudioContext||window.webkitAudioContext;let xi=null;const yt=new class extends Wt{constructor(){super(...arguments),h(this,"prevState",void 0),h(this,"curState",void 0),h(this,"currentTime",void 0),h(this,"currentTimeStuckAt",void 0),h(this,"interruptDetectorTrack",void 0),h(this,"onLocalAudioTrackMute",()=>{E.info("ios15-interruption-start"),this.emit(Re.IOS_15_16_INTERRUPTION_START)}),h(this,"onLocalAudioTrackUnmute",async()=>{E.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?E.info("ios15-interruption-end-canceled"):(xi&&await xi.suspend(),this.emit(Re.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(i){E.debug("webaudio bindInterruptDetectorTrack ".concat(i.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=i,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(i){E.debug("webaudio unbindInterruptDetectorTrack ".concat(i.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===i&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function qk(){if(!vR)return void E.error("your browser is not support web audio");E.info("create audio context");const i=function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?IR(Object(n),!0).forEach(function(s){h(t,s,n[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):IR(Object(n)).forEach(function(s){Object.defineProperty(t,s,Object.getOwnPropertyDescriptor(n,s))})}return t}({},v("WEBAUDIO_INIT_OPTIONS"));E.debug("audio context init option:",JSON.stringify(i)),xi=new vR(i),yt.curState=xi.state,xi.onstatechange=()=>{yt.prevState=yt.curState,yt.curState=xi?xi.state:void 0;const{prevState:t,curState:e}=yt,n=e==="running",s=e==="interrupted",r=t==="running",o=t==="suspended",a=t==="interrupted",c=ft().osVersion;(Qe()||kn())&&r&&s&&(E.info("ios".concat(c,"-interruption-start")),yt.emit(Re.IOS_INTERRUPTION_START)),(Qe()||kn())&&(o||a)&&n&&(E.info("ios".concat(c,"-interruption-end")),yt.emit(Re.IOS_INTERRUPTION_END)),t!==e&&yt.emit(Re.STATE_CHANGE,e,t)},setInterval(()=>{var t;const e=(t=xi)===null||t===void 0?void 0:t.currentTime;yt.currentTime!==e?(yt.currentTimeStuckAt&&(E.debug("AudioContext current time resume at ".concat(e)),yt.currentTimeStuckAt=void 0),yt.currentTime=e):(e!==yt.currentTimeStuckAt&&(z.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:e},tag:Yt.TRACER}).onSuccess(),E.warning("AudioContext current time stuck at ".concat(e))),yt.currentTimeStuckAt=e)},5e3),async function(t){const e=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,s=!1,r=!1,o=!1;function a(g){t.state==="running"?c(!1):Qe()||kn()?t.state==="suspended"&&(c(!0),g&&t.resume().then(l,l)):t.state!=="closed"&&(c(!0),g&&t.resume().then(l,l))}function c(g){if(s!==g){s=g;for(let C=0,y=e;C<y.length;C+=1){const A=y[C];g?window.addEventListener(A,u,{capture:!0,passive:!0}):window.removeEventListener(A,u,{capture:!0,passive:!0})}}}function d(){a(!0)}function l(){a(!1)}function u(){a(!0)}function p(g){if(!o)if(n.paused)if(g){let C;_(!1),o=!0;try{C=n.play(),C?C.then(S,S):(n.addEventListener("playing",S),n.addEventListener("abort",S),n.addEventListener("error",S))}catch{S()}}else _(!0);else _(!1)}function _(g){if(r!==g){r=g;for(let C=0,y=e;C<y.length;C++){const A=y[C];g?window.addEventListener(A,f,{capture:!0,passive:!0}):window.removeEventListener(A,f,{capture:!0,passive:!0})}}}function S(){n.removeEventListener("playing",S),n.removeEventListener("abort",S),n.removeEventListener("error",S),o=!1,p(!1)}function f(){p(!0)}if(Qe()){const g=t.createMediaStreamDestination(),C=document.createElement("div");C.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=C.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=g.stream,p(!0)}yt.on(Re.STATE_CHANGE,d),a(!1)}(xi)}function Co(){if(!xi){if(qk(),!xi)throw new M(R.NOT_SUPPORTED,"can not create audio context");return xi}return xi}function yR(){return!!xi}function vr(i){if(function(){if(lp!==null)return lp;const n=Co(),s=n.createBufferSource(),r=n.createGain(),o=n.createGain();s.connect(r),s.connect(o),s.disconnect(r);let a=!1;try{s.disconnect(r)}catch{a=!0}return s.disconnect(),lp=a,a}())return;const t=i.connect,e=i.disconnect;i.connect=(n,s,r)=>{var o;return i._inputNodes||(i._inputNodes=[]),q(o=i._inputNodes).call(o,n)||(n instanceof AudioNode?(i._inputNodes.push(n),t.call(i,n,s,r)):t.call(i,n,s)),i},i.disconnect=(n,s,r)=>{e.call(i),n?Jc(i._inputNodes,n):i._inputNodes=[];for(const o of i._inputNodes)t.call(i,o)}}let lp=null;function up(i,t){let e=!1;const n=1/t;if(v("DISABLE_WEBAUDIO")){const s=window.setInterval(()=>{e?window.clearInterval(s):i(performance.now()/1e3)},1e3*n)}else{const s=Co();let r=s.createGain();r.gain.value=0,r.connect(s.destination);const o=()=>{if(e)return void(r=null);const a=s.createOscillator();a.onended=o,a.connect(r),a.start(0),a.stop(s.currentTime+n),i(s.currentTime)};o()}return()=>{e=!0}}class AR{constructor(){h(this,"context",void 0),h(this,"analyserNode",void 0),h(this,"sourceNode",void 0),this.context=Co(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Qe()||kn()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const n=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(n);for(let s=0;s<t.length;++s)t[s]=n[s]/128-1}const e=mr(t).call(t,(n,s)=>n+s*s,0)/t.length;return Math.max(10*Math.log10(e)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,e;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(e=this.sourceNode)===null||e===void 0||e.connect(this.analyserNode)}catch{E.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class bR extends Wt{get processSourceNode(){return this.sourceNode}set processedNode(t){var e;if(!this.isDestroyed&&this._processedNode!==t){try{var n;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.outputNode)}catch{}(e=this._processedNode)===null||e===void 0||e.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),h(this,"outputNode",void 0),h(this,"outputTrack",void 0),h(this,"isPlayed",!1),h(this,"context",void 0),h(this,"audioBufferNode",void 0),h(this,"destNode",void 0),h(this,"audioOutputLevel",0),h(this,"volumeLevelAnalyser",void 0),h(this,"_processedNode",void 0),h(this,"playNode",void 0),h(this,"isDestroyed",!1),h(this,"onNoAudioInput",void 0),h(this,"isNoAudioInput",!1),h(this,"_noAudioInputCount",0),this.context=Co(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),vr(this.outputNode),this.volumeLevelAnalyser=new AR}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit(_i.ON_AUDIO_BUFFER,function(n){for(let s=0;s<n.outputBuffer.numberOfChannels;s+=1){const r=n.outputBuffer.getChannelData(s);for(let o=0;o<r.length;o+=1)r[o]=0}return n.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Ot().webAudioMediaStreamDest)throw new M(R.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&zc(()=>{yt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Qe()||kn()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const e=this.volumeLevelAnalyser.getAnalyserNode();let n;e.getFloatTimeDomainData?(n=new Float32Array(e.fftSize),e.getFloatTimeDomainData(n)):(n=new Uint8Array(e.fftSize),e.getByteTimeDomainData(n));let s=!1;for(let r=0;r<n.length;r++)n[r]!==0&&(s=!0);return s?(this.isNoAudioInput=!1,!0):(await ye(200),await this.checkHasAudioInput(t?t+1:1)&&s)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,e;(t=this.processedNode)===null||t===void 0||t.disconnect(),(e=this.sourceNode)===null||e===void 0||e.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class hp extends bR{get isFreeze(){return!1}constructor(t,e,n){var s;if(super(),h(this,"sourceNode",void 0),h(this,"track",void 0),h(this,"clonedTrack",void 0),h(this,"audioElement",void 0),h(this,"isCurrentTrackCloned",!1),h(this,"isRemoteTrack",!1),h(this,"originVolumeLevelAnalyser",void 0),h(this,"rebuildWebAudio",async()=>{if(E.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void E.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>E.info("resume success")),E.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),vr(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),vr(this.outputNode),this.emit(_i.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new M(R.UNEXPECTED_ERROR);this.track=t;const r=new MediaStream([this.track]);if(this.isRemoteTrack=!!e,this.sourceNode=this.context.createMediaStreamSource(r),vr(this.sourceNode),n){const a=n.clone();a.enabled=!0,this.clonedTrack=a,E.debug("create an unmuted track ".concat(a.id," from the original track ").concat(n.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));vr(c),this.originVolumeLevelAnalyser=new AR,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=r;const o=ft();e&&o.os===_e.IOS&&Number((s=o.osVersion)===null||s===void 0?void 0:s.split(".")[0])<15&&(yt.on(Re.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const e=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(e),vr(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(_i.UPDATE_SOURCE),this.audioElement.srcObject=e}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),yt.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const e=t.clone();e.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=e),E.debug("create an unmuted track ".concat(e.id," from the original track ").concat(t.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([e]));vr(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function wR(i,t,e){const n=(r,o)=>r?typeof r!="number"?r.max||r.exact||r.ideal||r.min||o:r:o,s={audio:!!e&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxHeight:n(t.height,1080),maxWidth:n(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(s.video.mandatory.maxFrameRate=t.frameRate.max,s.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(s.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(s)}async function Jk(i,t){const e=await OR(i.mediaSource),{sourceId:n,audio:s}=await function(r){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new P((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const _=document.createElement("div");_.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const S=document.createElement("button");S.innerHTML="cancel",S.setAttribute("style","width: 85px;"),S.onclick=()=>{document.body.removeChild(C);const y=new Error("NotAllowedError");y.name="NotAllowedError",c(y)};let f=o;const g=document.createElement("div");if(o){const y=document.createElement("input");y.setAttribute("type","checkbox");const A=document.createElement("span");y.setAttribute("style","margin-right: 6px;"),A.innerText="Share audio",y.checked=f,y.onchange=()=>{f=y.checked},g.appendChild(y),g.appendChild(A)}_.appendChild(g),_.appendChild(S),l.appendChild(u),l.appendChild(p),l.appendChild(_);const C=document.createElement("div");C.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),C.appendChild(d),C.appendChild(l),document.body.appendChild(C),r.map(y=>{if(y.id){const A=document.createElement("div");A.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let k=y.thumbnail;try{const{width:O}=k.getSize();O>1920&&(k=k.resize({width:1920}))}catch(O){throw O&&O.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),O}A.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+k.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+y.name.replace(/[\u00A0-\u9999<>\&]/g,function(O){return"&#"+O.charCodeAt(0)+";"})+"</span>",A.onclick=()=>{document.body.removeChild(C),a({sourceId:y.id,audio:f})},p.appendChild(A)}})})}(e,t);return await wR(n,i,s)}async function OR(i){let t=["window","screen"];i!=="application"&&i!=="window"||(t=["window"]),i==="screen"&&(t=["screen"]);const e=mT();if(!e)throw console.error("failed to fetch electron, please mount it to window"),new M(R.ELECTRON_IS_NULL);let n=null;try{var s;n=((s=e.desktopCapturer)===null||s===void 0?void 0:s.getSources({types:t}))||e.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{n=null}n&&n.then||(n=new P((r,o)=>{e.desktopCapturer.getSources({types:t},(a,c)=>{a?o(a):r(c)})}));try{return await n}catch(r){throw new M(R.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,r.toString())}}function NR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}const pp=new Ae("safari");let DR=!1,PR=!1;async function Vi(i,t){let e=0,n=null;for(;e<2;)try{n=await zk(i,t,e>0);break}catch(s){if(s instanceof M)throw E.error("[".concat(t,"] ").concat(s.toString())),s;const r=vd(s.name||s.code||s,s.message);if(r.code===R.MEDIA_OPTION_INVALID){E.debug("[".concat(t,"] detect media option invalid, retry")),e+=1,await ye(500);continue}throw E.error("[".concat(t,"] ").concat(r.toString())),r}if(!n)throw new M(R.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function zk(i,t,e){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new M(R.NOT_SUPPORTED,"can not find getUserMedia");e&&(i.video&&(delete i.video.width,delete i.video.height),i.screen&&(delete i.screen.width,delete i.screen.height));const n=Ot(),s=new MediaStream;if(i.audioSource&&s.addTrack(i.audioSource),i.videoSource&&s.addTrack(i.videoSource),!i.audio&&!i.video&&!i.screen)return E.debug("Using Video Source/ Audio Source"),s;if(i.screen)if(mT())i.screen.sourceId?Io(s,await wR(i.screen.sourceId,i.screen,i.screenAudio)):Io(s,await Jk(i.screen,i.screenAudio));else if(la()&&i.screen.extensionId&&i.screen.mandatory){if(!n.getStreamFromExtension)throw new M(R.NOT_SUPPORTED,"This browser does not support screen sharing");E.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const p=await(o=i.screen.extensionId,a=t,new P((_,S)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},f=>{if(!f||!f.streamId)return E.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),f),void S(new M(R.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));_(f.streamId)})}catch(f){E.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),f.toString()),S(new M(R.CHROME_PLUGIN_NOT_INSTALL))}}));i.screen.mandatory.chromeMediaSourceId=p,Io(s,await navigator.mediaDevices.getUserMedia({video:{mandatory:i.screen.mandatory}}))}else if(n.getDisplayMedia){var r;i.screen.mediaSource&&TR(i.screen.mediaSource);const p={width:i.screen.width,height:i.screen.height,frameRate:i.screen.frameRate,displaySurface:(r=i.screen.displaySurface)!==null&&r!==void 0?r:i.screen.mediaSource==="screen"?"monitor":i.screen.mediaSource},{selfBrowserSurface:_,surfaceSwitching:S,systemAudio:f}=i.screen,g={selfBrowserSurface:_,surfaceSwitching:S,systemAudio:f};!_&&delete g.selfBrowserSurface,!S&&delete g.surfaceSwitching,!f&&delete g.systemAudio,E.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:p,audio:!!i.screenAudio,controls:g}));const C=await navigator.mediaDevices.getDisplayMedia(function(y){for(var A=1;A<arguments.length;A++){var k=arguments[A]!=null?arguments[A]:{};A%2?NR(Object(k),!0).forEach(function(O){h(y,O,k[O])}):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(k)):NR(Object(k)).forEach(function(O){Object.defineProperty(y,O,Object.getOwnPropertyDescriptor(k,O))})}return y}({video:p,audio:!!i.screenAudio},g));Io(s,C)}else{if(!Nt())throw E.error("[".concat(t,"] This browser does not support screenSharing")),new M(R.NOT_SUPPORTED,"This browser does not support screen sharing");{i.screen.mediaSource&&TR(i.screen.mediaSource);const p={video:{mediaSource:i.screen.mediaSource,width:i.screen.width,height:i.screen.height,frameRate:i.screen.frameRate}};E.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(p))),Io(s,await navigator.mediaDevices.getUserMedia(p))}}var o,a;if(!i.video&&!i.audio)return s;let c={video:i.video,audio:i.audio},d=v("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=uh(c,d)}catch{}E.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),ft();let l,u=null;(Xe()||Qe()||Kc())&&(u=await pp.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(p){throw u&&u(),p}return c.audio&&(DR=!0),c.video&&(PR=!0),Io(s,l),u&&u(),s}function vd(i,t){switch(i){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new M(R.MEDIA_OPTION_INVALID,"".concat(i,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new M(R.DEVICE_NOT_FOUND,"".concat(i,": ").concat(t));case"NotSupportedError":return new M(R.NOT_SUPPORTED,"".concat(i,": ").concat(t));case"NotReadableError":return new M(R.NOT_READABLE,"".concat(i,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new M(R.PERMISSION_DENIED,"".concat(i,": ").concat(t));case"ConstraintNotSatisfiedError":return new M(R.CONSTRAINT_NOT_SATISFIED,"".concat(i,": ").concat(t));default:return E.error("getUserMedia unexpected error",i),new M(R.UNEXPECTED_ERROR,"".concat(i,": ").concat(t))}}function Io(i,t){const e=i.getVideoTracks()[0],n=i.getAudioTracks()[0],s=t.getVideoTracks()[0],r=t.getAudioTracks()[0];r&&(n&&i.removeTrack(n),i.addTrack(r)),s&&(e&&i.removeTrack(e),i.addTrack(s))}const Fi=new class extends Wt{get state(){return this._state}set state(i){i!==this._state&&(this.emit(rs.STATE_CHANGE,i),this._state=i)}constructor(){super(),h(this,"_state",Ir.IDLE),h(this,"isAccessMicrophonePermission",!1),h(this,"isAccessCameraPermission",!1),h(this,"lastAccessMicrophonePermission",!1),h(this,"lastAccessCameraPermission",!1),h(this,"checkdeviceMatched",!1),h(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(v("ENUMERATE_DEVICES_INTERVAL")||(Yc()||Hc()===_e.HARMONY_OS)&&vs())&&this.updateDevicesInfo()},v("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(i=>E.error(i.toString()))}async enumerateDevices(i,t){let e=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new M(R.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),s=this.checkMediaDeviceInfoIsOk(n);let r=!this.isAccessMicrophonePermission&&i,o=!this.isAccessCameraPermission&&t;s.audio&&(r=!1),s.video&&(o=!1);let a=null,c=null,d=null;if(!e&&(r||o)){if(pp.isLocked&&(E.debug("[device manager] wait GUM lock"),(await pp.lock())(),E.debug("[device manager] GUM unlock")),DR&&(r=!1,this.isAccessMicrophonePermission=!0),PR&&(o=!1,this.isAccessCameraPermission=!0),E.debug("[device manager] check media device permissions",i,t,r,o),r&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){const u=vd(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;E.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(r){try{a=await navigator.mediaDevices.getUserMedia({audio:i})}catch(l){const u=vd(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;E.warning("getUserMedia failed in getDevices",u)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(l){const u=vd(l.name||l.code||l,l.message);if(u.code===R.PERMISSION_DENIED)throw u;E.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0}E.debug("[device manager] mic permission",i,"cam permission",t)}try{const l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach(u=>u.stop()),c&&c.getTracks().forEach(u=>u.stop()),d&&d.getTracks().forEach(u=>u.stop()),a=null,c=null,d=null,new M(R.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,i)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,i)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let i=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,i)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(i){let t=null;return this.deviceInfoMap.forEach(e=>{e.device.label===i&&(t=e.device.deviceId)}),t}async getDeviceById(i){const t=(await this.enumerateDevices(!0,!0,!0)).find(e=>e.deviceId===i);if(!t)throw new M(R.DEVICE_NOT_FOUND,"deviceId: ".concat(i));return t}async init(){this.state=Ir.INITING;try{await this.updateDevicesInfo(),this.state=Ir.INITEND}catch(i){throw E.warning("Device Detection functionality cannot start properly.",i.toString()),this.state=Ir.IDLE,!(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")&&new M(R.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),i}}async updateDevicesInfo(){const i=await this.enumerateDevices(!0,!0,!0),t=Date.now(),e=[];if(i[0]&&i[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const s=i.find(o=>o.kind==="audioinput"&&o.deviceId==="default"),r=i.find(o=>o.kind==="audiooutput"&&o.deviceId==="default");s&&r?r.groupId===s.groupId?E.debug("[device-check] default input ".concat(s.label," and output ").concat(r.label," is the same group")):E.warning("[device-check] default input ".concat(s.label," and output ").concat(r.label," is not the same group")):E.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(i);if(i.forEach(s=>{if(!s.deviceId)return;const r=this.deviceInfoMap.get("".concat(s.kind,"_").concat(s.deviceId));if((r?r.state:"INACTIVE")!=="ACTIVE"){const o={initAt:t,updateAt:t,device:s,state:"ACTIVE"};this.deviceInfoMap.set("".concat(s.kind,"_").concat(s.deviceId),o),e.push(o)}r&&(r.updateAt=t)}),this.deviceInfoMap.forEach((s,r)=>{s.state==="ACTIVE"&&s.updateAt!==t&&(s.state="INACTIVE",e.push(s))}),this.state!==Ir.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));e.forEach(s=>{switch(s.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(rs.RECORDING_DEVICE_CHANGED,s);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(rs.CAMERA_DEVICE_CHANGED,s);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(rs.PLAYOUT_DEVICE_CHANGED,s)}}),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(i){const t=i.filter(s=>s.kind==="audioinput"),e=i.filter(s=>s.kind==="videoinput"),n={audio:!1,video:!1};for(const s of t)if(s.label&&s.deviceId){n.audio=!0;break}for(const s of e)if(s.label&&s.deviceId){n.video=!0;break}return n}};let _p=!1;const Bi=new class extends Wt{constructor(){super(...arguments),h(this,"onAutoplayFailed",void 0),h(this,"onAudioAutoplayFailed",void 0)}};function LR(){if(ft(),!_p){const i=t=>{t.preventDefault(),_p=!1,ua()?document.body.removeEventListener("click",i,!0):(document.body.removeEventListener("touchstart",i,!0),document.body.removeEventListener("mousedown",i,!0))};_p=!0,ua()?document.body.addEventListener("click",i,!0):(document.body.addEventListener("touchstart",i,!0),document.body.addEventListener("mousedown",i,!0)),E.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Bi.onAutoplayFailed?Bi.onAutoplayFailed():Bi.onAudioAutoplayFailed?E.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):E.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Bi.emit("autoplay-failed")}}function kR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function MR(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?kR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):kR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function UR(i,t,e,n){if(!i)return;const s=z.getBaseInfoBySessionId(i);if(!s)return;const r=s.info,o=Date.now(),a=MR(MR({},r),{},{vid:r.vid===void 0?0:Number(r.vid),lts:o,elapse:o-s.startTime,cbRegistered:Bi.onAutoplayFailed||Bi.onAudioAutoplayFailed?1:-1,errorMsg:e,mediaType:t,trackId:n,extend:void 0});z.send({type:Ft.AUTOPLAY_FAILED,data:a},!0)}const Xk=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],mi=new class{constructor(){h(this,"onAutoplayFailed",void 0),h(this,"elementMap",new Map),h(this,"elementStateMap",new Map),h(this,"elementsNeedToResume",[]),h(this,"sinkIdMap",new Map),h(this,"autoResumeAfterInterruption",i=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t;const s=this.elementStateMap.get(e),r=n.srcObject.getAudioTracks()[0],o=r&&r.readyState;if(E.debug("resume after interrupted, ele: ".concat(s," audio: ").concat(o," ").concat(i)),o==="live"){if(i)return n.pause(),void n.play();if(yt.curState==="running")return no()?(n.pause(),void n.play()):void(s&&s==="paused"&&n.play())}})}),h(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(i=>{let[t,e]=i;const n=e.srcObject.getAudioTracks()[0];n&&n.readyState==="live"&&(E.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),e.pause(),e.play())})}),this.autoResumeAudioElement(),yt.on(Re.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.on(Re.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),yt.on(Re.STATE_CHANGE,()=>{Qe()&&yt.prevState==="suspended"&&yt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(i,t){const e=this.elementMap.get(i);if(this.sinkIdMap.set(i,t),e)try{await e.setSinkId(t)}catch(n){throw new M(R.PERMISSION_DENIED,"can not set sink id: "+n.toString())}}play(i,t,e,n){if(this.elementMap.has(t))return;const s=document.createElement("audio");s.autoplay=!0,s.srcObject=new MediaStream([i]),this.bindAudioElementEvents(t,s),this.elementMap.set(t,s),this.elementStateMap.set(t,Je.INIT),this.setVolume(t,e);const r=this.sinkIdMap.get(t);if(r)try{s.setSinkId(r).catch(a=>{E.warning("[".concat(t,"] set sink id failed"),a.toString())})}catch(a){E.warning("[".concat(t,"] set sink id failed"),a.toString())}const o=s.play();o&&o.then&&o.catch(a=>{n&&UR(n,"audio",a.message,t),E.warning("audio element play warning",a.toString()),this.elementMap.has(t)&&a.name==="NotAllowedError"&&(E.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(s),zc(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),LR()}))})}updateTrack(i,t){const e=this.elementMap.get(i);e&&(e.srcObject=new MediaStream([t]))}isPlaying(i){return this.elementMap.has(i)&&this.elementStateMap.get(i)==="playing"}setVolume(i,t){const e=this.elementMap.get(i);e&&(t=Math.max(0,Math.min(100,t)),e.volume=t/100)}stop(i){const t=this.elementMap.get(i);if(this.sinkIdMap.delete(i),!t)return;const e=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(e,1),t.srcObject=null,t.remove(),this.elementMap.delete(i),this.elementStateMap.delete(i)}bindAudioElementEvents(i,t){Xk.forEach(e=>{t.addEventListener(e,n=>{const s=this.elementStateMap.get(i),r=n.type==="pause"?"paused":n.type;if(E.debug("[".concat(i,"] audio-element-status change ").concat(s," => ").concat(r)),n.type==="error"){const o=t==null?void 0:t.error;o&&E.error("[".concat(i,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(i,r)})})}getPlayerState(i){return this.elementStateMap.get(i)||"uninit"}autoResumeAudioElement(){const i=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(e=>{E.debug("Auto resume audio element success")}).catch(e=>{E.warning("Auto resume audio element failed!",e)})}),this.elementsNeedToResume=[]};new P(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{ua()?document.body.addEventListener("click",i,!0):(document.body.addEventListener("touchstart",i,!0),document.body.addEventListener("mousedown",i,!0))})}};function te(){return function(i,t,e){const n=e.value;return typeof n=="function"&&(e.value=function(){this._isClosed&&new M(R.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",E);for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];const a=n.apply(this,r);return a instanceof P?new P((c,d)=>{a.then(c).catch(d)}):a}),e}}function xR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function yd(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?xR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):xR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class VR extends Wt{constructor(t){super(),h(this,"name","VideoProcessorDestination"),h(this,"ID","0"),h(this,"_source",void 0),h(this,"videoContext",void 0),h(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new M(R.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new M(R.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(qe.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(qe.ON_TRACK,void 0)}}class FR extends Wt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"usageRegistry",[]),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"_chained",!1),this.trackId=t,this.direction=e}async getConstraints(){return await re(this,Ei.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,e){var n;return E.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),Dt(this,Ei.REQUEST_UPDATE_CONSTRAINTS,Array.from(In(n=this.constraintsMap).call(n)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return E.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),Dt(this,Ei.REQUEST_UPDATE_CONSTRAINTS,Array.from(In(e=this.constraintsMap).call(e)))}registerStats(t,e,n){this.statsRegistry.find(s=>s.processorID===t.ID&&s.processorName===t.name&&s.type===e)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:n})}unregisterStats(t,e){const n=this.statsRegistry.findIndex(s=>s.processorID===t.ID&&s.processorName===t.name&&s.type===e);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:n,type:s,cb:r}of this.statsRegistry)try{const o=r();t.push({processorID:e,processorName:n,type:s,stats:o})}catch(o){E.error(new M(R.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,e){this.usageRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name);e!==-1&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let n=e();n instanceof P&&(n=await n),t.push(yd(yd({},n),{},{direction:this.direction}))}catch(n){E.error("gather extension usage error",n)}return t}getDirection(){return this.direction}}class Ad extends Wt{constructor(t){super(),h(this,"name","AudioProcessorDestination"),h(this,"ID","0"),h(this,"inputTrack",void 0),h(this,"inputNode",void 0),h(this,"audioProcessorContext",void 0),h(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new M(R.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new M(R.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(qe.ON_TRACK,void 0),this.emit(qe.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(qe.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(qe.ON_NODE,this.inputNode))}}class bd extends Wt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,e,n){super(),h(this,"constraintsMap",new Map),h(this,"statsRegistry",[]),h(this,"audioContext",void 0),h(this,"trackId",void 0),h(this,"direction",void 0),h(this,"usageRegistry",[]),h(this,"_chained",!1),this.audioContext=t,this.trackId=e,this.direction=n}async getConstraints(){return re(this,Ei.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,e){var n;return E.info("processor ".concat(e.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(e,t),Dt(this,Ei.REQUEST_UPDATE_CONSTRAINTS,Array.from(In(n=this.constraintsMap).call(n)))}async requestRevertConstraints(t){var e;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),Dt(this,Ei.REQUEST_UPDATE_CONSTRAINTS,Array.from(In(e=this.constraintsMap).call(e)))}registerStats(t,e,n){this.statsRegistry.find(s=>s.processorID===t.ID&&s.processorName===t.name&&s.type===e)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:e,cb:n})}unregisterStats(t,e){const n=this.statsRegistry.findIndex(s=>s.processorID===t.ID&&s.processorName===t.name&&s.type===e);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){const t=[];for(const{processorID:e,processorName:n,type:s,cb:r}of this.statsRegistry)try{const o=r();t.push({processorID:e,processorName:n,type:s,stats:o})}catch(o){E.error(new M(R.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,e){this.usageRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:e})}unregisterUsage(t){const e=this.usageRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name);e!==-1&&this.usageRegistry.splice(e,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:e}of this.usageRegistry)try{let n=e();n instanceof P&&(n=await n),t.push(yd(yd({},n),{},{direction:this.direction}))}catch(n){E.error("gather extension usage error",n)}return t}getDirection(){return this.direction}}class Ep extends Wt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),h(this,"context",void 0),h(this,"processSourceNode",void 0),h(this,"outputTrack",void 0),h(this,"processedNode",void 0),h(this,"clonedTrack",void 0),h(this,"outputNode",void 0),this.outputNode=new Qk}setVolume(){}createOutputTrack(){throw new M(R.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Qk{disconnect(){}connect(){}}let vo=null;class Zk{constructor(){h(this,"state","open"),h(this,"trigger",void 0),h(this,"tasks",[]),E.debug("[macro-task-queue] is created."),this.trigger=window.setTimeout(()=>{this.state="closed",E.debug("[macro-task-queue] will be closed, all remaining tasks will execute. [".concat(this.tasks.map(t=>t.key),"]")),this.trigger=void 0,this.tasks.forEach(t=>{let{func:e}=t;return e()}),this.tasks.length=0,E.debug("[macro-task-queue] is closed.")})}enqueue(t,e){this.state!=="closed"&&(this.tasks.push({key:t,func:e}),E.debug("[macro-task-queue] is queued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")))}runTask(t){if(this.state==="closed")return;const e=this.tasks.findIndex(n=>n.key===t);if(e!==-1){const n=this.tasks.splice(e,1);E.debug("[macro-task-queue] is unqueued, current queue ".concat(this.tasks.length,". ").concat(typeof t=="string"?t:"")),n[0].func()}}release(){this.trigger&&(this.state="closed",clearTimeout(this.trigger),this.trigger=void 0,this.tasks.length=0,E.debug("[macro-task-queue] is closed."))}}function mp(i){return function(t,e,n){var s;const r=(s=n.value)!==null&&s!==void 0?s:n.get,o=function(){vo&&vo.state==="open"&&vo.runTask(i);for(var a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];return r==null?void 0:r.apply(this,...c)};return n.value?n.value=o:n.get=o,n}}function BR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function fp(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?BR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):BR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Ct extends xe{get _source(){return this._trackSource}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get processorDestination(){return this._processorDestination}set processorDestination(t){this._processorDestination=t}get isPlaying(){return this._useAudioElement?mi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,s,r){super(t,n),h(this,"trackMediaType","audio"),h(this,"_encoderConfig",void 0),h(this,"_trackSource",void 0),h(this,"_enabled",!0),h(this,"_volume",100),h(this,"_useAudioElement",!1),h(this,"_bypassWebAudio",!1),h(this,"processor",void 0),h(this,"_processorContext",void 0),h(this,"_processorDestination",void 0),h(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!s;const o=()=>{this.processorContext=new bd(this._source.context,this.getTrackId(),"local"),this.processorDestination=new Ad(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(_i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})},a=r&&Xe()&&!yR();v("DISABLE_WEBAUDIO")?(this._source=new Ep,this._useAudioElement=!0,this._bypassWebAudio=!0):a?this._source=new Ep:(this._source=new hp(t,!1,this._getOriginVolumeLevel?t:void 0),v("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0)),o(),!v("DISABLE_WEBAUDIO")&&a&&(vo||(vo=new Zk),vo).enqueue("INIT_WEBAUDIO",()=>{this._source=new hp(t,!1,this._getOriginVolumeLevel?t:void 0),v("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")||(this._useAudioElement=!0),o(),this.emit(Id.UPDATE_TRACK_SOURCE)})}setVolume(t){bt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&mi.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void E.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Dt(this,K.NEED_REPLACE_TRACK,this).then(()=>{E.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{E.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!la()&&v("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new M(R.NOT_SUPPORTED,"your browser does not support setting the audio output device");await mi.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Dt(this,K.NEED_ENABLE_TRACK,this),E.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(s){throw n||(this._enabled=!1),E.error("[".concat(this.getTrackId(),"] setEnabled to true error"),s.toString()),s}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Dt(this,K.NEED_DISABLE_TRACK,this)}catch(s){throw n||(this._enabled=!0),E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),s.toString()),s}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,E.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Dt(this,K.NEED_MUTE_TRACK,this):await Dt(this,K.NEED_UNMUTE_TRACK,this))}getStats(){return pa(()=>{E.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Ci(this,K.GET_STATS)||fp({},ap)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),this._source.on(_i.ON_AUDIO_BUFFER,n=>t(n))}play(){E.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(E.debug("[".concat(this.getTrackId(),"] start audio playback in element")),mi.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){E.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?mi.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];E.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&mi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this.processor.updateInput({track:t,context:this.processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Dt(this,K.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return P.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new M(R.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new M(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(qe.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Dt(this,K.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Dt(this,K.NEED_REPLACE_TRACK,this))}),this.processorDestination.on(qe.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(qe.ON_TRACK),this.processorDestination.removeAllListeners(qe.ON_NODE)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ei.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ei.REQUEST_CONSTRAINTS)}}U([mp("INIT_WEBAUDIO"),T("design:type",Object),T("design:paramtypes",[Object])],Ct.prototype,"_source",null),U([mp("INIT_WEBAUDIO"),T("design:type",bd),T("design:paramtypes",[bd])],Ct.prototype,"processorContext",null),U([mp("INIT_WEBAUDIO"),T("design:type",Ad),T("design:paramtypes",[Ad])],Ct.prototype,"processorDestination",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t],throttleTime:300}),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",void 0)],Ct.prototype,"setVolume",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Ct.prototype,"setPlaybackDevice",null),U([co("LocalAudioTrack","_enabledMutex"),$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean,Object,Boolean]),T("design:returntype",P)],Ct.prototype,"setEnabled",null),U([co("LocalAudioTrack","_enabledMutex"),$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean]),T("design:returntype",P)],Ct.prototype,"setMuted",null),U([te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",Object)],Ct.prototype,"getStats",null),U([te(),T("design:type",Function),T("design:paramtypes",[Object,Number]),T("design:returntype",void 0)],Ct.prototype,"setAudioFrameCallback",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Ct.prototype,"play",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Ct.prototype,"stop",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Ct.prototype,"close",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t.name]}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",Object)],Ct.prototype,"pipe",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Ct.prototype,"unpipe",null);class yr extends Ct{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,s){super(t,e.encoderConfig?Cd(e.encoderConfig):{},s,v("GET_VOLUME_OF_MUTED_AUDIO_TRACK"),!0),h(this,"_config",void 0),h(this,"_deviceName","default"),h(this,"_constraints",void 0),h(this,"_originalConstraints",void 0),h(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(no()||rh())&&yt.bindInterruptDetectorTrack(this),this.on(Id.UPDATE_TRACK_SOURCE,()=>{this.bindProcessorContextEvents()}),yR()&&this.bindProcessorContextEvents()}async setDevice(t){if(E.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await Fi.getDeviceById(t),n={};n.audio=fp({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let s=null;try{s=await Vi(n,this.getTrackId())}catch(r){throw E.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),s=await Vi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await Fi.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}E.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,n){if(e)return E.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){var s;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(s=this._source.clonedTrack)===null||s===void 0||s.stop(),n||(this._enabled=!1);try{await Dt(this,K.NEED_DISABLE_TRACK,this)}catch(a){throw E.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}const r=fp({},this._constraints),o=Fi.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);const a=await Vi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),await Dt(this,K.NEED_ENABLE_TRACK,this)}catch(a){throw n||(this._enabled=!1),E.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}E.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(no()||rh())&&yt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((Qe()||kn())&&this._enabled&&!this._isClosed&&yt.duringInterruption){const t=async()=>{yt.off(Re.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};yt.on(Re.IOS_INTERRUPTION_END,t)}else E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(xs.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,n=Fi.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const s=await Vi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!0)}}bindProcessorContextEvents(){this.processorContext.on(Ei.REQUEST_UPDATE_CONSTRAINTS,async(t,e,n)=>{try{const s=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(s),e()}catch(s){n(s)}}),this.processorContext.on(Ei.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],yr.prototype,"setDevice",null),U([co("MicrophoneAudioTrack","_enabledMutex"),$({argsMap:(i,t,e)=>[i.getTrackId(),t,e]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean,Boolean,Boolean]),T("design:returntype",P)],yr.prototype,"setEnabled",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],yr.prototype,"close",null);class Vs extends Ct{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,s){super(e.createOutputTrack(),n,s),h(this,"source",void 0),h(this,"_bufferSource",void 0),this.source=t,this._bufferSource=e,this._bufferSource.on(_i.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(xs.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){bt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}U([$({argsMap:(i,t)=>[i.getTrackId(),t,i.duration]}),te(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",void 0)],Vs.prototype,"startProcessAudioBuffer",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Vs.prototype,"pauseProcessAudioBuffer",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",void 0)],Vs.prototype,"seekAudioBuffer",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Vs.prototype,"resumeProcessAudioBuffer",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Vs.prototype,"stopProcessAudioBuffer",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Vs.prototype,"close",null),U([$({argsMap:i=>[i.getTrackId()]}),te(),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",void 0)],Vs.prototype,"setAudioBufferPlaybackSpeed",null);class ce extends Ct{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=Co().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,Pt(8,"track-mix-")),h(this,"trackList",void 0),h(this,"destNode",void 0);try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(E.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):E.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){E.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Jc(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(e=>{e._encoderConfig&&((e._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=e._encoderConfig.bitrate),(e._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=e._encoderConfig.sampleRate),(e._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=e._encoderConfig.sampleSize),e._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(e=>{e instanceof ce?e.emit(So.TRANSCEIVER_UPDATED,t):e._updateRtpTransceiver(t)}))}}function wd(i){const t={};i.facingMode&&(t.facingMode=i.facingMode),i.cameraId&&(t.deviceId={exact:i.cameraId});const e=Vn(i.encoderConfig);return e.width!=null&&(t.width=e.width),e.height!=null&&(t.height=e.height),!lT()&&e.frameRate&&(t.frameRate=e.frameRate),ft().name===Rt.EDGE&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Nt()&&(t.frameRate={ideal:30,max:30}),t}function jR(i){const t={};if(lT()||(i.AGC!==void 0&&(t.autoGainControl=i.AGC),i.AEC!==void 0&&(t.echoCancellation=i.AEC),i.ANS!==void 0&&(t.noiseSuppression=i.ANS,la()&&i.ANS&&(t.googHighpassFilter=i.ANS))),i.encoderConfig){const e=Cd(i.encoderConfig);t.channelCount=e.stereo?2:1,t.sampleRate=e.sampleRate,t.sampleSize=e.sampleSize}return i.microphoneId&&(t.deviceId={exact:i.microphoneId}),Yc()&&(t.sampleRate=void 0),t}class $k extends bR{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(_i.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),h(this,"audioBuffer",void 0),h(this,"sourceNode",void 0),h(this,"startPlayTime",0),h(this,"startPlayOffset",0),h(this,"pausePlayTime",0),h(this,"options",void 0),h(this,"currentLoopCount",0),h(this,"currentPlaybackSpeed",100),h(this,"_currentState","stopped"),this.audioBuffer=t,this.options=e,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):E.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const GR=new Map;async function tM(i,t){let e=null;if(typeof i=="string"){const s=GR.get(i);if(s)return E.debug("use cached audio resource: ",i),s;try{e=(await Cn(()=>hi.get(i,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(r){throw new M(R.FETCH_AUDIO_FILE_FAILED,r.toString())}}else e=await new P((r,o)=>{const a=new FileReader;a.onload=c=>{c.target?r(c.target.result):o(new M(R.READ_LOCAL_AUDIO_FILE_ERROR))},a.onerror=()=>{o(new M(R.READ_LOCAL_AUDIO_FILE_ERROR))},a.readAsArrayBuffer(i)});const n=await function(s){const r=Co();return new P((o,a)=>{r.decodeAudioData(s,c=>{o(c)},c=>{a(new M(R.DECODE_AUDIO_FILE_FAILED,c.toString()))})})}(e);return typeof i=="string"&&t&&GR.set(i,n),n}const gp=i=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new P((e,n)=>{t.toBlob(async s=>{if(t.remove(),s){const r=await WR(s);e({buffer:r,width:t.width,height:t.height})}else n(new M(R.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},i,1)})},WR=async i=>{const t=await i.arrayBuffer();return new Uint8Array(t)},os=new class extends Wt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),h(this,"_lastHiddenTime",0),h(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),E.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};function HR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function KR(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?HR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):HR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Tp{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(E.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}constructor(t){h(this,"trackId",void 0),h(this,"config",void 0),h(this,"onFirstVideoFrameDecoded",void 0),h(this,"freezeTimeCounterList",[]),h(this,"renderFreezeAccTime",0),h(this,"isKeepLastFrame",!1),h(this,"timeUpdatedCount",0),h(this,"freezeTime",0),h(this,"playbackTime",0),h(this,"lastTimeUpdatedTime",0),h(this,"autoplayFailed",!1),h(this,"videoTrack",void 0),h(this,"videoElement",void 0),h(this,"cacheVideoElement",void 0),h(this,"videoElementCheckInterval",void 0),h(this,"_videoElementStatus",Je.NONE),h(this,"isGettingVideoDimensions",!1),h(this,"startGetVideoDimensions",()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return E.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()}),h(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&yt.curState==="running"&&(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(nT())),cT()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),h(this,"handleVideoEvents",e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Je.PLAYING;break;case"loadeddata":if(this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Je.CANPLAY;break;case"stalled":this.videoElementStatus=Je.STALLED;break;case"suspend":this.videoElementStatus=Je.SUSPEND;break;case"pause":this.videoElementStatus=Je.PAUSED,Qe()||kn()||Xe()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Je.WAITING;break;case"abort":this.videoElementStatus=Je.ABORT;break;case"ended":this.videoElementStatus=Je.ENDED;break;case"emptied":this.videoElementStatus=Je.EMPTIED;break;case"error":{this.videoElementStatus=Je.ERROR;const n=this.videoElement.error;n&&E.error("[".concat(this.trackId,"] media error, code: ").concat(n.code,", message: ").concat(n.message));break}case"timeupdate":{const n=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=n);const s=n-this.lastTimeUpdatedTime,r=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=n,os.lastVisibleTime<os.lastHiddenTime||r<os.lastHiddenTime||r<os.lastVisibleTime)return;for(s>v("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=s),this.playbackTime+=s;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),h(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(E.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(nT())),cT()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),yt.on(Re.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.on(Re.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const e=this.videoElement.play();e&&e.catch&&e.catch(s=>{t&&UR(t,"video",s.message,this.trackId),s.name==="NotAllowedError"?(E.warning("detected video element autoplay failed",s),this.autoplayFailed=!0,this.handleAutoPlayFailed()):E.warning("[".concat(this.trackId,"] play warning: "),s)});const n=ft();if((n.name==="Safari"&&Number(n.version)===15||no())&&e&&e.then){const s=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};e.then(s).catch(s)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const e=t.getContext("2d");if(!e)return E.error("create canvas context failed!"),new ImageData(2,2);e.drawImage(this.videoElement,0,0,t.width,t.height);const n=e.getImageData(0,0,t.width,t.height);return t.remove(),n}async getCurrentFrameToUint8Array(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const s=n.getContext("2d");return s?(s.drawImage(this.videoElement,0,0,n.width,n.height),new P((r,o)=>{n.toBlob(async a=>{if(n.remove(),a){const c=await WR(a);r({buffer:c,width:n.width,height:n.height})}else o(new M(R.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,e<0?.1:e>1?1:e)})):await gp(t)}destroy(){yt.off(Re.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.off(Re.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[]}initVideoElement(){if(this.videoElementStatus=Je.INIT,!this.videoElementCheckInterval&&(YR.forEach(r=>{this.videoElement.addEventListener(r,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(r){return r!==document.body&&document.body.contains(r)})(this.videoElement)||(this.videoElementStatus=Je.DESTROYED)},1e3),v("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,e;let r;const o=(a,c)=>{if(this.videoElementStatus===Je.PLAYING){if(r){const u=c.presentationTime-r.presentationTime;u>v("VIDEO_FREEZE_DURATION")&&os.lastVisibleTime>=os.lastHiddenTime&&r.timestamp>os.lastVisibleTime&&r.timestamp>os.lastHiddenTime&&(this.renderFreezeAccTime+=u)}r=KR(KR({},c),{},{timestamp:a})}var d,l;v("ENABLE_VIDEO_FRAME_CALLBACK")&&((d=(l=this.videoElement).requestVideoFrameCallback)===null||d===void 0||d.call(l,o))};(t=(e=this.videoElement).requestVideoFrameCallback)===null||t===void 0||t.call(e,o)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Yc()&&(this.videoElement.poster="noposter");const n=ft();n.name==="Safari"&&Number(n.version)===15||no()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Nt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Nt()&&this.videoElement.load());const s=this.videoElement.play();s!==void 0&&s.catch(r=>{E.debug("[".concat(this.trackId,"] playback interrupted"),r.toString())})}resetVideoElement(){YR.forEach(t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Je.NONE}handleAutoPlayFailed(){const t=e=>{e.preventDefault(),this.videoElement.play().then(()=>{E.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(n=>{E.error(n)}),this.autoplayFailed=!1,ua()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};ua()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),LR()}}const YR=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class qR extends Tp{constructor(t){super(t),h(this,"container",void 0),h(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const e=t.element;e!==this.slot&&(this.destroy(),this.slot=e),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var e;let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,n):await gp(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",v("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}function JR(i){return new P((t,e)=>{let n=!1;const s=document.createElement("video");s.setAttribute("autoplay",""),s.setAttribute("muted",""),s.muted=!0,s.autoplay=!0,s.setAttribute("playsinline",""),s.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(s);const r=Qe()?"canplay":"playing";s.addEventListener(r,()=>{const o=s.videoWidth,a=s.videoHeight;!o&&Nt()||(n=!0,s.srcObject=null,s.remove(),t([o,a]))}),s.srcObject=new MediaStream([i]),s.play().catch(Qc),setTimeout(()=>{n||(s.srcObject=null,s.remove(),t([s.videoWidth,s.videoHeight]))},4e3)})}const eM=async(i,t,e)=>{const n=function(o){const a=[];for(let c=0;c<o.length;c+=2)a.push(parseInt(o.slice(c,c+2),16));return Uint8Array.from(a)}(function(o){const a="0123456789abcdef";function c(F){let j,it="";for(j=0;j<=3;j++)it+=a.charAt(F>>8*j+4&15)+a.charAt(F>>8*j&15);return it}function d(F,j){const it=(65535&F)+(65535&j);return(F>>16)+(j>>16)+(it>>16)<<16|65535&it}function l(F,j,it,ct,Ut,he){return d(function(Bt,Ai){return Bt<<Ai|Bt>>>32-Ai}(d(d(j,F),d(ct,he)),Ut),it)}function u(F,j,it,ct,Ut,he,Bt){return l(j&it|~j&ct,F,j,Ut,he,Bt)}function p(F,j,it,ct,Ut,he,Bt){return l(j&ct|it&~ct,F,j,Ut,he,Bt)}function _(F,j,it,ct,Ut,he,Bt){return l(j^it^ct,F,j,Ut,he,Bt)}function S(F,j,it,ct,Ut,he,Bt){return l(it^(j|~ct),F,j,Ut,he,Bt)}const f=function(F){let j;const it=1+(F.length+8>>6),ct=new Array(16*it);for(j=0;j<16*it;j++)ct[j]=0;for(j=0;j<F.length;j++)ct[j>>2]|=F.charCodeAt(j)<<j%4*8;return ct[j>>2]|=128<<j%4*8,ct[16*it-2]=8*F.length,ct}(o);let g,C,y,A,k,O=1732584193,N=-271733879,L=-1732584194,D=271733878;for(g=0;g<f.length;g+=16)C=O,y=N,A=L,k=D,O=u(O,N,L,D,f[g+0],7,-680876936),D=u(D,O,N,L,f[g+1],12,-389564586),L=u(L,D,O,N,f[g+2],17,606105819),N=u(N,L,D,O,f[g+3],22,-1044525330),O=u(O,N,L,D,f[g+4],7,-176418897),D=u(D,O,N,L,f[g+5],12,1200080426),L=u(L,D,O,N,f[g+6],17,-1473231341),N=u(N,L,D,O,f[g+7],22,-45705983),O=u(O,N,L,D,f[g+8],7,1770035416),D=u(D,O,N,L,f[g+9],12,-1958414417),L=u(L,D,O,N,f[g+10],17,-42063),N=u(N,L,D,O,f[g+11],22,-1990404162),O=u(O,N,L,D,f[g+12],7,1804603682),D=u(D,O,N,L,f[g+13],12,-40341101),L=u(L,D,O,N,f[g+14],17,-1502002290),N=u(N,L,D,O,f[g+15],22,1236535329),O=p(O,N,L,D,f[g+1],5,-165796510),D=p(D,O,N,L,f[g+6],9,-1069501632),L=p(L,D,O,N,f[g+11],14,643717713),N=p(N,L,D,O,f[g+0],20,-373897302),O=p(O,N,L,D,f[g+5],5,-701558691),D=p(D,O,N,L,f[g+10],9,38016083),L=p(L,D,O,N,f[g+15],14,-660478335),N=p(N,L,D,O,f[g+4],20,-405537848),O=p(O,N,L,D,f[g+9],5,568446438),D=p(D,O,N,L,f[g+14],9,-1019803690),L=p(L,D,O,N,f[g+3],14,-187363961),N=p(N,L,D,O,f[g+8],20,1163531501),O=p(O,N,L,D,f[g+13],5,-1444681467),D=p(D,O,N,L,f[g+2],9,-51403784),L=p(L,D,O,N,f[g+7],14,1735328473),N=p(N,L,D,O,f[g+12],20,-1926607734),O=_(O,N,L,D,f[g+5],4,-378558),D=_(D,O,N,L,f[g+8],11,-2022574463),L=_(L,D,O,N,f[g+11],16,1839030562),N=_(N,L,D,O,f[g+14],23,-35309556),O=_(O,N,L,D,f[g+1],4,-1530992060),D=_(D,O,N,L,f[g+4],11,1272893353),L=_(L,D,O,N,f[g+7],16,-155497632),N=_(N,L,D,O,f[g+10],23,-1094730640),O=_(O,N,L,D,f[g+13],4,681279174),D=_(D,O,N,L,f[g+0],11,-358537222),L=_(L,D,O,N,f[g+3],16,-722521979),N=_(N,L,D,O,f[g+6],23,76029189),O=_(O,N,L,D,f[g+9],4,-640364487),D=_(D,O,N,L,f[g+12],11,-421815835),L=_(L,D,O,N,f[g+15],16,530742520),N=_(N,L,D,O,f[g+2],23,-995338651),O=S(O,N,L,D,f[g+0],6,-198630844),D=S(D,O,N,L,f[g+7],10,1126891415),L=S(L,D,O,N,f[g+14],15,-1416354905),N=S(N,L,D,O,f[g+5],21,-57434055),O=S(O,N,L,D,f[g+12],6,1700485571),D=S(D,O,N,L,f[g+3],10,-1894986606),L=S(L,D,O,N,f[g+10],15,-1051523),N=S(N,L,D,O,f[g+1],21,-2054922799),O=S(O,N,L,D,f[g+8],6,1873313359),D=S(D,O,N,L,f[g+15],10,-30611744),L=S(L,D,O,N,f[g+6],15,-1560198380),N=S(N,L,D,O,f[g+13],21,1309151649),O=S(O,N,L,D,f[g+4],6,-145523070),D=S(D,O,N,L,f[g+11],10,-1120210379),L=S(L,D,O,N,f[g+2],15,718787259),N=S(N,L,D,O,f[g+9],21,-343485551),O=d(O,C),N=d(N,y),L=d(L,A),D=d(D,k);return c(O)+c(N)+c(L)+c(D)}(""+t+e)).slice(0,16),s=n.slice(0,12),r=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,i))},zR=async(i,t,e)=>await eM(i.buffer,t,e);function XR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function ji(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?XR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):XR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class dt extends xe{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Je.PLAYING)}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,e,n,s,r,o){if(super(t,r),h(this,"trackMediaType","video"),h(this,"_player",void 0),h(this,"isUseScaleResolutionDownBy",!1),h(this,"_videoVisibleTimer",null),h(this,"_statsTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"_encoderConfig",void 0),h(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),h(this,"_optimizationMode",void 0),h(this,"_videoHeight",void 0),h(this,"_videoWidth",void 0),h(this,"_forceBitrateLimit",void 0),h(this,"_enabled",!0),h(this,"processorDestination",void 0),h(this,"_processorContext",void 0),Xe()){const{width:a,height:c}=t.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=e,this._scalabilityMode=n,this._optimizationMode=s,this._hints=o||[],this._hints.indexOf(Mt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(a,c,d){const l=ft();return!(l.name!==a||!l.osVersion)&&(d?Number(l.version)>=c&&Number(l.version)<=d:Number(l.version)===c)}(Rt.CHROME,115)&&Hc().indexOf("Windows")!==-1){const a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&Ot().supportWebRTCInsertableStream){const l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"});let p,_,S=Date.now();const f=()=>{g&&(clearInterval(g),g=void 0),p&&(p.close(),p=void 0),c.stop(),_=void 0,u.removeEventListener("ended",f)};let g=window.setInterval(()=>{if(_&&p&&Date.now()-S>(d??1e3))try{u.readyState==="live"?_.enqueue(p.clone()):f()}catch{f()}},d??1e3);const C=new TransformStream({transform:(y,A)=>{u.readyState==="live"?(_=A,S=Date.now(),p===void 0?(p=y,A.enqueue(y.clone())):(A.enqueue(p),p=y)):y.close()}});return u.addEventListener("ended",f),l.readable.pipeThrough(C).pipeTo(u.writable),u}}(t);a&&(E.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}e&&this._hints.indexOf(Mt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(e),this.processorContext=new FR(this.getTrackId(),"local"),this.processorDestination=new VR(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const s=document.getElementById(t);s?t=s:(E.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}E.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=ji(ji(ji({},this._getDefaultPlayerConfig()),e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new Tp(n):this._player=new qR(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const s=this.getVideoElementVisibleStatus();this.safeEmit(xs.VIDEO_ELEMENT_VISIBLE_STATUS,s)}catch{}},v("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,E.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await Dt(this,K.NEED_DISABLE_TRACK,this)}catch(n){throw E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}return e||(this._enabled=!1),void E.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Dt(this,K.NEED_ENABLE_TRACK,this)}catch(n){throw E.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}E.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,E.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Dt(this,K.NEED_MUTE_TRACK,this):await Dt(this,K.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,e){if(!this._enabled)throw new M(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Vn(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const n=wd({encoderConfig:t});(Xe()||Qe()||kn())&&(n.deviceId=void 0),E.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(s){const r=new M(R.UNEXPECTED_ERROR,s.toString());throw E.error("[".concat(this.getTrackId(),"] applyConstraints error"),r.toString()),r}}this._encoderConfig=t,this._hints.indexOf(Mt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Dt(this,K.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(E)}}getStats(){return pa(()=>{E.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Ci(this,K.GET_STATS)||ji({},cp)}async setBeautyEffect(t){E.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,e):await gp(t)}async setBitrateLimit(t){if(E.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await Dt(this,K.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(E)}}}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void E.error(R.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const e=this._optimizationMode;try{this._optimizationMode=t,await Dt(this,K.SET_OPTIMIZATION_MODE,this)}catch(n){throw this._optimizationMode=e,E.error("[".concat(this.getTrackId(),"] set optimization mode failed"),n.toString()),n}E.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return E.error(R.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,E.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){JR(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Qc)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new M(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");E.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=Vn(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(Mt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Dt(this,K.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(E)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:e,frameRate:n}=this.getMediaStreamTrackSettings();if(!t||!e||!n)return;const[s,r]=function(o,a,c,d){let l;const u=200*Math.pow(c/15,.6)*Math.pow(o*a/640/360,.75),p=u;if(d==="STANDARD_BITRATE")l=4*u;else{if(d!=="COMPATIABLE_BITRATE")return;l=2*u}return[Math.floor(l),Math.floor(p)]}(t,e,n,v("BITRATE_ADAPTER_TYPE"))||[void 0,void 0];this._encoderConfig.bitrateMin||this._encoderConfig.bitrateMax||(this._encoderConfig.bitrateMin=r,this._encoderConfig.bitrateMax=s,E.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(e,", fps: ").concat(n,"] => [brMax: ").concat(s,", brMin: ").concat(r,"]")))}getVideoElementVisibleStatus(){try{var t,e;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),s={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:r,slot:o}=s;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=_T.checkOneElementVisible(r),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new M(R.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new M(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;t&&(n=ji(ji({},n),Vn(t))),n=Er(n);const s=Pt(8,"track-video-cloned-"),r=new dt(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,Er(this._scalabilityMode),this._optimizationMode,s,Er(this._hints));return t&&n&&r.setEncoderConfiguration(n),E.debug("clone video track from ".concat(this.getTrackId()," to ").concat(s,", clone ").concat(e)),r}async replaceTrack(t,e){if(!(t instanceof MediaStreamTrack))throw new M(R.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new M(R.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,e,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Xe()&&!Qe())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,e=Sd[t],n=-1,s=Date.now();const r=o=>{o>2||o<0||(s=Date.now(),e=Sd[o],this.setSenderConfiguration(e))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const o=this.getStats(),a=Ci(this,K.GET_RTC_STATS);if(o.sendPackets>0&&a){n===-1&&(n=Date.now());const c=Date.now();if(c-n<1e3||c-s<v("PROFILE_SWITCH_INTERVAL"))return;const d=o.sendFrameRate,l=.6*e.frameRate,u=.9*e.frameRate;typeof d=="number"&&d>0&&d<l?t>0&&(t--,r(t),E.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(d,", switchProfile to ").concat(t))):a.OutgoingAvailableBandwidth<e.bitrateMin?t>0&&(t--,r(t),E.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", bitrateMin ").concat(e.bitrateMin,", switchProfile to ").concat(t))):typeof d=="number"&&d>u&&t<Sd.length-1&&a.OutgoingAvailableBandwidth>1.2*Sd[t+1].bitrateMin&&(t++,r(t),E.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(d,", OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}},v("CHECK_LOCAL_STATS_INTERVAL"))}bindProcessorDestinationEvents(){this.processorDestination.on(qe.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await Dt(this,K.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Dt(this,K.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(qe.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ei.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ei.REQUEST_CONSTRAINTS)}}U([$({argsMap:(i,t,e)=>[i.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",e]}),te(),T("design:type",Function),T("design:paramtypes",[Object,Object]),T("design:returntype",void 0)],dt.prototype,"play",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],dt.prototype,"stop",null),U([co("LocalVideoTrack","_enabledMutex"),$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean,Boolean]),T("design:returntype",P)],dt.prototype,"setEnabled",null),U([co("LocalVideoTrack","_enabledMutex"),$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean]),T("design:returntype",P)],dt.prototype,"setMuted",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Object,Boolean]),T("design:returntype",P)],dt.prototype,"setEncoderConfiguration",null),U([te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",Object)],dt.prototype,"getStats",null),U([$({argsMap:(i,t,e)=>[i.getTrackId(),t,e]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean,Object]),T("design:returntype",P)],dt.prototype,"setBeautyEffect",null),U([te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",ImageData)],dt.prototype,"getCurrentFrameData",null),U([te(),T("design:type",Function),T("design:paramtypes",[String,Number]),T("design:returntype",P)],dt.prototype,"getCurrentFrameImage",null),U([te(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],dt.prototype,"setBitrateLimit",null),U([te(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],dt.prototype,"setOptimizationMode",null),U([te(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",void 0)],dt.prototype,"setScalabiltyMode",null),U([te(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],dt.prototype,"updateMediaStreamTrackResolution",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t.name]}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",Object)],dt.prototype,"pipe",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],dt.prototype,"unpipe",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],dt.prototype,"close",null),U([$({argsMap:(i,t,e)=>[i.getTrackId(),t.label,e]}),T("design:type",Function),T("design:paramtypes",[MediaStreamTrack,Boolean]),T("design:returntype",P)],dt.prototype,"replaceTrack",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],dt.prototype,"startMonitorStats",null);class Fs extends dt{get __className__(){return"CameraVideoTrack"}constructor(t,e,n,s,r,o){super(t,Vn(e.encoderConfig),s,r,o),h(this,"_config",void 0),h(this,"_originalConstraints",void 0),h(this,"_constraints",void 0),h(this,"_enabled",!0),h(this,"_deviceName","default"),h(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(no()||rh())&&!function(){const a=ft();if(a.os!==_e.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&dT()&&this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=e,this._originalConstraints=n,this._constraints=n,this._deviceName=t.label,this._encoderConfig=Vn(this._config.encoderConfig),yt.on(Re.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),yt.on(Re.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(E.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const e=await Fi.getDeviceById(t),n={};n.video=ji({},this._constraints),n.video.deviceId={exact:t},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let s=null;try{s=await Vi(n,this.getTrackId())}catch(r){throw E.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),s=await Vi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(s.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(s.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await Fi.getDeviceById(t);this._deviceName=e.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(e){throw E.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}E.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){E.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const e={video:ji(ji({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let n=null;try{n=await Vi(e,this.getTrackId())}catch(s){throw E.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),s.toString()),n=await Vi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=ji({},e.video),E.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,e){if(!e){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(E.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const n=await Vi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1)}await Dt(this,K.NEED_ENABLE_TRACK,this)}catch(n){throw E.error("[".concat(this.getTrackId(),"] setEnabled true error"),n.toString()),n}this.updateMediaStreamTrackResolution(),E.info("[".concat(this.getTrackId(),"] setEnabled to true success")),e||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),e||(this._enabled=!1);try{await Dt(this,K.NEED_DISABLE_TRACK,this)}catch(n){throw E.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}E.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,e){if(!this._enabled)throw new M(R.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Vn(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin);const n=kt(this._config);n.encoderConfig=t;const s=wd(n);(Xe()||Qe()||kn())&&(s.deviceId=void 0),E.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(s));try{await this._originMediaStreamTrack.applyConstraints(s),this.updateMediaStreamTrackResolution()}catch(r){const o=new M(R.UNEXPECTED_ERROR,r.toString());throw E.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=n,this._constraints=s,this._originalConstraints=s,this._encoderConfig=t,this._hints.indexOf(Mt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Dt(this,K.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(E)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Qe()||kn())&&this._enabled&&!this._isClosed&&yt.duringInterruption){const t=async()=>{yt.off(Re.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(E.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};yt.on(Re.IOS_INTERRUPTION_END,t)}else E.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(xs.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,n=Fi.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId={exact:n}),this._enabled){const s=await Vi({video:e},this.getTrackId());this._constraints=e,await this._updateOriginMediaStreamTrack(s.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),yt.off(Re.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),yt.off(Re.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;t&&(n=ji(ji({},n),Vn(t))),n=Er(n);const s=Pt(8,"track-cam-cloned-"),r=new Fs(e?this._mediaStreamTrack.clone():this._mediaStreamTrack,Er(ji(ji({},this._config),{},{encoderConfig:n})),Er(this._constraints),Er(this._scalabilityMode),this._optimizationMode,s);return t&&n&&r.setEncoderConfiguration(n),E.debug("clone track from ".concat(this.getTrackId()," to ").concat(s,", clone ").concat(e)),r}bindProcessorContextEvents(){this.processorContext.on(Ei.REQUEST_UPDATE_CONSTRAINTS,async(t,e,n)=>{try{const s=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(s),e()}catch(s){n(s)}}),this.processorContext.on(Ei.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}}function QR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Od(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?QR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):QR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function Sp(i,t,e,n){e.optimizationMode&&(n&&n.width&&n.height?(e.encoderConfig=Od(Od({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),e.optimizationMode!=="motion"&&e.optimizationMode!=="detail"||(t.contentHint=e.optimizationMode,t.contentHint===e.optimizationMode?E.debug("[".concat(i,"] set content hint to"),e.optimizationMode):E.debug("[".concat(i,"] set content hint failed")))):E.warning("[".concat(i,"] can not apply optimization mode bitrate config, no encoderConfig")))}function ZR(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Nd(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?ZR(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):ZR(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Fs.prototype,"setDevice",null),U([co("CameraVideoTrack","_enabledMutex"),$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Boolean,Boolean]),T("design:returntype",P)],Fs.prototype,"setEnabled",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),te(),T("design:type",Function),T("design:paramtypes",[Object,Boolean]),T("design:returntype",P)],Fs.prototype,"setEncoderConfiguration",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Fs.prototype,"close",null);class $R extends CR{getUserId(){return this._userId}constructor(t,e,n,s){super(t,"track-".concat(t.kind,"-").concat(e,"-").concat(s.clientId,"_").concat(Pt(5,""))),h(this,"_userId",void 0),h(this,"_uintId",void 0),h(this,"_isDestroyed",!1),h(this,"store",void 0),h(this,"processor",void 0),this._userId=e,this._uintId=n,this.store=s}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,E.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}class Fn extends $R{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Je.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,s){super(t,e,n,s),h(this,"_videoVisibleTimer",null),h(this,"_previousVideoVisibleStatus",void 0),h(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),h(this,"trackMediaType","video"),h(this,"_videoWidth",void 0),h(this,"_videoHeight",void 0),h(this,"_player",void 0),h(this,"processorDestination",void 0),h(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new FR(this.getTrackId(),"remote"),this.processorDestination=new VR(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return pa(()=>{E.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Ci(this,K.GET_STATS)||Nd({},RR)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const s=document.getElementById(t);s?t=s:(E.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}E.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=Nd(Nd({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(t instanceof HTMLVideoElement?this._player=new Tp(n):this._player=new qR(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Cr.FIRST_FRAME_DECODED)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const s=this.getVideoElementVisibleStatus();this.safeEmit(Cr.VIDEO_ELEMENT_VISIBLE_STATUS,s)}catch{}},v("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,E.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){JR(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Qc)}_updatePlayerSource(){E.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),s={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:r,slot:o}=s;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=_T.checkOneElementVisible(r),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new M(R.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new M(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(qe.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(qe.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}}U([$({argsMap:(i,t,e)=>[i.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",e]}),T("design:type",Function),T("design:paramtypes",[Object,Object]),T("design:returntype",void 0)],Fn.prototype,"play",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Fn.prototype,"stop",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t.name]}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",Object)],Fn.prototype,"pipe",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Fn.prototype,"unpipe",null);class pn extends $R{get isPlaying(){return this._useAudioElement?mi.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,s){super(t,e,n,s),h(this,"trackMediaType","audio"),h(this,"_source",void 0),h(this,"_useAudioElement",!0),h(this,"_volume",100),h(this,"processorContext",void 0),h(this,"processorDestination",void 0),h(this,"_played",!1),h(this,"_bypassWebAudio",!1),v("DISABLE_WEBAUDIO")?(this._source=new Ep,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new hp(t,!0),v("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(_i.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Cr.FIRST_FRAME_DECODED)}),this.processorContext=new bd(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ad(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(_i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),this._source.on(_i.ON_AUDIO_BUFFER,n=>t(n))}setVolume(t){this._volume=t,this._useAudioElement?mi.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!la()&&v("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new M(R.NOT_SUPPORTED,"your browser does not support setting the audio output device");await mi.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return pa(()=>{E.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Ci(this,K.GET_STATS)||Nd({},SR)}play(){E.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(E.debug("[".concat(this.getTrackId(),"] use audio element to play")),mi.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){E.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?mi.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];E.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&mi.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new M(R.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(qe.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(qe.ON_NODE,t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(qe.ON_TRACK),this.processorDestination.removeAllListeners(qe.ON_NODE)}}U([$({argsMap:(i,t)=>[i.getTrackId(),t],throttleTime:300}),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",void 0)],pn.prototype,"setVolume",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t]}),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],pn.prototype,"setPlaybackDevice",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],pn.prototype,"play",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],pn.prototype,"stop",null),U([$({argsMap:(i,t)=>[i.getTrackId(),t.name]}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",Object)],pn.prototype,"pipe",null),U([$({argsMap:i=>[i.getTrackId()]}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],pn.prototype,"unpipe",null);function yo(i){let t=i.length;for(;--t>=0;)i[t]=0}const Rp=256,tC=286,Ra=30,Ca=15,Cp=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Dd=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),iM=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),eC=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),as=new Array(576);yo(as);const Ia=new Array(60);yo(Ia);const va=new Array(512);yo(va);const ya=new Array(256);yo(ya);const Ip=new Array(29);yo(Ip);const Pd=new Array(Ra);function vp(i,t,e,n,s){this.static_tree=i,this.extra_bits=t,this.extra_base=e,this.elems=n,this.max_length=s,this.has_stree=i&&i.length}let iC,nC,sC;function yp(i,t){this.dyn_tree=i,this.max_code=0,this.stat_desc=t}yo(Pd);const rC=i=>i<256?va[i]:va[256+(i>>>7)],Aa=(i,t)=>{i.pending_buf[i.pending++]=255&t,i.pending_buf[i.pending++]=t>>>8&255},Gi=(i,t,e)=>{i.bi_valid>16-e?(i.bi_buf|=t<<i.bi_valid&65535,Aa(i,i.bi_buf),i.bi_buf=t>>16-i.bi_valid,i.bi_valid+=e-16):(i.bi_buf|=t<<i.bi_valid&65535,i.bi_valid+=e)},Bn=(i,t,e)=>{Gi(i,e[2*t],e[2*t+1])},oC=(i,t)=>{let e=0;do e|=1&i,i>>>=1,e<<=1;while(--t>0);return e>>>1},aC=(i,t,e)=>{const n=new Array(16);let s,r,o=0;for(s=1;s<=Ca;s++)o=o+e[s-1]<<1,n[s]=o;for(r=0;r<=t;r++){let a=i[2*r+1];a!==0&&(i[2*r]=oC(n[a]++,a))}},cC=i=>{let t;for(t=0;t<tC;t++)i.dyn_ltree[2*t]=0;for(t=0;t<Ra;t++)i.dyn_dtree[2*t]=0;for(t=0;t<19;t++)i.bl_tree[2*t]=0;i.dyn_ltree[512]=1,i.opt_len=i.static_len=0,i.sym_next=i.matches=0},dC=i=>{i.bi_valid>8?Aa(i,i.bi_buf):i.bi_valid>0&&(i.pending_buf[i.pending++]=i.bi_buf),i.bi_buf=0,i.bi_valid=0},lC=(i,t,e,n)=>{const s=2*t,r=2*e;return i[s]<i[r]||i[s]===i[r]&&n[t]<=n[e]},Ap=(i,t,e)=>{const n=i.heap[e];let s=e<<1;for(;s<=i.heap_len&&(s<i.heap_len&&lC(t,i.heap[s+1],i.heap[s],i.depth)&&s++,!lC(t,n,i.heap[s],i.depth));)i.heap[e]=i.heap[s],e=s,s<<=1;i.heap[e]=n},uC=(i,t,e)=>{let n,s,r,o,a=0;if(i.sym_next!==0)do n=255&i.pending_buf[i.sym_buf+a++],n+=(255&i.pending_buf[i.sym_buf+a++])<<8,s=i.pending_buf[i.sym_buf+a++],n===0?Bn(i,s,t):(r=ya[s],Bn(i,r+Rp+1,t),o=Cp[r],o!==0&&(s-=Ip[r],Gi(i,s,o)),n--,r=rC(n),Bn(i,r,e),o=Dd[r],o!==0&&(n-=Pd[r],Gi(i,n,o)));while(a<i.sym_next);Bn(i,256,t)},bp=(i,t)=>{const e=t.dyn_tree,n=t.stat_desc.static_tree,s=t.stat_desc.has_stree,r=t.stat_desc.elems;let o,a,c,d=-1;for(i.heap_len=0,i.heap_max=573,o=0;o<r;o++)e[2*o]!==0?(i.heap[++i.heap_len]=d=o,i.depth[o]=0):e[2*o+1]=0;for(;i.heap_len<2;)c=i.heap[++i.heap_len]=d<2?++d:0,e[2*c]=1,i.depth[c]=0,i.opt_len--,s&&(i.static_len-=n[2*c+1]);for(t.max_code=d,o=i.heap_len>>1;o>=1;o--)Ap(i,e,o);c=r;do o=i.heap[1],i.heap[1]=i.heap[i.heap_len--],Ap(i,e,1),a=i.heap[1],i.heap[--i.heap_max]=o,i.heap[--i.heap_max]=a,e[2*c]=e[2*o]+e[2*a],i.depth[c]=(i.depth[o]>=i.depth[a]?i.depth[o]:i.depth[a])+1,e[2*o+1]=e[2*a+1]=c,i.heap[1]=c++,Ap(i,e,1);while(i.heap_len>=2);i.heap[--i.heap_max]=i.heap[1],((l,u)=>{const p=u.dyn_tree,_=u.max_code,S=u.stat_desc.static_tree,f=u.stat_desc.has_stree,g=u.stat_desc.extra_bits,C=u.stat_desc.extra_base,y=u.stat_desc.max_length;let A,k,O,N,L,D,F=0;for(N=0;N<=Ca;N++)l.bl_count[N]=0;for(p[2*l.heap[l.heap_max]+1]=0,A=l.heap_max+1;A<573;A++)k=l.heap[A],N=p[2*p[2*k+1]+1]+1,N>y&&(N=y,F++),p[2*k+1]=N,k>_||(l.bl_count[N]++,L=0,k>=C&&(L=g[k-C]),D=p[2*k],l.opt_len+=D*(N+L),f&&(l.static_len+=D*(S[2*k+1]+L)));if(F!==0){do{for(N=y-1;l.bl_count[N]===0;)N--;l.bl_count[N]--,l.bl_count[N+1]+=2,l.bl_count[y]--,F-=2}while(F>0);for(N=y;N!==0;N--)for(k=l.bl_count[N];k!==0;)O=l.heap[--A],O>_||(p[2*O+1]!==N&&(l.opt_len+=(N-p[2*O+1])*p[2*O],p[2*O+1]=N),k--)}})(i,t),aC(e,d,i.bl_count)},hC=(i,t,e)=>{let n,s,r=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),t[2*(e+1)+1]=65535,n=0;n<=e;n++)s=o,o=t[2*(n+1)+1],++a<c&&s===o||(a<d?i.bl_tree[2*s]+=a:s!==0?(s!==r&&i.bl_tree[2*s]++,i.bl_tree[32]++):a<=10?i.bl_tree[34]++:i.bl_tree[36]++,a=0,r=s,o===0?(c=138,d=3):s===o?(c=6,d=3):(c=7,d=4))},pC=(i,t,e)=>{let n,s,r=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),n=0;n<=e;n++)if(s=o,o=t[2*(n+1)+1],!(++a<c&&s===o)){if(a<d)do Bn(i,s,i.bl_tree);while(--a!=0);else s!==0?(s!==r&&(Bn(i,s,i.bl_tree),a--),Bn(i,16,i.bl_tree),Gi(i,a-3,2)):a<=10?(Bn(i,17,i.bl_tree),Gi(i,a-3,3)):(Bn(i,18,i.bl_tree),Gi(i,a-11,7));a=0,r=s,o===0?(c=138,d=3):s===o?(c=6,d=3):(c=7,d=4)}};let _C=!1;const EC=(i,t,e,n)=>{Gi(i,0+(n?1:0),3),dC(i),Aa(i,e),Aa(i,~e),e&&i.pending_buf.set(i.window.subarray(t,t+e),i.pending),i.pending+=e};var nM=i=>{_C||((()=>{let t,e,n,s,r;const o=new Array(16);for(n=0,s=0;s<28;s++)for(Ip[s]=n,t=0;t<1<<Cp[s];t++)ya[n++]=s;for(ya[n-1]=s,r=0,s=0;s<16;s++)for(Pd[s]=r,t=0;t<1<<Dd[s];t++)va[r++]=s;for(r>>=7;s<Ra;s++)for(Pd[s]=r<<7,t=0;t<1<<Dd[s]-7;t++)va[256+r++]=s;for(e=0;e<=Ca;e++)o[e]=0;for(t=0;t<=143;)as[2*t+1]=8,t++,o[8]++;for(;t<=255;)as[2*t+1]=9,t++,o[9]++;for(;t<=279;)as[2*t+1]=7,t++,o[7]++;for(;t<=287;)as[2*t+1]=8,t++,o[8]++;for(aC(as,287,o),t=0;t<Ra;t++)Ia[2*t+1]=5,Ia[2*t]=oC(t,5);iC=new vp(as,Cp,257,tC,Ca),nC=new vp(Ia,Dd,0,Ra,Ca),sC=new vp(new Array(0),iM,0,19,7)})(),_C=!0),i.l_desc=new yp(i.dyn_ltree,iC),i.d_desc=new yp(i.dyn_dtree,nC),i.bl_desc=new yp(i.bl_tree,sC),i.bi_buf=0,i.bi_valid=0,cC(i)},sM=(i,t,e,n)=>{let s,r,o=0;i.level>0?(i.strm.data_type===2&&(i.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<Rp;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(i)),bp(i,i.l_desc),bp(i,i.d_desc),o=(a=>{let c;for(hC(a,a.dyn_ltree,a.l_desc.max_code),hC(a,a.dyn_dtree,a.d_desc.max_code),bp(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*eC[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(i),s=i.opt_len+3+7>>>3,r=i.static_len+3+7>>>3,r<=s&&(s=r)):s=r=e+5,e+4<=s&&t!==-1?EC(i,t,e,n):i.strategy===4||r===s?(Gi(i,2+(n?1:0),3),uC(i,as,Ia)):(Gi(i,4+(n?1:0),3),((a,c,d,l)=>{let u;for(Gi(a,c-257,5),Gi(a,d-1,5),Gi(a,l-4,4),u=0;u<l;u++)Gi(a,a.bl_tree[2*eC[u]+1],3);pC(a,a.dyn_ltree,c-1),pC(a,a.dyn_dtree,d-1)})(i,i.l_desc.max_code+1,i.d_desc.max_code+1,o+1),uC(i,i.dyn_ltree,i.dyn_dtree)),cC(i),n&&dC(i)},rM=(i,t,e)=>(i.pending_buf[i.sym_buf+i.sym_next++]=t,i.pending_buf[i.sym_buf+i.sym_next++]=t>>8,i.pending_buf[i.sym_buf+i.sym_next++]=e,t===0?i.dyn_ltree[2*e]++:(i.matches++,t--,i.dyn_ltree[2*(ya[e]+Rp+1)]++,i.dyn_dtree[2*rC(t)]++),i.sym_next===i.sym_end),oM={_tr_init:nM,_tr_stored_block:EC,_tr_flush_block:sM,_tr_tally:rM,_tr_align:i=>{Gi(i,2,3),Bn(i,256,as),(t=>{t.bi_valid===16?(Aa(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(i)}},ba=(i,t,e,n)=>{let s=65535&i|0,r=i>>>16&65535|0,o=0;for(;e!==0;){o=e>2e3?2e3:e,e-=o;do s=s+t[n++]|0,r=r+s|0;while(--o);s%=65521,r%=65521}return s|r<<16|0};const aM=new Uint32Array((()=>{let i,t=[];for(var e=0;e<256;e++){i=e;for(var n=0;n<8;n++)i=1&i?3988292384^i>>>1:i>>>1;t[e]=i}return t})());var ri=(i,t,e,n)=>{const s=aM,r=n+e;i^=-1;for(let o=n;o<r;o++)i=i>>>8^s[255&(i^t[o])];return-1^i},Ar={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Ao={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:cM,_tr_stored_block:wp,_tr_flush_block:dM,_tr_tally:Bs,_tr_align:lM}=oM,{Z_NO_FLUSH:js,Z_PARTIAL_FLUSH:uM,Z_FULL_FLUSH:hM,Z_FINISH:_n,Z_BLOCK:mC,Z_OK:ai,Z_STREAM_END:fC,Z_STREAM_ERROR:jn,Z_DATA_ERROR:pM,Z_BUF_ERROR:Op,Z_DEFAULT_COMPRESSION:_M,Z_FILTERED:EM,Z_HUFFMAN_ONLY:Ld,Z_RLE:mM,Z_FIXED:fM,Z_DEFAULT_STRATEGY:gM,Z_UNKNOWN:TM,Z_DEFLATED:kd}=Ao,Np=286,SM=30,RM=19,CM=2*Np+1,IM=15,br=258,Gn=262,bo=42,wr=113,wa=666,Or=(i,t)=>(i.msg=Ar[t],t),gC=i=>2*i-(i>4?9:0),Gs=i=>{let t=i.length;for(;--t>=0;)i[t]=0},vM=i=>{let t,e,n,s=i.w_size;t=i.hash_size,n=t;do e=i.head[--n],i.head[n]=e>=s?e-s:0;while(--t);t=s,n=t;do e=i.prev[--n],i.prev[n]=e>=s?e-s:0;while(--t)};let Ws=(i,t,e)=>(t<<i.hash_shift^e)&i.hash_mask;const Zi=i=>{const t=i.state;let e=t.pending;e>i.avail_out&&(e=i.avail_out),e!==0&&(i.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+e),i.next_out),i.next_out+=e,t.pending_out+=e,i.total_out+=e,i.avail_out-=e,t.pending-=e,t.pending===0&&(t.pending_out=0))},$i=(i,t)=>{dM(i,i.block_start>=0?i.block_start:-1,i.strstart-i.block_start,t),i.block_start=i.strstart,Zi(i.strm)},Xt=(i,t)=>{i.pending_buf[i.pending++]=t},Oa=(i,t)=>{i.pending_buf[i.pending++]=t>>>8&255,i.pending_buf[i.pending++]=255&t},Dp=(i,t,e,n)=>{let s=i.avail_in;return s>n&&(s=n),s===0?0:(i.avail_in-=s,t.set(i.input.subarray(i.next_in,i.next_in+s),e),i.state.wrap===1?i.adler=ba(i.adler,t,s,e):i.state.wrap===2&&(i.adler=ri(i.adler,t,s,e)),i.next_in+=s,i.total_in+=s,s)},TC=(i,t)=>{let e,n,s=i.max_chain_length,r=i.strstart,o=i.prev_length,a=i.nice_match;const c=i.strstart>i.w_size-Gn?i.strstart-(i.w_size-Gn):0,d=i.window,l=i.w_mask,u=i.prev,p=i.strstart+br;let _=d[r+o-1],S=d[r+o];i.prev_length>=i.good_match&&(s>>=2),a>i.lookahead&&(a=i.lookahead);do if(e=t,d[e+o]===S&&d[e+o-1]===_&&d[e]===d[r]&&d[++e]===d[r+1]){r+=2,e++;do;while(d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&d[++r]===d[++e]&&r<p);if(n=br-(p-r),r=p-br,n>o){if(i.match_start=t,o=n,n>=a)break;_=d[r+o-1],S=d[r+o]}}while((t=u[t&l])>c&&--s!=0);return o<=i.lookahead?o:i.lookahead},wo=i=>{const t=i.w_size;let e,n,s;do{if(n=i.window_size-i.lookahead-i.strstart,i.strstart>=t+(t-Gn)&&(i.window.set(i.window.subarray(t,t+t-n),0),i.match_start-=t,i.strstart-=t,i.block_start-=t,i.insert>i.strstart&&(i.insert=i.strstart),vM(i),n+=t),i.strm.avail_in===0)break;if(e=Dp(i.strm,i.window,i.strstart+i.lookahead,n),i.lookahead+=e,i.lookahead+i.insert>=3)for(s=i.strstart-i.insert,i.ins_h=i.window[s],i.ins_h=Ws(i,i.ins_h,i.window[s+1]);i.insert&&(i.ins_h=Ws(i,i.ins_h,i.window[s+3-1]),i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++,i.insert--,!(i.lookahead+i.insert<3)););}while(i.lookahead<Gn&&i.strm.avail_in!==0)},SC=(i,t)=>{let e,n,s,r=i.pending_buf_size-5>i.w_size?i.w_size:i.pending_buf_size-5,o=0,a=i.strm.avail_in;do{if(e=65535,s=i.bi_valid+42>>3,i.strm.avail_out<s||(s=i.strm.avail_out-s,n=i.strstart-i.block_start,e>n+i.strm.avail_in&&(e=n+i.strm.avail_in),e>s&&(e=s),e<r&&(e===0&&t!==_n||t===js||e!==n+i.strm.avail_in)))break;o=t===_n&&e===n+i.strm.avail_in?1:0,wp(i,0,0,o),i.pending_buf[i.pending-4]=e,i.pending_buf[i.pending-3]=e>>8,i.pending_buf[i.pending-2]=~e,i.pending_buf[i.pending-1]=~e>>8,Zi(i.strm),n&&(n>e&&(n=e),i.strm.output.set(i.window.subarray(i.block_start,i.block_start+n),i.strm.next_out),i.strm.next_out+=n,i.strm.avail_out-=n,i.strm.total_out+=n,i.block_start+=n,e-=n),e&&(Dp(i.strm,i.strm.output,i.strm.next_out,e),i.strm.next_out+=e,i.strm.avail_out-=e,i.strm.total_out+=e)}while(o===0);return a-=i.strm.avail_in,a&&(a>=i.w_size?(i.matches=2,i.window.set(i.strm.input.subarray(i.strm.next_in-i.w_size,i.strm.next_in),0),i.strstart=i.w_size,i.insert=i.strstart):(i.window_size-i.strstart<=a&&(i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,i.insert>i.strstart&&(i.insert=i.strstart)),i.window.set(i.strm.input.subarray(i.strm.next_in-a,i.strm.next_in),i.strstart),i.strstart+=a,i.insert+=a>i.w_size-i.insert?i.w_size-i.insert:a),i.block_start=i.strstart),i.high_water<i.strstart&&(i.high_water=i.strstart),o?4:t!==js&&t!==_n&&i.strm.avail_in===0&&i.strstart===i.block_start?2:(s=i.window_size-i.strstart,i.strm.avail_in>s&&i.block_start>=i.w_size&&(i.block_start-=i.w_size,i.strstart-=i.w_size,i.window.set(i.window.subarray(i.w_size,i.w_size+i.strstart),0),i.matches<2&&i.matches++,s+=i.w_size,i.insert>i.strstart&&(i.insert=i.strstart)),s>i.strm.avail_in&&(s=i.strm.avail_in),s&&(Dp(i.strm,i.window,i.strstart,s),i.strstart+=s,i.insert+=s>i.w_size-i.insert?i.w_size-i.insert:s),i.high_water<i.strstart&&(i.high_water=i.strstart),s=i.bi_valid+42>>3,s=i.pending_buf_size-s>65535?65535:i.pending_buf_size-s,r=s>i.w_size?i.w_size:s,n=i.strstart-i.block_start,(n>=r||(n||t===_n)&&t!==js&&i.strm.avail_in===0&&n<=s)&&(e=n>s?s:n,o=t===_n&&i.strm.avail_in===0&&e===n?1:0,wp(i,i.block_start,e,o),i.block_start+=e,Zi(i.strm)),o?3:1)},Pp=(i,t)=>{let e,n;for(;;){if(i.lookahead<Gn){if(wo(i),i.lookahead<Gn&&t===js)return 1;if(i.lookahead===0)break}if(e=0,i.lookahead>=3&&(i.ins_h=Ws(i,i.ins_h,i.window[i.strstart+3-1]),e=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),e!==0&&i.strstart-e<=i.w_size-Gn&&(i.match_length=TC(i,e)),i.match_length>=3)if(n=Bs(i,i.strstart-i.match_start,i.match_length-3),i.lookahead-=i.match_length,i.match_length<=i.max_lazy_match&&i.lookahead>=3){i.match_length--;do i.strstart++,i.ins_h=Ws(i,i.ins_h,i.window[i.strstart+3-1]),e=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart;while(--i.match_length!=0);i.strstart++}else i.strstart+=i.match_length,i.match_length=0,i.ins_h=i.window[i.strstart],i.ins_h=Ws(i,i.ins_h,i.window[i.strstart+1]);else n=Bs(i,0,i.window[i.strstart]),i.lookahead--,i.strstart++;if(n&&($i(i,!1),i.strm.avail_out===0))return 1}return i.insert=i.strstart<2?i.strstart:2,t===_n?($i(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&($i(i,!1),i.strm.avail_out===0)?1:2},Oo=(i,t)=>{let e,n,s;for(;;){if(i.lookahead<Gn){if(wo(i),i.lookahead<Gn&&t===js)return 1;if(i.lookahead===0)break}if(e=0,i.lookahead>=3&&(i.ins_h=Ws(i,i.ins_h,i.window[i.strstart+3-1]),e=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart),i.prev_length=i.match_length,i.prev_match=i.match_start,i.match_length=2,e!==0&&i.prev_length<i.max_lazy_match&&i.strstart-e<=i.w_size-Gn&&(i.match_length=TC(i,e),i.match_length<=5&&(i.strategy===EM||i.match_length===3&&i.strstart-i.match_start>4096)&&(i.match_length=2)),i.prev_length>=3&&i.match_length<=i.prev_length){s=i.strstart+i.lookahead-3,n=Bs(i,i.strstart-1-i.prev_match,i.prev_length-3),i.lookahead-=i.prev_length-1,i.prev_length-=2;do++i.strstart<=s&&(i.ins_h=Ws(i,i.ins_h,i.window[i.strstart+3-1]),e=i.prev[i.strstart&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=i.strstart);while(--i.prev_length!=0);if(i.match_available=0,i.match_length=2,i.strstart++,n&&($i(i,!1),i.strm.avail_out===0))return 1}else if(i.match_available){if(n=Bs(i,0,i.window[i.strstart-1]),n&&$i(i,!1),i.strstart++,i.lookahead--,i.strm.avail_out===0)return 1}else i.match_available=1,i.strstart++,i.lookahead--}return i.match_available&&(n=Bs(i,0,i.window[i.strstart-1]),i.match_available=0),i.insert=i.strstart<2?i.strstart:2,t===_n?($i(i,!0),i.strm.avail_out===0?3:4):i.sym_next&&($i(i,!1),i.strm.avail_out===0)?1:2};function Wn(i,t,e,n,s){this.good_length=i,this.max_lazy=t,this.nice_length=e,this.max_chain=n,this.func=s}const Na=[new Wn(0,0,0,0,SC),new Wn(4,4,8,4,Pp),new Wn(4,5,16,8,Pp),new Wn(4,6,32,32,Pp),new Wn(4,4,16,16,Oo),new Wn(8,16,32,32,Oo),new Wn(8,16,128,128,Oo),new Wn(8,32,128,256,Oo),new Wn(32,128,258,1024,Oo),new Wn(32,258,258,4096,Oo)];function yM(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=kd,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*CM),this.dyn_dtree=new Uint16Array(2*(2*SM+1)),this.bl_tree=new Uint16Array(2*(2*RM+1)),Gs(this.dyn_ltree),Gs(this.dyn_dtree),Gs(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(IM+1),this.heap=new Uint16Array(2*Np+1),Gs(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Np+1),Gs(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Da=i=>{if(!i)return 1;const t=i.state;return!t||t.strm!==i||t.status!==bo&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==wr&&t.status!==wa?1:0},RC=i=>{if(Da(i))return Or(i,jn);i.total_in=i.total_out=0,i.data_type=TM;const t=i.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?bo:wr,i.adler=t.wrap===2?0:1,t.last_flush=-2,cM(t),ai},CC=i=>{const t=RC(i);var e;return t===ai&&((e=i.state).window_size=2*e.w_size,Gs(e.head),e.max_lazy_match=Na[e.level].max_lazy,e.good_match=Na[e.level].good_length,e.nice_match=Na[e.level].nice_length,e.max_chain_length=Na[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),t},IC=(i,t,e,n,s,r)=>{if(!i)return jn;let o=1;if(t===_M&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>9||e!==kd||n<8||n>15||t<0||t>9||r<0||r>fM||n===8&&o!==1)return Or(i,jn);n===8&&(n=9);const a=new yM;return i.state=a,a.strm=i,a.status=bo,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=r,a.method=e,CC(i)};var AM=(i,t)=>{if(Da(i)||t>mC||t<0)return i?Or(i,jn):jn;const e=i.state;if(!i.output||i.avail_in!==0&&!i.input||e.status===wa&&t!==_n)return Or(i,i.avail_out===0?Op:jn);const n=e.last_flush;if(e.last_flush=t,e.pending!==0){if(Zi(i),i.avail_out===0)return e.last_flush=-1,ai}else if(i.avail_in===0&&gC(t)<=gC(n)&&t!==_n)return Or(i,Op);if(e.status===wa&&i.avail_in!==0)return Or(i,Op);if(e.status===bo&&e.wrap===0&&(e.status=wr),e.status===bo){let s=kd+(e.w_bits-8<<4)<<8,r=-1;if(r=e.strategy>=Ld||e.level<2?0:e.level<6?1:e.level===6?2:3,s|=r<<6,e.strstart!==0&&(s|=32),s+=31-s%31,Oa(e,s),e.strstart!==0&&(Oa(e,i.adler>>>16),Oa(e,65535&i.adler)),i.adler=1,e.status=wr,Zi(i),e.pending!==0)return e.last_flush=-1,ai}if(e.status===57){if(i.adler=0,Xt(e,31),Xt(e,139),Xt(e,8),e.gzhead)Xt(e,(e.gzhead.text?1:0)+(e.gzhead.hcrc?2:0)+(e.gzhead.extra?4:0)+(e.gzhead.name?8:0)+(e.gzhead.comment?16:0)),Xt(e,255&e.gzhead.time),Xt(e,e.gzhead.time>>8&255),Xt(e,e.gzhead.time>>16&255),Xt(e,e.gzhead.time>>24&255),Xt(e,e.level===9?2:e.strategy>=Ld||e.level<2?4:0),Xt(e,255&e.gzhead.os),e.gzhead.extra&&e.gzhead.extra.length&&(Xt(e,255&e.gzhead.extra.length),Xt(e,e.gzhead.extra.length>>8&255)),e.gzhead.hcrc&&(i.adler=ri(i.adler,e.pending_buf,e.pending,0)),e.gzindex=0,e.status=69;else if(Xt(e,0),Xt(e,0),Xt(e,0),Xt(e,0),Xt(e,0),Xt(e,e.level===9?2:e.strategy>=Ld||e.level<2?4:0),Xt(e,3),e.status=wr,Zi(i),e.pending!==0)return e.last_flush=-1,ai}if(e.status===69){if(e.gzhead.extra){let s=e.pending,r=(65535&e.gzhead.extra.length)-e.gzindex;for(;e.pending+r>e.pending_buf_size;){let a=e.pending_buf_size-e.pending;if(e.pending_buf.set(e.gzhead.extra.subarray(e.gzindex,e.gzindex+a),e.pending),e.pending=e.pending_buf_size,e.gzhead.hcrc&&e.pending>s&&(i.adler=ri(i.adler,e.pending_buf,e.pending-s,s)),e.gzindex+=a,Zi(i),e.pending!==0)return e.last_flush=-1,ai;s=0,r-=a}let o=new Uint8Array(e.gzhead.extra);e.pending_buf.set(o.subarray(e.gzindex,e.gzindex+r),e.pending),e.pending+=r,e.gzhead.hcrc&&e.pending>s&&(i.adler=ri(i.adler,e.pending_buf,e.pending-s,s)),e.gzindex=0}e.status=73}if(e.status===73){if(e.gzhead.name){let s,r=e.pending;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>r&&(i.adler=ri(i.adler,e.pending_buf,e.pending-r,r)),Zi(i),e.pending!==0)return e.last_flush=-1,ai;r=0}s=e.gzindex<e.gzhead.name.length?255&e.gzhead.name.charCodeAt(e.gzindex++):0,Xt(e,s)}while(s!==0);e.gzhead.hcrc&&e.pending>r&&(i.adler=ri(i.adler,e.pending_buf,e.pending-r,r)),e.gzindex=0}e.status=91}if(e.status===91){if(e.gzhead.comment){let s,r=e.pending;do{if(e.pending===e.pending_buf_size){if(e.gzhead.hcrc&&e.pending>r&&(i.adler=ri(i.adler,e.pending_buf,e.pending-r,r)),Zi(i),e.pending!==0)return e.last_flush=-1,ai;r=0}s=e.gzindex<e.gzhead.comment.length?255&e.gzhead.comment.charCodeAt(e.gzindex++):0,Xt(e,s)}while(s!==0);e.gzhead.hcrc&&e.pending>r&&(i.adler=ri(i.adler,e.pending_buf,e.pending-r,r))}e.status=103}if(e.status===103){if(e.gzhead.hcrc){if(e.pending+2>e.pending_buf_size&&(Zi(i),e.pending!==0))return e.last_flush=-1,ai;Xt(e,255&i.adler),Xt(e,i.adler>>8&255),i.adler=0}if(e.status=wr,Zi(i),e.pending!==0)return e.last_flush=-1,ai}if(i.avail_in!==0||e.lookahead!==0||t!==js&&e.status!==wa){let s=e.level===0?SC(e,t):e.strategy===Ld?((r,o)=>{let a;for(;;){if(r.lookahead===0&&(wo(r),r.lookahead===0)){if(o===js)return 1;break}if(r.match_length=0,a=Bs(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++,a&&($i(r,!1),r.strm.avail_out===0))return 1}return r.insert=0,o===_n?($i(r,!0),r.strm.avail_out===0?3:4):r.sym_next&&($i(r,!1),r.strm.avail_out===0)?1:2})(e,t):e.strategy===mM?((r,o)=>{let a,c,d,l;const u=r.window;for(;;){if(r.lookahead<=br){if(wo(r),r.lookahead<=br&&o===js)return 1;if(r.lookahead===0)break}if(r.match_length=0,r.lookahead>=3&&r.strstart>0&&(d=r.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=r.strstart+br;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);r.match_length=br-(l-d),r.match_length>r.lookahead&&(r.match_length=r.lookahead)}if(r.match_length>=3?(a=Bs(r,1,r.match_length-3),r.lookahead-=r.match_length,r.strstart+=r.match_length,r.match_length=0):(a=Bs(r,0,r.window[r.strstart]),r.lookahead--,r.strstart++),a&&($i(r,!1),r.strm.avail_out===0))return 1}return r.insert=0,o===_n?($i(r,!0),r.strm.avail_out===0?3:4):r.sym_next&&($i(r,!1),r.strm.avail_out===0)?1:2})(e,t):Na[e.level].func(e,t);if(s!==3&&s!==4||(e.status=wa),s===1||s===3)return i.avail_out===0&&(e.last_flush=-1),ai;if(s===2&&(t===uM?lM(e):t!==mC&&(wp(e,0,0,!1),t===hM&&(Gs(e.head),e.lookahead===0&&(e.strstart=0,e.block_start=0,e.insert=0))),Zi(i),i.avail_out===0))return e.last_flush=-1,ai}return t!==_n?ai:e.wrap<=0?fC:(e.wrap===2?(Xt(e,255&i.adler),Xt(e,i.adler>>8&255),Xt(e,i.adler>>16&255),Xt(e,i.adler>>24&255),Xt(e,255&i.total_in),Xt(e,i.total_in>>8&255),Xt(e,i.total_in>>16&255),Xt(e,i.total_in>>24&255)):(Oa(e,i.adler>>>16),Oa(e,65535&i.adler)),Zi(i),e.wrap>0&&(e.wrap=-e.wrap),e.pending!==0?ai:fC)},bM=(i,t)=>{let e=t.length;if(Da(i))return jn;const n=i.state,s=n.wrap;if(s===2||s===1&&n.status!==bo||n.lookahead)return jn;if(s===1&&(i.adler=ba(i.adler,t,e,0)),n.wrap=0,e>=n.w_size){s===0&&(Gs(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(t.subarray(e-n.w_size,e),0),t=c,e=n.w_size}const r=i.avail_in,o=i.next_in,a=i.input;for(i.avail_in=e,i.next_in=0,i.input=t,wo(n);n.lookahead>=3;){let c=n.strstart,d=n.lookahead-2;do n.ins_h=Ws(n,n.ins_h,n.window[c+3-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--d);n.strstart=c,n.lookahead=2,wo(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,i.next_in=o,i.input=a,i.avail_in=r,n.wrap=s,ai},Pa={deflateInit:(i,t)=>IC(i,t,kd,15,8,gM),deflateInit2:IC,deflateReset:CC,deflateResetKeep:RC,deflateSetHeader:(i,t)=>Da(i)||i.state.wrap!==2?jn:(i.state.gzhead=t,ai),deflate:AM,deflateEnd:i=>{if(Da(i))return jn;const t=i.state.status;return i.state=null,t===wr?Or(i,pM):ai},deflateSetDictionary:bM,deflateInfo:"pako deflate (from Nodeca project)"};const wM=(i,t)=>Object.prototype.hasOwnProperty.call(i,t);var Md={assign:function(i){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const e=t.shift();if(e){if(typeof e!="object")throw new TypeError(e+"must be non-object");for(const n in e)wM(e,n)&&(i[n]=e[n])}}return i},flattenChunks:i=>{let t=0;for(let n=0,s=i.length;n<s;n++)t+=i[n].length;const e=new Uint8Array(t);for(let n=0,s=0,r=i.length;n<r;n++){let o=i[n];e.set(o,s),s+=o.length}return e}};let vC=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{vC=!1}const La=new Uint8Array(256);for(let i=0;i<256;i++)La[i]=i>=252?6:i>=248?5:i>=240?4:i>=224?3:i>=192?2:1;La[254]=La[254]=1;var ka={string2buf:i=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(i);let t,e,n,s,r,o=i.length,a=0;for(s=0;s<o;s++)e=i.charCodeAt(s),(64512&e)==55296&&s+1<o&&(n=i.charCodeAt(s+1),(64512&n)==56320&&(e=65536+(e-55296<<10)+(n-56320),s++)),a+=e<128?1:e<2048?2:e<65536?3:4;for(t=new Uint8Array(a),r=0,s=0;r<a;s++)e=i.charCodeAt(s),(64512&e)==55296&&s+1<o&&(n=i.charCodeAt(s+1),(64512&n)==56320&&(e=65536+(e-55296<<10)+(n-56320),s++)),e<128?t[r++]=e:e<2048?(t[r++]=192|e>>>6,t[r++]=128|63&e):e<65536?(t[r++]=224|e>>>12,t[r++]=128|e>>>6&63,t[r++]=128|63&e):(t[r++]=240|e>>>18,t[r++]=128|e>>>12&63,t[r++]=128|e>>>6&63,t[r++]=128|63&e);return t},buf2string:(i,t)=>{const e=t||i.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(i.subarray(0,t));let n,s;const r=new Array(2*e);for(s=0,n=0;n<e;){let o=i[n++];if(o<128){r[s++]=o;continue}let a=La[o];if(a>4)r[s++]=65533,n+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&n<e;)o=o<<6|63&i[n++],a--;a>1?r[s++]=65533:o<65536?r[s++]=o:(o-=65536,r[s++]=55296|o>>10&1023,r[s++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&vC)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(o[d]);return c})(r,s)},utf8border:(i,t)=>{(t=t||i.length)>i.length&&(t=i.length);let e=t-1;for(;e>=0&&(192&i[e])==128;)e--;return e<0||e===0?t:e+La[i[e]]>t?e:t}},yC=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const AC=Object.prototype.toString,{Z_NO_FLUSH:OM,Z_SYNC_FLUSH:NM,Z_FULL_FLUSH:DM,Z_FINISH:PM,Z_OK:Ud,Z_STREAM_END:LM,Z_DEFAULT_COMPRESSION:kM,Z_DEFAULT_STRATEGY:MM,Z_DEFLATED:UM}=Ao;function Ma(i){this.options=Md.assign({level:kM,method:UM,chunkSize:16384,windowBits:15,memLevel:8,strategy:MM},i||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yC,this.strm.avail_out=0;let e=Pa.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(e!==Ud)throw new Error(Ar[e]);if(t.header&&Pa.deflateSetHeader(this.strm,t.header),t.dictionary){let n;if(n=typeof t.dictionary=="string"?ka.string2buf(t.dictionary):AC.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,e=Pa.deflateSetDictionary(this.strm,n),e!==Ud)throw new Error(Ar[e]);this._dict_set=!0}}function Lp(i,t){const e=new Ma(t);if(e.push(i,!0),e.err)throw e.msg||Ar[e.err];return e.result}Ma.prototype.push=function(i,t){const e=this.strm,n=this.options.chunkSize;let s,r;if(this.ended)return!1;for(r=t===~~t?t:t===!0?PM:OM,typeof i=="string"?e.input=ka.string2buf(i):AC.call(i)==="[object ArrayBuffer]"?e.input=new Uint8Array(i):e.input=i,e.next_in=0,e.avail_in=e.input.length;;)if(e.avail_out===0&&(e.output=new Uint8Array(n),e.next_out=0,e.avail_out=n),(r===NM||r===DM)&&e.avail_out<=6)this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;else{if(s=Pa.deflate(e,r),s===LM)return e.next_out>0&&this.onData(e.output.subarray(0,e.next_out)),s=Pa.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===Ud;if(e.avail_out!==0){if(r>0&&e.next_out>0)this.onData(e.output.subarray(0,e.next_out)),e.avail_out=0;else if(e.avail_in===0)break}else this.onData(e.output)}return!0},Ma.prototype.onData=function(i){this.chunks.push(i)},Ma.prototype.onEnd=function(i){i===Ud&&(this.result=Md.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};var xM={Deflate:Ma,deflate:Lp,deflateRaw:function(i,t){return(t=t||{}).raw=!0,Lp(i,t)},gzip:function(i,t){return(t=t||{}).gzip=!0,Lp(i,t)},constants:Ao};const xd=16209;var VM=function(i,t){let e,n,s,r,o,a,c,d,l,u,p,_,S,f,g,C,y,A,k,O,N,L,D,F;const j=i.state;e=i.next_in,D=i.input,n=e+(i.avail_in-5),s=i.next_out,F=i.output,r=s-(t-i.avail_out),o=s+(i.avail_out-257),a=j.dmax,c=j.wsize,d=j.whave,l=j.wnext,u=j.window,p=j.hold,_=j.bits,S=j.lencode,f=j.distcode,g=(1<<j.lenbits)-1,C=(1<<j.distbits)-1;t:do{_<15&&(p+=D[e++]<<_,_+=8,p+=D[e++]<<_,_+=8),y=S[p&g];e:for(;;){if(A=y>>>24,p>>>=A,_-=A,A=y>>>16&255,A===0)F[s++]=65535&y;else{if(!(16&A)){if(!(64&A)){y=S[(65535&y)+(p&(1<<A)-1)];continue e}if(32&A){j.mode=16191;break t}i.msg="invalid literal/length code",j.mode=xd;break t}k=65535&y,A&=15,A&&(_<A&&(p+=D[e++]<<_,_+=8),k+=p&(1<<A)-1,p>>>=A,_-=A),_<15&&(p+=D[e++]<<_,_+=8,p+=D[e++]<<_,_+=8),y=f[p&C];i:for(;;){if(A=y>>>24,p>>>=A,_-=A,A=y>>>16&255,!(16&A)){if(!(64&A)){y=f[(65535&y)+(p&(1<<A)-1)];continue i}i.msg="invalid distance code",j.mode=xd;break t}if(O=65535&y,A&=15,_<A&&(p+=D[e++]<<_,_+=8,_<A&&(p+=D[e++]<<_,_+=8)),O+=p&(1<<A)-1,O>a){i.msg="invalid distance too far back",j.mode=xd;break t}if(p>>>=A,_-=A,A=s-r,O>A){if(A=O-A,A>d&&j.sane){i.msg="invalid distance too far back",j.mode=xd;break t}if(N=0,L=u,l===0){if(N+=c-A,A<k){k-=A;do F[s++]=u[N++];while(--A);N=s-O,L=F}}else if(l<A){if(N+=c+l-A,A-=l,A<k){k-=A;do F[s++]=u[N++];while(--A);if(N=0,l<k){A=l,k-=A;do F[s++]=u[N++];while(--A);N=s-O,L=F}}}else if(N+=l-A,A<k){k-=A;do F[s++]=u[N++];while(--A);N=s-O,L=F}for(;k>2;)F[s++]=L[N++],F[s++]=L[N++],F[s++]=L[N++],k-=3;k&&(F[s++]=L[N++],k>1&&(F[s++]=L[N++]))}else{N=s-O;do F[s++]=F[N++],F[s++]=F[N++],F[s++]=F[N++],k-=3;while(k>2);k&&(F[s++]=F[N++],k>1&&(F[s++]=F[N++]))}break}}break}}while(e<n&&s<o);k=_>>3,e-=k,_-=k<<3,p&=(1<<_)-1,i.next_in=e,i.next_out=s,i.avail_in=e<n?n-e+5:5-(e-n),i.avail_out=s<o?o-s+257:257-(s-o),j.hold=p,j.bits=_};const Vd=15,FM=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),BM=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),jM=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),GM=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Ua=(i,t,e,n,s,r,o,a)=>{const c=a.bits;let d,l,u,p,_,S,f=0,g=0,C=0,y=0,A=0,k=0,O=0,N=0,L=0,D=0,F=null;const j=new Uint16Array(16),it=new Uint16Array(16);let ct,Ut,he,Bt=null;for(f=0;f<=Vd;f++)j[f]=0;for(g=0;g<n;g++)j[t[e+g]]++;for(A=c,y=Vd;y>=1&&j[y]===0;y--);if(A>y&&(A=y),y===0)return s[r++]=20971520,s[r++]=20971520,a.bits=1,0;for(C=1;C<y&&j[C]===0;C++);for(A<C&&(A=C),N=1,f=1;f<=Vd;f++)if(N<<=1,N-=j[f],N<0)return-1;if(N>0&&(i===0||y!==1))return-1;for(it[1]=0,f=1;f<Vd;f++)it[f+1]=it[f]+j[f];for(g=0;g<n;g++)t[e+g]!==0&&(o[it[t[e+g]]++]=g);if(i===0?(F=Bt=o,S=20):i===1?(F=FM,Bt=BM,S=257):(F=jM,Bt=GM,S=0),D=0,g=0,f=C,_=r,k=A,O=0,u=-1,L=1<<A,p=L-1,i===1&&L>852||i===2&&L>592)return 1;for(;;){ct=f-O,o[g]+1<S?(Ut=0,he=o[g]):o[g]>=S?(Ut=Bt[o[g]-S],he=F[o[g]-S]):(Ut=96,he=0),d=1<<f-O,l=1<<k,C=l;do l-=d,s[_+(D>>O)+l]=ct<<24|Ut<<16|he|0;while(l!==0);for(d=1<<f-1;D&d;)d>>=1;if(d!==0?(D&=d-1,D+=d):D=0,g++,--j[f]==0){if(f===y)break;f=t[e+o[g]]}if(f>A&&(D&p)!==u){for(O===0&&(O=A),_+=C,k=f-O,N=1<<k;k+O<y&&(N-=j[k+O],!(N<=0));)k++,N<<=1;if(L+=1<<k,i===1&&L>852||i===2&&L>592)return 1;u=D&p,s[u]=A<<24|k<<16|_-r|0}}return D!==0&&(s[_+D]=f-O<<24|64<<16|0),a.bits=A,0};const{Z_FINISH:bC,Z_BLOCK:WM,Z_TREES:Fd,Z_OK:Nr,Z_STREAM_END:HM,Z_NEED_DICT:KM,Z_STREAM_ERROR:En,Z_DATA_ERROR:wC,Z_MEM_ERROR:OC,Z_BUF_ERROR:YM,Z_DEFLATED:NC}=Ao,Bd=16180,jd=16190,cs=16191,kp=16192,Mp=16194,Gd=16199,Wd=16200,Up=16206,we=16209,DC=i=>(i>>>24&255)+(i>>>8&65280)+((65280&i)<<8)+((255&i)<<24);function qM(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Dr=i=>{if(!i)return 1;const t=i.state;return!t||t.strm!==i||t.mode<Bd||t.mode>16211?1:0},PC=i=>{if(Dr(i))return En;const t=i.state;return i.total_in=i.total_out=t.total=0,i.msg="",t.wrap&&(i.adler=1&t.wrap),t.mode=Bd,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,Nr},LC=i=>{if(Dr(i))return En;const t=i.state;return t.wsize=0,t.whave=0,t.wnext=0,PC(i)},kC=(i,t)=>{let e;if(Dr(i))return En;const n=i.state;return t<0?(e=0,t=-t):(e=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?En:(n.window!==null&&n.wbits!==t&&(n.window=null),n.wrap=e,n.wbits=t,LC(i))},MC=(i,t)=>{if(!i)return En;const e=new qM;i.state=e,e.strm=i,e.window=null,e.mode=Bd;const n=kC(i,t);return n!==Nr&&(i.state=null),n};let xp,Vp,UC=!0;const JM=i=>{if(UC){xp=new Int32Array(512),Vp=new Int32Array(32);let t=0;for(;t<144;)i.lens[t++]=8;for(;t<256;)i.lens[t++]=9;for(;t<280;)i.lens[t++]=7;for(;t<288;)i.lens[t++]=8;for(Ua(1,i.lens,0,288,xp,0,i.work,{bits:9}),t=0;t<32;)i.lens[t++]=5;Ua(2,i.lens,0,32,Vp,0,i.work,{bits:5}),UC=!1}i.lencode=xp,i.lenbits=9,i.distcode=Vp,i.distbits=5},xC=(i,t,e,n)=>{let s;const r=i.state;return r.window===null&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new Uint8Array(r.wsize)),n>=r.wsize?(r.window.set(t.subarray(e-r.wsize,e),0),r.wnext=0,r.whave=r.wsize):(s=r.wsize-r.wnext,s>n&&(s=n),r.window.set(t.subarray(e-n,e-n+s),r.wnext),(n-=s)?(r.window.set(t.subarray(e-n,e),0),r.wnext=n,r.whave=r.wsize):(r.wnext+=s,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=s))),0};var zM=(i,t)=>{let e,n,s,r,o,a,c,d,l,u,p,_,S,f,g,C,y,A,k,O,N,L,D=0;const F=new Uint8Array(4);let j,it;const ct=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Dr(i)||!i.output||!i.input&&i.avail_in!==0)return En;e=i.state,e.mode===cs&&(e.mode=kp),o=i.next_out,s=i.output,c=i.avail_out,r=i.next_in,n=i.input,a=i.avail_in,d=e.hold,l=e.bits,u=a,p=c,L=Nr;t:for(;;)switch(e.mode){case Bd:if(e.wrap===0){e.mode=kp;break}for(;l<16;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(2&e.wrap&&d===35615){e.wbits===0&&(e.wbits=15),e.check=0,F[0]=255&d,F[1]=d>>>8&255,e.check=ri(e.check,F,2,0),d=0,l=0,e.mode=16181;break}if(e.head&&(e.head.done=!1),!(1&e.wrap)||(((255&d)<<8)+(d>>8))%31){i.msg="incorrect header check",e.mode=we;break}if((15&d)!==NC){i.msg="unknown compression method",e.mode=we;break}if(d>>>=4,l-=4,N=8+(15&d),e.wbits===0&&(e.wbits=N),N>15||N>e.wbits){i.msg="invalid window size",e.mode=we;break}e.dmax=1<<e.wbits,e.flags=0,i.adler=e.check=1,e.mode=512&d?16189:cs,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(e.flags=d,(255&e.flags)!==NC){i.msg="unknown compression method",e.mode=we;break}if(57344&e.flags){i.msg="unknown header flags set",e.mode=we;break}e.head&&(e.head.text=d>>8&1),512&e.flags&&4&e.wrap&&(F[0]=255&d,F[1]=d>>>8&255,e.check=ri(e.check,F,2,0)),d=0,l=0,e.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.head&&(e.head.time=d),512&e.flags&&4&e.wrap&&(F[0]=255&d,F[1]=d>>>8&255,F[2]=d>>>16&255,F[3]=d>>>24&255,e.check=ri(e.check,F,4,0)),d=0,l=0,e.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.head&&(e.head.xflags=255&d,e.head.os=d>>8),512&e.flags&&4&e.wrap&&(F[0]=255&d,F[1]=d>>>8&255,e.check=ri(e.check,F,2,0)),d=0,l=0,e.mode=16184;case 16184:if(1024&e.flags){for(;l<16;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.length=d,e.head&&(e.head.extra_len=d),512&e.flags&&4&e.wrap&&(F[0]=255&d,F[1]=d>>>8&255,e.check=ri(e.check,F,2,0)),d=0,l=0}else e.head&&(e.head.extra=null);e.mode=16185;case 16185:if(1024&e.flags&&(_=e.length,_>a&&(_=a),_&&(e.head&&(N=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Uint8Array(e.head.extra_len)),e.head.extra.set(n.subarray(r,r+_),N)),512&e.flags&&4&e.wrap&&(e.check=ri(e.check,n,_,r)),a-=_,r+=_,e.length-=_),e.length))break t;e.length=0,e.mode=16186;case 16186:if(2048&e.flags){if(a===0)break t;_=0;do N=n[r+_++],e.head&&N&&e.length<65536&&(e.head.name+=String.fromCharCode(N));while(N&&_<a);if(512&e.flags&&4&e.wrap&&(e.check=ri(e.check,n,_,r)),a-=_,r+=_,N)break t}else e.head&&(e.head.name=null);e.length=0,e.mode=16187;case 16187:if(4096&e.flags){if(a===0)break t;_=0;do N=n[r+_++],e.head&&N&&e.length<65536&&(e.head.comment+=String.fromCharCode(N));while(N&&_<a);if(512&e.flags&&4&e.wrap&&(e.check=ri(e.check,n,_,r)),a-=_,r+=_,N)break t}else e.head&&(e.head.comment=null);e.mode=16188;case 16188:if(512&e.flags){for(;l<16;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(4&e.wrap&&d!==(65535&e.check)){i.msg="header crc mismatch",e.mode=we;break}d=0,l=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),i.adler=e.check=0,e.mode=cs;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}i.adler=e.check=DC(d),d=0,l=0,e.mode=jd;case jd:if(e.havedict===0)return i.next_out=o,i.avail_out=c,i.next_in=r,i.avail_in=a,e.hold=d,e.bits=l,KM;i.adler=e.check=1,e.mode=cs;case cs:if(t===WM||t===Fd)break t;case kp:if(e.last){d>>>=7&l,l-=7&l,e.mode=Up;break}for(;l<3;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}switch(e.last=1&d,d>>>=1,l-=1,3&d){case 0:e.mode=16193;break;case 1:if(JM(e),e.mode=Gd,t===Fd){d>>>=2,l-=2;break t}break;case 2:e.mode=16196;break;case 3:i.msg="invalid block type",e.mode=we}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){i.msg="invalid stored block lengths",e.mode=we;break}if(e.length=65535&d,d=0,l=0,e.mode=Mp,t===Fd)break t;case Mp:e.mode=16195;case 16195:if(_=e.length,_){if(_>a&&(_=a),_>c&&(_=c),_===0)break t;s.set(n.subarray(r,r+_),o),a-=_,r+=_,c-=_,o+=_,e.length-=_;break}e.mode=cs;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(e.nlen=257+(31&d),d>>>=5,l-=5,e.ndist=1+(31&d),d>>>=5,l-=5,e.ncode=4+(15&d),d>>>=4,l-=4,e.nlen>286||e.ndist>30){i.msg="too many length or distance symbols",e.mode=we;break}e.have=0,e.mode=16197;case 16197:for(;e.have<e.ncode;){for(;l<3;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.lens[ct[e.have++]]=7&d,d>>>=3,l-=3}for(;e.have<19;)e.lens[ct[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,j={bits:e.lenbits},L=Ua(0,e.lens,0,19,e.lencode,0,e.work,j),e.lenbits=j.bits,L){i.msg="invalid code lengths set",e.mode=we;break}e.have=0,e.mode=16198;case 16198:for(;e.have<e.nlen+e.ndist;){for(;D=e.lencode[d&(1<<e.lenbits)-1],g=D>>>24,C=D>>>16&255,y=65535&D,!(g<=l);){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(y<16)d>>>=g,l-=g,e.lens[e.have++]=y;else{if(y===16){for(it=g+2;l<it;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(d>>>=g,l-=g,e.have===0){i.msg="invalid bit length repeat",e.mode=we;break}N=e.lens[e.have-1],_=3+(3&d),d>>>=2,l-=2}else if(y===17){for(it=g+3;l<it;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}d>>>=g,l-=g,N=0,_=3+(7&d),d>>>=3,l-=3}else{for(it=g+7;l<it;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}d>>>=g,l-=g,N=0,_=11+(127&d),d>>>=7,l-=7}if(e.have+_>e.nlen+e.ndist){i.msg="invalid bit length repeat",e.mode=we;break}for(;_--;)e.lens[e.have++]=N}}if(e.mode===we)break;if(e.lens[256]===0){i.msg="invalid code -- missing end-of-block",e.mode=we;break}if(e.lenbits=9,j={bits:e.lenbits},L=Ua(1,e.lens,0,e.nlen,e.lencode,0,e.work,j),e.lenbits=j.bits,L){i.msg="invalid literal/lengths set",e.mode=we;break}if(e.distbits=6,e.distcode=e.distdyn,j={bits:e.distbits},L=Ua(2,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,j),e.distbits=j.bits,L){i.msg="invalid distances set",e.mode=we;break}if(e.mode=Gd,t===Fd)break t;case Gd:e.mode=Wd;case Wd:if(a>=6&&c>=258){i.next_out=o,i.avail_out=c,i.next_in=r,i.avail_in=a,e.hold=d,e.bits=l,VM(i,p),o=i.next_out,s=i.output,c=i.avail_out,r=i.next_in,n=i.input,a=i.avail_in,d=e.hold,l=e.bits,e.mode===cs&&(e.back=-1);break}for(e.back=0;D=e.lencode[d&(1<<e.lenbits)-1],g=D>>>24,C=D>>>16&255,y=65535&D,!(g<=l);){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(C&&!(240&C)){for(A=g,k=C,O=y;D=e.lencode[O+((d&(1<<A+k)-1)>>A)],g=D>>>24,C=D>>>16&255,y=65535&D,!(A+g<=l);){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}d>>>=A,l-=A,e.back+=A}if(d>>>=g,l-=g,e.back+=g,e.length=y,C===0){e.mode=16205;break}if(32&C){e.back=-1,e.mode=cs;break}if(64&C){i.msg="invalid literal/length code",e.mode=we;break}e.extra=15&C,e.mode=16201;case 16201:if(e.extra){for(it=e.extra;l<it;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.length+=d&(1<<e.extra)-1,d>>>=e.extra,l-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=16202;case 16202:for(;D=e.distcode[d&(1<<e.distbits)-1],g=D>>>24,C=D>>>16&255,y=65535&D,!(g<=l);){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(!(240&C)){for(A=g,k=C,O=y;D=e.distcode[O+((d&(1<<A+k)-1)>>A)],g=D>>>24,C=D>>>16&255,y=65535&D,!(A+g<=l);){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}d>>>=A,l-=A,e.back+=A}if(d>>>=g,l-=g,e.back+=g,64&C){i.msg="invalid distance code",e.mode=we;break}e.offset=y,e.extra=15&C,e.mode=16203;case 16203:if(e.extra){for(it=e.extra;l<it;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}e.offset+=d&(1<<e.extra)-1,d>>>=e.extra,l-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){i.msg="invalid distance too far back",e.mode=we;break}e.mode=16204;case 16204:if(c===0)break t;if(_=p-c,e.offset>_){if(_=e.offset-_,_>e.whave&&e.sane){i.msg="invalid distance too far back",e.mode=we;break}_>e.wnext?(_-=e.wnext,S=e.wsize-_):S=e.wnext-_,_>e.length&&(_=e.length),f=e.window}else f=s,S=o-e.offset,_=e.length;_>c&&(_=c),c-=_,e.length-=_;do s[o++]=f[S++];while(--_);e.length===0&&(e.mode=Wd);break;case 16205:if(c===0)break t;s[o++]=e.length,c--,e.mode=Wd;break;case Up:if(e.wrap){for(;l<32;){if(a===0)break t;a--,d|=n[r++]<<l,l+=8}if(p-=c,i.total_out+=p,e.total+=p,4&e.wrap&&p&&(i.adler=e.check=e.flags?ri(e.check,s,p,o-p):ba(e.check,s,p,o-p)),p=c,4&e.wrap&&(e.flags?d:DC(d))!==e.check){i.msg="incorrect data check",e.mode=we;break}d=0,l=0}e.mode=16207;case 16207:if(e.wrap&&e.flags){for(;l<32;){if(a===0)break t;a--,d+=n[r++]<<l,l+=8}if(4&e.wrap&&d!==(4294967295&e.total)){i.msg="incorrect length check",e.mode=we;break}d=0,l=0}e.mode=16208;case 16208:L=HM;break t;case we:L=wC;break t;case 16210:return OC;default:return En}return i.next_out=o,i.avail_out=c,i.next_in=r,i.avail_in=a,e.hold=d,e.bits=l,(e.wsize||p!==i.avail_out&&e.mode<we&&(e.mode<Up||t!==bC))&&xC(i,i.output,i.next_out,p-i.avail_out),u-=i.avail_in,p-=i.avail_out,i.total_in+=u,i.total_out+=p,e.total+=p,4&e.wrap&&p&&(i.adler=e.check=e.flags?ri(e.check,s,p,i.next_out-p):ba(e.check,s,p,i.next_out-p)),i.data_type=e.bits+(e.last?64:0)+(e.mode===cs?128:0)+(e.mode===Gd||e.mode===Mp?256:0),(u===0&&p===0||t===bC)&&L===Nr&&(L=YM),L},ds={inflateReset:LC,inflateReset2:kC,inflateResetKeep:PC,inflateInit:i=>MC(i,15),inflateInit2:MC,inflate:zM,inflateEnd:i=>{if(Dr(i))return En;let t=i.state;return t.window&&(t.window=null),i.state=null,Nr},inflateGetHeader:(i,t)=>{if(Dr(i))return En;const e=i.state;return 2&e.wrap?(e.head=t,t.done=!1,Nr):En},inflateSetDictionary:(i,t)=>{const e=t.length;let n,s,r;return Dr(i)?En:(n=i.state,n.wrap!==0&&n.mode!==jd?En:n.mode===jd&&(s=1,s=ba(s,t,e,0),s!==n.check)?wC:(r=xC(i,t,e,e),r?(n.mode=16210,OC):(n.havedict=1,Nr)))},inflateInfo:"pako inflate (from Nodeca project)"},XM=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const VC=Object.prototype.toString,{Z_NO_FLUSH:QM,Z_FINISH:ZM,Z_OK:xa,Z_STREAM_END:Fp,Z_NEED_DICT:Bp,Z_STREAM_ERROR:$M,Z_DATA_ERROR:FC,Z_MEM_ERROR:t1}=Ao;function Va(i){this.options=Md.assign({chunkSize:65536,windowBits:15,to:""},i||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||i&&i.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new yC,this.strm.avail_out=0;let e=ds.inflateInit2(this.strm,t.windowBits);if(e!==xa)throw new Error(Ar[e]);if(this.header=new XM,ds.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=ka.string2buf(t.dictionary):VC.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(e=ds.inflateSetDictionary(this.strm,t.dictionary),e!==xa)))throw new Error(Ar[e])}function jp(i,t){const e=new Va(t);if(e.push(i),e.err)throw e.msg||Ar[e.err];return e.result}Va.prototype.push=function(i,t){const e=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let r,o,a;if(this.ended)return!1;for(o=t===~~t?t:t===!0?ZM:QM,VC.call(i)==="[object ArrayBuffer]"?e.input=new Uint8Array(i):e.input=i,e.next_in=0,e.avail_in=e.input.length;;){for(e.avail_out===0&&(e.output=new Uint8Array(n),e.next_out=0,e.avail_out=n),r=ds.inflate(e,o),r===Bp&&s&&(r=ds.inflateSetDictionary(e,s),r===xa?r=ds.inflate(e,o):r===FC&&(r=Bp));e.avail_in>0&&r===Fp&&e.state.wrap>0&&i[e.next_in]!==0;)ds.inflateReset(e),r=ds.inflate(e,o);switch(r){case $M:case FC:case Bp:case t1:return this.onEnd(r),this.ended=!0,!1}if(a=e.avail_out,e.next_out&&(e.avail_out===0||r===Fp))if(this.options.to==="string"){let c=ka.utf8border(e.output,e.next_out),d=e.next_out-c,l=ka.buf2string(e.output,c);e.next_out=d,e.avail_out=n-d,d&&e.output.set(e.output.subarray(c,c+d),0),this.onData(l)}else this.onData(e.output.length===e.next_out?e.output:e.output.subarray(0,e.next_out));if(r!==xa||a!==0){if(r===Fp)return r=ds.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,!0;if(e.avail_in===0)break}}return!0},Va.prototype.onData=function(i){this.chunks.push(i)},Va.prototype.onEnd=function(i){i===xa&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Md.flattenChunks(this.chunks)),this.chunks=[],this.err=i,this.msg=this.strm.msg};var e1={Inflate:Va,inflate:jp,inflateRaw:function(i,t){return(t=t||{}).raw=!0,jp(i,t)},ungzip:jp,constants:Ao};const{Deflate:SU,deflate:i1,deflateRaw:RU,gzip:CU}=xM,{Inflate:IU,inflate:n1,inflateRaw:vU,ungzip:yU}=e1;var Gp,s1=i1,r1=n1;(function(i){i[i.ONE_BYTE=0]="ONE_BYTE",i[i.TWO_BYTE=1]="TWO_BYTE"})(Gp||(Gp={}));class o1{constructor(){h(this,"_sequence",0),h(this,"_startTime",Date.now()),h(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const e={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};e.commonPacketHeader.extension=1,e.extension=d,e.payload=this.compress(t),e.commonPacketHeader.length=8+(e.extension.length+2)+e.payload.byteLength}else e.commonPacketHeader.length=8+e.payload.byteLength;v("SHOW_DATASTREAM2_LOG")&&E.debug("send data header: ".concat(JSON.stringify(e.commonPacketHeader)));const n=new ArrayBuffer(e.commonPacketHeader.length),s=new Uint8Array(n),r=new DataView(n);let o=0;if(r.setUint16(o,e.commonPacketHeader.extension<<15|e.commonPacketHeader.reserved<<14|e.commonPacketHeader.length,!0),o+=2,r.setUint32(o,e.commonPacketHeader.sequence,!0),o+=4,r.setUint16(o,e.commonStreamHeader,!0),o+=2,e.extension){const a=this.serializeExtension(e.extension);s.set(new Uint8Array(a),o),o+=a.byteLength}if(s.set(new Uint8Array(e.payload),o),o+=e.payload.byteLength,o!==e.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const e=new DataView(t);let n=0;const s=e.getUint16(n,!0);n+=2;const r={length:16383&s,reserved:(16384&s)>>14,extension:(32768&s)>>15,sequence:e.getUint16(n+2,!0)<<16|e.getUint16(n,!0)};let o,a;if(n+=4,v("SHOW_DATASTREAM2_LOG")&&E.debug("receive data header: ".concat(JSON.stringify(r))),e.getUint16(n,!0),n+=2,r.extension){a=this.deserializeExtension(t.slice(n)),n+=2+a.length,o=t.slice(n);let c=!1;if(a.datas.length>0){const d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}o=c?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:e,length:n,datas:s}=t,r=new ArrayBuffer(n+2),o=new Uint8Array(r),a=new DataView(r);let c=0;if(a.setUint8(c++,e),a.setUint8(c++,n),s.forEach(d=>{e?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==n+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(n+2));return r}deserializeExtension(t){const e=new DataView(t);let n=0;const s=e.getUint8(n);n++;const r=e.getUint8(n);n++;const o=s===Gp.TWO_BYTE,a=[],c=new DataView(t,2);let d=0;for(;d<r;){let l=0,u=0,p=new ArrayBuffer(0);o?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(p=c.buffer.slice(d+2,d+2+u),d+=p.byteLength),a.push({id:l,length:u,data:p})}if(d!==r)throw Error("parse error");return{profile:s,length:r,datas:a}}decompress(t){return r1(new Uint8Array(t))}compress(t){return s1(new Uint8Array(t))}}class BC extends Wt{constructor(t,e){super(),h(this,"_version",1),h(this,"_type",3),h(this,"_config",void 0),h(this,"_originDataChannel",void 0),h(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),h(this,"_dataStreamPacketHandler",void 0),h(this,"_datachannelEventMap",new Map),this._config=t,e&&(this._originDataChannel=e,this._bandDataChannelEvents(e)),this._initPacketHeader(),this._dataStreamPacketHandler=new o1}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return v("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,e;return(t=(e=this._originDataChannel)===null||e===void 0?void 0:e.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,e;return(t=(e=this._originDataChannel)===null||e===void 0?void 0:e.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new P((t,e)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const n=setTimeout(()=>{var s;e(new M(R.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((s=this._originDataChannel)===null||s===void 0?void 0:s.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new M(R.DATACHANNEL_CONNECTION_TIMEOUT)}}else e(new M(R.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Ro.OPEN,Ro.CLOSE,Ro.ERROR].forEach(e=>{const n=()=>{this.emit(e)};this._datachannelEventMap.set(e,n),t.addEventListener(e,n)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(e=>{let[n,s]=e;t.removeEventListener(n,s)}),this._datachannelEventMap.clear()}}class a1 extends BC{constructor(t){super(t),h(this,"_messageListener",void 0),this._messageListener=e=>{if(e.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const n=e.data.slice(0,this._dataStreamPacketHeader.byteLength),s=new DataView(n).getUint8(3);if(s!==this.id)return void(v("SHOW_DATASTREAM2_LOG")&&E.debug("invalid datachannel id: ".concat(s," !== ").concat(this.id)));let r=e.data.slice(this._dataStreamPacketHeader.byteLength);r=this._dataStreamPacketHandler.deserialize(r),this.emit(Ro.MESSAGE,r)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class jC extends BC{send(t){if(this._originDataChannel){let e=t;e=this._dataStreamPacketHandler.serialize(t);const n=new Uint8Array(this._dataStreamPacketHeader.byteLength+e.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(e),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}(function(){const i=ft();Ye.getDisplayMedia=function(t){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),Ye.getStreamFromExtension=i.name===Rt.CHROME&&Number(i.version)>34,Ye.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let e=!1;try{t.addTransceiver("audio"),e=!0}catch{}return t.close(),e}(),Ye.supportMinBitrate=i.name===Rt.CHROME||i.name===Rt.EDGE,Ye.supportSetRtpSenderParameters=function(){const t=ft();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!vs()||!(!Xe()&&!Kc())||t.name===Rt.FIREFOX&&Number(t.version)>=64}(),i.name===Rt.SAFARI&&(Number(i.version)>=14?Ye.supportDualStream=!0:Ye.supportDualStream=!1),Ye.webAudioMediaStreamDest=function(){const t=ft();return!(t.name===Rt.SAFARI&&Number(t.version)<12)}(),Ye.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),Ye.supportWebGL=typeof WebGLRenderingContext<"u",Ye.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,vs()||(Ye.webAudioWithAEC=!0),Ye.supportShareAudio=function(){const t=ft();return(t.os===_e.WIN_10||t.os===_e.WIN_81||t.os===_e.WIN_7||t.os===_e.LINUX||t.os===_e.MAC_OS||t.os===_e.CHROMIUM_OS)&&t.name===Rt.CHROME&&Number(t.version)>=74}(),Ye.supportDataChannel=function(){return!!(sh(76)||function(t){const e=ft();return!(e.name!==Rt.FIREFOX||!e.osVersion)&&Number(e.version)>=t}(68)||function(t){const e=ft();return!(e.name!==Rt.SAFARI||!e.osVersion)&&Number(e.version)>=t}(14))}(),Ye.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!Nt()&&!!t&&t.prototype.setConfiguration instanceof Function}(),Ye.supportWebRTCEncodedTransform=function(){const t=ft();return t.name==="Chrome"&&Number(t.version)>=86}(),Ye.supportWebRTCInsertableStream=function(){const t=ft();return(t.name===Rt.CHROME||t.name===Rt.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),zc(()=>{Ye.supportDualStreamEncoding=function(){const t=ft();return v("DISABLE_WEBAUDIO")?!0:t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&v("CHROME_DUAL_STREAM_USE_ENCODING"))}(),E.info("browser compatibility",JSON.stringify(Ye),JSON.stringify(i))})})();class c1 extends Wt{constructor(){super(...arguments),h(this,"resultStorage",new Map)}setLocalAudioStats(t,e,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(n,e)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(n,e))}setLocalVideoStats(t,e,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(n,e)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(n,e)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(n))}setRemoteAudioStats(t,e){const n=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(e))}setRemoteVideoStats(t,e){const n=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(e))}record(t,e,n){if(v("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const s=this.resultStorage.get(t);if(s&&(s.result.push(n),s.result.length>=5)){var r;const o=q(r=s.result).call(r,!0);s.isPrevNormal&&!o&&this.emit("exception",GC[t],t,e),!s.isPrevNormal&&o&&this.emit("exception",GC[t]+2e3,t+"_RECOVER",e),s.isPrevNormal=o,s.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,e){return e instanceof ce&&!e.isActive||!!e.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,e){let n=null;e._encoderConfig&&e._encoderConfig.frameRate&&(n=Ui(e._encoderConfig.frameRate));const s=t.captureFrameRate;return!n||!s||!(n>10&&s<5||n<10&&n>=5&&s<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,e){return!!e.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,e){return e instanceof ce&&!e.isActive||!!e.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const GC={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Ve=new class{markSubscribeStart(i,t){performance.mark("agora-web-sdk/".concat(i,"/subscribe-").concat(t))}markPublishStart(i,t){performance.mark("agora-web-sdk/".concat(i,"/publish-").concat(t))}measureFromSubscribeStart(i,t){const e=performance.getEntriesByName("agora-web-sdk/".concat(i,"/subscribe-").concat(t));if(e.length>0){const n=e[e.length-1];return Math.round(performance.now()-n.startTime)}return 0}measureFromPublishStart(i,t){const e=performance.getEntriesByName("agora-web-sdk/".concat(i,"/publish-").concat(t));if(e.length>0){const n=e[e.length-1];return Math.round(performance.now()-n.startTime)}return 0}};function Wp(i,t){this.v=i,this.k=t}function at(i){return new Wp(i,0)}var d1=iT,l1=Pn;zt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var i=l1.f(this);return{promise:i.promise,resolve:i.resolve,reject:i.reject}}});var u1=Pn,h1=to;zt({target:"Promise",stat:!0,forced:!0},{try:function(i){var t=u1.f(this),e=h1(i);return(e.error?t.reject:t.resolve)(e.value),t.promise}});var Hp=xt(d1),WC=Hr.f("asyncIterator"),p1=xt(WC);function Fa(i){var t,e;function n(r,o){try{var a=i[r](o),c=a.value,d=c instanceof Wp;Hp.resolve(d?c.v:c).then(function(l){if(d){var u=r==="return"?"return":"next";if(!c.k||l.done)return n(u,l);l=i[u](l).value}s(a.done?"return":"normal",l)},function(l){n("throw",l)})}catch(l){s("throw",l)}}function s(r,o){switch(r){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?n(t.key,t.arg):e=null}this._invoke=function(r,o){return new Hp(function(a,c){var d={key:r,arg:o,resolve:a,reject:c,next:null};e?e=e.next=d:(t=e=d,n(r,o))})},typeof i.return!="function"&&(this.return=void 0)}function vi(i){return function(){return new Fa(i.apply(this,arguments))}}Fa.prototype[typeof Xr=="function"&&p1||"@@asyncIterator"]=function(){return this},Fa.prototype.next=function(i){return this._invoke("next",i)},Fa.prototype.throw=function(i){return this._invoke("throw",i)},Fa.prototype.return=function(i){return this._invoke("return",i)};var HC=xt(zn.Object.getOwnPropertySymbols),_1=zt,E1=Ol.indexOf,m1=vu,Kp=Za([].indexOf),KC=!!Kp&&1/Kp([1],1,-0)<0;_1({target:"Array",proto:!0,forced:KC||!m1("indexOf")},{indexOf:function(i){var t=arguments.length>1?arguments[1]:void 0;return KC?Kp(this,i,t)||0:E1(this,i,t)}});var f1=Ts("Array").indexOf,g1=rn,T1=f1,Yp=Array.prototype,YC=xt(function(i){var t=i.indexOf;return i===Yp||g1(Yp,i)&&t===Yp.indexOf?T1:t}),S1=fs,qC=Yl;zt({target:"Object",stat:!0,forced:Gt(function(){qC(1)})},{keys:function(i){return qC(S1(i))}});var R1=xt(zn.Object.keys);function C1(i,t){if(i==null)return{};var e,n,s=function(o,a){if(o==null)return{};var c,d,l={},u=R1(o);for(d=0;d<u.length;d++)c=u[d],YC(a).call(a,c)>=0||(l[c]=o[c]);return l}(i,t);if(HC){var r=HC(i);for(n=0;n<r.length;n++)e=r[n],YC(t).call(t,e)>=0||Object.prototype.propertyIsEnumerable.call(i,e)&&(s[e]=i[e])}return s}var JC={exports:{}};(function(i,t){i.exports=(()=>{var e={8:(r,o,a)=>{a.r(o),a.d(o,{Parser:()=>it,Printer:()=>Ai,parse:()=>st,print:()=>gt});const c=`
`,d="".concat("\r").concat(c),l=" ";let u;function p(W){return W>="0"&&W<="9"}function _(W){return W>="!"&&W<="~"}function S(W){return _(W)||W>="Â"&&W<="Ã¿"}function f(W){return W==="!"||W>="#"&&W<="'"||W>="*"&&W<="+"||W>="-"&&W<="."||W>="0"&&W<="9"||W>="A"&&W<="Z"||W>="^"&&W<="~"}function g(W){return W>="1"&&W<="9"}function C(W){return W>="A"&&W<="Z"||W>="a"&&W<="z"}function y(W){return W==="d"||W==="h"||W==="m"||W==="s"}function A(W){return W>""&&W<"	"||W>"\v"&&W<"\f"||W>""&&W<"Ã¿"}function k(W){return C(W)||p(W)||W==="+"||W==="/"}function O(W){return p(W)||C(W)||W==="+"||W==="/"||W==="-"||W==="_"}function N(W){return C(W)||p(W)||W==="+"||W==="/"}function L(W,m){var I=Object.keys(W);if(Object.getOwnPropertySymbols){var b=Object.getOwnPropertySymbols(W);m&&(b=b.filter(function(B){return Object.getOwnPropertyDescriptor(W,B).enumerable})),I.push.apply(I,b)}return I}function D(W){for(var m=1;m<arguments.length;m++){var I=arguments[m]!=null?arguments[m]:{};m%2?L(Object(I),!0).forEach(function(b){F(W,b,I[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(W,Object.getOwnPropertyDescriptors(I)):L(Object(I)).forEach(function(b){Object.defineProperty(W,b,Object.getOwnPropertyDescriptor(I,b))})}return W}function F(W,m,I){return m in W?Object.defineProperty(W,m,{value:I,enumerable:!0,configurable:!0,writable:!0}):W[m]=I,W}(function(W){W.VERSION="v",W.ORIGIN="o",W.SESSION_NAME="s",W.INFORMATION="i",W.URI="u",W.EMAIL="e",W.PHONE="p",W.CONNECTION="c",W.BANDWIDTH="b",W.TIME="t",W.REPEAT="r",W.ZONE_ADJUSTMENTS="z",W.KEY="k",W.ATTRIBUTE="a",W.MEDIA="m"})(u||(u={}));class j{consumeText(m,I){let b=I;for(;b<m.length;){const B=m[b];if(B==="\0"||B==="\r"||B===c)break;b+=1}if(b-I==0)throw new Error("Invalid text, at ".concat(m));return b}consumeUnicastAddress(m,I,b){return this.consumeTill(m,I,l)}consumeOneOrMore(m,I,b){let B=I;for(;b(m[B]);)B++;if(B-I==0)throw new Error("Invalid rule at ".concat(I,"."));return B}consumeSpace(m,I){if(m[I]===l)return I+1;throw new Error("Invalid space at ".concat(I,"."))}consumeIP4Address(m,I){let b=I;for(let B=0;B<4;B++)if(b=this.consumeDecimalUChar(m,b),B!==3){if(m[b]!==".")throw new Error("Invalid IP4 address.");b++}return b}consumeDecimalUChar(m,I){let b=I;for(let rt=0;rt<3&&p(m[b]);rt++,b++);if(b-I==0)throw new Error("Invalid decimal uchar.");const B=parseInt(m.slice(I,b));if(B>=0&&B<=255)return b;throw new Error("Invalid decimal uchar")}consumeIP6Address(m,I){let b=this.consumeHexpart(m,I);return m[b]===":"&&(b+=1,b=this.consumeIP4Address(m,b)),b}consumeHexpart(m,I){let b=I;if(m[b]===":"&&m[b+1]===":"){b+=2;try{b=this.consumeHexseq(m,b)}catch{}return b}if(b=this.consumeHexseq(m,b),m[b]===":"&&m[b+1]===":"){b+=2;try{b=this.consumeHexseq(m,b)}catch{}return b}return b}consumeHexseq(m,I){let b=I;for(;b=this.consumeHex4(m,b),m[b]===":"&&m[b+1]!==":";)b+=1;return b}consumeHex4(m,I){let b=0;for(;b<4;b++)if(!((B=m[I+b])>="0"&&B<="9"||B>="a"&&B<="f"||B>="A"&&B<="F")){if(b===0)throw new Error("Invalid hex 4");break}var B;return I+b}consumeFQDN(m,I){let b=I;for(;p(m[b])||C(m[b])||m[b]==="-"||m[b]===".";)b+=1;if(b-I<4)throw new Error("Invalid FQDN");return b}consumeExtnAddr(m,I){return this.consumeOneOrMore(m,I,S)}consumeMulticastAddress(m,I,b){switch(b){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(m,I);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(m,I);default:try{return this.consumeFQDN(m,I)}catch{return this.consumeExtnAddr(m,I)}}}consumeIP6MulticastAddress(m,I){const b=this.consumeHexpart(m,I);return m[b]==="/"?this.consumeInteger(m,b+1):b}consumeIP4MulticastAddress(m,I){let b=I+3;const B=m.slice(I,b),rt=parseInt(B);if(rt<224||rt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Vt=0;Vt<3;Vt++){if(m[b]!==".")throw new Error("Invalid IP4 multicast address.");b+=1,b=this.consumeDecimalUChar(m,b)}return m[b]==="/"&&(b+=1),b=this.consumeTTL(m,b),m[b]==="/"&&(b=this.consumeInteger(m,b)),b}consumeInteger(m,I){if(!g(m[I]))throw new Error("Invalid integer.");for(I+=1;p(m[I]);)I+=1;return I}consumeTTL(m,I){if(m[I]==="0")return I+1;if(!g(m[I]))throw new Error("Invalid TTL.");I+=1;for(let b=0;b<2&&p(m[I]);b++)I+=1;return I}consumeToken(m,I){return this.consumeOneOrMore(m,I,f)}consumeTime(m,I){let b=I;if(m[b]==="0")return b+1;for(g(m[b])&&(b+=1);p(m[b]);)b++;if(b-I<10)throw new Error("Invalid time");return b}consumeAddress(m,I){return this.consumeTill(m,I,l)}consumeTypedTime(m,I){let b=I;return b=this.consumeOneOrMore(m,b,p),y(m[b])?b+1:b}consumeRepeatInterval(m,I){if(!g(m[I]))throw new Error("Invalid repeat interval");for(I+=1;p(m[I]);)I+=1;return y(m[I])&&(I+=1),I}consumePort(m,I){return this.consumeOneOrMore(m,I,p)}consume(m,I,b){for(let B=0;B<b.length;B++){if(I+B>=m.length)throw new Error("consume exceeding value length");if(m[I+B]!==b[B])throw new Error("consume ".concat(b," failed at ").concat(B))}return I+b.length}consumeTill(m,I,b){let B=I;for(;B<m.length&&(typeof b!="string"||m[B]!==b)&&(typeof b!="function"||!b(m[B]));)B++;return B}}class it extends j{constructor(){super(),F(this,"records",[]),F(this,"currentLine",0)}parse(m){const I=this.probeEOL(m);this.records=m.split(I).filter(pe=>!!pe.trim()).map(this.parseLine),this.currentLine=0;const b=this.parseVersion(),B=this.parseOrigin(),rt=this.parseSessionName(),Vt=this.parseInformation(),je=this.parseUri(),bi=this.parseEmail(),ps=this.parsePhone(),sl=this.parseConnection(),rl=this.parseBandWidth(),sn=this.parseTimeFields(),Zs=this.parseKey(),Vo=this.parseSessionAttribute(),ee=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:b,origin:B,sessionName:rt,information:Vt,uri:je,emails:bi,phones:ps,connection:sl,bandwidths:rl,timeFields:sn,key:Zs,attributes:Vo,mediaDescriptions:ee}}getCurrentRecord(){const m=this.records[this.currentLine];if(!m)throw new Error("Record doesn't exit.");return m}probeEOL(m){for(let I=0;I<m.length;I++)if(m[I]===c)return m[I-1]==="\r"?d:c;throw new Error("Invalid newline character.")}parseLine(m,I){if(m.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const b=m[0];if(m[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:b,value:m.slice(2),line:I,cur:0}}parseSessionAttribute(){const m=new Ut;for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==u.ATTRIBUTE)break;const b={attField:this.extractOneOrMore(I,B=>f(B)&&B!==":"),_cur:0};I.value[I.cur]===":"&&(I.cur+=1,b.attValue=this.extractOneOrMore(I,A)),m.parse(b),this.currentLine++}return m.digest()}parseMediaAttributes(m){const I=new he(m);for(;this.currentLine<this.records.length;){const b=this.getCurrentRecord();if(b.type!==u.ATTRIBUTE)break;const B={attField:this.extractOneOrMore(b,rt=>f(rt)&&rt!==":"),_cur:0};b.value[b.cur]===":"&&(b.cur+=1,B.attValue=this.extractOneOrMore(b,A)),I.parse(B),this.currentLine++}return I.digest()}parseKey(){const m=this.getCurrentRecord();if(m.type===u.KEY){if(m.value==="prompt"||m.value==="clear:"||m.value==="base64:"||m.value==="uri:")return m.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const m=this.getCurrentRecord();if(m.type===u.ZONE_ADJUSTMENTS){const I=[];for(;;)try{const b=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);let B=!1;m.value[m.cur]==="-"&&(B=!0,m.cur+=1);const rt=this.extract(m,this.consumeTypedTime);I.push({time:b,typedTime:rt,back:B})}catch{break}if(I.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,I}return[]}parseRepeat(){const m=[];for(;;){const I=this.getCurrentRecord();if(I.type!==u.REPEAT)break;{const b=this.extract(I,this.consumeRepeatInterval),B=this.parseTypedTime(I);m.push({repeatInterval:b,typedTimes:B}),this.currentLine++}}return m}parseTypedTime(m){const I=[];for(;;)try{this.consumeSpaceForRecord(m),I.push(this.extract(m,this.consumeTypedTime))}catch{break}if(I.length===0)throw new Error("Invalid typed time.");return I}parseTime(){const m=this.getCurrentRecord(),I=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);const b=this.extract(m,this.consumeTime);return this.currentLine++,{startTime:I,stopTime:b}}parseBandWidth(){const m=[];for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==u.BANDWIDTH)break;{const b=this.extractOneOrMore(I,f);if(I.value[I.cur]!==":")throw new Error("Invalid bandwidth field.");I.cur++;const B=this.extractOneOrMore(I,p);m.push({bwtype:b,bandwidth:B}),this.currentLine++}}return m}parseVersion(){const m=this.getCurrentRecord();if(m.type!==u.VERSION)throw new Error("first sdp record must be version");const I=m.value.slice(0,this.consumeOneOrMore(m.value,0,p));if(I.length!==m.value.length)throw new Error('invalid proto version, "v='.concat(m.value,'"'));return this.currentLine++,I}parseOrigin(){const m=this.getCurrentRecord();if(m.type!==u.ORIGIN)throw new Error("second line of sdp must be origin");const I=this.extractOneOrMore(m,S);this.consumeSpaceForRecord(m);const b=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);const B=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);const rt=this.extractOneOrMore(m,f);this.consumeSpaceForRecord(m);const Vt=this.extractOneOrMore(m,f);this.consumeSpaceForRecord(m);const je=this.extract(m,this.consumeUnicastAddress);return this.currentLine++,{username:I,sessId:b,sessVersion:B,nettype:rt,addrtype:Vt,unicastAddress:je}}parseSessionName(){const m=this.getCurrentRecord();if(m.type===u.SESSION_NAME){const I=this.extract(m,this.consumeText);return this.currentLine++,I}}parseInformation(){const m=this.getCurrentRecord();if(m.type!==u.INFORMATION)return;const I=this.extract(m,this.consumeText);return this.currentLine++,I}parseUri(){const m=this.getCurrentRecord();if(m.type===u.URI)return this.currentLine++,m.value}parseEmail(){const m=[];for(;;){const I=this.getCurrentRecord();if(I.type!==u.EMAIL)break;m.push(I.value),this.currentLine++}return m}parsePhone(){const m=[];for(;;){const I=this.getCurrentRecord();if(I.type!==u.PHONE)break;m.push(I.value),this.currentLine++}return m}parseConnection(){const m=this.getCurrentRecord();if(m.type===u.CONNECTION){const I=this.extractOneOrMore(m,f);this.consumeSpaceForRecord(m);const b=this.extractOneOrMore(m,f);this.consumeSpaceForRecord(m);const B=this.extract(m,this.consumeAddress);return this.currentLine++,{nettype:I,addrtype:b,address:B}}}parseMedia(){const m=this.getCurrentRecord(),I=this.extract(m,this.consumeToken);this.consumeSpaceForRecord(m);let b=this.extract(m,this.consumePort);m.value[m.cur]==="/"&&(m.cur+=1,b+=this.extract(m,this.consumeInteger)),this.consumeSpaceForRecord(m);const B=[];for(B.push(this.extract(m,this.consumeToken));m.value[m.cur]==="/";)m.cur+=1,B.push(this.extract(m,this.consumeToken));if(B.length===0)throw new Error("Invalid proto");const rt=this.parseFmt(m);return this.currentLine++,{mediaType:I,port:b,protos:B,fmts:rt}}parseTimeFields(){const m=[];for(;this.getCurrentRecord().type===u.TIME;){const I=this.parseTime(),b=this.parseRepeat(),B=this.parseZone();m.push({time:I,repeats:b,zones:B})}return m}parseMediaDescription(){const m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.MEDIA;){const I=this.parseMedia(),b=this.parseInformation(),B=this.parseConnections(),rt=this.parseBandWidth(),Vt=this.parseKey(),je=this.parseMediaAttributes(I);m.push({media:I,information:b,connections:B,bandwidths:rt,key:Vt,attributes:je})}return m}parseConnections(){const m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.CONNECTION;)m.push(this.parseConnection());return m}parseFmt(m){const I=[];for(;;)try{this.consumeSpaceForRecord(m),I.push(this.extract(m,this.consumeToken))}catch{break}if(I.length===0)throw new Error("Invalid fmts");return I}extract(m,I,...b){const B=I.call(this,m.value,m.cur,...b),rt=m.value.slice(m.cur,B);return m.cur=B,rt}extractOneOrMore(m,I){const b=this.consumeOneOrMore(m.value,m.cur,I),B=m.value.slice(m.cur,b);return m.cur=b,B}consumeSpaceForRecord(m){if(m.value[m.cur]!==l)throw new Error("Invalid space at ".concat(m.cur,"."));m.cur+=1}}class ct extends j{constructor(...m){super(...m),F(this,"attributes",void 0),F(this,"digested",!1)}extractOneOrMore(m,I,b){const B=this.consumeOneOrMore(m.attValue,m._cur,I),rt=m.attValue.slice(m._cur,B),[Vt,je]=b||[];if(typeof Vt=="number"&&rt.length<Vt)throw new Error("error in length, should be more or equal than ".concat(Vt," characters."));if(typeof je=="number"&&rt.length>je)throw new Error("error in length, should be less or equal than ".concat(je," characters."));return m._cur=B,rt}consumeAttributeSpace(m){if(m.attValue[m._cur]!==l)throw new Error("Invalid space at ".concat(m._cur,"."));m._cur+=1}extract(m,I,...b){if(!m.attValue)throw new Error("Nothing to extract from attValue.");const B=I.call(this,m.attValue,m._cur,...b),rt=m.attValue.slice(m._cur,B);return m._cur=B,rt}atEnd(m){if(!m.attValue)throw new Error;return m._cur>=m.attValue.length}peekChar(m){if(!m.attValue)throw new Error;return m.attValue[m._cur]}peek(m,I){if(!m.attValue)throw new Error;for(let b=0;b<I.length;b++)if(I[b]!==m.attValue[m._cur+b])return!1;return!0}parseIceUfrag(m){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(m,k,[4,256])}parseIcePwd(m){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(m,k,[22,256])}parseIceOptions(m){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const I=[];for(;!this.atEnd(m);){I.push(this.extractOneOrMore(m,k));try{this.consumeAttributeSpace(m)}catch(b){if(this.atEnd(m))break;throw b}}this.attributes.iceOptions=I}parseFingerprint(m){const I=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);const b=this.extract(m,this.consumeTill);this.attributes.fingerprints.push({hashFunction:I,fingerprint:b})}parseExtmap(m){const I=this.extractOneOrMore(m,p);let b;this.peekChar(m)==="/"&&(this.extract(m,this.consume,"/"),b=this.extract(m,this.consumeToken)),this.consumeAttributeSpace(m);const B=this.extract(m,this.consumeTill,l),rt=D(D({entry:parseInt(I,10)},b&&{direction:b}),{},{extensionName:B});this.peekChar(m)===l&&(this.consumeAttributeSpace(m),rt.extensionAttributes=this.extract(m,this.consumeTill)),this.attributes.extmaps.push(rt)}parseSetup(m){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const I=this.extract(m,this.consumeTill);if(I!=="active"&&I!=="passive"&&I!=="actpass"&&I!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=I}}class Ut extends ct{constructor(...m){super(...m),F(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"group":this.parseGroup(m);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"fingerprint":this.parseFingerprint(m);break;case"setup":this.parseSetup(m);break;case"tls-id":this.parseTlsId(m);break;case"identity":this.parseIdentity(m);break;case"extmap":this.parseExtmap(m);break;case"msid-semantic":this.parseMsidSemantic(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(I){throw console.error("parsing session attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),I}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(m){const I=this.extract(m,this.consumeToken),b=[];for(;!this.atEnd(m)&&this.peekChar(m)===l;)this.consumeAttributeSpace(m),b.push(this.extract(m,this.consumeToken));this.attributes.groups.push({semantic:I,identificationTag:b})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(m){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(m,O)}parseIdentity(m){const I=this.extractOneOrMore(m,N),b=[];for(;!this.atEnd(m)&&this.peekChar(m)===l;){this.consumeAttributeSpace(m);const B=this.extract(m,this.consumeToken);this.extract(m,this.consume,"=");const rt=this.extractOneOrMore(m,Vt=>Vt!==l&&A(Vt));b.push({name:B,value:rt})}this.attributes.identities.push({assertionValue:I,extensions:b})}parseMsidSemantic(m){this.peekChar(m)===l&&this.consumeAttributeSpace(m);const I={semantic:this.extract(m,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(m)}catch{break}if(this.peekChar(m)==="*"){this.extract(m,this.consume,"*"),I.applyForAll=!0;break}{const b=this.extract(m,this.consumeTill,l);I.identifierList.push(b)}}this.attributes.msidSemantic=I}}class he extends ct{constructor(m){super(),F(this,"attributes",void 0),m.protos.indexOf("RTP")!==-1||m.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"extmap":this.parseExtmap(m);break;case"setup":this.parseSetup(m);break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"candidate":this.parseCandidate(m);break;case"remote-candidate":this.parseRemoteCandidate(m);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(m);break;case"rtpmap":this.parseRtpmap(m);break;case"ptime":this.parsePtime(m);break;case"maxptime":this.parseMaxPtime(m);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(m);break;case"ssrc":this.parseSSRC(m);break;case"fmtp":this.parseFmtp(m);break;case"rtcp-fb":this.parseRtcpFb(m);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(m);break;case"mid":this.parseMid(m);break;case"msid":this.parseMsid(m);break;case"imageattr":this.parseImageAttr(m);break;case"rid":this.parseRid(m);break;case"simulcast":this.parseSimulcast(m);break;case"sctp-port":this.parseSctpPort(m);break;case"max-message-size":this.parseMaxMessageSize(m);break;case"ssrc-group":this.parseSSRCGroup(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(I){throw console.error("parsing media attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),I}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}parseCandidate(m){const I=this.extractOneOrMore(m,k,[1,32]);this.consumeAttributeSpace(m);const b=this.extractOneOrMore(m,p,[1,5]);this.consumeAttributeSpace(m);const B=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);const rt=this.extractOneOrMore(m,p,[1,10]);this.consumeAttributeSpace(m);const Vt=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);const je=this.extract(m,this.consumePort);this.consumeAttributeSpace(m),this.extract(m,this.consume,"typ"),this.consumeAttributeSpace(m);const bi={foundation:I,componentId:b,transport:B,priority:rt,connectionAddress:Vt,port:je,type:this.extract(m,this.consumeToken),extension:{}};for(this.peek(m," raddr")&&(this.extract(m,this.consume," raddr"),this.consumeAttributeSpace(m),bi.relAddr=this.extract(m,this.consumeAddress)),this.peek(m," rport")&&(this.extract(m,this.consume," rport"),this.consumeAttributeSpace(m),bi.relPort=this.extract(m,this.consumePort));this.peekChar(m)===l;){this.consumeAttributeSpace(m);const ps=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m),bi.extension[ps]=this.extractOneOrMore(m,_)}this.attributes.candidates.push(bi)}parseRemoteCandidate(m){const I=[];for(;;){const b=this.extractOneOrMore(m,p,[1,5]);this.consumeAttributeSpace(m);const B=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);const rt=this.extract(m,this.consumePort);I.push({componentId:b,connectionAddress:B,port:rt});try{this.consumeAttributeSpace(m)}catch{break}}this.attributes.remoteCandidatesList.push(I)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(m){const I=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);const b=this.extract(m,this.consumeTill,"/");this.extract(m,this.consume,"/");const B={encodingName:b,clockRate:this.extractOneOrMore(m,p)};this.atEnd(m)||this.peekChar(m)!=="/"||(this.extract(m,this.consume,"/"),B.encodingParameters=parseInt(this.extract(m,this.consumeTill),10));const rt=this.attributes.payloads.find(Vt=>Vt.payloadType===parseInt(I,10));rt?rt.rtpMap=B:this.attributes.payloads.push({payloadType:parseInt(I,10),rtpMap:B,rtcpFeedbacks:[]})}parsePtime(m){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(m,this.consumeTill)}parseMaxPtime(m){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(m,this.consumeTill)}parseDirection(m){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=m.attField}parseSSRC(m){const I=this.extractOneOrMore(m,p);this.consumeAttributeSpace(m);const b=this.extract(m,this.consumeTill,":");let B;this.peekChar(m)===":"&&(this.extract(m,this.consume,":"),B=this.extract(m,this.consumeTill));const rt=this.attributes.ssrcs.find(Vt=>Vt.ssrcId===parseInt(I,10));rt?rt.attributes[b]=B:this.attributes.ssrcs.push({ssrcId:parseInt(I,10),attributes:{[b]:B}})}parseFmtp(m){const I=this.extract(m,this.consumeTill,l);this.consumeAttributeSpace(m);const b=this.extract(m,this.consumeTill),B={};b.split(";").forEach(Vt=>{let[je,bi]=Vt.split("=");je=je.trim();const ps=typeof bi=="string"?bi.trim():null;typeof je=="string"&&je.length>0&&(B[je]=ps)});const rt=this.attributes.payloads.find(Vt=>Vt.payloadType===parseInt(I,10));rt?rt.fmtp={parameters:B}:this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[],fmtp:{parameters:B}})}parseFmtParameters(m){const I={},b=this.extract(m,this.consumeTill,"=");m._cur++;const B=this.extract(m,this.consumeTill,";");for(I[b]=B;m.attValue[m._cur]===";";){const rt=this.extract(m,this.consumeTill,"=");m._cur++;const Vt=this.extract(m,this.consumeTill,";");I[rt]=Vt}return I}parseRtcpFb(m){let I="";I=this.peekChar(m)==="*"?this.extract(m,this.consume,"*"):this.extract(m,this.consumeTill,l),this.consumeAttributeSpace(m);const b=this.extract(m,this.consumeTill,l);let B;if(b==="trr-int")B={type:b,interval:this.extract(m,this.consumeTill)};else{const rt={type:b};this.peekChar(m)===l&&(this.consumeAttributeSpace(m),rt.parameter=this.extract(m,this.consumeToken),this.peekChar(m)===l&&(rt.additional=this.extract(m,this.consumeTill))),B=rt}if(I==="*")this.attributes.rtcpFeedbackWildcards.push(B);else{const rt=this.attributes.payloads.find(Vt=>Vt.payloadType===parseInt(I,10));rt?rt.rtcpFeedbacks.push(B):this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[B]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(m){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const I={port:this.extract(m,this.consumePort)};this.peekChar(m)===l&&(this.consumeAttributeSpace(m),I.netType=this.extractOneOrMore(m,f),this.consumeAttributeSpace(m),I.addressType=this.extractOneOrMore(m,f),this.consumeAttributeSpace(m),I.address=this.extract(m,this.consumeAddress)),this.attributes.rtcp=I}parseMsid(m){const I={id:this.extractOneOrMore(m,f,[1,64])};this.peekChar(m)===l&&(this.consumeAttributeSpace(m),I.appdata=this.extractOneOrMore(m,f,[1,64])),this.attributes.msids.push(I)}parseImageAttr(m){this.attributes.imageattr.push(m.attValue)}parseRid(m){const I=this.extractOneOrMore(m,B=>C(B)||p(B)||B==="_"||B==="-");this.consumeAttributeSpace(m);const b={id:I,direction:this.extract(m,this.consumeToken),params:[]};if(this.peekChar(m)===l){if(this.consumeAttributeSpace(m),this.peek(m,"pt=")){this.extract(m,this.consume,"pt=");const B=[];for(;;){const rt=this.extract(m,this.consumeToken);B.push(rt);try{this.extract(m,this.consume,",")}catch{break}}b.payloads=B,this.peekChar(m)===l&&this.extract(m,this.consume,l)}for(;;){const B=this.extract(m,this.consumeToken);switch(B){case"depend":{const rt={type:B,rids:this.extract(m,this.consume,"=").split(",")};b.params.push(rt);break}default:{const rt={type:B};this.peekChar(m)==="="&&(this.extract(m,this.consume,"="),rt.val=this.extract(m,this.consumeTill,";")),b.params.push(rt)}}try{this.extract(m,this.consume,";")}catch{break}}}this.attributes.rids.push(b)}parseSimulcast(m){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=m.attValue,this.extract(m,this.consumeTill)}parseSctpPort(m){this.attributes.sctpPort=this.extractOneOrMore(m,p,[1,5])}parseMaxMessageSize(m){this.attributes.maxMessageSize=this.extractOneOrMore(m,p,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(m){this.attributes.mid=this.extract(m,this.consumeToken)}parseSSRCGroup(m){const I=this.extract(m,this.consumeToken),b=[];for(;;)try{this.consumeAttributeSpace(m);const B=this.extract(m,this.consumeInteger);b.push(parseInt(B,10))}catch{break}this.attributes.ssrcGroups.push({semantic:I,ssrcIds:b})}}function Bt(W,m,I){return m in W?Object.defineProperty(W,m,{value:I,enumerable:!0,configurable:!0,writable:!0}):W[m]=I,W}class Ai{constructor(){Bt(this,"eol",d)}print(m,I){let b="";return I&&(this.eol=I),b+=this.printVersion(m.version),b+=this.printOrigin(m.origin),b+=this.printSessionName(m.sessionName),b+=this.printInformation(m.information),b+=this.printUri(m.uri),b+=this.printEmail(m.emails),b+=this.printPhone(m.phones),b+=this.printConnection(m.connection),b+=this.printBandwidth(m.bandwidths),b+=this.printTimeFields(m.timeFields),b+=this.printKey(m.key),b+=this.printSessionAttributes(m.attributes),b+=this.printMediaDescription(m.mediaDescriptions),b}printVersion(m){return"v=".concat(m).concat(this.eol)}printOrigin(m){return"o=".concat(m.username," ").concat(m.sessId," ").concat(m.sessVersion," ").concat(m.nettype," ").concat(m.addrtype," ").concat(m.unicastAddress).concat(this.eol)}printSessionName(m){return m?"s=".concat(m).concat(this.eol):""}printInformation(m){return m?"i=".concat(m).concat(this.eol):""}printUri(m){return m?"u=".concat(m).concat(this.eol):""}printEmail(m){let I="";for(const b of m)I+="e=".concat(b).concat(this.eol);return I}printPhone(m){let I="";for(const b of m)I+="e=".concat(b).concat(this.eol);return I}printConnection(m){return m?"c=".concat(m.nettype," ").concat(m.addrtype," ").concat(m.address).concat(this.eol):""}printBandwidth(m){let I="";for(const b of m)I+="b=".concat(b.bwtype,":").concat(b.bandwidth).concat(this.eol);return I}printTimeFields(m){let I="";for(const b of m){I+="t=".concat(b.time.startTime," ").concat(b.time.startTime).concat(this.eol);for(const B of b.repeats)I+="r=".concat(B.repeatInterval," ").concat(B.typedTimes.join(" ")).concat(this.eol);b.zoneAdjustments&&(I+="z=",I+="z=".concat(b.zoneAdjustments.map(B=>"".concat(B.time," ").concat(B.back?"-":""," ").concat(B.typedTime)).join(" ")).concat(this.eol),I+=this.eol)}return I}printKey(m){return m?"k=".concat(m).concat(this.eol):""}printAttributes(m){let I="";for(const b of m)I+="a=".concat(b.attField).concat(b.attValue?":".concat(b.attValue):"").concat(this.eol);return I}printMediaDescription(m){let I="";for(const b of m)I+=this.printMedia(b.media),I+=this.printInformation(b.information),I+=this.printConnections(b.connections),I+=this.printBandwidth(b.bandwidths),I+=this.printKey(b.key),I+=this.printMediaAttributes(b);return I}printConnections(m){let I="";for(const b of m)I+=this.printConnection(b);return I}printMedia(m){return"m=".concat(m.mediaType," ").concat(m.port," ").concat(m.protos.join("/")," ").concat(m.fmts.join(" ")).concat(this.eol)}printSessionAttributes(m){return new G(this.eol).print(m)}printMediaAttributes(m){return new Y(this.eol).print(m)}}class x{constructor(m){Bt(this,"eol",void 0),this.eol=m}printIceUfrag(m){return m===void 0?"":"a=ice-ufrag:".concat(m).concat(this.eol)}printIcePwd(m){return m===void 0?"":"a=ice-pwd:".concat(m).concat(this.eol)}printIceOptions(m){return m===void 0?"":"a=ice-options:".concat(m.join(l)).concat(this.eol)}printFingerprints(m){return m.length>0?m.map(I=>"a=fingerprint:".concat(I.hashFunction).concat(l).concat(I.fingerprint)).join(this.eol)+this.eol:""}printExtmap(m){return m.map(I=>"a=extmap:".concat(I.entry).concat(I.direction?"/".concat(I.direction):"").concat(l).concat(I.extensionName).concat(I.extensionAttributes?"".concat(l).concat(I.extensionAttributes):"").concat(this.eol)).join("")}printSetup(m){return m===void 0?"":"a=setup:".concat(m).concat(this.eol)}printUnrecognized(m){return m.map(I=>"a=".concat(I.attField).concat(I.attValue?":".concat(I.attValue):"").concat(this.eol)).join("")}}class G extends x{print(m){let I="";return I+=this.printGroups(m.groups),I+=this.printMsidSemantic(m.msidSemantic),I+=this.printIceLite(m.iceLite),I+=this.printIceUfrag(m.iceUfrag),I+=this.printIcePwd(m.icePwd),I+=this.printIceOptions(m.iceOptions),I+=this.printFingerprints(m.fingerprints),I+=this.printSetup(m.setup),I+=this.printTlsId(m.tlsId),I+=this.printIdentity(m.identities),I+=this.printExtmap(m.extmaps),I+=this.printUnrecognized(m.unrecognized),I}printGroups(m){let I="";return m.length>0&&(I+=m.map(b=>"a=group:".concat(b.semantic).concat(b.identificationTag.map(B=>"".concat(l).concat(B)).join("")).concat(this.eol)).join("")),I}printIceLite(m){return m===void 0?"":"a=ice-lite"+this.eol}printTlsId(m){return m?"a=tls-id:".concat(m).concat(this.eol):""}printIdentity(m){return m.length===0?"":m.map(I=>"a=identity:".concat(I.assertionValue).concat(I.extensions.map(b=>"".concat(l).concat(b.name).concat(b.value?"=".concat(b.value):"")))).join(this.eol)+this.eol}printMsidSemantic(m){if(!m)return"";let I="a=msid-semantic:".concat(m.semantic);return m.applyForAll?I+="".concat(l,"*"):m.identifierList.length>0&&(I+=m.identifierList.map(b=>"".concat(l).concat(b))),I+this.eol}}class Y extends x{print(m){const I=m.attributes;let b="";return b+=this.printRTCP(I.rtcp),b+=this.printIceUfrag(I.iceUfrag),b+=this.printIcePwd(I.icePwd),b+=this.printIceOptions(I.iceOptions),b+=this.printCandidates(I.candidates),b+=this.printRemoteCandidatesList(I.remoteCandidatesList),b+=this.printEndOfCandidates(I.endOfCandidates),b+=this.printFingerprints(I.fingerprints),b+=this.printSetup(I.setup),b+=this.printMid(I.mid),b+=this.printExtmap(I.extmaps),b+=this.printRTPRelated(I),b+=this.printPtime(I.ptime),b+=this.printMaxPtime(I.maxPtime),b+=this.printDirection(I.direction),b+=this.printSSRCGroups(I.ssrcGroups),b+=this.printSSRC(I.ssrcs),b+=this.printRTCPMux(I.rtcpMux),b+=this.printRTCPMuxOnly(I.rtcpMuxOnly),b+=this.printRTCPRsize(I.rtcpRsize),b+=this.printMSId(I.msids),b+=this.printImageattr(I.imageattr),b+=this.printRid(I.rids),b+=this.printSimulcast(I.simulcast),b+=this.printSCTPPort(I.sctpPort),b+=this.printMaxMessageSize(I.maxMessageSize),b+=this.printUnrecognized(I.unrecognized),b}printCandidates(m){return m.map(I=>"a=candidate:".concat(I.foundation).concat(l).concat(I.componentId).concat(l).concat(I.transport).concat(l).concat(I.priority).concat(l).concat(I.connectionAddress).concat(l).concat(I.port).concat(l,"typ").concat(l).concat(I.type).concat(I.relAddr?"".concat(l,"raddr").concat(l).concat(I.relAddr):"").concat(I.relPort?"".concat(l,"rport").concat(l).concat(I.relPort):"").concat(Object.keys(I.extension).map(b=>"".concat(l).concat(b).concat(l).concat(I.extension[b])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(m){return m.map(I=>"a=remote-candidates:".concat(I.join(l)).concat(this.eol)).join("")}printEndOfCandidates(m){return m===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(m){if(!m.payloads)return"";const I=m.payloads;let b="";b+=m.rtcpFeedbackWildcards.map(B=>this.printRTCPFeedback("*",B)).join("");for(const B of I)b+=this.printRtpMap(B.payloadType,B.rtpMap),b+=this.printFmtp(B.payloadType,B.fmtp),b+=B.rtcpFeedbacks.map(rt=>this.printRTCPFeedback(B.payloadType,rt)).join("");return b}printFmtp(m,I){if(!I)return"";const b=Object.keys(I.parameters);return b.length===1&&I.parameters[b[0]]===null?"a=fmtp:".concat(m).concat(l).concat(b[0]).concat(this.eol):"a=fmtp:".concat(m).concat(l).concat(Object.keys(I.parameters).map(B=>"".concat(B,"=").concat(I.parameters[B])).join(";")).concat(this.eol)}printRtpMap(m,I){return I?"a=rtpmap:".concat(m).concat(l).concat(I.encodingName,"/").concat(I.clockRate).concat(I.encodingParameters?"/".concat(I.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(m,I){let b="a=rtcp-fb:".concat(m).concat(l),B=I;return B.type==="trr-int"?b+="ttr-int".concat(l).concat(B.interval):(b+="".concat(B.type),B.parameter&&(b+="".concat(l).concat(B.parameter),B.additional&&(b+="".concat(l).concat(B.additional)))),b+this.eol}printPtime(m){return m===void 0?"":"a=ptime:".concat(m).concat(this.eol)}printMaxPtime(m){return m===void 0?"":"a=maxptime:".concat(m).concat(this.eol)}printDirection(m){return m===void 0?"":"a=".concat(m).concat(this.eol)}printSSRC(m){return m.map(I=>Object.keys(I.attributes).map(b=>"a=ssrc:".concat(I.ssrcId.toString(10)).concat(l).concat(b).concat(I.attributes[b]?":".concat(I.attributes[b]):"").concat(this.eol)).join("")).join("")}printRTCPMux(m){return m===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(m){return m===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(m){return m===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(m){if(m===void 0)return"";let I="a=rtcp:".concat(m.port);return m.netType&&(I+="".concat(l).concat(m.netType)),m.addressType&&(I+="".concat(l).concat(m.addressType)),m.address&&(I+="".concat(l).concat(m.address)),I+this.eol}printMSId(m){return m.map(I=>"a=msid:".concat(I.id).concat(I.appdata?"".concat(l).concat(I.appdata):"").concat(this.eol)).join("")}printImageattr(m){return m.map(I=>"a=imageattr:".concat(I).concat(this.eol)).join("")}printRid(m){return m.map(I=>{let b="a=rid:".concat(I.id).concat(l).concat(I.direction);return I.payloads&&(b+="".concat(l,"pt=").concat(I.payloads.join(","))),I.params.length>0&&(b+="".concat(l).concat(I.params.map(B=>B.type==="depend"?"depend=".concat(B.rids.join(",")):"".concat(B.type,"=").concat(B.val)).join(";"))),b+this.eol}).join("")}printSimulcast(m){return m===void 0?"":"a=simulcast:".concat(m).concat(this.eol)}printSCTPPort(m){return m===void 0?"":"a=sctp-port:".concat(m).concat(this.eol)}printMaxMessageSize(m){return m===void 0?"":"a=max-message-size:".concat(m).concat(this.eol)}printMid(m){return m===void 0?"":"a=mid:".concat(m).concat(this.eol)}printSSRCGroups(m){return m.map(I=>"a=ssrc-group:".concat(I.semantic).concat(I.ssrcIds.map(b=>"".concat(l).concat(b.toString(10))).join("")).concat(this.eol)).join("")}}function st(W){return new it().parse(W)}function gt(W,m){return new Ai().print(W,m)}}},n={};function s(r){if(n[r])return n[r].exports;var o=n[r]={exports:{}};return e[r](o,o.exports,s),o.exports}return s.d=(r,o)=>{for(var a in o)s.o(o,a)&&!s.o(r,a)&&Object.defineProperty(r,a,{enumerable:!0,get:o[a]})},s.o=(r,o)=>Object.prototype.hasOwnProperty.call(r,o),s.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},s(8)})()})(JC);var Ht=JC.exports;function mn(i){if(Array.isArray(i))return i.map(e=>e);if(!zC(i))return i;const t={};for(const e in i){const n=i[e];zC(n)||Array.isArray(n)?t[e]=mn(n):t[e]=n}return t}function zC(i){return!(typeof i!="object"||Array.isArray(i)||!i)}class qp{constructor(t){h(this,"input",[]),h(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Hn={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Ba={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Hn,remoteCandidate:Hn}},XC={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},QC={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},ZC={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},$C={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function tI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function eI(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?tI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):tI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Jp{constructor(t,e){h(this,"onFirstVideoReceived",void 0),h(this,"onFirstVideoDecoded",void 0),h(this,"onFirstAudioReceived",void 0),h(this,"onFirstVideoDecodedTimeout",void 0),h(this,"onFirstAudioDecoded",void 0),h(this,"onSelectedLocalCandidateChanged",void 0),h(this,"onSelectedRemoteCandidateChanged",void 0),h(this,"videoIsReady",!1),h(this,"videoIsReady2",{}),h(this,"pc",void 0),h(this,"options",void 0),h(this,"intervalTimer",void 0),h(this,"stats",mn(Ba)),h(this,"isFirstVideoReceived",{}),h(this,"isFirstVideoDecoded",{}),h(this,"isFirstAudioReceived",{}),h(this,"isFirstAudioDecoded",{}),h(this,"isFirstVideoDecodedTimeout",{}),h(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new P(t=>{t({local:eI({},Hn),remote:eI({},Hn)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let s=0,r=0,o=0,a=0;for(const c of n)t[c].forEach((d,l)=>{if(!this.lossRateWindowStats[e-1][c][l]||!this.lossRateWindowStats[0][c][l])return;const u=this.lossRateWindowStats[e-1][c][l].packets-this.lossRateWindowStats[0][c][l].packets,p=this.lossRateWindowStats[e-1][c][l].packetsLost-this.lossRateWindowStats[0][c][l].packetsLost;c==="videoSend"||c==="audioSend"?(s+=u,o+=p):(r+=u,a+=p),Number.isNaN(u)||Number.isNaN(u)?d.packetLostRate=0:d.packetLostRate=u<=0||p<=0?0:p/(u+p)});t.sendPacketLossRate=s<=0||o<=0?0:o/(s+o),t.recvPacketLossRate=r<=0||a<=0?0:a/(r+a)}}function iI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function I1(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?iI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):iI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class v1 extends Jp{constructor(){super(...arguments),h(this,"_stats",Ba),h(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=mn(Ba);const n=e.filter(r=>r.type==="ssrc");this.processSSRCStats(n);const s=e.find(r=>r.type==="VideoBwe");s&&this.processBandwidthStats(s),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var n;const s=q(n=e.id).call(n,"send");switch("".concat(e.mediaType,"_").concat(s?"send":"recv")){case"video_send":{const r=mn(QC);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=mn(XC),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){const a=o.stats,c=Date.now()-o.lts;r.framesDecodeFreezeTime=a.framesDecodeFreezeTime,r.framesDecodeInterval=a.framesDecodeInterval,r.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=c,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:I1({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=mn($C);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=mn(ZC);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new P((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){const e=[];return t.result().forEach(n=>{const s={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach(r=>{s[r]=n.stat(r)}),e.push(s)}),e}}function nI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Pr(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?nI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):nI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class sI extends Jp{constructor(){super(...arguments),h(this,"_stats",Ba),h(this,"report",void 0),h(this,"lastDecodeVideoReceiverStats",new Map),h(this,"lastVideoFramesRecv",new Map),h(this,"lastVideoFramesSent",new Map),h(this,"lastVideoFramesDecode",new Map),h(this,"lastVideoJBDelay",new Map),h(this,"lastAudioJBDelay",new Map),h(this,"mediaBytesSent",new Map),h(this,"mediaBytesRetransmit",new Map),h(this,"mediaBytesTargetEncode",new Map),h(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=mn(Ba),this.report.forEach(t=>{switch(t.type){case pi.OUTBOUND:case pi.INBOUND:{const e=t.mediaType||t.kind,n=!e&&"frameWidth"in t,s=!e&&!("frameWidth"in t);t.type===pi.OUTBOUND?e==="audio"||s?this.processAudioOutboundStats(t):(e==="video"||n)&&this.processVideoOutboundStats(t):t.type===pi.INBOUND&&(e==="audio"||s?this.processAudioInboundStats(t):(e==="video"||n)&&this.processVideoInboundStats(t));break}case pi.TRANSPORT:{const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case pi.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:Pr({},Hn),remote:Pr({},Hn)};return t.forEach(n=>{let s;if(n.type===pi.TRANSPORT&&(s=t.get(n.selectedCandidatePairId)),n.type===pi.CANDIDATE_PAIR&&n.selected&&(s=n),s){const r=(o,a)=>{o.type=a.type,o.id=a.id,a.address&&(o.address=a.address),a.candidateType&&(o.candidateType=a.candidateType),a.port&&(o.port=a.port),a.priority&&(o.priority=a.priority),a.protocol&&(o.protocol=a.protocol),a.relayProtocol&&(o.relayProtocol=a.relayProtocol)};if(s.localCandidateId){const o=t.get(s.localCandidateId);o&&r(e.local,o)}if(s.remoteCandidateId){const o=t.get(s.remoteCandidateId);o&&r(e.remote,o)}}}),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===pi.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===pi.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===pi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Pr({},e),Pr({},this.stats.selectedCandidatePair.localCandidate)),t.type===pi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Pr({},e),Pr({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(n=>n.ssrc===t.ssrc);e||(e=mn($C),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let e=this._stats.videoRecv.find(o=>o.ssrc===t.ssrc);e||(e=mn(XC),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay;const n=this.lastDecodeVideoReceiverStats.get(e.ssrc),s=this.lastVideoFramesDecode.get(e.ssrc),r=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const o=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,o,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(n){const o=n.stats,a=r-n.lts;e.framesDecodeFreezeTime=o.framesDecodeFreezeTime,e.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(n.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<o.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(n.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-n.qpSum)/(t.framesDecoded-n.stats.framesDecodeCount))}s&&r-s.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-s.count)/((r-s.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:r,rate:e.decodeFrameRate})):s?e.decodeFrameRate=s.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:r,rate:0}),t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:Pr({},e),lts:n?n.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(s=>s.ssrc===t.ssrc);e||(e=mn(QC),this._stats.videoSend.push(e));const n=this.mediaBytesSent.get(t.ssrc);if(n)n.add(t.bytesSent);else{const s=new qp(10);s.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,s)}if(t.retransmittedBytesSent!==void 0){const s=this.mediaBytesRetransmit.get(t.ssrc);if(s)s.add(t.retransmittedBytesSent);else{const r=new qp(10);r.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,r)}}if(t.totalEncodedBytesTarget){const s=this.mediaBytesTargetEncode.get(t.ssrc);if(s)s.add(t.totalEncodedBytesTarget);else{const r=new qp(10);r.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,r)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){const s=this.lastEncoderMs.get(t.ssrc);if(!s||s.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const r=t.framesEncoded-s.lastFrameCount,o=t.totalEncodeTime-s.lastEncoderTime;e.avgEncodeMs=1e3*o/r}}if(t.framesEncoded&&t.qpSum){const s=this.lastEncoderMs.get(t.ssrc);!s||s.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-s.lastQpSum)/(t.framesEncoded-s.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const s=this.findRemoteStatsId(t.ssrc,pi.REMOTE_INBOUND);s&&this.processRemoteInboundStats(s,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(n=>n.ssrc===t.ssrc);if(e||(e=mn(ZC),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const n=this.findRemoteStatsId(t.ssrc,pi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}findRemoteStatsId(t,e){var n;const s=Array.from(In(n=this.report).call(n)).find(r=>r.type===e&&r.ssrc===t);return s?s.id:null}processVideoMediaSource(t,e){const n=this.report.get(t);n&&n.width&&n.height&&n.framesPerSecond&&(e.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(t,e){const n=this.report.get(t);n&&(e.inputLevel=n.audioLevel)}processVideoTrackSenderStats(t,e,n){var s,r,o,a;const c=e?this.report.get(e):void 0,d=(s=c==null?void 0:c.framesSent)!==null&&s!==void 0?s:t.framesSent;if(typeof d!="number")return;let l=(r=c==null?void 0:c.frameWidth)!==null&&r!==void 0?r:t.frameWidth,u=(o=c==null?void 0:c.frameHeight)!==null&&o!==void 0?o:t.frameHeight,p=(a=c==null?void 0:c.framesPerSecond)!==null&&a!==void 0?a:t.framesPerSecond;if(typeof l=="number"&&typeof u=="number"||(l=0,u=0),p==null){const _=Date.now(),S=this.lastVideoFramesSent.get(n.ssrc);S&&_-S.lts>=800?(p=Math.round((d-S.count)/((_-S.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:d,lts:_,rate:p})):S?p=S.rate:this.lastVideoFramesSent.set(n.ssrc,{count:d,lts:_,rate:0})}n.sentFrame={width:l,height:u,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(t,e,n){var s,r,o,a,c;const d=e?this.report.get(e):void 0,l=(s=d==null?void 0:d.framesReceived)!==null&&s!==void 0?s:t.framesReceived,u=(r=d==null?void 0:d.frameWidth)!==null&&r!==void 0?r:t.frameWidth,p=(o=d==null?void 0:d.frameHeight)!==null&&o!==void 0?o:t.frameHeight,_=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:t.jitterBufferDelay,S=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:t.jitterBufferEmittedCount;if(typeof l=="number"){const f=this.lastVideoFramesRecv.get(n.ssrc),g=Date.now();n.framesReceivedCount=l;let C=0;f&&g-f.lts>=800?(C=Math.round((l-f.count)/((g-f.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:l,lts:g,rate:C})):f?C=f.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:l,lts:g,rate:0}),n.receivedFrame={width:u||0,height:p||0,frameRate:C||0},n.decodedFrame={width:u||0,height:p||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:u||0,height:p||0,frameRate:n.decodeFrameRate||0}}if(_&&S){const f=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let g=f.jitterBufferMs;const C=S-f.jitterBufferEmittedCount;C>0&&(g=1e3*(_-f.jitterBufferDelay)/C),n.jitterBufferMs=g,n.currentDelayMs=Math.round(g),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:_,jitterBufferEmittedCount:S,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(t,e,n){var s,r,o,a;const c=e?this.report.get(e):void 0,d=(s=(r=c==null?void 0:c.echoReturnLoss)!==null&&r!==void 0?r:t.echoReturnLoss)!==null&&s!==void 0?s:0,l=(o=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:t.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;n.aecReturnLoss=d,n.aecReturnLossEnhancement=l}processAudioTrackReceiverStats(t,e,n){var s,r,o,a,c,d,l;const u=e?this.report.get(e):void 0,p=(s=u==null?void 0:u.removedSamplesForAcceleration)!==null&&s!==void 0?s:t.removedSamplesForAcceleration,_=(r=u==null?void 0:u.totalSamplesReceived)!==null&&r!==void 0?r:t.totalSamplesReceived,S=(o=u==null?void 0:u.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,f=(a=u==null?void 0:u.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount,g=(c=u==null?void 0:u.audioLevel)!==null&&c!==void 0?c:t==null?void 0:t.audioLevel,C=(d=u==null?void 0:u.totalSamplesDuration)!==null&&d!==void 0?d:t==null?void 0:t.totalSamplesDuration,y=(l=u==null?void 0:u.concealedSamples)!==null&&l!==void 0?l:t.concealedSamples;if(p&&_&&(n.accelerateRate=p/_),S&&f){const k=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let O=k.jitterBufferMs;const N=f-k.jitterBufferEmittedCount;N>0&&(O=1e3*(S-k.jitterBufferDelay)/N),n.jitterBufferMs=Math.round(O),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:S,jitterBufferEmittedCount:f,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=g;let A=1920;C&&_&&(A=_/C/50,n.receivedFrames=Math.round(_/A)),y&&(n.droppedFrames=Math.round(y/A))}processRemoteInboundStats(t,e){const n=this.report.get(t);n&&(e.packetsLost=n.packetsLost,n.roundTripTime&&(e.rttMs=1e3*n.roundTripTime),n.jitter&&(e.jitterMs=1e3*n.jitter),n.timestamp&&(e.timestamp=n.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const n=e.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let t=0,e=null,n=null;this.mediaBytesSent.forEach(r=>{t+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{e=e===null?r.diffMean():e+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{n=n===null?r.diffMean():n+r.diffMean()});const s=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*s/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}}class y1 extends Jp{updateStats(){return P.resolve()}}function Hd(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const r=function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null}();return r?r<76?new v1(i,{updateInterval:t,lossRateInterval:e,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new sI(i,{updateInterval:t,lossRateInterval:e,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(o){return!!window.RTCStatsReport&&o.getStats()instanceof P}(i)?new sI(i,{updateInterval:t,lossRateInterval:e,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new y1(i,{updateInterval:t,lossRateInterval:e,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function rI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function oI(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?rI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):rI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function ja(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:r,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=e;let l=[],u=[],p=[],_=[],S=!1,f=!1;if(Ht.parse(i).mediaDescriptions.forEach(C=>{n&&n!==C.attributes.direction||(C.media.mediaType!=="video"||S||(u=C.attributes.payloads,_=C.attributes.extmaps,S=!0),C.media.mediaType!=="audio"||f||(l=C.attributes.payloads,p=C.attributes.extmaps,f=!0))}),!_||u.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!p||l.length===0)throw new Error("Cannot get audio capabilities from SDP.");u.forEach(C=>{var y;(y=C.rtpMap)!==null&&y!==void 0&&y.clockRate&&(C.rtpMap.clockRate=parseInt(C.rtpMap.clockRate)),d&&C.rtcpFeedbacks.push({type:"rrtr"})}),l.forEach(C=>{var y;(y=C.rtpMap)!==null&&y!==void 0&&y.clockRate&&(C.rtpMap.clockRate=parseInt(C.rtpMap.clockRate)),d&&C.rtcpFeedbacks.push({type:"rrtr"})}),s&&(l=l.filter(C=>{var y;return((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())!=="rtx"}),u=u.filter(C=>{var y;return((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())!=="rtx"})),r&&(u=u.filter(C=>{var y;return!/(red)|(ulpfec)|(flexfec)/i.test(((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName)||"")})),o&&(l=l.filter(C=>{var y;return!/(red)|(ulpfec)|(flexfec)/i.test(((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(l=l.filter(C=>{var y;return q(a).call(a,((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0&&(u=u.filter(C=>{var y;return q(c).call(c,((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())||"")}));const g=v("UNSUPPORTED_VIDEO_CODEC");return g&&g.length>0&&(u=u.filter(C=>!(C.rtpMap&&q(g).call(g,C.rtpMap.encodingName.toLowerCase())))),{audioCodecs:l,videoCodecs:u,audioExtensions:p,videoExtensions:_}}function An(i){const t=Ht.parse(i);let e,n;for(const s of t.mediaDescriptions){if(!e){const r=s.attributes.iceUfrag,o=s.attributes.icePwd;if(!r||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");e={iceUfrag:r,icePwd:o}}if(!n){const r=s.attributes.fingerprints;r.length>0&&(n={fingerprints:r})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!e)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:e,dtlsParameters:n}}function zp(i,t){const e=[],n=i.attributes.ssrcGroups.filter(o=>o.semantic==="FID"),s=i.attributes.ssrcGroups.find(o=>o.semantic==="SIM"),r=i.attributes.ssrcs;if(s)s.ssrcIds.forEach(o=>{var a;const c=(a=n.find(d=>d.ssrcIds[0]===o))===null||a===void 0?void 0:a.ssrcIds[1];e.push({ssrcId:o,rtx:t?c:void 0})});else if(n.length>0){const o=n[0].ssrcIds[0],a=n[0].ssrcIds[1];e.push({ssrcId:o,rtx:t?a:void 0})}else{if(r.length===0)throw new Error("No ssrcs found on local media description.");e.push({ssrcId:r[0].ssrcId})}return e}function aI(i,t){const{cname:e}=i;let n;t&&t.ip&&typeof t.port=="number"?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],E.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),E.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):n=i.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));const s={fingerprints:i.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},r={iceUfrag:i.iceParameters.iceUfrag,icePwd:i.iceParameters.icePwd};let o;switch(i.dtlsParameters.role){case"server":o="passive";break;case"client":o="active";break;case"auto":o="actpass"}return{dtlsParameters:s,iceParameters:r,candidates:n,rtpCapabilities:Do(i.rtpCapabilities),setup:o,cname:e}}function fi(i,t,e){const n=[],s=[];return i.forEach(r=>{let{ssrcId:o,rtx:a}=r;const c=Pt(8,"track-"),d={ssrcId:o,attributes:oI({label:c,mslabel:e=e||Pt(10,""),msid:"".concat(e," ").concat(c)},t&&{cname:t})};if(n.push(d),a!==void 0){const l={ssrcId:a,attributes:oI({label:c,mslabel:e,msid:"".concat(e," ").concat(c)},t&&{cname:t})};n.push(l),s.push({semantic:"FID",ssrcIds:[o,a]})}}),i.length>1&&s.push({semantic:"SIM",ssrcIds:i.map(r=>{let{ssrcId:o}=r;return o})}),{ssrcs:n,ssrcGroups:s}}function Hs(i,t){t instanceof Ct&&i.attributes.payloads.forEach(e=>{var n;const s=(n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase();if(!s||["opus","pcmu","pcma","g722"].indexOf(s)===-1)return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const r=t._encoderConfig;r&&s!=="pcmu"&&s!=="pcma"&&s!=="g722"&&(r.bitrate&&!Nt()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*r.bitrate))),r.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(r.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(r.sampleRate)),r.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))})}function Kd(i){const t=i.attributes.unrecognized.findIndex(e=>e.attField==="x-google-flag"&&e.attValue==="conference");t!==-1&&i.attributes.unrecognized.splice(t,1)}function Yd(i,t){var e;if(!(t instanceof dt&&t._encoderConfig&&t._hints.indexOf(Mt.SCREEN_TRACK)===-1))return;const n=t._encoderConfig;Ot().supportMinBitrate&&n.bitrateMin&&i.attributes.payloads.forEach(s=>{var r,o;q(r=["h264","h265","vp8","vp9","av1"]).call(r,((o=s.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(s.fmtp||(s.fmtp={parameters:{}}),s.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))}),Ot().supportMinBitrate&&!q(e=t._hints).call(e,Mt.LOW_STREAM)&&n.bitrateMax&&i.attributes.payloads.forEach(s=>{var r,o;q(r=["h264","h265","vp8","vp9","av1"]).call(r,((o=s.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(s.fmtp||(s.fmtp={parameters:{}}),s.fmtp.parameters["x-google-start-bitrate"]="".concat(v("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))})}function Xp(i){if(i.media.mediaType!=="video")return;const t=ft();if(t.name!==Rt.SAFARI&&t.os!==_e.IOS)return;const e=i.attributes.extmaps.findIndex(n=>/video-orientation/g.test(n.extensionName));e!==-1&&i.attributes.extmaps.splice(e,1)}function No(i,t,e){if(!t)return;let n,s;if(i.media.mediaType==="video"?(n=e.videoExtensions,s=e.videoCodecs):(n=e.audioExtensions,s=e.audioCodecs),t.twcc===!0){const r=n.find(o=>o.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");r&&(i.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||i.attributes.extmaps.push({entry:r.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="transport-cc")))}(s,i.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(t.twcc===!1){const r=i.attributes.extmaps.findIndex(o=>o.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");r!==-1&&i.attributes.extmaps.splice(r,1),i.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}if(t.remb===!0){const r=n.find(o=>o.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");r&&(i.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||i.attributes.extmaps.push({entry:r.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="goog-remb")))}(s,i.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(t.remb===!1){const r=i.attributes.extmaps.findIndex(o=>o.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");r!==-1&&i.attributes.extmaps.splice(r,1),i.attributes.payloads.forEach(o=>{const a=o.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&o.rtcpFeedbacks.splice(a,1)})}}function Qp(i,t,e){if(Nt()||i.media.mediaType!=="video"||!(t instanceof dt)||e!=="vp9"&&e!=="vp8"||e==="vp8"&&!v("SIMULCAST")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const n=e==="vp8"?2:t._scalabilityMode.numSpatialLayers,s=i.attributes.ssrcs[0],r=i.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===s.ssrcId),o={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let a=1;a<n;a++)i.attributes.ssrcs.push({ssrcId:s.ssrcId+a,attributes:kt(s.attributes)}),o.ssrcIds.push(s.ssrcId+a),r&&(i.attributes.ssrcs.push({ssrcId:r.ssrcIds[1]+a,attributes:kt(s.attributes)}),i.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+a,r.ssrcIds[1]+a]}));i.attributes.ssrcGroups.unshift(o)}async function Zp(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly"}),e.addTransceiver("audio",{direction:"sendonly"}),e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"});const n=(await e.createOffer()).sdp,{send:s,recv:r,sendrecv:o}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const l=ja(d,a,c,"sendonly"),u=ja(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(fn(l,u,"videoExtensions",p,_,S),fn(l,u,"videoCodecs",p,_,S),fn(l,u,"audioExtensions",p,_,S),fn(l,u,"audioCodecs",p,_,S),v("RAISE_H264_BASELINE_PRIORITY")){const f=S.videoCodecs.findIndex(g=>{var C,y;return((C=g.rtpMap)===null||C===void 0?void 0:C.encodingName.toLocaleLowerCase())==="h264"&&((y=g.fmtp)===null||y===void 0?void 0:y.parameters["profile-level-id"])==="42001f"});if(f!==-1){const g=S.videoCodecs.findIndex(C=>{var y;return((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"});if(g<f){E.debug("raising H264 baseline profile priority");const C=S.videoCodecs[f];S.videoCodecs.splice(f,1),S.videoCodecs.splice(g,0,C)}g!==-1&&(_.videoCodecs=_.videoCodecs.filter(C=>{var y,A;return!(((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"&&((A=C.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!=="42001f")})),g!==-1&&v("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(C=>{var y,A;return!(((y=C.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"&&((A=C.fmtp)===null||A===void 0?void 0:A.parameters["profile-level-id"])!=="42001f")}))}}return{send:p,recv:_,sendrecv:S}}(i,t,n);try{e.close()}catch{}return{send:s,recv:r,sendrecv:o}}function cI(){const i={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=ja(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),e={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(fn(i,t,"videoExtensions",e,n,s),fn(i,t,"videoCodecs",e,n,s),fn(i,t,"audioExtensions",e,n,s),fn(i,t,"audioCodecs",e,n,s),v("RAISE_H264_BASELINE_PRIORITY")){const r=s.videoCodecs.findIndex(o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f");if(r!==-1){const o=s.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(o<r){E.debug("raising H264 baseline profile priority");const a=s.videoCodecs[r];s.videoCodecs.splice(r,1),s.videoCodecs.splice(o,0,a)}o!==-1&&(n.videoCodecs=n.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:e,recv:n,sendrecv:s}}function fn(i,t,e,n,s,r){if(e==="videoExtensions"||e==="audioExtensions"){const o=[];return i[e].forEach(a=>{t[e].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(d),!0})?r[e].push(a):n[e].push(a)}),void t[e].forEach((a,c)=>{o.indexOf(c)===-1&&s[e].push(a)})}if(e==="videoCodecs"||e==="audioCodecs"){const o=[];return i[e].forEach(a=>{t[e].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(d),!0})?r[e].push(a):n[e].push(a)}),void t[e].forEach((a,c)=>{o.indexOf(c)===-1&&s[e].push(a)})}}function Do(i){const{send:t,recv:e,sendrecv:n}=i;if(!n){if(!t||!e)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:e}}let s,r;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...n.audioCodecs],r.videoCodecs=[...e.videoCodecs,...n.videoCodecs],r.audioExtensions=[...e.audioExtensions,...n.audioExtensions],r.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):r=n,{send:s,recv:r}}function bn(i){i.media.mediaType==="audio"&&i.attributes.payloads.filter(t=>{var e;return((e=t.rtpMap)===null||e===void 0?void 0:e.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function Ga(i){i.mediaDescriptions.forEach(t=>{t.media.mediaType!=="video"&&t.media.mediaType!=="audio"||t.attributes.payloads.forEach(e=>{e.rtcpFeedbacks.findIndex(n=>n.type==="rrtr")===-1&&e.rtcpFeedbacks.push({type:"rrtr"})})})}function Lr(i,t,e,n){let s=[];if(i===J.VIDEO){if(v("H264_PROFILE_LEVEL_ID")&&n==="h264"&&(s=t.videoCodecs.filter(r=>{var o;return q(o=r.rtpMap&&r.rtpMap.encodingName.toLowerCase()||"").call(o,n)&&r&&r.fmtp&&r.fmtp.parameters["profile-level-id"]===v("H264_PROFILE_LEVEL_ID")})),!Array.isArray(s)||s.length===0){let r=[];const o=[],a=[];e.videoCodecs.forEach(c=>{var d,l,u;q(d=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(d,n)&&r.push(c),q(l=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(l,"vp8")&&o.push(c),q(u=c.rtpMap&&c.rtpMap.encodingName.toLowerCase()||"").call(u,"h264")&&a.push(c)}),r.length===0&&(o.length!==0?(r=o,E.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: vp8"))):a.length!==0&&(r=a,E.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: h264")))),r.length!==0&&(s=t.videoCodecs.filter(c=>r.some(d=>d.payloadType===c.payloadType)))}if(v("USE_PUB_RTX")){const r=s.map(a=>a.payloadType.toString()),o=t.videoCodecs.filter(a=>a.rtpMap&&a.rtpMap.encodingName==="rtx"&&q(r).call(r,a.fmtp&&a.fmtp.parameters.apt||""));s=[...s,...o]}s.length===0&&(E.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),s=t.videoCodecs)}else s=t.audioCodecs.filter(r=>{var o;return q(o=r.rtpMap&&r.rtpMap.encodingName.toLowerCase()||"").call(o,n)}),s.length===0&&(E.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),s=t.audioCodecs.filter(r=>{var o;return q(o=r.rtpMap&&r.rtpMap.encodingName.toLowerCase()||"").call(o,"opus")}));return s}let dI=class{get localCapabilities(){return kt(this._localCapabilities)}get rtpCapabilities(){return kt(this._rtpCapabilities)}get candidates(){return kt(this._candidates)}get iceParameters(){return kt(this._iceParameters)}get dtlsParameters(){return kt(this._dtlsParameters)}constructor(i){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname","o/i14u9pJrxRKAsu"),h(this,"firefoxSsrcMidMap",new Map),i=kt(i);const{remoteIceParameters:t,remoteDtlsParameters:e,candidates:n,remoteRTPCapabilities:s,localCapabilities:r,direction:o,setup:a,videoCodec:c,audioCodec:d}=i;let l;this.setup=a,l=o===He.RECEIVE_ONLY?Ht.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Ht.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=e,this._localCapabilities=r;const u=o===He.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=o===He.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,_=o===He.RECEIVE_ONLY?s.send.videoCodecs:Lr(J.VIDEO,u,p,c),S=o===He.RECEIVE_ONLY?s.send.audioCodecs:Lr(J.AUDIO,u,p,d);for(const f of l.mediaDescriptions){if(f.attributes.iceUfrag=t.iceUfrag,f.attributes.icePwd=t.icePwd,f.attributes.fingerprints=e.fingerprints,f.attributes.candidates=n,f.attributes.setup=this.setup,f.media.mediaType==="application"&&(f.attributes.sctpPort="5000"),f.media.mediaType==="video"&&(f.media.fmts=_.map(g=>g.payloadType.toString(10)),f.attributes.payloads=_,f.attributes.extmaps=u.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:g,ssrcGroups:C}=fi([{ssrcId:4e4,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);f.attributes.ssrcs=g,f.attributes.ssrcGroups=C}if(f.media.mediaType==="audio"&&(f.media.fmts=S.map(g=>g.payloadType.toString(10)),f.attributes.payloads=S,f.attributes.extmaps=u.audioExtensions,bn(f),v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:g,ssrcGroups:C}=fi([{ssrcId:2e4}],this.cname);f.attributes.ssrcs=g,f.attributes.ssrcGroups=C}}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Ht.print(this.sessionDesc)}hasMid(i){return Array.isArray(i)?i.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===i)}send(i,t,e,n,s){e=e.replace(/ /g,"-");const{ssrcs:r,ssrcGroups:o}=fi(t,this.cname,v("SYNC_GROUP")?e:void 0),a=this.findPreloadMediaDesc(r);if(a){if(Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,a.attributes.mid),s&&(s.twcc||s.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,s),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(i,r,n);let d;return c===-1?(d=this.createOrRecycleSendMedia(i,r,o,"sendonly",n,s),this.updateBundleMids()):(d=kt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=r,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,s)),Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(i){const t=this.sessionDesc.mediaDescriptions.filter(e=>e.attributes.mid&&i.indexOf(e.attributes.mid)!==-1);if(t.length!==i.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(e=>{e.attributes.ssrcs=[]}),this.updateBundleMids()}receive(i,t,e){const n=[];return i.forEach(s=>{const r=s._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(r);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(s,[],"recvonly",t,e),this.updateBundleMids()):(a=kt(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),n.push({mid:a.attributes.mid,needCreateTransceiver:c})}),n}stopReceiving(i){const t=this.sessionDesc.mediaDescriptions.filter(e=>i.indexOf(e.attributes.mid)!==-1);if(t.length!==i.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(e=>{e.media.port="0",e.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(i){const{foundation:t,protocol:e,address:n,port:s,type:r,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(i),d={foundation:t??"",componentId:"1",transport:e??"",priority:c?c+"":"",connectionAddress:n??"",port:s?s+"":"",type:r?r+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(i,t,e,n,s){const r=i._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=Lr(r,o,this.localCapabilities.send,r===J.AUDIO?s:n),c=r===J.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:r,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:e,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,i);const u=this.findFirstClosedMedia(r);if(u){const p=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(i){const t=this.sessionDesc.mediaDescriptions.filter(e=>q(i).call(i,e.attributes.mid||""));if(t.length!==i.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(e=>{e.attributes.direction="inactive"})}unmuteRemote(i){const t=this.sessionDesc.mediaDescriptions.filter(e=>q(i).call(i,e.attributes.mid||""));if(t.length!==i.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(e=>{e.attributes.direction="recvonly"})}findAvailableMediaIndex(i,t,e){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const s=n.media.mediaType===i&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(Nt()){if(s){const r=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return s&&n.attributes.mid===e})}findAvailableRecvMediaIndex(i){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const e=t.media.mediaType===i&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&e})}predictReceivingMids(i){const t=[];for(let e=0;e<i;e++)t.push((this.currentMidIndex+e+1).toString(10));return t}restartICE(i){i=kt(i),this._iceParameters=i,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=i.iceUfrag,t.attributes.icePwd=i.icePwd})}createOrRecycleSendMedia(i,t,e,n,s,r){const o=this.rtpCapabilities.send,a=i===J.VIDEO?o.videoCodecs:o.audioCodecs,c=i===J.VIDEO?o.videoExtensions:o.audioExtensions;Nt()&&(s="".concat(++this.currentMidIndex));let d={media:{mediaType:i,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:e,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:s}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(i);if(l){const u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(i,t,e){const n=kt(i);return Kd(n),Hs(n,t),Yd(n,t),Xp(n),No(n,e,this.localCapabilities.send),n}mungSendMediaDesc(i,t){const e=kt(i);return No(e,t,this.localCapabilities.recv),bn(e),e}updateRecvMedia(i,t){const e=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===i);if(e!==-1){const n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[e],t);this.sessionDesc.mediaDescriptions[e]=n}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(i=>i.media.port!=="0").map(i=>i.attributes.mid)}findPreloadMediaDesc(i){return this.sessionDesc.mediaDescriptions.find(t=>{var e;return((e=t.attributes)===null||e===void 0||(e=e.ssrcs[0])===null||e===void 0?void 0:e.ssrcId)===i[0].ssrcId})}findFirstClosedMedia(i){return this.sessionDesc.mediaDescriptions.find(t=>Nt()?t.media.port==="0"&&t.media.mediaType===i:t.media.port==="0")}};const A1=["sdp"];function lI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Ks(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?lI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):lI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}let Wi=class Fo extends jS{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return(t=(e=this.peerConnection.getReceivers()[0])===null||e===void 0||(e=e.transport)===null||e===void 0?void 0:e.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,e,n){super(t,e),h(this,"direction",void 0),h(this,"name",void 0),h(this,"store",void 0),h(this,"spec",void 0),h(this,"peerConnection",void 0),h(this,"initialOffer",void 0),h(this,"transport",void 0),h(this,"statsFilter",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"localCandidateAddress",null),h(this,"useXR",v("USE_XR")),h(this,"filter",{filterRTX:!v("USE_PUB_RTX")&&!v("USE_SUB_RTX"),filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC")}),h(this,"extension",{useXR:this.useXR}),h(this,"_isInRestartIce",!1),h(this,"mutex",new Ae("P2PConnection-mutex")),h(this,"onLocalCandidate",void 0),h(this,"remoteSDP",void 0),h(this,"pendingCandidates",[]),h(this,"localCapabilities",void 0),h(this,"isReady",!1),h(this,"restartCnt",0),h(this,"curTurnServerIndex",0),this.store=e,this.spec=t,this.peerConnection=new RTCPeerConnection(Fo.resolvePCConfiguration(t,e.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=n??He.SEND_ONLY,this.name=this.direction===He.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Hd(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const e=await Zp(this.filter,this.extension);if(this.localCapabilities=Do(e),t){const{sdp:n}=t,s=C1(t,A1),r=function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=ja(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(fn(u,l,"videoExtensions",p,_,S),fn(u,l,"videoCodecs",p,_,S),fn(u,l,"audioExtensions",p,_,S),fn(u,l,"audioCodecs",p,_,S),v("RAISE_H264_BASELINE_PRIORITY")){const f=S.videoCodecs.findIndex(g=>g.rtpMap&&g.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&g.fmtp&&g.fmtp.parameters["profile-level-id"]==="42001f");if(f!==-1){const g=S.videoCodecs.findIndex(C=>C.rtpMap&&C.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(g<f){E.debug("raising H264 baseline profile priority");const C=S.videoCodecs[f];S.videoCodecs.splice(f,1),S.videoCodecs.splice(g,0,C)}g!==-1&&v("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(C=>!(C.rtpMap&&C.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&C.fmtp&&C.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:p,recv:_,sendrecv:S}}(this.filter,this.extension,n);this.remoteSDP=new dI({remoteIceParameters:s.iceParameters,remoteDtlsParameters:s.dtlsParameters,candidates:[],remoteRTPCapabilities:r,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=An(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await cI(this.filter,this.extension,o.sdp);this.localCapabilities=Do(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),Ks(Ks({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const s=An(n.sdp);return this.initialOffer=n,Ks(Ks({},s),{},{sdp:n.sdp})}}catch(e){throw new M(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:e,iceParameters:n,dtlsParameters:s}=t,r=await cI(this.filter,this.extension,e);this.remoteSDP=new dI({remoteIceParameters:n,remoteDtlsParameters:s,candidates:[],remoteRTPCapabilities:r,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(e=>{this.peerConnection.addIceCandidate(e)}),this.pendingCandidates=[])}catch(e){throw new M(R.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(t,e,n){var s=this;return vi(function*(){const r=yield at(s.mutex.lock("From P2PConnection.send"));try{if(!s.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=s.remoteSDP.receive(t,e,n);t.forEach((g,C)=>{if(a[C].needCreateTransceiver){const y=s.peerConnection.addTransceiver(g._mediaStreamTrack,{direction:"sendonly"});o.push(y),g._updateRtpTransceiver(y)}else{const y=s.peerConnection.getTransceivers().find(A=>A.mid===a[C].mid);if(!y)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[C].mid));o.push(y),g._updateRtpTransceiver(y)}}),Nt()&&v("SIMULCAST")===!0&&(yield at(s.applySimulcastForFirefox(o,t)));const c=a.map(g=>g.mid),d=yield at(s.peerConnection.createOffer()),l=s.mungSendOfferSDP(d.sdp,t,c),u=Ht.parse(l),p=c.map(g=>{const C=u.mediaDescriptions.find(y=>y.attributes.mid===g);if(!C)throw new Error("Cannot extract ssrc from mediaDescription.");return zp(C,v("USE_PUB_RTX"))}),_=o.map((g,C)=>{const y=c[C];return{localSSRC:p[C],id:y}});yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield _}catch(g){const C=s.remoteSDP.toString();throw yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield at(s.peerConnection.setRemoteDescription({type:"answer",sdp:C})),yield at(s.stopSending(c,!0)),g}yield at(s.applySimulcastEncodings(o,t)),yield at(s.applySendEncodings(o,t));const S=s.remoteSDP.toString(),f=s.logSDPExchange(l,"offer","local","send");return f==null||f(S),yield at(s.setRemoteDescription({type:"answer",sdp:S})),o.map((g,C)=>{const y=c[C];return{localSSRC:p[C],id:y}})}catch(o){throw o instanceof M?o:new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(t,e){const n=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const s=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length (".concat(s.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));s.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(s){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(s.toString()))}finally{n&&n()}}async receive(t,e,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(t,e,n,s);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,r,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===r);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(r){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async mockReceive(t,e,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(t,e,n,s);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,r,t);c==null||c(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(r){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===es.Auto&&(this.store.p2pTransport=es.SdRtn,Ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Fo.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Ot().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Fo.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:n}=An(e.sdp);return this.store.descriptionStart(),this.direction===He.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),n}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===He.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:n}=An(e.sdp);return await this.peerConnection.setLocalDescription(e),n}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(n.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const r=this.remoteSDP.toString(),o=this.logSDPExchange(s,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),o==null||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new M(R.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,e){const n=this.peerConnection.getTransceivers().filter(s=>s.mid===t);n.length===1&&(this.isVP8Simulcast(e)?Nt()||await this.applySimulcastEncodings(n,[e]):await this.applySendEncodings(n,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const n=this.peerConnection.getTransceivers().find(s=>s.mid===e);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:n,remote:s}=e.getSelectedCandidatePair();return{local:Ks(Ks({},Hn),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:Ks(Ks({},Hn),{},{candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,e;q(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var e;t.candidate.candidate&&(this.localCandidateAddress=t.candidate.address,(e=this.onLocalCandidate)===null||e===void 0||e.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const s={iceServers:[]};var r;return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ro(t.turnServer.servers)?s.iceServers=t.turnServer.servers:(s.iceServers&&s.iceServers.push(...Fo.turnServerConfigToIceServers(t.turnServer.servers,e,n)),v("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...Fo.turnServerConfigToIceServers(t.turnServer.serversFromGateway,e,n)),q(r=[es.Relay,es.SdRtn]).call(r,e)&&(s.iceTransportPolicy="relay"),v("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(s.iceTransportPolicy="relay")}))),v("ENABLE_ENCODED_TRANSFORM")&&Ot().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),E.debug("P2PConnection p2pTransport is ".concat(e)),s}static turnServerConfigToIceServers(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const s=[],r=t.filter(a=>a.tcpport);E.debug("P2PConnection turnServers is ".concat(r,", current index is ").concat(n));const o=r.length>n?r[n]:r[0];switch(e){case es.SdRtn:const a=t.filter(d=>{var l;return q(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>n?a[n]:a[0];c&&(s.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(ks(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),s.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(ks(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case es.Relay:o&&(s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ks(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ks(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),s.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return s}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var n;t!=null&&t.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,t.state))},t.onerror=n=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in n?n.error:n)};const e=t.iceTransport;e&&(e.onstatechange=()=>{const n=t==null?void 0:t.iceTransport.state;var s;n&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,n))},e.getSelectedCandidatePair&&(e.onselectedcandidatepairchange=()=>{if(e.getSelectedCandidatePair()){const{local:n,remote:s}=e.getSelectedCandidatePair();E.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var n;if(e||(e=this.peerConnection.getSenders().find(l=>l.track===t._mediaStreamTrack)),!e)return E.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return E.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ot().supportSetRtpSenderParameters)return E.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},r={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:l,frameRate:u,scaleResolutionDownBy:p}=t._encoderConfig;l&&(r.maxBitrate=1e3*l),q(o=t._hints).call(o,Mt.LOW_STREAM)&&(u&&(r.maxFramerate=Ui(u)),p&&p>=1&&(r.scaleResolutionDownBy=p))}if(v("DSCP_TYPE")&&vs()){var a;const l=v("DSCP_TYPE");q(a=["very-low","low","medium","high"]).call(a,l)&&(r.networkPriority=l)}const c=e.getParameters(),d=(n=c.encodings)===null||n===void 0?void 0:n[0];Nt()&&!d&&(s.encodings=[r]),d&&Object.assign(d,r),Object.assign(c,s),E.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await e.setParameters(c)}async applySendEncodings(t,e){try{if(!Ot().supportSetRtpSenderParameters||t.length!==e.length)return;for(let n=0;n<t.length;n++){const s=t[n],r=e[n];r instanceof dt&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,s.sender)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,n){const s=Ht.parse(t);return e.forEach((r,o)=>{const a=n[o],c=s.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Hs(c,r),Qp(c,r,this.store.codec))}),Ht.print(s)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,n)=>{var s;(s=this.onFirstVideoDecoded)===null||s===void 0||s.call(this,t,e,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var n,s,r,o,a;const d=t[c],l=e[c];if(l instanceof dt&&!q(n=l._hints).call(n,Mt.LOW_STREAM)&&(s=l._encoderConfig)!==null&&s!==void 0&&s.bitrateMax&&((r=l._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,u))}}}async applySimulcastEncodings(t,e){if(!Nt()&&t.length===e.length)for(let n=0;n<t.length;n++){const s=e[n];if(s instanceof dt&&this.isVP8Simulcast(s)){const r=t[n],o={},a={high:1e3*(s._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=r.sender.getParameters();await r.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,n,s,r,o;return!!(t instanceof dt&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(e=t._hints).call(e,Mt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((s=t._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,n,s){if(v("SDP_LOGGING"))return E.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(e," SDP during P2PConnection.").concat(s,`
`),t),e==="offer"?r=>{this.logSDPExchange(r,"answer",n==="local"?"remote":"local",s)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async o=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(t,e){var n,s;if(e=(n=e)!==null&&n!==void 0?n:(s=this.currentRemoteDescription)===null||s===void 0?void 0:s.sdp){var r;const o=(r=Ht.parse(e).mediaDescriptions.find(a=>a.attributes.mid===t))===null||r===void 0?void 0:r.attributes.ssrcs;return o==null?void 0:o[0].ssrcId}}async setRemoteDescription(t){var e;await this.peerConnection.setRemoteDescription(t),q(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,e,n){const s=Ht.parse(t),r=s.mediaDescriptions.find(o=>o.attributes.mid===e);return r&&(n===J.AUDIO&&r.media.mediaType==="audio"&&bn(r),this.useXR&&Ga(s)),Ht.print(s)}};function gn(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function $p(i,t){let e=document.createElement("video"),n=document.createElement("canvas");e.setAttribute("style","display:none"),n.setAttribute("style","display:none"),e.setAttribute("muted",""),e.muted=!0,e.setAttribute("autoplay",""),e.autoplay=!0,e.setAttribute("playsinline",""),n.width=Ui(t.width),n.height=Ui(t.height);const s=Ui(t.framerate||15);document.body.append(e),document.body.append(n);let r=i._mediaStreamTrack;e.srcObject=new MediaStream([r]),e.play();const o=n.getContext("2d");if(!o)throw new w(R.UNEXPECTED_ERROR,"can not get canvas context");const a=Ot(),c=n.captureStream(a.supportRequestFrame?0:s).getVideoTracks()[0];c.canvas||(c.canvas=n),n.startCapture=()=>{if(!e)return n.stopCapture&&n.stopCapture();if(e.paused&&e.play(),e.videoHeight>2&&e.videoWidth>2){const l=e.videoWidth,u=e.videoHeight/l,p=n.width*u;Math.abs(p-n.height)>=2&&(E.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(p)),n.height=p)}o.drawImage(e,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),r!==i._mediaStreamTrack&&(r=i._mediaStreamTrack,e.srcObject=new MediaStream([r]))},n.stopCapture=up(()=>n.startCapture&&n.startCapture(),s);const d=c.stop;return c.stop=()=>{d.call(c),e&&(e.remove(),e.srcObject=null,e=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),E.debug("clean low stream renderer")},c}var Wa,uI,Ce,Ys,Fe,Po,t_,ls,tn,e_,Hi;U([gn,T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Wi.prototype,"establish",null),U([gn,T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Wi.prototype,"connect",null),U([gn,T("design:type",Function),T("design:paramtypes",[String,Array,String,String]),T("design:returntype",P)],Wi.prototype,"receive",null),U([gn,T("design:type",Function),T("design:paramtypes",[String,Array,String,String]),T("design:returntype",P)],Wi.prototype,"mockReceive",null),U([gn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Wi.prototype,"stopReceiving",null),U([gn,T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Wi.prototype,"restartICE",null),U([gn,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Wi.prototype,"close",null),U([gn,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Wi.prototype,"updateEncoderConfig",null),U([gn,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Wi.prototype,"updateSendParameters",null),U([gn,T("design:type",Function),T("design:paramtypes",[xe,String]),T("design:returntype",P)],Wi.prototype,"replaceTrack",null),U([gn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Wi.prototype,"muteLocal",null),U([gn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Wi.prototype,"unmuteLocal",null),function(i){i[i.HEIGHT=2033]="HEIGHT",i[i.FRAME_RATE=2034]="FRAME_RATE",i[i.WIDTH=2035]="WIDTH"}(Wa||(Wa={})),function(i){i[i.HEIGHT=2072]="HEIGHT",i[i.FRAME_RATE=2074]="FRAME_RATE",i[i.WIDTH=2076]="WIDTH"}(uI||(uI={})),function(i){i[i.FRAME_RATE=2002]="FRAME_RATE",i[i.WIDTH=2003]="WIDTH",i[i.HEIGHT=2004]="HEIGHT",i[i.PACKAGE_LOST=2005]="PACKAGE_LOST",i[i.AVG_ENCODE=2007]="AVG_ENCODE",i[i.NACKS=2009]="NACKS",i[i.PLIS=2010]="PLIS",i[i.FIRS=2011]="FIRS",i[i.BITRATE=2012]="BITRATE",i[i.PACKAGE_RATE=2031]="PACKAGE_RATE",i[i.ADAPTATION=2032]="ADAPTATION",i[i.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",i[i.BANDWIDTH=2061]="BANDWIDTH",i[i.RETRANSMIT=2062]="RETRANSMIT",i[i.TARGET_ENCODED=2064]="TARGET_ENCODED",i[i.TRANSMIT=2066]="TRANSMIT",i[i.FREEZE=2082]="FREEZE",i[i.DISABLED=2095]="DISABLED",i[i.PLAYER_STATUS=2128]="PLAYER_STATUS",i[i.QP_SUM=2143]="QP_SUM"}(Ce||(Ce={})),function(i){i[i.BITRATE=2069]="BITRATE",i[i.PACKAGE_LOST=2070]="PACKAGE_LOST",i[i.PACKAGE_RATE=2071]="PACKAGE_RATE",i[i.HEIGHT=2073]="HEIGHT",i[i.FRAME_RATE=2075]="FRAME_RATE",i[i.WIDTH=2077]="WIDTH"}(Ys||(Ys={})),function(i){i[i.JITTER=-1]="JITTER",i[i.PACKAGE_LOST=2014]="PACKAGE_LOST",i[i.WIDTH=2018]="WIDTH",i[i.HEIGHT=2019]="HEIGHT",i[i.FRAME_RATE=2020]="FRAME_RATE",i[i.JITTER_BUFFER=2023]="JITTER_BUFFER",i[i.CURRENT_DELAY=2024]="CURRENT_DELAY",i[i.NACKS=2026]="NACKS",i[i.PLIS=2027]="PLIS",i[i.FIRS=2028]="FIRS",i[i.BITRATE=2029]="BITRATE",i[i.PACKAGE_RATE=2078]="PACKAGE_RATE",i[i.FREEZE=2084]="FREEZE",i[i.DISABLED=2101]="DISABLED",i[i.PLAYER_STATUS=2129]="PLAYER_STATUS",i[i.QP_SUM=2144]="QP_SUM",i[i.I_FRAME_DELAY=2149]="I_FRAME_DELAY"}(Fe||(Fe={})),function(i){i[i.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",i[i.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",i[i.FREEZE_TIME=2109]="FREEZE_TIME",i[i.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER"}(Po||(Po={})),function(i){i[i.PCM_LEVEL=2104]="PCM_LEVEL"}(t_||(t_={})),function(i){i[i.PACKAGE_LOST=-1]="PACKAGE_LOST",i[i.LEVEL=2038]="LEVEL",i[i.BITRATE=2039]="BITRATE",i[i.PACKAGE_RATE=2040]="PACKAGE_RATE",i[i.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",i[i.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",i[i.FREEZE=2081]="FREEZE",i[i.DISABLED=2096]="DISABLED"}(ls||(ls={})),function(i){i[i.BITRATE=2044]="BITRATE",i[i.PACKAGE_LOST=2045]="PACKAGE_LOST",i[i.PACKAGE_RATE=2046]="PACKAGE_RATE",i[i.CURRENT_DELAY=2047]="CURRENT_DELAY",i[i.JITTER_BUFFER=2054]="JITTER_BUFFER",i[i.JITTER=2055]="JITTER",i[i.FREEZE=2083]="FREEZE",i[i.DISABLED=2102]="DISABLED",i[i.PCM_LEVEL=2105]="PCM_LEVEL",i[i.PLAYER_STATUS=2130]="PLAYER_STATUS",i[i.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES"}(tn||(tn={})),function(i){i[i.FREEZE_TIME=-1]="FREEZE_TIME",i[i.LEVEL=2043]="LEVEL"}(e_||(e_={})),function(i){i[i.RTT=2006]="RTT",i[i.CONN_TYPE=801]="CONN_TYPE"}(Hi||(Hi={}));const us=1e3,kr=3;function ht(i,t,e){e!=null&&Number.isFinite(e)&&(i[t]=Math.round(Math.max(0,e)))}function hI(i){const t={[Hi.CONN_TYPE]:0,[Hi.RTT]:i.rtt};switch(i.selectedCandidatePair.localCandidate.candidateType){case"relay":{const e=i.selectedCandidatePair.localCandidate.relayProtocol;e==="udp"&&(t[Hi.CONN_TYPE]=1),e==="tcp"&&(t[Hi.CONN_TYPE]=3),e==="tls"&&(t[Hi.CONN_TYPE]=4);break}case"srflx":t[Hi.CONN_TYPE]=2}return t}class pI extends Wt{constructor(t){super(),h(this,"store",void 0),h(this,"uploadWRTCStatsTimer",void 0),h(this,"uploadOutboundDenoiserStatsTimer",void 0),h(this,"uploadExtStatsTimer",void 0),h(this,"uploadExtUsageStatsTimer",void 0),h(this,"uploadInboundExtStatsTimer",void 0),h(this,"requestStats",void 0),h(this,"requestTransportStats",void 0),h(this,"requestLocalMedia",void 0),h(this,"requestRemoteMedia",void 0),h(this,"requestAllTracks",void 0),h(this,"requestVideoIsReady",void 0),h(this,"requestUploadStats",void 0),h(this,"requestUpload",void 0),h(this,"uploadOutboundStarted",!1),h(this,"uploadInboundStarted",!1),h(this,"uploadTransportStarted",!1),h(this,"uploadExtensionUsageStarted",!1),h(this,"lastRecvStats",void 0),h(this,"lastSendStats",void 0),h(this,"lastFullRecvStats",void 0),h(this,"lastFullSendStats",void 0),h(this,"needUploadRenderFreezeTime",!0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;let e,n;if(this.uploadTransportStarted&&(e=this.requestStats(),this.store.useP2P&&(n=this.requestStats(!0))),!e&&this.uploadOutboundStarted&&(e=this.requestStats()),!n&&this.uploadInboundStarted&&(n=this.requestStats(!0)),e||n){const s={};if(this.uploadTransportStarted&&e){const r=this.getTransportStats(e,n,t);r&&(s.misc=[r])}if(this.uploadOutboundStarted&&e){const r=this.getOutboundStats(e,t?this.lastSendStats:this.lastFullSendStats,t);r&&(s.outbound=[r])}if(this.uploadInboundStarted&&n){const r=this.getInboundStats(n,t?this.lastRecvStats:this.lastFullRecvStats,t);r&&(s.inbound=r)}this.requestUploadStats(s)}this.lastRecvStats=n,this.lastSendStats=e,t||(this.lastFullRecvStats=n,this.lastFullSendStats=e)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(t!==kr),++t===kr+1&&(t=1)},us)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(t,e,n){if(!this.requestStats)return;if(n)return t.rtt==null?void 0:{addition:{[Hi.RTT]:t.rtt,[Hi.CONN_TYPE]:void 0}};const s=hI(t);if(this.store.useP2P){if(e){const r=hI(e);s[Hi.CONN_TYPE]+=r[Hi.CONN_TYPE]<<3}s[Hi.CONN_TYPE]+=110}else s[Hi.CONN_TYPE]+=100;return{addition:s}}getOutboundStats(t,e,n){if(!this.requestUploadStats||!this.requestLocalMedia)return;const s=this.requestLocalMedia();if(!s||s.length===0)return;let r,o,a;return s.forEach(c=>{let[d,{track:l,ssrcs:u}]=c;switch(d){case V.LocalVideoLowTrack:case V.LocalVideoTrack:if(d===V.LocalVideoTrack){const p=function(f,g,C,y,A){const k=g.videoSend.find(F=>F.ssrc===f);if(!k)return;const O={},{sentFrame:N,inputFrame:L}=k;if(L&&N){const F=L.frameRate,j=N.frameRate;O[Ce.FREEZE]=function(it,ct){let Ut=!0;return Ut=!(it<=5)&&(it<=10?ct<3:it<=20?ct<4:ct<5),Ut}(F,j)?1:0}if(ht(O,Ce.QP_SUM,k.qpSumPerFrame),A)return O;switch(N&&(ht(O,Ce.HEIGHT,N.height),ht(O,Ce.WIDTH,N.width),ht(O,Ce.FRAME_RATE,N.frameRate)),O[Ce.DISABLED]=y._originMediaStreamTrack&&!y._originMediaStreamTrack.enabled||y._mediaStreamTrack&&!y._mediaStreamTrack.enabled?1:0,k.adaptionChangeReason){case"none":O[Ce.ADAPTATION]=0;break;case"cpu":O[Ce.ADAPTATION]=1;break;case"bandwidth":O[Ce.ADAPTATION]=2;break;case"other":O[Ce.ADAPTATION]=3}O[Ce.PLAYER_STATUS]=dp[y._player?y._player.videoElementStatus:"uninit"],ht(O,Ce.NACKS,k.nacksCount),ht(O,Ce.PLIS,k.plisCount),ht(O,Ce.FIRS,k.firsCount),ht(O,Ce.AVG_ENCODE,k.avgEncodeMs);const D=C&&C.videoSend.find(F=>F.ssrc===f);if(D){let F=A?us:us*kr;D.timestamp&&k.timestamp&&(F=k.timestamp-D.timestamp),D.packets!=null&&k.packets!=null&&ht(O,Ce.PACKAGE_RATE,1e3*(k.packets-D.packets)/F),k.packetsLost!=null&&D.packetsLost!=null&&ht(O,Ce.PACKAGE_LOST,k.packetsLost-D.packetsLost),D.bytes!=null&&k.bytes!=null&&ht(O,Ce.BITRATE,8*(k.bytes-D.bytes)/F)}return O}(u[0].ssrcId,t,e,l,n),_=n?null:function(f,g,C){const y=g.videoSend.find(D=>D.ssrc===f);if(!y)return null;const A={},k=y.inputFrame,O=k&&k.height||C&&C._videoHeight||0,N=k&&k.width||C&&C._videoWidth||0,L=k&&k.frameRate||0;return ht(A,Wa.HEIGHT,O),ht(A,Wa.WIDTH,N),ht(A,Wa.FRAME_RATE,L),A}(u[0].ssrcId,t,l),S=n?null:function(f){const g={};return ht(g,Ce.RETRANSMIT,f.bitrate.retransmit),ht(g,Ce.TARGET_ENCODED,f.bitrate.targetEncoded),ht(g,Ce.ACTUAL_ENCODED,f.bitrate.actualEncoded),ht(g,Ce.TRANSMIT,f.bitrate.transmit),ht(g,Ce.BANDWIDTH,f.sendBandwidth),g}(t);o=Object.assign({},p,_,S)}else a=n?void 0:function(p,_,S){const f=_.videoSend.find(y=>y.ssrc===p);if(!f)return;const g={},C=f.sentFrame;if(C&&(ht(g,Ys.HEIGHT,C.height),ht(g,Ys.WIDTH,C.width),ht(g,Ys.FRAME_RATE,C.frameRate)),S){const y=S.videoSend.find(A=>A.ssrc===p);if(y){let A=us*kr;y.timestamp&&f.timestamp&&(A=f.timestamp-y.timestamp),y.packets!=null&&f.packets!=null&&ht(g,Ys.PACKAGE_RATE,1e3*(f.packets-y.packets)/A),f.packetsLost!=null&&y.packetsLost!=null&&ht(g,Ys.PACKAGE_LOST,f.packetsLost-y.packetsLost),y.bytes!=null&&f.bytes!=null&&ht(g,Ys.BITRATE,8*(f.bytes-y.bytes)/A)}}return g}(u[0].ssrcId,t,e);break;case V.LocalAudioTrack:r=n?void 0:function(p,_,S,f){const g=_.audioSend.find(O=>O.ssrc===p);if(!g)return;const C={};C[ls.DISABLED]=f._originMediaStreamTrack&&!f._originMediaStreamTrack.enabled||f._mediaStreamTrack&&!f._mediaStreamTrack.enabled?1:0;const y=f._source.getAccurateVolumeLevel(),A=g.inputLevel;ht(C,ls.LEVEL,100*(A??y)),ht(C,t_.PCM_LEVEL,100*y),ht(C,ls.AEC_RETURN_LOSS,g.aecReturnLoss),ht(C,ls.AEC_RETURN_LOSS_ENH,g.aecReturnLossEnhancement),C[ls.FREEZE]=0;const k=S&&S.audioSend.find(O=>O.ssrc===p);if(k){let O=us*kr;k.timestamp&&g.timestamp&&(O=g.timestamp-k.timestamp),k.bytes!=null&&g.bytes!=null&&ht(C,ls.BITRATE,8*(g.bytes-k.bytes)/O),k.packets!=null&&g.packets!=null&&ht(C,ls.PACKAGE_RATE,1e3*(g.packets-k.packets)/O)}return C}(u[0].ssrcId,t,e,l)}}),{high:o,low:a,audio:r}}getInboundStats(t,e,n){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],r=[];return s.forEach(o=>{let[a,c]=o;const d={peer:a.uid};if(c.has(J.VIDEO)&&a.videoTrack){const l=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,u=a.videoTrack?function(p,_,S,f,g,C,y){const A=_.videoRecv.find(F=>F.ssrc===p);if(!A)return;const k={},{receivedFrame:O,outputFrame:N,decodeFrameRate:L}=A,D=S&&S.videoRecv.find(F=>F.ssrc===p);if(k[Fe.FREEZE]=g&&Ha.isRemoteVideoFreeze(f,A,D)?1:0,ht(k,Po.FRAME_RATE_DECODE,L),ht(k,Fe.QP_SUM,A.qpSumPerFrame),A.framesRateFirefox&&ht(k,Fe.FRAME_RATE,A.framesRateFirefox),O&&ht(k,Fe.FRAME_RATE,O.frameRate),D){const F=_.timestamp-S.timestamp||(y?us:kr*us);A.packetsLost!=null&&D.packetsLost!=null&&ht(k,Fe.PACKAGE_LOST,A.packetsLost-D.packetsLost),D.bytes!=null&&A.bytes!=null&&ht(k,Fe.BITRATE,8*(A.bytes-D.bytes)/F),D.packets!=null&&A.packets!=null&&ht(k,Fe.PACKAGE_RATE,1e3*(A.packets-D.packets)/F)}if(y)return k;if(O?(ht(k,Fe.HEIGHT,O.height),ht(k,Fe.WIDTH,O.width)):f&&(ht(k,Fe.HEIGHT,f._videoHeight||0),ht(k,Fe.WIDTH,f._videoWidth||0)),N&&ht(k,Po.FRAME_RATE_RENDER,N.frameRate),ht(k,Fe.JITTER_BUFFER,A.jitterBufferMs),ht(k,Fe.CURRENT_DELAY,A.currentDelayMs),ht(k,Fe.FIRS,A.firsCount),ht(k,Fe.NACKS,A.nacksCount),ht(k,Fe.PLIS,A.plisCount),f){k[Fe.DISABLED]=f._originMediaStreamTrack.enabled&&f._mediaStreamTrack.enabled?0:1;const F=f._player;if(F){const{freezeTimeCounterList:j,renderFreezeAccTime:it}=F;if(j&&j.length>0&&ht(k,Po.FREEZE_TIME,j.splice(0,1)[0]),C&&os.visibility==="visible"){const ct=Math.min(6e3,it);F.renderFreezeAccTime=Math.max(0,it-ct),ht(k,Po.FREEZE_TIME_RENDER,ct)}}}if(k[Fe.PLAYER_STATUS]=dp[f._player?f._player.videoElementStatus:"uninit"],D&&A.totalInterFrameDelay!==void 0&&A.totalSquaredInterFrameDelay!==void 0&&D.totalInterFrameDelay!==void 0&&D.totalSquaredInterFrameDelay!==void 0){const F=A.totalInterFrameDelay-D.totalInterFrameDelay,j=A.totalSquaredInterFrameDelay-D.totalSquaredInterFrameDelay,it=A.framesDecodeCount-D.framesDecodeCount,ct=F/it*1e3,Ut=Math.round(1e3*Math.sqrt((j-Math.pow(F,2)/it)/it));!isNaN(Ut)&&ct+Ut>Math.max(3*ct,ct+150)&&(k[Fe.I_FRAME_DELAY]=Ut)}return k}(a._videoSSRC,t,e,a.videoTrack,l===!0,this.needUploadRenderFreezeTime,n):void 0;u&&(d.video=u)}if(c.has(J.AUDIO)&&a.audioTrack){const l=a.audioTrack?function(u,p,_,S,f){const g=p.audioRecv.find(F=>F.ssrc===u);if(!g)return;const C={},y=_&&_.audioRecv.find(F=>F.ssrc===u),{receivedFrames:A,droppedFrames:k}=g;var O,N;if(ht(C,tn.JITTER,g.jitterMs),A!=null&&k!=null&&(C[tn.FREEZE]=(N=k,(O=A)===0||100*N/O>20?1:0)),y){const F=p.timestamp-_.timestamp||(f?us:us*kr);g.packets!=null&&y.packets!=null&&ht(C,tn.PACKAGE_RATE,1e3*(g.packets-y.packets)/F),y.bytes!=null&&g.bytes!=null&&ht(C,tn.BITRATE,8*(g.bytes-y.bytes)/F),g.packetsLost!=null&&y.packetsLost!=null&&ht(C,tn.PACKAGE_LOST,g.packetsLost-y.packetsLost)}if(f)return C;const L=S._source.getAccurateVolumeLevel(),D=g.outputLevel;if(ht(C,e_.LEVEL,100*(D??L)),ht(C,tn.PCM_LEVEL,100*L),S&&(C[tn.DISABLED]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1),ht(C,tn.JITTER_BUFFER,g.jitterBufferMs),ht(C,tn.CURRENT_DELAY,g.jitterBufferMs),C[tn.PLAYER_STATUS]=dp[mi.getPlayerState(S.getTrackId())],y){const F=g.concealedSamples-y.concealedSamples;F>0&&ht(C,tn.CONCEALED_SAMPLES,F)}return C}(a._audioSSRC,t,e,a.audioTrack,n):void 0;l&&(d.audio=l)}(d.video||d.audio)&&r.push(d)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,r}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(e=>e instanceof yr);if(t&&t._external.getDenoiserStats){const e=t._external.getDenoiserStats();e&&this.requestUpload(is.DENOISER_STATS,e)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[e,n]=t;n.has(J.VIDEO)&&e.videoTrack&&e.videoTrack.getProcessorStats().forEach(s=>{this.requestUpload&&this.requestUpload(s.type,s.stats)}),n.has(J.AUDIO)&&e.audioTrack&&e.audioTrack.getProcessorStats().forEach(s=>{this.requestUpload&&this.requestUpload(s.type,s.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const e=Date.now(),n={connectionInterval:v("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:e};let s=[];const r=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of r)!d.muted&&d.enabled&&(s=s.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,l]of o)l.has(J.VIDEO)&&d.videoTrack&&(s=s.concat(await d.videoTrack.getProcessorUsage())),l.has(J.AUDIO)&&d.audioTrack&&(s=s.concat(await d.audioTrack.getProcessorUsage()));if(s.length===0)return;n.details=function(d,l){const u={};for(const{id:f,value:g,level:C,direction:y}of d){var p;const A=(p=l.get(f))!==null&&p!==void 0?p:0,k=g===2?A+v("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:A;var _,S;l.set(f,k),u[f]?(g===2&&(u[f].value=g),C>u[f].level&&(u[f].level=C),y==="remote"&&(u[f].remoteUidCount+=1),u[f].totalTs=(_=l.get(f))!==null&&_!==void 0?_:0):u[f]={value:g,level:C,remoteUidCount:y==="local"?0:1,totalTs:(S=l.get(f))!==null&&S!==void 0?S:0}}return Object.keys(u).map(f=>{const{level:g,value:C,totalTs:y}=u[f];return{id:f,level:g,value:C,totalTs:y}})}(s,t);const a=Date.now(),c=a>e?a:e+1;this.requestUpload&&this.requestUpload(is.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:c})},v("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class Le{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,e){h(this,"uid",void 0),h(this,"_uintid",void 0),h(this,"_trust_in_room_",!0),h(this,"_trust_audio_enabled_state_",!0),h(this,"_trust_video_enabled_state_",!0),h(this,"_trust_audio_mute_state_",!0),h(this,"_trust_video_mute_state_",!0),h(this,"_audio_muted_",!1),h(this,"_video_muted_",!1),h(this,"_audio_enabled_",!0),h(this,"_video_enabled_",!0),h(this,"_audio_added_",!1),h(this,"_video_added_",!1),h(this,"_is_pre_created",!1),h(this,"_video_pre_subscribed",!1),h(this,"_audio_pre_subscribed",!1),h(this,"_trust_video_stream_added_state_",!0),h(this,"_trust_audio_stream_added_state_",!0),h(this,"_audioTrack",void 0),h(this,"_videoTrack",void 0),h(this,"_dataChannels",[]),h(this,"_audioSSRC",void 0),h(this,"_videoSSRC",void 0),h(this,"_audioOrtc",void 0),h(this,"_videoOrtc",void 0),h(this,"_cname",void 0),h(this,"_rtxSsrcId",void 0),h(this,"_videoMid",void 0),h(this,"_audioMid",void 0),this.uid=t,this._uintid=e}}var en;function b1(i,t){var e;let n;switch(t){case V.LocalAudioTrack:n=St.Audio;break;case V.LocalVideoTrack:n=q(e=i._hints).call(e,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:n=St.Low}return n}function _I(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function qd(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?_I(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):_I(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}(function(i){i.SEND_ONLY="SEND_ONLY",i.RECEIVE_ONLY="RECEIVE_ONLY"})(en||(en={}));class Te extends Wt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(tt.StateChange,e,this._state)}constructor(t,e){super(),h(this,"store",void 0),h(this,"statsUploader",void 0),h(this,"sendConnection",void 0),h(this,"recvConnection",void 0),h(this,"localTrackMap",new Map),h(this,"remoteUserMap",new Map),h(this,"localDataChannels",[]),h(this,"pendingLocalTracks",[]),h(this,"pendingRemoteTracks",[]),h(this,"statsCollector",void 0),h(this,"dtlsFailedCount",0),h(this,"sendMutex",new Ae("P2PChannel2-send-mutex")),h(this,"recvMutex",new Ae("P2PChannel2-recv-mutex")),h(this,"_state",vt.Disconnected),h(this,"_restartStates",["disconnected","failed"]),h(this,"reconnectInterval",void 0),h(this,"uploadUnplinkStarted",!1),h(this,"uploadDownlinkStarted",!1),h(this,"uplinkStateUploadInterval",void 0),h(this,"downlinkStatsUploadInterval",void 0),h(this,"handleMuteLocalTrack",async(n,s,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==vt.Connected)return void r(new M(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const d=this.filterTobeMutedTracks(n);if(d.length===0)return void s();const l=d.find(S=>S[0]==="videoLowTrack");l&&l[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(d.map(S=>{let[,{id:f}]=S;return f}));let u=!1;var a,c;n.trackMediaType==="video"?u=!((a=this.localTrackMap.get(V.LocalAudioTrack))===null||a===void 0||!a.track._muted):u=((c=this.localTrackMap.get(V.LocalVideoTrack))===null||c===void 0?void 0:c.id)===void 0;const p=this.createMuteMessage(d);await Dt(this,tt.RequestMuteLocal,p);const _=n.trackMediaType==="video"?xn.MUTE_LOCAL_VIDEO:xn.MUTE_LOCAL_AUDIO;await Dt(this,tt.RequestP2PMuteLocal,{action:_,message:p,isMuteAll:u}),s()}catch(d){r(d)}finally{o()}}),h(this,"handleUnmuteLocalTrack",async(n,s,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==vt.Connected)return void r(new M(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const a=this.filterTobeUnmutedTracks(n);if(a.length===0)return void s();await this.sendConnection.unmuteLocal(a.map(l=>{let[,{id:u}]=l;return u}));const c=this.createUnmuteMessage(a),d=n.trackMediaType==="video"?xn.UNMUTE_LOCAL_VIDEO:xn.UNMUTE_LOCAL_AUDIO;await Dt(this,tt.RequestP2PMuteLocal,{action:d,message:c}),s()}catch(a){r(a)}finally{o()}}),h(this,"handleUpdateVideoEncoder",async(n,s,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const a=this.localTrackMap.get(V.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==n||this.state!==vt.Connected)return void s();const{id:c,track:d}=a;c&&(await this.sendConnection.updateSendParameters(c,d),await this.sendConnection.updateEncoderConfig(c,d),this.emit(tt.UpdateVideoEncoder,d)),s()}catch(a){r(a)}finally{o()}}),h(this,"handleSetOptimizationMode",async(n,s,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const a=this.localTrackMap.get(V.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==n||this.state!==vt.Connected)return;const{id:c,track:d}=a;c&&await this.sendConnection.updateSendParameters(c,d),s()}catch(a){r(a)}finally{o()}}),h(this,"handleReplaceTrack",async(n,s,r,o)=>{let a;E.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var c;const l=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:p}]=u;return n===p});if(!this.sendConnection||!l||l[1].id===void 0||this.state!==vt.Connected)return void s();if(await((c=this.sendConnection)===null||c===void 0?void 0:c.replaceTrack(n,l[1].id)),l[0]===V.LocalVideoTrack&&Ot().supportDualStreamEncoding){const u=this.localTrackMap.get(V.LocalVideoLowTrack);if(u){const p=n._mediaStreamTrack.clone();u.track._originMediaStreamTrack.stop(),u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p,await new P((_,S)=>{this.handleReplaceTrack(u.track,_,S,!0)})}}s()}catch(l){r(l)}finally{var d;(d=a)===null||d===void 0||d()}}),h(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),h(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),h(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),h(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new pI(t),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},v("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new M(R.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t,e,n,s,r,o){throw new M(R.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Wi(t,this.store,He.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const s=await this.recvConnection.establish(e);return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}{this.state=vt.New,this.sendConnection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Wi(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const s=await this.sendConnection.establish();return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}}finally{n&&n()}}async p2pConnect(t){if(!this.sendConnection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=vt.Connected}async addRemoteCandidate(t,e){if(e===He.RECEIVE_ONLY){if(!this.sendConnection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,n){var s=this;return vi(function*(){const r=yield at(s.sendMutex.lock("From P2PChannel.publish"));try{if(!s.sendConnection||s.state!==vt.Connected){s.throwIfTrackTypeNotMatch(t);const l=t.filter(u=>s.pendingLocalTracks.indexOf(u)===-1);return void(s.pendingLocalTracks=s.pendingLocalTracks.concat(l))}s.store.pubId=s.store.pubId+1,Ve.markPublishStart(s.store.clientId,s.store.pubId);const o=s.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield at(s.tryToUnmuteAudio(t)));o.forEach(l=>{let{track:u,type:p}=l;const _=Date.now();s.store.publish(u.getTrackId(),p===V.LocalAudioTrack?"audio":"video",_)}),s.bindLocalTrackEvents(o);const a=yield at(s.sendConnection.send(o.map(l=>{let{track:u}=l;return u}),s.store.codec,s.store.audioCodec)),c=(yield at(a.next())).value,d=s.createGatewayPublishMessage(o,c);try{yield d}catch(l){throw a.throw(l),(l==null?void 0:l.code)===R.WS_ABORT&&o.forEach(u=>{let{track:p}=u;s.pendingLocalTracks.indexOf(p)===-1&&s.pendingLocalTracks.push(p)}),s.unbindLocalTrackEvents(o),l}yield at(a.next()),o.forEach(l=>{let{type:u}=l;s.statsCollector.addLocalStats(u)}),s.statsUploader.startUploadOutboundStats(),s.assignLocalTracks(o,c),o.forEach(l=>{let{track:u,type:p}=l;const _=Date.now();s.store.publish(u.getTrackId(),p===V.LocalAudioTrack?"audio":"video",void 0,_)}),s.startUploadUplinkState()}finally{r()}})()}async unpublish(t){if(!this.sendConnection||this.state!==vt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!q(t).call(t,r)));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(r=>r[0]==="videoLowTrack");n&&n[1].track.close();const s=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:a}]=r;return{type:o,track:a}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===vt.Connected)return n&&n[1].track.close(),s;t.forEach(r=>{const o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(s=>{let[r,{track:o,ssrcs:a}]=s;const c={stream_type:b1(o,r),ssrcs:a};o._muted||!o._enabled?e.push(c):n.push(c)}),e.length>0&&e.forEach(s=>{Dt(this,tt.RequestMuteLocal,[s])}),n.length>0&&n.forEach(s=>{Dt(this,tt.RequestUnmuteLocal,[s])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return vi(function*(){throw new M(R.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(E.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await re(this,tt.RequestRePublish,this.pendingLocalTracks),this.emit(tt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new M(R.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,s){var r;if(!this.recvConnection)throw new M(R.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;const{track:o,mid:a,transceiver:c}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),s);e===J.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new pn(o,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Fn(o,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack));const d=this.remoteUserMap.get(t);d?d.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const l=this.pendingRemoteTracks.findIndex(u=>{let{user:p,kind:_}=u;return p.uid===t.uid&&e===_});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(tt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,n,s){if(!this.recvConnection)throw new M(R.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),s)}async unsubscribe(t,e,n){const s=this.pendingRemoteTracks.filter(o=>{let{user:a,kind:c}=o;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(s.forEach(o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)}),this.recvConnection||n||s.forEach(o=>{let{kind:a}=o;var c;if(a===J.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===J.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:a}]=o;return a})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[a,{kind:c}]=o;var d,l;if(c===J.VIDEO&&a._videoSSRC&&((d=this.recvConnection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===J.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===J.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:a}]=o;Dt(this,tt.RequestP2PMuteRemote,a)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[J.VIDEO,J.AUDIO].forEach(s=>{n.has(s)?Dt(this,tt.RequestP2PUnmuteRemote,s):Dt(this,tt.RequestP2PMuteRemote,s)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new M(R.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new M(R.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new M(R.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new M(R.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const s=e===J.VIDEO?t._videoSSRC:t._audioSSRC;s!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||E.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(V.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ce){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(s=>{let[r]=s;return r!==V.LocalAudioTrack}).filter(s=>{let[r]=s;return!(t&&r===V.LocalVideoLowTrack)}).map(s=>{let[,{track:r}]=s;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[s]=n;return!(t&&s===V.LocalVideoLowTrack)}).map(n=>{let[,{track:s}]=n;return s})}reportPublishEvent(t,e,n,s,r){if(t){const a=this.localTrackMap.get(V.LocalAudioTrack),c=s?this.localTrackMap.get(V.LocalVideoLowTrack):this.localTrackMap.get(V.LocalVideoTrack);z.publish(this.store.sessionId,{eventElapse:Ve.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(Mt.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const a=n.find(d=>d instanceof Ct),c=s?(o=this.localTrackMap.get(V.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(d=>d instanceof dt);z.publish(this.store.sessionId,{eventElapse:Ve.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(Mt.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,s){const r=s===J.VIDEO?n._videoSSRC:n._audioSSRC;r&&z.subscribe(this.store.sessionId,{succ:t,ec:e,video:s===J.VIDEO,audio:s===J.AUDIO,peerid:n.uid,subscribeRequestid:s===J.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ve.measureFromSubscribeStart(this.store.clientId,r)})}reset(){E.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Ae("P2PChannel2-send-mutex"),this.sendMutex=new Ae("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(V.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ce){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=vt.Disconnected}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(V.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(V.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof dt||e&&e.track instanceof Ct?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Di(e=this.remoteUserMap).call(e)).find(s=>s.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[s]=n;return{uid:s.uid,level:s.audioTrack?100*s.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(V.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=ta(t).call(t,(n,s)=>n.level-s.level),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(E.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=vt.Reconnecting,v("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:s}]=t;switch(n){case V.LocalVideoTrack:q(e=s._hints).call(e,Mt.LOW_STREAM)?s.close():this.pendingLocalTracks.push(s);break;case V.LocalAudioTrack:s instanceof ce?this.pendingLocalTracks=this.pendingLocalTracks.concat(s.trackList):this.pendingLocalTracks.push(s);case V.LocalVideoLowTrack:}}),this.emit(tt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Di(n).call(n)).forEach(s=>{this.setPendingRemoteMedia(e,s)}),this.emit(tt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),E.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:s,kind:r}=n;if((t instanceof Le?t.uid:t)===s.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let n,s;if(t===He.SEND_ONLY){if(!this.sendConnection)throw new M(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),s=this.sendConnection}else{if(!this.recvConnection)throw new M(R.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),s=this.recvConnection}try{if(e){const r=await s.restartICE(e);return s.isInRestartIce=!1,r}{const r=await s.restartICE();if(r){const o=await re(this,tt.RequestP2PRestartICE,{direction:He.RECEIVE_ONLY,iceParameter:r});await s.restartICE(o),s.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(V.LocalVideoTrack),n=this.localTrackMap.get(V.LocalAudioTrack),s=t.videoSend.find(S=>{var f;return S.ssrc===(e==null||(f=e.ssrcs)===null||f===void 0?void 0:f[0].ssrcId)}),r=t.audioSend.find(S=>{var f;return S.ssrc===(n==null||(f=n.ssrcs)===null||f===void 0?void 0:f[0].ssrcId)});if(!s||!r)return 1;const o=Ci(this,tt.NeedSignalRTT),a=s?s.rttMs:void 0,c=r?r.rttMs:void 0,d=a&&c?(a+c)/2:a||c,l=(d&&o?(d+o)/2:d||o)||0,u=100*t.sendPacketLossRate*.7/50+.3*l/1500,p=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,_=e==null?void 0:e.track;if(_&&_._encoderConfig&&_._hints.indexOf(Mt.SCREEN_TRACK)===-1){const S=_._encoderConfig.bitrateMax,f=t.bitrate.actualEncoded;if(S&&f){const g=(1e3*S-f)/(1e3*S);return PS[g<.15?0:g<.3?1:g<.45?2:g<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[s]=n;const r=s._audioSSRC,o=s._videoSSRC,a=t.audioRecv.find(f=>f.ssrc===r),c=t.videoRecv.find(f=>f.ssrc===o);if(!a&&!c)return void(e+=1);const d=Ci(this,tt.NeedSignalRTT),l=t.rtt,u=(l&&d?(l+d)/2:l||d)||0,p=a?a.jitterMs:void 0,_=t.recvPacketLossRate;let S=.7*_*100/50+.3*u/1500;p&&(S=.6*_*100/50+.2*u/1500+.2*p/400),e+=S<.1?1:S<.17?2:S<.36?3:S<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new P((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}filterTobePublishedTracks(t,e,n){const s=[],r=Ot(),o=this.getAllTracks();t=oo(t=t.filter(d=>o.indexOf(d)===-1));let a=!1,c=!1;for(const d of t){if(d instanceof dt&&(this.localTrackMap.has(V.LocalVideoTrack)||a?new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(s.push({track:d,type:V.LocalVideoTrack}),a=!0),e)){const l=this.getLowVideoTrack(d,n);s.push({track:l,type:V.LocalVideoLowTrack})}if(d instanceof Ct){const l=this.localTrackMap.get(V.LocalAudioTrack);if(l){if(!(l.track instanceof ce))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(c){const u=s.find(p=>{let{type:_}=p;return _===V.LocalAudioTrack});if(!(u.track instanceof ce))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(d)}else{if(!r.webAudioMediaStreamDest||d instanceof ce||d._bypassWebAudio)s.push({track:d,type:V.LocalAudioTrack});else{const u=new ce;u.addAudioTrack(d),s.push({track:u,type:V.LocalAudioTrack})}c=!0}}}return s}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=oo(t=t.filter(s=>n.indexOf(s)!==-1));for(const s of t){if(s instanceof Ct){const r=this.localTrackMap.get(V.LocalAudioTrack);if(!r)continue;r.track instanceof ce?(r.track.removeAudioTrack(s),this.unbindLocalAudioTrackEvents(s),r.track.trackList.length===0&&(e.push([V.LocalAudioTrack,r]),r.track.close())):e.push([V.LocalAudioTrack,r])}if(s instanceof dt){const r=this.localTrackMap.get(V.LocalVideoTrack);if(!r)continue;e.push([V.LocalVideoTrack,r]);const o=this.localTrackMap.get(V.LocalVideoLowTrack);o&&e.push([V.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:s}=e;switch(s){case V.LocalVideoTrack:n.addListener(K.GET_STATS,this.handleGetLocalVideoStats),n.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(K.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(K.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),n.addListener(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case V.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case V.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof ce?t.trackList.forEach(n=>{n.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(K.GET_STATS,this.handleGetLocalAudioStats),n.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(K.GET_STATS,this.handleGetLocalAudioStats),t.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(K.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:s}]=e;return{track:s,type:n}})),t.forEach(e=>{let{track:n,type:s}=e;switch(s){case V.LocalVideoTrack:n.off(K.GET_STATS,this.handleGetLocalVideoStats),n.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(K.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(K.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),n.off(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case V.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case V.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof ce?t.trackList.forEach(e=>{e.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(K.GET_STATS,this.handleGetLocalAudioStats),e.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(K.GET_STATS,this.handleGetLocalAudioStats),t.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Fn&&e.addListener(K.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof pn&&e.addListener(K.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(K.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(J.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(J.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,s)=>{var r;let o,{track:a,type:c}=n;switch(c){case V.LocalAudioTrack:o=St.Audio;break;case V.LocalVideoTrack:o=q(r=a._hints).call(r,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:o=St.Low}return{kind:c===V.LocalAudioTrack?J.AUDIO:J.VIDEO,stream_type:o,mid:e[s].id,ssrcs:e[s].localSSRC,isMuted:a.muted||!a.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}assignLocalTracks(t,e){t.forEach((n,s)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[s].id,ssrcs:e[s].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(tt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),q(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await ye(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),z.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Yt.TRACER}).onSuccess(),this.emit(tt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;s&&(this.store.subscribe(s.uid,"audio",void 0,void 0,void 0,Date.now()),(r=s.audioTrack)===null||r===void 0||r.emit(Cr.FIRST_FRAME_DECODED),z.firstRemoteFrame(this.store.sessionId,me.FIRST_AUDIO_DECODE,Ft.FIRST_AUDIO_DECODE,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);s&&z.firstRemoteFrame(this.store.sessionId,me.FIRST_AUDIO_RECEIVED,Ft.FIRST_AUDIO_RECEIVED,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,s)=>{this.reportVideoFirstFrameDecoded(e,n,s)},t.onFirstVideoReceived=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);s&&z.firstRemoteFrame(this.store.sessionId,me.FIRST_VIDEO_RECEIVED,Ft.FIRST_VIDEO_RECEIVED,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const s=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&s===r||this.emit(tt.ConnectionTypeChange,s),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ms(n))," -> ").concat(JSON.stringify(Ms(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ms(n))," -> ").concat(JSON.stringify(Ms(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(tt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===He.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,E.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===He.SEND_ONLY?this.restartICE(t):re(this,tt.RequestP2PRestartICE,{direction:He.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(V.LocalAudioTrack);if(t instanceof Ct&&(n==null?void 0:n.track)instanceof ce)return n.track.isActive||e.push([V.LocalAudioTrack,n]),e;const s=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(s&&(e.push(s),s[0]===V.LocalVideoTrack)){const r=this.localTrackMap.get(V.LocalVideoLowTrack);r&&e.push([V.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(V.LocalAudioTrack);if(t instanceof Ct&&(n==null?void 0:n.track)instanceof ce)return n.track.isActive&&e.push([V.LocalAudioTrack,n]),e;const s=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(s)if(s[0]===V.LocalVideoTrack){e.push(s);const r=this.localTrackMap.get(V.LocalVideoLowTrack);r&&e.push([V.LocalVideoLowTrack,r])}else e.push(s);return e}createMuteMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}createUnmuteMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(t,e){const n=[],s=this.remoteUserMap.get(t);if(!s)return n;if(e){const r=s.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(s.entries()).forEach(r=>{let[o,a]=r;n.push([t,{kind:o,id:a}])});return n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[s,{kind:r,id:o}]=n;switch(r){case J.VIDEO:return void(s._videoSSRC&&e.push({stream_type:J.VIDEO,ssrcId:s._videoSSRC}));case J.AUDIO:return void(s._audioSSRC&&e.push({stream_type:J.AUDIO,ssrcId:s._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:s}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(s),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(V.LocalVideoTrack),n=this.localTrackMap.get(V.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof Ct){const n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;const s=this.createUnmuteMessage(n);return void await Dt(this,tt.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(tt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(tt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await ye($c(this.dtlsFailedCount,ae)),this.emit(tt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(V.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof dt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof dt).length>1)throw new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Ct).length>1&&(t.some(e=>e instanceof Ct&&e._bypassWebAudio)||!Ot().webAudioMediaStreamDest))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof dt&&this.pendingLocalTracks.some(n=>n instanceof dt))throw new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Ct&&this.pendingLocalTracks.some(n=>n instanceof Ct)&&(!Ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Ct&&n._bypassWebAudio)))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding,s=qd(qd({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=n?t._mediaStreamTrack.clone():$p(t,s);const o=Pt(8,"track-low-"),a=new dt(r,qd(qd({},n&&{scaleResolutionDownBy:Jh(s,t)}),{},{frameRate:s.framerate,bitrateMax:s.bitrate,bitrateMin:s.bitrate}),void 0,void 0,o);return a.on(So.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,Us.LOW_STREAM)}),a._hints.push(Mt.LOW_STREAM),t.addListener(K.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,s){var r;const o=Array.from(Di(r=this.remoteUserMap).call(r)).find(a=>a._videoSSRC===t);if(o){s||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");z.firstRemoteVideoDecode(this.store.sessionId,me.FIRST_VIDEO_DECODE,Ft.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:s?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return!1;const s=this.remoteUserMap.get(t);if(!s)return!1;const r=s.get(e);if(!r)return!1;const o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){E.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(t)),this.state===vt.Connected?(E.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(t){throw new M(R.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new M(R.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new M(R.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new M(R.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new M(R.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new M(R.NOT_SUPPORTED)}async preConnect(t,e,n,s,r,o){throw new M(R.NOT_SUPPORTED)}getEstablishParams(){throw new M(R.NOT_SUPPORTED)}async reSubscribe(t){throw new M(R.NOT_SUPPORTED)}async updateVideoStreamParameter(t,e){throw new M(R.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===V.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Us.LOW_STREAM):n._updateRtpTransceiver(void 0)})}}function wn(i){return function(t,e,n){const s=t[e];if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];switch(i){case en.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(e));try{return await s.apply(this,o)}finally{c()}}case en.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(e));try{return await s.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(e)),d=await this.recvMutex.lock("From P2PChannel2.".concat(e));try{return await s.apply(this,o)}finally{c(),d()}}}},n}}function EI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Mr(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?EI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):EI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}U([wn(en.SEND_ONLY),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Te.prototype,"p2pConnect",null),U([wn(en.SEND_ONLY),T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Te.prototype,"unpublish",null),U([wn(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],Te.prototype,"unpublishLowStream",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String,Number,String]),T("design:returntype",P)],Te.prototype,"subscribe",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String,Number,String]),T("design:returntype",P)],Te.prototype,"mockSubscribe",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String,Boolean]),T("design:returntype",P)],Te.prototype,"unsubscribe",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Te.prototype,"muteRemote",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Te.prototype,"unmuteRemote",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Te.prototype,"hasRemoteMediaWithLock",null),U([wn(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],Te.prototype,"disconnectForReconnect",null),U([wn(en.RECEIVE_ONLY),T("design:type",Function),T("design:paramtypes",[Le,String,Number]),T("design:returntype",P)],Te.prototype,"remoteMediaSsrcChanged",null);class Ha{constructor(t){h(this,"store",void 0),h(this,"onStatsException",void 0),h(this,"onUploadPublishDuration",void 0),h(this,"onStatsChanged",void 0),h(this,"localStats",new Map),h(this,"remoteStats",new Map),h(this,"updateStatsInterval",void 0),h(this,"trafficStats",void 0),h(this,"trafficStatsPeerList",[]),h(this,"uplinkStats",void 0),h(this,"exceptionMonitor",void 0),h(this,"p2pChannel",void 0),h(this,"scalabilityMode",Mh.L1T1),h(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new c1,this.exceptionMonitor.on("exception",(e,n,s)=>{this.onStatsException&&this.onStatsException(e,n,s)})}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(V.LocalAudioTrack)||Mr({},ap)}getLocalVideoTrackStats(){return this.localStats.get(V.LocalVideoTrack)||Mr({},cp)}getRemoteAudioTrackStats(t){const e=(r,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===r);return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},n={};if(t){var s;const r=(s=this.remoteStats.get(t))===null||s===void 0?void 0:s.audioStats;r&&(n[t]=e(t,r))}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{audioStats:a}]=r;a&&(n[o]=e(o,a))});return n}getRemoteNetworkQualityStats(t){const e={};if(t){var n;const s=(n=this.remoteStats.get(t))===null||n===void 0?void 0:n.networkStats;s&&(e[t]=s)}else Array.from(this.remoteStats.entries()).forEach(s=>{let[r,{networkStats:o}]=s;o&&(e[r]=o)});return e}getRemoteVideoTrackStats(t){const e=(r,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===r);return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},n={};if(t){var s;const r=(s=this.remoteStats.get(t))===null||s===void 0?void 0:s.videoStats;r&&(n[t]=e(t,r))}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{videoStats:a}]=r;a&&(n[o]=e(o,a))});return n}getRTCStats(){let t=0,e=0,n=0,s=0;const r=this.localStats.get(V.LocalAudioTrack);r&&(t+=r.sendBytes,e+=r.sendBitrate);const o=this.localStats.get(V.LocalVideoTrack);o&&(t+=o.sendBytes,e+=o.sendBitrate);const a=this.localStats.get(V.LocalVideoLowTrack);a&&(t+=a.sendBytes,e+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(n+=l.receiveBytes,s+=l.receiveBitrate),u&&(n+=u.receiveBytes,s+=u.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:e,SendBytes:t,RecvBytes:n,RecvBitrate:s,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(e=>e.B_ppad!==void 0||e.B_ppvd!==void 0),t.peer_delay.filter(e=>this.trafficStatsPeerList.indexOf(e.peer_uid)===-1).forEach(e=>{var n;const s=(n=this.p2pChannel)===null||n===void 0?void 0:n.getRemoteMedia(e.peer_uid),r=s!=null&&s.videoSSRC?Ve.measureFromSubscribeStart(this.store.clientId,s.videoSSRC):0,o=s!=null&&s.audioSSRC?Ve.measureFromSubscribeStart(this.store.clientId,s.audioSSRC):0;e.B_ppad!==void 0&&e.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,r>o?r:o),this.trafficStatsPeerList.push(e.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&E.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,e,n){if(!t)return!1;const s=!!n&&e.framesDecodeFreezeTime>n.framesDecodeFreezeTime,r=!n||e.framesDecodeCount>n.framesDecodeCount;return s||!r}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(e=>{let[n,s]=e;switch(n){case V.LocalVideoTrack:case V.LocalVideoLowTrack:{const o=s,a=Mr({},cp),c=t.getStats(),d=t.getLocalMedia(n);if(c){const l=c.videoSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){const u=t.getLocalVideoSize(),p=t.getEncoderConfig(V.LocalVideoTrack);l.codec!=="H264"&&l.codec!=="H265"&&l.codec!=="VP8"&&l.codec!=="VP9"&&l.codec!=="AV1X"&&l.codec!=="AV1"||(a.codecType=l.codec),a.sendBytes=l.bytes,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0,l.inputFrame?(a.captureFrameRate=l.inputFrame.frameRate,a.captureResolutionHeight=l.inputFrame.height,a.captureResolutionWidth=l.inputFrame.width):u&&(a.captureResolutionWidth=u.width,a.captureResolutionHeight=u.height),l.sentFrame?(a.sendFrameRate=l.sentFrame.frameRate,a.sendResolutionHeight=l.sentFrame.height,a.sendResolutionWidth=l.sentFrame.width):u&&(a.sendResolutionWidth=u.width,a.sendResolutionHeight=u.height),l.avgEncodeMs&&(a.encodeDelay=l.avgEncodeMs),p&&p.bitrateMax&&(a.targetSendBitrate=1e3*p.bitrateMax),a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.totalDuration=o?o.totalDuration+1:1,a.totalFreezeTime=o?o.totalFreezeTime:0,this.isLocalVideoFreeze(l)&&(a.totalFreezeTime+=1),l.scalabilityMode&&this.scalabilityMode!==l.scalabilityMode&&(E.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(l.scalabilityMode)),this.scalabilityMode=l.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var r;this.localStats.set(n,a),((o==null?void 0:o.sendResolutionWidth)!==a.sendResolutionWidth||(o==null?void 0:o.sendResolutionHeight)!==a.sendResolutionHeight)&&((r=this.onStatsChanged)===null||r===void 0||r.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case V.LocalAudioTrack:{const o=s,a=Mr({},ap),c=t.getStats(),d=t.getLocalMedia(n);if(c){const l=c.audioSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){if(l.codec!=="opus"&&l.codec!=="aac"&&l.codec!=="PCMU"&&l.codec!=="PCMA"&&l.codec!=="G722"||(a.codecType=l.codec),l.inputLevel)a.sendVolumeLevel=Math.round(32767*l.inputLevel);else{const u=t.getLocalAudioVolume();u&&(a.sendVolumeLevel=Math.round(32767*u))}a.sendBytes=l.bytes,a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.sendBitrate=o?8*Math.max(0,a.sendBytes-o.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(V.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(e=>{var n,s;let[r,{videoStats:o,audioStats:a,videoPcStats:c}]=e;const d=a,l=o,u=c,p=Mr({},SR),_=Mr({},RR),S=Mr({},Yk),{audioTrack:f,videoTrack:g,audioSSRC:C,videoSSRC:y}=t.getRemoteMedia(r);let A;A=t instanceof Te?t.getStats(!0):t.getStats();const k=(n=A)===null||n===void 0?void 0:n.audioRecv.find(L=>L.ssrc===C),O=(s=A)===null||s===void 0?void 0:s.videoRecv.find(L=>L.ssrc===y),N=this.trafficStats&&this.trafficStats.peer_delay.find(L=>L.peer_uid===r);if(k&&(k.codec!=="opus"&&k.codec!=="aac"&&k.codec!=="PCMU"&&k.codec!=="PCMA"&&k.codec!=="G722"||(p.codecType=k.codec),k.outputLevel?p.receiveLevel=Math.round(32767*k.outputLevel):f&&(p.receiveLevel=Math.round(32767*f.getVolumeLevel())),p.receiveBytes=k.bytes,p.receivePackets=k.packets,p.receivePacketsLost=k.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=k.jitterBufferMs,p.totalDuration>10&&Ha.isRemoteAudioFreeze(f)&&(p.totalFreezeTime+=1)),O){O.codec!=="H264"&&O.codec!=="H265"&&O.codec!=="VP8"&&O.codec!=="VP9"&&O.codec!=="AV1X"&&O.codec!=="AV1"||(_.codecType=O.codec),_.receiveBytes=O.bytes,_.receiveBitrate=l?8*Math.max(0,_.receiveBytes-l.receiveBytes):0,_.decodeFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,_.renderFrameRate=O.decodeFrameRate<0?0:O.decodeFrameRate,O.outputFrame&&(_.renderFrameRate=O.outputFrame.frameRate),O.receivedFrame?(_.receiveFrameRate=O.receivedFrame.frameRate,_.receiveResolutionHeight=O.receivedFrame.height,_.receiveResolutionWidth=O.receivedFrame.width):g&&(_.receiveResolutionHeight=g._videoHeight||0,_.receiveResolutionWidth=g._videoWidth||0),O.framesRateFirefox!==void 0&&(_.receiveFrameRate=Math.round(O.framesRateFirefox)),_.receivePackets=O.packets,_.receivePacketsLost=O.packetsLost,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost),_.totalDuration=l?l.totalDuration+1:1,_.totalFreezeTime=l?l.totalFreezeTime:0,_.receiveDelay=O.jitterBufferMs||0;const L=!!y&&t.getRemoteVideoIsReady(y);g&&L&&Ha.isRemoteVideoFreeze(g,O,u)&&(_.totalFreezeTime+=1),_.freezeRate=_.totalFreezeTime/_.totalDuration}N&&(p.end2EndDelay=N.B_ad,_.end2EndDelay=N.B_vd,p.transportDelay=N.B_ed,_.transportDelay=N.B_ed,p.currentPacketLossRate=N.B_ealr4/100,_.currentPacketLossRate=N.B_evlr4/100,S.uplinkNetworkQuality=N.B_punq?N.B_punq:0,S.downlinkNetworkQuality=N.B_pdnq?N.B_pdnq:0),this.remoteStats.set(r,{audioStats:p,videoStats:_,videoPcStats:O,networkStats:S}),f&&this.exceptionMonitor.setRemoteAudioStats(f,p),g&&this.exceptionMonitor.setRemoteVideoStats(g,_)})}}function mI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Ka(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?mI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):mI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class w1 extends Wt{constructor(t,e,n,s){super(),h(this,"spec",void 0),h(this,"token",void 0),h(this,"websocket",void 0),h(this,"pingpongTimer",void 0),h(this,"reconnectMode","retry"),h(this,"serviceMode",void 0),h(this,"reqId",0),h(this,"commandReqId",0),h(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),h(this,"handleWebSocketMessage",r=>{if(!r.data)return;const o=JSON.parse(r.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):this.serviceMode===fe.INJECT?this.emit(dn.INJECT_STREAM_STATUS,o):(z.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===fe.TRANSCODE?1:2}),this.emit(dn.PUBLISH_STREAM_STATUS,o))}),this.spec=e,this.token=t,this.serviceMode=s,this.websocket=new Ta("live-streaming",n),this.websocket.on(et.CONNECTED,this.handleWebSocketOpen),this.websocket.on(et.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(et.REQUEST_NEW_URLS,(r,o)=>{re(this,dn.REQUEST_NEW_ADDRESS).then(r).catch(o)}),this.websocket.on(et.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,e,n,s){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const r=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new w(R.UNEXPECTED_ERROR);const a=Ka({command:t,sdkVersion:Ji==="4.20.0"?"0.0.1":Ji,seq:o,requestId:o,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},e);if(this.websocket.state==="closed")throw new w(R.WS_DISCONNECT);const c=()=>new P((p,_)=>{this.websocket.once(et.CLOSED,()=>_(new w(R.WS_ABORT))),this.websocket.once(et.CONNECTED,p)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new P((p,_)=>{const S=()=>{_(new w(R.WS_ABORT))};this.websocket.once(et.RECONNECTING,S),this.websocket.once(et.CLOSED,S),this.once("@".concat(o,"-").concat(this.spec.sid),f=>{p(f)})});s&&z.workerEvent(this.spec.sid,Ka(Ka({},s),{},{requestId:r,actionType:"request",payload:JSON.stringify(e.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(p){if(this.websocket.state==="closed")throw p;return await c(),await this.request(t,e,n)}return s&&z.workerEvent(this.spec.sid,Ka(Ka({},s),{},{requestId:r,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=Ji==="4.20.0"?"0.0.1":Ji;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case ne.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void E.warning("live stream response already exists stream");case ne.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ne.LIVE_STREAM_RESPONSE_BAD_STREAM:case ne.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new w(R.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case ne.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ne.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new w(R.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case ne.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new w(R.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(dn.WARNING,e,t.serverResponse.url)}case ne.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const e=new w(R.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(dn.WARNING,e,t.serverResponse.url)}case ne.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ne.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new w(R.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case ne.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const e=new w(R.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(dn.WARNING,e,t.serverResponse.url)}case ne.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case ne.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ne.LIVE_STREAM_RESPONSE_WORKER_LOST:case ne.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ne.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ne.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new w(R.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Qc)},6e3)}}function fI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function ci(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?fI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):fI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class O1 extends Wt{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ae,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ae;super(),h(this,"onLiveStreamWarning",void 0),h(this,"onLiveStreamError",void 0),h(this,"onInjectStatusChange",void 0),h(this,"spec",void 0),h(this,"retryTimeout",1e4),h(this,"connection",void 0),h(this,"httpRetryConfig",void 0),h(this,"wsRetryConfig",void 0),h(this,"streamingTasks",new Map),h(this,"isStartingStreamingTask",!1),h(this,"taskMutex",new Ae("live-streaming")),h(this,"cancelToken",hi.CancelToken.source()),h(this,"transcodingConfig",void 0),h(this,"injectConfig",ci({},dk)),h(this,"injectLoopTimes",0),h(this,"uapResponse",void 0),h(this,"lastTaskId",1),h(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=n,this.wsRetryConfig=e}async setTranscodingConfig(t){const e=ci(ci({},ck),t);e.videoCodecProfile!==66&&e.videoCodecProfile!==77&&e.videoCodecProfile!==100&&(E.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(e.videoCodecProfile," -> 100")),e.videoCodecProfile=100),e.transcodingUsers||(e.transcodingUsers=e.userConfigs),e.transcodingUsers&&(e.transcodingUsers=e.transcodingUsers.map(o=>ci(ci(ci({},ak),o),{},{zOrder:o.zOrder?o.zOrder+1:1}))),function(o){Kt(o.width)||bt(o.width,"config.width",0,1e4),Kt(o.height)||bt(o.height,"config.height",0,1e4),Kt(o.videoBitrate)||bt(o.videoBitrate,"config.videoBitrate",1,1e6),Kt(o.videoFrameRate)||bt(o.videoFrameRate,"config.videoFrameRate"),Kt(o.lowLatency)||ys(o.lowLatency,"config.lowLatency"),Kt(o.audioSampleRate)||Ee(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Kt(o.audioBitrate)||bt(o.audioBitrate,"config.audioBitrate",1,128),Kt(o.audioChannels)||Ee(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),Kt(o.videoGop)||bt(o.videoGop,"config.videoGop"),Kt(o.videoCodecProfile)||Ee(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Kt(o.userCount)||bt(o.userCount,"config.userCount",0,17),Kt(o.backgroundColor)||bt(o.backgroundColor,"config.backgroundColor",0,16777215),Kt(o.userConfigExtraInfo)||Me(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!Kt(o.transcodingUsers)&&($n(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach((a,c)=>{Vh(a.uid),Kt(a.x)||bt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Kt(a.y)||bt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Kt(a.width)||bt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Kt(a.height)||bt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Kt(a.zOrder)||bt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Kt(a.alpha)||bt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),Kt(o.watermark)||Bh(o.watermark,"watermark"),Kt(o.backgroundImage)||Bh(o.backgroundImage,"backgroundImage"),o.images&&!Kt(o.images)&&($n(o.images,"config.images"),o.images.forEach((a,c)=>{Bh(a,"images[".concat(c,"]"))}))}(e);const n=[];e.images&&n.push(...e.images.map(o=>ci(ci(ci({},Fh),o),{},{zOrder:255}))),e.backgroundImage&&(n.push(ci(ci(ci({},Fh),e.backgroundImage),{},{zOrder:0})),delete e.backgroundImage),e.watermark&&(n.push(ci(ci(ci({},Fh),e.watermark),{},{zOrder:255})),delete e.watermark),e.images=n,e.transcodingUsers&&(e.userConfigs=e.transcodingUsers.map(o=>ci({},o)),e.userCount=e.transcodingUsers.length,delete e.transcodingUsers);const s=(e.userConfigs||[]).map(o=>typeof o.uid=="number"?P.resolve(o.uid):_R(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await P.all(s)).forEach((o,a)=>{e.userConfigs&&e.userConfigs[a]&&(e.userConfigs[a].uid=o)}),this.transcodingConfig=e,this.connection)try{var r;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(In(r=this.streamingTasks).call(r)).map(a=>a.taskId).join("#")});E.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{E.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then(()=>{E.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{E.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}}setInjectStreamConfig(t,e){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=e}async startLiveStreamingTask(t,e,n){var s;if(Array.from(In(s=this.streamingTasks).call(s)).find(c=>c.mode===fe.INJECT)&&e===fe.INJECT)return new w(R.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&e===fe.TRANSCODE)throw new w(R.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};E.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(e));const o=await this.taskMutex.lock();if(!this.connection&&n)return void o();if(this.streamingTasks.get(t)&&!n)return o(),new w(R.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(e))}catch(c){throw o(),c}switch(e){case fe.TRANSCODE:r.transcodingConfig=ci({},this.transcodingConfig);break;case fe.RAW:break;case fe.INJECT:r={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const c=new P((l,u)=>{ye(this.retryTimeout).then(()=>{if(n)return u(n);const p=this.statusError.get(t);return p?(this.statusError.delete(t),u(p)):void 0})}),d=await P.race([this.connection.request("request",{clientRequest:r},!0,{url:t,command:"PublishStream",workerType:e===fe.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),c]);this.isStartingStreamingTask=!1,E.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(d.code)),this.streamingTasks.set(t,{clientRequest:r,mode:e,url:t,taskId:a}),o()}catch(c){if(o(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||n)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,e,c)):await this.startLiveStreamingTask(t,e,c)}}stopLiveStreamingTask(t){return new P((e,n)=>{const s=this.streamingTasks.get(t);if(!s||!this.connection)return new w(R.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const r=s.mode;s.abortTask=()=>{E.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),e()},this.connection.request("request",{clientRequest:{command:r===fe.INJECT?"UninjectStream":"UnpublishStream",url:s.url}},!1,{url:t,command:"UnPublishStream",workerType:r===fe.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(o=>{E.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&r!==fe.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),e(),r===fe.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)}).catch(n)})}async controlInjectStream(t,e,n,s){const r=this.streamingTasks.get(t);if(!r||!this.connection||r.mode!==fe.INJECT)throw new w(R.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:e,audioVolume:n,position:s}})).serverResponse}resetAllTask(){var t;const e=Array.from(In(t=this.streamingTasks).call(t));this.terminate();for(const n of e)this.startLiveStreamingTask(n.url,n.mode).catch(s=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,s)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=hi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new w(R.UNEXPECTED_ERROR,"live streaming connection has already connected");const e=await re(this,Eo.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=e,this.connection=new w1(e.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(dn.WARNING,(n,s)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(s,n)),this.connection.on(dn.PUBLISH_STREAM_STATUS,n=>this.handlePublishStreamServer(n)),this.connection.on(dn.INJECT_STREAM_STATUS,n=>this.handleInjectStreamServerStatus(n)),this.connection.on(dn.REQUEST_NEW_ADDRESS,(n,s)=>{if(!this.connection)return s(new w(R.UNEXPECTED_ERROR,"can not get new live streaming address list"));re(this,Eo.REQUEST_WORKER_MANAGER_LIST,t).then(r=>{this.uapResponse=r,n(r.addressList)}).catch(s)}),await this.connection.init(e.addressList),this.connection}handlePublishStreamServer(t){const e=t.serverStatus&&t.serverStatus.url||"empty_url",n=this.streamingTasks.get(e),s=t.reason;switch(t.code){case ne.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ne.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new w(R.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(n)return E.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(e,o);if(!this.isStartingStreamingTask)return;this.statusError.set(e,o)}case ne.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new w(R.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,s);return this.onLiveStreamWarning&&this.onLiveStreamWarning(e,o)}case ne.LIVE_STREAM_RESPONSE_WORKER_LOST:case ne.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var r;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(In(r=this.streamingTasks).call(r));for(const a of o)a.abortTask?a.abortTask():(E.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new w(R.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{E.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{E.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}handleInjectStreamServerStatus(t){const e=Number(t.uid),n=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_START_SUCCESS,e,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,e,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_START_UNAUTHORIZED,e,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_BROKEN,e,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Ns.INJECT_STREAM_STATUS_START_TIMEOUT,e,n),void this.streamingTasks.delete(n);default:return void E.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class Jd{constructor(){h(this,"destChannelMediaInfos",new Map),h(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){MS(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){MS(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){xh(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function gI(i){if(!(i instanceof Jd))return new w(R.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=i.getSrcChannelMediaInfo(),e=i.getDestChannelMediaInfo();if(!t)return new w(R.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(e.size===0)return new w(R.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class N1 extends Wt{constructor(t,e,n){super(),h(this,"ws",void 0),h(this,"requestId",1),h(this,"heartBeatTimer",void 0),h(this,"joinInfo",void 0),h(this,"clientId",void 0),h(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),h(this,"onClose",s=>{this.emit("close"),this.dispose()}),h(this,"onMessage",s=>{const r=JSON.parse(s.data);if(!r||r.command!=="serverResponse"||!r.requestId)return r&&r.command==="serverStatus"&&r.serverStatus&&r.serverStatus.command?(this.emit("status",r.serverStatus),void this.emit(r.serverStatus.command,r.serverStatus)):void 0;this.emit("req_".concat(r.requestId),r)}),this.joinInfo=t,this.clientId=e,this.ws=new Ta("cross-channel-".concat(this.clientId),n),this.ws.on(et.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(et.CONNECTED,this.onOpen),this.ws.on(et.ON_MESSAGE,this.onMessage),this.ws.on(et.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const e=this.requestId++;return t.requestId=e,t.seq=e,this.ws.sendMessage(t),e}waitStatus(t){return new P((e,n)=>{const s=window.setTimeout(()=>{n(new w(R.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,r=>{window.clearTimeout(s),r.state&&r.state!==0?n(new w(R.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):e(void 0)}),this.once("dispose",()=>{window.clearTimeout(s),n(new w(R.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new w(R.WS_DISCONNECT);const e=()=>new P((o,a)=>{this.ws.once(et.CLOSED,()=>a(new w(R.WS_ABORT))),this.ws.once(et.CONNECTED,o)});this.ws.state!=="connected"&&await e();const n=this.sendMessage(t),s=new P((o,a)=>{const c=()=>{a(new w(R.WS_ABORT))};this.ws.once(et.RECONNECTING,c),this.ws.once(et.CLOSED,c),this.once("req_".concat(n),o),ye(3e3).then(()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(et.RECONNECTING,c),this.ws.off(et.CLOSED,c),a(new w(R.TIMEOUT,"cross channel ws request timeout"))})}),r=await s;if(!r||r.code!==200)throw new w(R.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(r)));return r}async connect(t){this.ws.removeAllListeners(et.REQUEST_NEW_URLS),this.ws.on(et.REQUEST_NEW_URLS,e=>{e(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const e=this.requestId++;return t.requestId=e,this.ws.sendMessage(t),e}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class D1 extends Wt{set state(t){t!==this._state&&(t!==si.RELAY_STATE_FAILURE&&(this.errorCode=Ds.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,e,n,s,r){super(),h(this,"joinInfo",void 0),h(this,"sid",void 0),h(this,"clientId",void 0),h(this,"cancelToken",hi.CancelToken.source()),h(this,"workerToken",void 0),h(this,"requestId",0),h(this,"signal",void 0),h(this,"prevChannelMediaConfig",void 0),h(this,"httpRetryConfig",void 0),h(this,"_resolution",void 0),h(this,"_state",si.RELAY_STATE_IDLE),h(this,"errorCode",Ds.RELAY_OK),h(this,"onStatus",o=>{E.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",vn.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",vn.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Ds.SRC_TOKEN_EXPIRED,this.state=si.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Ds.DEST_TOKEN_EXPIRED,this.state=si.RELAY_STATE_FAILURE))}),h(this,"onReconnect",async()=>{E.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",vn.NETWORK_DISCONNECTED),this.state=si.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(o=>{this.state!==si.RELAY_STATE_IDLE&&(E.error("auto restart channel media relay failed",o.toString()),this.errorCode=Ds.SERVER_CONNECTION_LOST,this.state=si.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=e,this.sid=lh(),this.signal=new N1(this.joinInfo,this.clientId,n),this.httpRetryConfig=s,this._resolution=r}async startChannelMediaRelay(t){if(this.state!==si.RELAY_STATE_IDLE)throw new w(R.INVALID_OPERATION);this.state=si.RELAY_STATE_CONNECTING,await this.connect(),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(e){throw e.data&&e.data.serverResponse&&e.data.serverResponse.command==="SetSourceChannel"?new w(R.CROSS_CHANNEL_FAILED_JOIN_SRC):e.data&&e.data.serverResponse&&e.serverResponse.command==="SetDestChannelStatus"?new w(R.CROSS_CHANNEL_FAILED_JOIN_DEST):e.data&&e.data.serverResponse&&e.serverResponse.command==="StartPacketTransfer"?new w(R.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):e}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==si.RELAY_STATE_RUNNING)throw new w(R.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==si.RELAY_STATE_RUNNING)throw new w(R.INVALID_OPERATION);const e=this.genMessage(Ke.SetVideoProfile);await this.signal.request(e),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),E.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=si.RELAY_STATE_IDLE,this.dispose()}dispose(){E.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=hi.CancelToken.source(),this.state=si.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await Fk(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",vn.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const e=this.genMessage(Ke.StopPacketTransfer);await this.signal.request(e),await this.signal.waitStatus("Normal Quit"),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(Ke.SetSdkProfile,t);await this.signal.request(n),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const s=this.genMessage(Ke.SetSourceChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",vn.PACKET_JOINED_SRC_CHANNEL),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(Ke.SetSourceUserId,t);await this.signal.request(r),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(Ke.SetDestChannel,t);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",vn.PACKET_JOINED_DEST_CHANNEL),E.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(Ke.StartPacketTransfer,t);await this.signal.request(a),this.emit("event",vn.PACKET_SENT_TO_DEST_CHANNEL),this.state=si.RELAY_STATE_RUNNING,E.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const e=this.genMessage(Ke.UpdateDestChannel,t);await this.signal.request(e),this.emit("event",vn.PACKET_UPDATE_DEST_CHANNEL),E.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(Ke.StopPacketTransfer);await this.signal.request(t),E.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,e){const n=[],s=[],r=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Ji,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.20.0"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(t){case Ke.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Ke.SetSourceChannel:if(c=e&&e.getSrcChannelMediaInfo(),!c)throw new w(R.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case Ke.SetSourceUserId:if(c=e&&e.getSrcChannelMediaInfo(),!c)throw new w(R.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case Ke.SetDestChannel:if(a=e&&e.getDestChannelMediaInfo(),!a)throw new w(R.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),s.push(d.uid+""),r.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"SetDestChannel",channelName:n,uid:s,token:r},o;case Ke.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Ke.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Ke.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Ke.UpdateDestChannel:if(a=e&&e.getDestChannelMediaInfo(),!a)throw new w(R.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),s.push(d.uid+""),r.push(d.token||this.joinInfo.appId)}),o.clientRequest={command:"UpdateDestChannel",channelName:n,uid:s,token:r},o;case Ke.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}function zd(i){var t={},e=!1;function n(s,r){return e=!0,{done:!1,value:new Wp(r=new Hp(function(o){o(i[s](r))}),1)}}return t[Xr!==void 0&&Bf||"@@iterator"]=function(){return this},t.next=function(s){return e?(e=!1,s):n("next",s)},typeof i.throw=="function"&&(t.throw=function(s){if(e)throw e=!1,s;return n("throw",s)}),typeof i.return=="function"&&(t.return=function(s){return e?(e=!1,s):n("return",s)}),t}var TI=xt(WC);function SI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function RI(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?SI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):SI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function CI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function II(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?CI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):CI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Oe extends pd{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var e;return q(e=Object.keys(ws)).call(e,t)}))]}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"statsFilter",void 0),h(this,"useRTX",!1),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"establishPromise",void 0),h(this,"mutex",new Ae("P2PConnection-mutex")),this.store=e,this.peerConnection=new RTCPeerConnection(Oe.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Hd(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=An(t.sdp),n=ja(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=t,II(II({},e),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:t.sdp})}catch(t){throw new M(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,n,s,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(c){h(this,"sessionDesc",void 0),h(this,"localCapabilities",void 0),h(this,"rtpCapabilities",void 0),h(this,"candidates",void 0),h(this,"iceParameters",void 0),h(this,"dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),c=kt(c);const{remoteIceParameters:d,remoteDtlsParameters:l,candidates:u,remoteRTPCapabilities:p,remoteSetup:_,localCapabilities:S,sdkCodec:f,cname:g}=c,C=Ht.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=p,this.candidates=u,this.iceParameters=d,this.dtlsParameters=l,this.setup=_,this.localCapabilities=S,this.cname=g;for(let y=0;y<C.mediaDescriptions.length;y++){const A=C.mediaDescriptions[y];if(A.attributes.iceUfrag=d.iceUfrag,A.attributes.icePwd=d.icePwd,A.attributes.fingerprints=l.fingerprints,A.attributes.candidates=u,A.attributes.setup=_,A.media.mediaType==="video"){A.media.fmts=p.videoCodecs.map(O=>O.payloadType.toString(10));let k=p.videoCodecs.filter(O=>{var N,L;return(N=O.rtpMap)===null||N===void 0?void 0:q(L=N.encodingName.toLowerCase()).call(L,f)});k.length===0&&(k=p.videoCodecs),A.attributes.payloads=k,A.attributes.extmaps=p.videoExtensions}A.media.mediaType==="audio"&&(A.media.fmts=p.audioCodecs.map(k=>k.payloadType.toString(10)),A.attributes.payloads=p.audioCodecs,A.attributes.extmaps=p.audioExtensions),C.mediaDescriptions[y]=this.mungMediaDesc(A)}this.sessionDesc=C,this.currentMidIndex=C.mediaDescriptions.length-1}toString(){return Ht.print(this.sessionDesc)}send(c,d,l){const{ssrcs:u,ssrcGroups:p}=fi(d,this.cname),_=this.sessionDesc.mediaDescriptions.find(g=>c===J.VIDEO?g.media.mediaType==="video":g.media.mediaType==="audio"),S=u[0].attributes.label,f=u[0].attributes.mslabel;return _.attributes.ssrcs=_.attributes.ssrcs.concat(u),_.attributes.ssrcGroups=_.attributes.ssrcGroups.concat(p),{id:S,mslabel:f}}batchSend(c){return c.map(d=>{let{kind:l,ssrcMsg:u}=d;return this.send(l,u,void 0)})}stopSending(c){this.sessionDesc.mediaDescriptions.forEach(d=>{const l=[],u=[],p=[];d.attributes.ssrcs.forEach(_=>{q(c).call(c,_.attributes.label||"")?p.push(_):l.push(_)}),d.attributes.ssrcGroups.forEach(_=>{var S;q(S=p.map(f=>f.ssrcId)).call(S,_.ssrcIds[0])||u.push(_)}),d.attributes.ssrcs=l,d.attributes.ssrcGroups=u})}mute(c){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive"}unmute(c){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly"}receive(c,d,l){c.forEach((u,p)=>{const _=u._mediaStreamTrack,S=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===_.kind),f=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[S],u);this.sessionDesc.mediaDescriptions[S]=f})}stopReceiving(c){}updateCandidates(c){c===Ue.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(l=>l.transport==="tcp"&&l.connectionAddress===d.connectionAddress&&l.port===d.port)===-1&&this.candidates.push(RI(RI({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(const d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates}restartICE(c){c=kt(c),this.iceParameters=c,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=c.iceUfrag,d.attributes.icePwd=c.icePwd})}predictReceivingMids(c){const d=[];for(let l=0;l<c;l++)d.push((this.currentMidIndex+l+1).toString(10));return d}mungRecvMediaDsec(c,d){const l=kt(c);return Hs(l,d),Yd(l,d),l}updateRecvMedia(c,d){const l=this.sessionDesc.mediaDescriptions.findIndex(u=>u.attributes.mid===c);if(l!==-1){const u=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[l],d);this.sessionDesc.mediaDescriptions[l]=u}}bumpMid(c){this.currentMidIndex+=c}updateTrackLabel(c,d,l){const u=this.sessionDesc.mediaDescriptions.find(_=>c===J.VIDEO?_.attributes.mid==="video":_.attributes.mid==="audio");if(u){const _=u.attributes.ssrcs.find(S=>S.attributes.label===d);var p;_&&(_.attributes.label=l,(p=_.attributes.msid)===null||p===void 0||p.replace(d,l))}}mungMediaDesc(c){const d=kt(c);return Kd(d),function(l){const u=l.attributes.extmaps.find(p=>p.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u&&l.attributes.extmaps.splice(l.attributes.extmaps.indexOf(u),1),l.attributes.payloads.forEach(p=>{const _=p.rtcpFeedbacks.findIndex(S=>S.type==="transport-cc");_!==-1&&p.rtcpFeedbacks.splice(_,1)})}(d),d}getSSRC(c){for(const d of this.sessionDesc.mediaDescriptions)for(const l of d.attributes.ssrcs)if(l.attributes.label===c)return[l]}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:n,remoteRTPCapabilities:s.send,remoteSetup:r,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,e){throw new M(R.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,e){var n=this;return vi(function*(){const s=yield at(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const r=t.map(p=>n.peerConnection.addTrack(p._mediaStreamTrack)),o=yield at(n.peerConnection.createOffer()),a=Ht.parse(o.sdp),c=t.map(p=>{const _=p._mediaStreamTrack,S=a.mediaDescriptions.find(f=>f.attributes.mid===_.kind);if(!S)throw new Error("Cannot extract ssrc from mediaDescription.");return function(f,g,C){const y=f.attributes.ssrcs.filter(k=>k.attributes.label===g),A=f.attributes.ssrcGroups;if(y.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(A&&y.length>1){const k=A.find(O=>O.ssrcIds.indexOf(y[0].ssrcId)!==-1);return k?[{ssrcId:k.ssrcIds[0],rtx:C?k.ssrcIds[1]:void 0}]:[{ssrcId:y[0].ssrcId}]}return[{ssrcId:y[0].ssrcId}]}(S,_.id,n.useRTX)});let d;try{d=yield c}catch(p){throw r.forEach(_=>{Xe()&&_.replaceTrack(null),n.peerConnection.removeTrack(_)}),p}const l=n.mungSendOfferSDP(o.sdp,t);n.remoteSDP.receive(t,e,d);const u=n.remoteSDP.toString();return yield at(n.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield at(n.applySendEncodings(r,t)),yield at(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),t.map((p,_)=>{const S=p._mediaStreamTrack.id;return{localSSRC:c[_],id:S}})}catch(r){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(r.toString()))}finally{s()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const e=this.peerConnection.getSenders().filter(r=>{var o;return t.indexOf(((o=r.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");e.map(r=>{Xe()&&r.replaceTrack(null),this.peerConnection.removeTrack(r)});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(t);const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(t,e,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:r,mslabel:o}=this.remoteSDP.send(t,e,s),a=new P((l,u)=>{const p=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(r)))},1e4),_=S=>{const f=ft();if((f.name==="Safari"&&Number(f.version)===11||Qe())&&S.track.id!==r&&S.streams[0].id===o){var g;const C=S.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(t,r,S.track.id),this.peerConnection.removeEventListener("track",_),clearTimeout(p),void l(C)}if(S.track.id===r)return this.peerConnection.removeEventListener("track",_),clearTimeout(p),void l(S.track)};this.peerConnection.addEventListener("track",_)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:r}}catch(r){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter(n=>{var s;return t.indexOf(((s=n.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(e.length!==t.length)throw new Error("sender' length doesn't match mids' length.");e.map(n=>{if(Xe()&&n.track)n.track.enabled=!1;else{const s=n.getParameters();s.encodings.forEach(r=>r.active=!1),n.setParameters(s)}})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getSenders().filter(r=>{var o;return t.indexOf(((o=r.track)===null||o===void 0?void 0:o.id)||"")!==-1});if(e.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");e.map(async r=>{if(Xe()&&r.track)r.track.enabled=!0;else{const o=r.getParameters();o.encodings.forEach(a=>a.active=!0),await r.setParameters(o)}});const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return vi(function*(){const n=yield at(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){const c=e.peerConnection.getConfiguration(),d=t===Ue.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(E.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,e.peerConnection.setConfiguration(c))}else if(t===Ue.RELAY)return;t!==Ue.RELAY&&e.remoteSDP.updateCandidates(t);const s=yield at(e.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=An(s.sdp),{remoteIceParameters:o}=yield r.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString();yield at(e.peerConnection.setLocalDescription(s)),yield at(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(s){E.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),s)}finally{n()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(n.sdp,[e]);this.remoteSDP.updateRecvMedia(e._mediaStreamTrack.kind,e);const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new M(R.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,e){const n=this.peerConnection.getSenders().filter(s=>{var r;return((r=s.track)===null||r===void 0?void 0:r.id)===t});n.length===1&&await this.applySendEncodings(n,[e])}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const n=this.peerConnection.getSenders().find(s=>{var r;return((r=s.track)===null||r===void 0?void 0:r.id)===e});n&&await n.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,e){throw new M(R.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new M(R.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},v("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ro(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...Oe.turnServerConfigToIceServers(t.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...Oe.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(n=>{n.security?n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),e}async updateRtpSenderEncodings(t,e){var n;if(e||(e=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===t._mediaStreamTrack.id})),!e)return E.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Ot().supportSetRtpSenderParameters)return E.warn("Browser not support set rtp-sender parameters");const s={},r={};if(t instanceof dt)switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(v("DSCP_TYPE")&&vs()){var o;const d=v("DSCP_TYPE");q(o=["very-low","low","medium","high"]).call(o,d)&&(r.networkPriority=d)}const a=e.getParameters(),c=(n=a.encodings)===null||n===void 0?void 0:n[0];c&&Object.assign(c,r),Object.assign(a,s),E.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await e.setParameters(a)}async applySendEncodings(t,e){try{if(!Ot().supportSetRtpSenderParameters||t.length!==e.length)return;for(let n=0;n<t.length;n++){const s=t[n],r=e[n];s&&r&&await this.updateRtpSenderEncodings(r,s)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e){const n=Ht.parse(t);return e.forEach((s,r)=>{const o=s._mediaStreamTrack,a=n.mediaDescriptions.find(c=>c.attributes.mid===o.kind);a&&Hs(a,s)}),Ht.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,n)=>{var s;(s=this.onFirstVideoDecoded)===null||s===void 0||s.call(this,t,e,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const e=this.remoteSDP.batchSend(t).map((r,o)=>{let{id:a,mslabel:c}=r;const{kind:d}=t[o];return new P((l,u)=>{const p=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)))},1e4),_=S=>{const f=ft();if(f.name==="Safari"&&Number(f.version)===11&&S.track.id!==a&&S.streams[0].id===c){var g;const C=S.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(d,a,S.track.id),this.peerConnection.removeEventListener("track",_),clearTimeout(p),void l({track:C,id:a})}if(S.track.id===a)return this.peerConnection.removeEventListener("track",_),clearTimeout(p),void l({track:S.track,id:a})};this.peerConnection.addEventListener("track",_)})}),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const s=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(s),await P.all(e)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Ot().supportPCSetConfiguration){const e=Oe.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function nn(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("Locking from P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function vI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function qs(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?vI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):vI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}U([nn,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Oe.prototype,"connect",null),U([nn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Oe.prototype,"stopSending",null),U([nn,T("design:type",Function),T("design:paramtypes",[String,Array,String,Object]),T("design:returntype",P)],Oe.prototype,"receive",null),U([nn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Oe.prototype,"stopReceiving",null),U([nn,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Oe.prototype,"muteRemote",null),U([nn,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Oe.prototype,"unmuteRemote",null),U([nn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Oe.prototype,"muteLocal",null),U([nn,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Oe.prototype,"unmuteLocal",null),U([nn,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Oe.prototype,"close",null),U([nn,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Oe.prototype,"updateEncoderConfig",null),U([nn,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Oe.prototype,"updateSendParameters",null),U([nn,T("design:type",Function),T("design:paramtypes",[xe,String]),T("design:returntype",P)],Oe.prototype,"replaceTrack",null),U([nn,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Oe.prototype,"getRemoteSSRC",null);const Ya="9",yI=4e4;function AI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Lo(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?AI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):AI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Qt extends pd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,e;return(t=(e=this.peerConnection.getReceivers()[0])===null||e===void 0||(e=e.transport)===null||e===void 0?void 0:e.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var e;return q(e=Object.keys(ws)).call(e,t)}))]}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useXR",v("USE_XR")),h(this,"localCapabilities",void 0),h(this,"remoteCodecs",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"dataStreamChannelMap",new Map),h(this,"establishPromise",void 0),h(this,"mutex",new Ae("P2PConnection-mutex")),this.store=e,this.peerConnection=new RTCPeerConnection(Qt.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Hd(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,e){if(this.remoteCodecs=e,!this.remoteSDP)return void E.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(e));if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}else E.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const e=An(t.sdp),n=await Zp({filterRTX:!v("USE_PUB_RTX")&&!v("USE_SUB_RTX"),filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterVideoCodec:v("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=Do(n),this.initialOffer=t,Lo(Lo({},e),{},{rtpCapabilities:n,offerSDP:t.sdp})}catch(t){throw new M(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,e,n,s,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return kt(this._localCapabilities)}get rtpCapabilities(){return kt(this._rtpCapabilities)}get candidates(){return kt(this._candidates)}get iceParameters(){return kt(this._iceParameters)}get dtlsParameters(){return kt(this._dtlsParameters)}constructor(_){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),_=kt(_);const{remoteIceParameters:S,remoteDtlsParameters:f,candidates:g,remoteRTPCapabilities:C,remoteSetup:y,localCapabilities:A,cname:k}=_,O=Ht.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=C,this._candidates=g,this._iceParameters=S,this._dtlsParameters=f,this._localCapabilities=A,this.setup=y,this.cname=k;const N=this.rtpCapabilities.send;for(const L of O.mediaDescriptions){if(L.attributes.iceUfrag=S.iceUfrag,L.attributes.icePwd=S.icePwd,L.attributes.fingerprints=f.fingerprints,L.attributes.candidates=g,L.attributes.setup=y,L.media.mediaType==="video"&&(L.media.fmts=N.videoCodecs.map(D=>D.payloadType.toString(10)),L.attributes.payloads=N.videoCodecs,L.attributes.extmaps=N.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:D,ssrcGroups:F}=fi([{ssrcId:yI,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);L.attributes.ssrcs=D,L.attributes.ssrcGroups=F}if(L.media.mediaType==="audio"&&(L.media.fmts=N.audioCodecs.map(D=>D.payloadType.toString(10)),L.attributes.payloads=N.audioCodecs,L.attributes.extmaps=N.audioExtensions,bn(L),v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:D,ssrcGroups:F}=fi([{ssrcId:2e4}],this.cname);L.attributes.ssrcs=D,L.attributes.ssrcGroups=F}}this.sessionDesc=O,this.currentMidIndex=O.mediaDescriptions.length-1}preloadRemoteMedia(){const _=v("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const S=this.candidates,f=this.dtlsParameters,g=this.iceParameters,C=this.rtpCapabilities.send;for(let y=1;y<_;y++){const A=2*y+2e4,k=2*y+yI,{ssrcs:O,ssrcGroups:N}=fi([{ssrcId:A}],this.cname),{ssrcs:L,ssrcGroups:D}=fi([{ssrcId:k,rtx:v("USE_SUB_RTX")?k+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Ya,protos:["UDP","TLS","RTP","SAVPF"],fmts:C.videoCodecs.map(F=>F.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:S,extmaps:C.videoExtensions,fingerprints:f.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:L,ssrcGroups:D,rtcpFeedbackWildcards:[],payloads:C.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*y)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Ya,protos:["UDP","TLS","RTP","SAVPF"],fmts:C.audioCodecs.map(F=>F.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:S,extmaps:C.audioExtensions,fingerprints:f.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:O,ssrcGroups:N,rtcpFeedbackWildcards:[],payloads:C.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*y+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ht.print(this.sessionDesc)}send(_,S,f,g){const{ssrcs:C,ssrcGroups:y}=fi(S,this.cname,v("SYNC_GROUP")?f:void 0),A=this.findPreloadMediaDesc(C);if(A){if(Nt()&&this.firefoxSsrcMidMap.set(C[0].ssrcId,A.attributes.mid),g&&(g.twcc||g.remb)){const k=this.sessionDesc.mediaDescriptions.indexOf(A);return this.sessionDesc.mediaDescriptions[k]=this.mungSendMediaDesc(A,g),{mid:A.attributes.mid,needExchangeSDP:!0}}return{mid:A.attributes.mid,needExchangeSDP:!1}}{const k=this.findAvailableMediaIndex(_,C);let O;return k===-1||k===1&&(Xe()||oT())||k===0&&v("USE_SUB_RTX")||aT()?(O=this.createOrRecycleSendMedia(_,C,y,"sendonly",g),this.updateBundleMids()):(O=kt(this.sessionDesc.mediaDescriptions[k]),O.attributes.direction="sendonly",O.attributes.ssrcs=C,O.attributes.ssrcGroups=y,this.sessionDesc.mediaDescriptions[k]=this.mungSendMediaDesc(O,g)),Nt()&&this.firefoxSsrcMidMap.set(C[0].ssrcId,O.attributes.mid),{mid:O.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:_,needExchangeSDP:S}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:_.attributes.mid,needExchangeSDP:S}}batchSend(_){const S=_.map(C=>{let{kind:y,ssrcMsg:A,mslabel:k}=C;return this.send(y,A,k)}),f=[];let g=!1;return S.forEach(C=>{let{mid:y,needExchangeSDP:A}=C;A&&(g=!0),f.push(y)}),{mids:f,needExchangeSDP:g}}stopSending(_){const S=this.sessionDesc.mediaDescriptions.filter(f=>f.attributes.mid&&_.indexOf(f.attributes.mid)!==-1);if(S.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");S.forEach(f=>{f.attributes.mid==="0"||Nt()||aT()?f.attributes.ssrcs=[]:(f.attributes.ssrcs=[],f.attributes.direction="inactive",f.media.port="0")}),this.updateBundleMids()}mute(_){const S=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_);if(!S)throw new Error("mediaDescription not found with ".concat(_," in remote SDP when calling RemoteSDP.mute."));S.attributes.direction="inactive"}unmute(_){const S=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_);if(!S)throw new Error("mediaDescription not found with ".concat(_," in remote SDP when calling RemoteSDP.unmute."));S.attributes.direction="sendonly"}muteRemote(_){const S=this.sessionDesc.mediaDescriptions.filter(f=>q(_).call(_,f.attributes.mid||""));if(S.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");S.forEach(f=>{f.attributes.direction="inactive"})}unmuteRemote(_){const S=this.sessionDesc.mediaDescriptions.filter(f=>q(_).call(_,f.attributes.mid||""));if(S.length!==_.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");S.forEach(f=>{f.attributes.direction="recvonly"})}receive(_,S,f,g){_.forEach((C,y)=>{this.createOrRecycleRecvMedia(C,[],"recvonly",S,f,g[y])}),this.updateBundleMids()}stopReceiving(_){const S=this.sessionDesc.mediaDescriptions.filter(f=>_.indexOf(f.attributes.mid)!==-1);if(S.length!==_.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");S.forEach(f=>{f.media.port="0",f.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(_){const S=this._candidates.filter(f=>f.transport==="udp");if(_===Ue.TCP){if(S.length===0)return;if(v("TCP_CANDIDATE_ONLY")){const f=this._candidates.filter(g=>g.transport==="tcp");S.forEach(g=>{f.findIndex(C=>C.connectionAddress===g.connectionAddress)===-1&&f.push(qs(qs({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=f}else{const f=[];S.forEach(g=>{f.push(qs(qs({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=[...S,...f]}}else if(_===Ue.RELAY){if(S.length!==0)return;{const f=this._candidates.filter(g=>g.transport==="tcp");f.forEach(g=>{S.push(qs(qs({},g),{},{foundation:"udpcandidate",priority:Number(g.priority)+1+"",transport:"udp",port:Number(g.port)-90+""}))}),this._candidates=[...S,...f]}}else S.length===0?(this._candidates.filter(f=>f.transport==="tcp").forEach(f=>{S.push(qs(qs({},f),{},{foundation:"udpcandidate",priority:Number(f.priority)+1+"",transport:"udp",port:Number(f.port)-90+""}))}),this._candidates=S):this._candidates=this._candidates.filter(f=>f.transport!=="tcp");for(const f of this.sessionDesc.mediaDescriptions)f.attributes.candidates=this.candidates}restartICE(_){_=kt(_),this._iceParameters=_,this.sessionDesc.mediaDescriptions.forEach(S=>{S.attributes.iceUfrag=_.iceUfrag,S.attributes.icePwd=_.icePwd})}predictReceivingMids(_){const S=[];for(let f=0;f<_;f++)S.push((this.currentMidIndex+f+1).toString(10));return S}findAvailableMediaIndex(_,S){return this.sessionDesc.mediaDescriptions.findIndex(f=>{const g=f.media.mediaType===_&&f.media.port!=="0"&&(f.attributes.direction==="sendonly"||f.attributes.direction==="sendrecv")&&f.attributes.ssrcs.length===0;if(Nt()){if(g){const C=this.firefoxSsrcMidMap.get(S[0].ssrcId);return!(C||f.attributes.mid!=="0"&&f.attributes.mid!=="1")||!(!C||C!==f.attributes.mid)}return!1}return g})}createOrRecycleDataChannel(){for(const f of this.sessionDesc.mediaDescriptions)if(f.media.mediaType==="application")return{mediaDesc:f,needExchangeSDP:!1};this.currentMidIndex+=1;const _="".concat(this.currentMidIndex),S={media:{mediaType:"application",port:Ya,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(_),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(S),{mediaDesc:S,needExchangeSDP:!0}}createOrRecycleRecvMedia(_,S,f,g,C,y){const A=_._mediaStreamTrack.kind,k=this.rtpCapabilities.recv,O=Lr(A,k,this.localCapabilities.send,A===J.VIDEO?g:C),N=A===J.VIDEO?k.videoExtensions:k.audioExtensions;this.currentMidIndex+=1;const L="".concat(this.currentMidIndex);let D={media:{mediaType:A,port:Ya,protos:["UDP","TLS","RTP","SAVPF"],fmts:O.map(j=>j.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:N,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:S,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:O,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:f,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(L)}};D=this.mungRecvMediaDsec(D,_,y);const F=this.findFirstClosedMedia(A);if(F){const j=this.sessionDesc.mediaDescriptions.indexOf(F);this.sessionDesc.mediaDescriptions[j]=D}else this.sessionDesc.mediaDescriptions.push(D);return D}updateRemoteCodec(_,S,f){const g=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(D=>D.rtpMap&&D.rtpMap.encodingName.toLowerCase()||"").filter(D=>{var F;return q(F=Object.keys(ws)).call(F,D)}))],C=new Set(S);if(g.every(D=>C.has(D)))return E.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(S)),!1;const y=this._rtpCapabilities.recv.videoCodecs.filter(D=>S.some(F=>{var j;return q(j=D.rtpMap&&D.rtpMap.encodingName.toLowerCase()||"").call(j,F)}));if(y.length===0)return E.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(g," codecs: ").concat(S)),!1;const A=[...new Set(y.map(D=>D.rtpMap&&D.rtpMap.encodingName.toLowerCase()||""))];let k;if(E.debug("updateRemoteCodec, from ".concat(g," to ").concat(A)),_.length===0)k=this.sessionDesc.mediaDescriptions.filter(D=>D.media.mediaType==="video"&&D.attributes.direction==="recvonly");else if(k=this.sessionDesc.mediaDescriptions.filter(D=>D.attributes.mid&&q(_).call(_,D.attributes.mid)&&D.attributes.direction==="recvonly"),k.length!==_.length)return E.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(_,", codecs: ").concat(S)),!1;this._rtpCapabilities.recv.videoCodecs=y;const O=this.localCapabilities.send,N=this.rtpCapabilities.recv,L=Lr(J.VIDEO,N,O,f);return k.forEach(D=>{const F=L.map(j=>j.payloadType.toString(10));E.debug("updateRemoteCodec mid: ".concat(D.attributes.mid,", from ").concat(D.attributes.payloads," to ").concat(L)),D.attributes.payloads=L,D.media.fmts=F}),!0}createOrRecycleSendMedia(_,S,f,g,C){const y=this.rtpCapabilities.send,A=_===J.VIDEO?y.videoCodecs:y.audioCodecs,k=_===J.VIDEO?y.videoExtensions:y.audioExtensions;this.currentMidIndex+=1;const O="".concat(this.currentMidIndex);let N={media:{mediaType:_,port:Ya,protos:["UDP","TLS","RTP","SAVPF"],fmts:A.map(D=>D.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:k,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:S,ssrcGroups:f,rtcpFeedbackWildcards:[],payloads:A,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:g,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(O)}};N=this.mungSendMediaDesc(N,C);const L=this.findFirstClosedMedia(_);if(L){const D=this.sessionDesc.mediaDescriptions.indexOf(L);this.sessionDesc.mediaDescriptions[D]=N}else this.sessionDesc.mediaDescriptions.push(N);return N}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(_=>_.media.port!=="0").map(_=>_.attributes.mid)}mungRecvMediaDsec(_,S,f){const g=kt(_);return Kd(g),Hs(g,S),Yd(g,S),Xp(g),No(g,f,this.localCapabilities.send),g}mungSendMediaDesc(_,S){const f=kt(_);return No(f,S,this.localCapabilities.recv),bn(f),f}updateRecvMedia(_,S){const f=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===_);if(f!==-1){const g=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[f],S);this.sessionDesc.mediaDescriptions[f]=g}}bumpMid(_){this.currentMidIndex+=_}findFirstClosedMedia(_){return this.sessionDesc.mediaDescriptions.find(S=>Nt()?S.media.port==="0"&&S.media.mediaType===_:S.media.port==="0")}findPreloadMediaDesc(_){return this.sessionDesc.mediaDescriptions.find(S=>{var f;return((f=S.attributes)===null||f===void 0||(f=f.ssrcs[0])===null||f===void 0?void 0:f.ssrcId)===_[0].ssrcId})}getSSRC(_){var S;return(S=this.sessionDesc.mediaDescriptions.find(f=>f.attributes.mid===_))===null||S===void 0?void 0:S.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:e,candidates:n,remoteRTPCapabilities:s,remoteSetup:r,localCapabilities:this.localCapabilities,cname:o}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const a=this.remoteSDP.toString(),c=Ht.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(_=>_.media.mediaType==="audio");d&&bn(d),this.useXR&&Ga(c);const l=Ht.print(c),u=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u==null||u(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const p=this.peerConnection.getTransceivers()[0];if(p!=null&&p.receiver&&this.tryBindTransportEvents(p.receiver),v("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const _=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:_});const S=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(S)}}catch(a){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(t,e,n){var s=this;return vi(function*(){const r=yield at(s.mutex.lock("From P2PConnection.send"));try{if(!s.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];t.forEach(f=>{const g=s.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});o.push(g),f._updateRtpTransceiver(g)}),Nt()&&v("SIMULCAST")===!0&&(yield at(s.applySimulcastForFirefox(o,t)));const a=yield at(s.peerConnection.createOffer()),c=s.remoteSDP.predictReceivingMids(t.length),d=s.mungSendOfferSDP(a.sdp,t,c),l=Ht.parse(d),u=c.map(f=>{const g=l.mediaDescriptions.find(C=>C.attributes.mid===f);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return zp(g,v("USE_PUB_RTX"))});let p;try{p=yield u}catch(f){p=[],s.remoteSDP.receive(t,e,n,p);const g=s.remoteSDP.toString();throw yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield at(s.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield at(s.stopSending(c,!0)),f}s.remoteSDP.receive(t,e,n,p);const _=s.remoteSDP.toString(),S=s.logSDPExchange(d,"offer","local","send");return yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield at(s.applySimulcastEncodings(o,t)),yield at(s.applySendEncodings(o,t)),S==null||S(_),yield at(s.peerConnection.setRemoteDescription({type:"answer",sdp:_})),o.map((f,g)=>{const C=c[g];return{localSSRC:u[g],id:C,transceiver:f}})}catch(o){throw o instanceof M?o:new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);n&&n.readyState==="open"?E.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)),e.forEach(r=>{r._updateOriginDataChannel(n)});const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),E.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else E.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(n){throw n instanceof M?n:new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(n.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return e==null||e.close(),void this.dataStreamChannelMap.delete(t)}catch(e){throw e instanceof M?e:new M(R.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(t,e){const n=e?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const s=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");s.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(s){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(s.toString()))}finally{n&&n()}}async receive(t,e,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(t,e,n,s);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,r,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===r);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:r,transceiver:a}}catch(r){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:n}=this.remoteSDP.batchSend(t);if(n){const s=this.remoteSDP.toString(),r=this.logSDPExchange(s,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o),E.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else E.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return e.map(s=>{const r=this.peerConnection.getTransceivers().find(o=>o.mid===s);if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s,transceiver:r}})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async(o,a)=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new M(R.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return vi(function*(){const n=yield at(e.mutex.lock("From P2PConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){const d=e.peerConnection.getConfiguration(),l=t===Ue.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(E.debug("[".concat(e.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,e.peerConnection.setConfiguration(d))}else if(t===Ue.RELAY)return;e.remoteSDP.updateCandidates(t);const s=yield at(e.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=An(s.sdp),{remoteIceParameters:o}=yield r.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString(),c=e.logSDPExchange(s.sdp||"","offer","local","restartICE");e.store.descriptionStart(),yield at(e.peerConnection.setLocalDescription(s)),c==null||c(a),yield at(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(s){E.warning("[".concat(e.store.clientId,"] restart ICE failed, abort operation"),s)}finally{n()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(n.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const r=this.remoteSDP.toString(),o=this.logSDPExchange(s,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),o==null||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new M(R.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,e){const n=this.peerConnection.getTransceivers().filter(s=>s.mid===t);n.length===1&&(this.isVP8Simulcast(e)?Nt()||await this.applySimulcastEncodings(n,[e]):await this.applySendEncodings(n,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const n=this.peerConnection.getTransceivers().find(s=>s.mid===e);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const e=t[0].transport.iceTransport,{local:n,remote:s}=e.getSelectedCandidatePair();return{local:Lo(Lo({},Hn),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:Lo(Lo({},Hn),{},{candidateType:s.type,protocol:s.protocol,address:s.address,port:s.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},v("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ro(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...Qt.turnServerConfigToIceServers(t.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...Qt.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(e.iceTransportPolicy="relay")}))),v("ENABLE_ENCODED_TRANSFORM")&&Ot().supportWebRTCEncodedTransform&&(e.encodedInsertableStreams=!0),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(n=>{n.security?n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(ks(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!v("FORCE_TURN_TCP")&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),e}tryBindTransportEvents(t){const e=t.transport;if(e){this.transportEventReceiver=t,e.onstatechange=()=>{var s;e!=null&&e.state&&((s=this.onDTLSTransportStateChange)===null||s===void 0||s.call(this,e.state))},e.onerror=s=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in s?s.error:s)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const s=e==null?void 0:e.iceTransport.state;var r;s&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,s))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:s,remote:r}=n.getSelectedCandidatePair();E.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:s.type,protocol:s.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,e){var n;if(e||(e=this.peerConnection.getSenders().find(l=>l.track===t._mediaStreamTrack)),!e)return E.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return E.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ot().supportSetRtpSenderParameters)return E.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},r={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:l,frameRate:u,scaleResolutionDownBy:p}=t._encoderConfig;l&&(r.maxBitrate=1e3*l),(q(o=t._hints).call(o,Mt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(u&&(r.maxFramerate=Ui(u)),p&&p>=1&&(r.scaleResolutionDownBy=p))}if(v("DSCP_TYPE")&&vs()){var a;const l=v("DSCP_TYPE");q(a=["very-low","low","medium","high"]).call(a,l)&&(r.networkPriority=l)}const c=e.getParameters(),d=(n=c.encodings)===null||n===void 0?void 0:n[0];Nt()&&!d&&(s.encodings=[r]),d&&Object.assign(d,r),Object.assign(c,s),E.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await e.setParameters(c)}async applySendEncodings(t,e){try{if(!Ot().supportSetRtpSenderParameters||t.length!==e.length)return;for(let n=0;n<t.length;n++){const s=t[n],r=e[n];r instanceof dt&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,s.sender)}}catch{E.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,e,n){const s=Ht.parse(t);return e.forEach((r,o)=>{const a=n[o],c=s.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Hs(c,r),Qp(c,r,this.store.codec))}),Ht.print(s)}mungReceiveAnswerSDP(t,e,n){const s=Ht.parse(t),r=s.mediaDescriptions.find(o=>o.attributes.mid===e);return r&&(n===J.AUDIO&&r.media.mediaType==="audio"&&bn(r),this.useXR&&Ga(s)),Ht.print(s)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,n)=>{var s;(s=this.onFirstVideoDecoded)===null||s===void 0||s.call(this,t,e,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var n,s,r,o,a;const d=t[c],l=e[c];if(l instanceof dt&&!q(n=l._hints).call(n,Mt.LOW_STREAM)&&(s=l._encoderConfig)!==null&&s!==void 0&&s.bitrateMax&&((r=l._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,u))}}}async applySimulcastEncodings(t,e){if(!Nt()&&t.length===e.length)for(let n=0;n<t.length;n++){const s=e[n];if(s instanceof dt&&this.isVP8Simulcast(s)){const r=t[n],o={},a={high:1e3*(s._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=r.sender.getParameters();await r.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,n,s,r,o;return!!(t instanceof dt&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(e=t._hints).call(e,Mt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((s=t._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,n,s){if(v("SDP_LOGGING"))return E.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(e," SDP during P2PConnection.").concat(s,`
`),t),e==="offer"?r=>{this.logSDPExchange(r,"answer",n==="local"?"remote":"local",s)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Ot().supportPCSetConfiguration){const e=Qt.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function yi(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function bI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function wI(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?bI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):bI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}U([yi,T("design:type",Function),T("design:paramtypes",[Array,Array]),T("design:returntype",P)],Qt.prototype,"updateRemoteRTPCapabilities",null),U([yi,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Qt.prototype,"connect",null),U([yi,T("design:type",Function),T("design:paramtypes",[Object,Array]),T("design:returntype",P)],Qt.prototype,"createDataChannels",null),U([yi,T("design:type",Function),T("design:paramtypes",[String,Array,String,Object]),T("design:returntype",P)],Qt.prototype,"receive",null),U([yi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Qt.prototype,"batchReceive",null),U([yi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Qt.prototype,"stopReceiving",null),U([yi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Qt.prototype,"muteRemote",null),U([yi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Qt.prototype,"unmuteRemote",null),U([yi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Qt.prototype,"muteLocal",null),U([yi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Qt.prototype,"unmuteLocal",null),U([yi,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Qt.prototype,"close",null),U([yi,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Qt.prototype,"updateEncoderConfig",null),U([yi,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Qt.prototype,"updateSendParameters",null),U([yi,T("design:type",Function),T("design:paramtypes",[xe,String]),T("design:returntype",P)],Qt.prototype,"replaceTrack",null),U([yi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Qt.prototype,"getRemoteSSRC",null);const OI=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,Xd="9",i_=2e4,n_=4e4;class P1{get localCapabilities(){return kt(this._localCapabilities)}get rtpCapabilities(){return kt(this._rtpCapabilities)}get candidates(){return kt(this._candidates)}get iceParameters(){return kt(this._iceParameters)}get dtlsParameters(){return kt(this._dtlsParameters)}constructor(t){h(this,"sessionDesc",void 0),h(this,"_localCapabilities",void 0),h(this,"_rtpCapabilities",void 0),h(this,"_candidates",void 0),h(this,"_iceParameters",void 0),h(this,"_dtlsParameters",void 0),h(this,"setup",void 0),h(this,"currentMidIndex",void 0),h(this,"cname",void 0),h(this,"firefoxSsrcMidMap",new Map),t=kt(t);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:s,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:a,cname:c}=t,d=Ht.parse(OI);this._rtpCapabilities=r,this._candidates=s,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=a,this.setup=o,this.cname=c;const l=this.rtpCapabilities.send;for(const u of d.mediaDescriptions){if(u.attributes.iceUfrag=e.iceUfrag,u.attributes.icePwd=e.icePwd,u.attributes.fingerprints=n.fingerprints,u.attributes.candidates=s,u.attributes.setup=o,u.media.mediaType==="application"&&(u.attributes.sctpPort="5000"),u.media.mediaType==="video"&&(u.media.fmts=l.videoCodecs.map(p=>p.payloadType.toString(10)),u.attributes.payloads=l.videoCodecs,u.attributes.extmaps=l.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:_}=fi([{ssrcId:n_,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);u.attributes.ssrcs=p,u.attributes.ssrcGroups=_}if(u.media.mediaType==="audio"&&(u.media.fmts=l.audioCodecs.map(p=>p.payloadType.toString(10)),u.attributes.payloads=l.audioCodecs,u.attributes.extmaps=l.audioExtensions,bn(u),v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:p,ssrcGroups:_}=fi([{ssrcId:i_}],this.cname);u.attributes.ssrcs=p,u.attributes.ssrcGroups=_}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){const e=Ht.parse(OI);this._rtpCapabilities=t;const n=this.rtpCapabilities.send;for(const s of e.mediaDescriptions){if(s.attributes.iceUfrag=this._iceParameters.iceUfrag,s.attributes.icePwd=this._iceParameters.icePwd,s.attributes.fingerprints=this._dtlsParameters.fingerprints,s.attributes.candidates=this._candidates,s.attributes.setup=this.setup,s.media.mediaType==="application"&&(s.attributes.sctpPort="5000"),s.media.mediaType==="video"&&(s.media.fmts=n.videoCodecs.map(r=>r.payloadType.toString(10)),s.attributes.payloads=n.videoCodecs,s.attributes.extmaps=n.videoExtensions,v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:r,ssrcGroups:o}=fi([{ssrcId:n_,rtx:v("USE_SUB_RTX")?40001:void 0}],this.cname);s.attributes.ssrcs=r,s.attributes.ssrcGroups=o}if(s.media.mediaType==="audio"&&(s.media.fmts=n.audioCodecs.map(r=>r.payloadType.toString(10)),s.attributes.payloads=n.audioCodecs,s.attributes.extmaps=n.audioExtensions,v("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:r,ssrcGroups:o}=fi([{ssrcId:i_}],this.cname);s.attributes.ssrcs=r,s.attributes.ssrcGroups=o}}this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;const e=this.candidates,n=this.dtlsParameters,s=this.iceParameters,r=this.rtpCapabilities.send;for(let o=1;o<t;o++){const a=2*o+i_,c=2*o+n_,{ssrcs:d,ssrcGroups:l}=fi([{ssrcId:a}],this.cname),{ssrcs:u,ssrcGroups:p}=fi([{ssrcId:c,rtx:v("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Xd,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:s.iceUfrag,icePwd:s.icePwd,unrecognized:[],candidates:e,extmaps:r.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:p,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Xd,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:s.iceUfrag,icePwd:s.icePwd,unrecognized:[],candidates:e,extmaps:r.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ht.print(this.sessionDesc)}send(t,e,n,s){const{ssrcs:r,ssrcGroups:o}=fi(e,this.cname,v("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(r);if(a){if(Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,a.attributes.mid),s&&(s.twcc||s.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,s),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,r);let d;return c===-1||Xe()||Qe()||oT()||c===0&&v("USE_SUB_RTX")?(d=this.createOrRecycleSendMedia(t,r,o,"sendonly",s),this.updateBundleMids()):(d=kt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=r,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,s)),Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const e=t.map(r=>{let{kind:o,ssrcMsg:a,mslabel:c}=r;return this.send(o,a,c)}),n=[];let s=!1;return e.forEach(r=>{let{mid:o,needExchangeSDP:a}=r;a&&(s=!0),n.push(o)}),{mids:n,needExchangeSDP:s}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.mid==="0"||Nt()||Xe()||Qe()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")}),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t);if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>q(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>q(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}receive(t,e,n,s){t.forEach((r,o)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",e,n,s[o])}),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>t.indexOf(n.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(t){t===Ue.TCP?this._candidates.forEach(e=>{this._candidates.findIndex(n=>n.transport==="tcp"&&n.connectionAddress===e.connectionAddress&&n.port===e.port)===-1&&this._candidates.push(wI(wI({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))}):this._candidates=this._candidates.filter(e=>e.transport!=="tcp");for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(t){t=kt(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const s=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(Nt()){if(s){const r=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return s})}createOrRecycleRecvMedia(t,e,n,s,r,o){const a=t._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=Lr(a,c,this.localCapabilities.send,a===J.VIDEO?s:r),l=a===J.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const u="".concat(this.currentMidIndex);let p={media:{mediaType:a,port:Xd,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(S=>S.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};p=this.mungRecvMediaDsec(p,t,o);const _=this.findFirstClosedMedia(a);if(_){const S=this.sessionDesc.mediaDescriptions.indexOf(_);this.sessionDesc.mediaDescriptions[S]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteCodec(t,e,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var _;return q(_=Object.keys(ws)).call(_,p)}))],r=new Set(e);if(s.every(p=>r.has(p)))return E.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter(p=>e.some(_=>{var S;return q(S=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(S,_)}));if(o.length===0)return E.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(e)),!1;const a=[...new Set(o.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(E.debug("updateRemoteCodec, from ".concat(s," to ").concat(a)),t.length===0)c=this.sessionDesc.mediaDescriptions.filter(p=>p.media.mediaType==="video"&&p.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&q(t).call(t,p.attributes.mid)&&p.attributes.direction==="recvonly"),c.length!==t.length)return E.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;this._rtpCapabilities.recv.videoCodecs=o;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,u=Lr(J.VIDEO,l,d,n);return c.forEach(p=>{const _=u.map(S=>S.payloadType.toString(10));E.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from ").concat(p.attributes.payloads," to ").concat(u)),p.attributes.payloads=u,p.media.fmts=_}),!0}createOrRecycleSendMedia(t,e,n,s,r){const o=this.rtpCapabilities.send,a=t===J.VIDEO?o.videoCodecs:o.audioCodecs,c=t===J.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let l={media:{mediaType:t,port:Xd,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:s,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,r);const u=this.findFirstClosedMedia(t);if(u){const p=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,e,n){const s=kt(t);return Kd(s),Hs(s,e),Yd(s,e),Xp(s),No(s,n,this.localCapabilities.send),s}mungSendMediaDesc(t,e){const n=kt(t);return No(n,e,this.localCapabilities.recv),bn(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex(s=>s.attributes.mid===t);if(n!==-1){const s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>Nt()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId})}getSSRC(t){var e;return(e=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===t))===null||e===void 0?void 0:e.attributes.ssrcs}}function NI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Qd(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?NI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):NI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}class Be extends pd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let t;return this.localCapabilities&&(t=Do(this.localCapabilities)),[...new Set(t&&t.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return q(n=Object.keys(ws)).call(n,e)}))]}constructor(t,e,n){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"remoteSDP",void 0),h(this,"initialOffer",void 0),h(this,"transportEventReceiver",void 0),h(this,"statsFilter",void 0),h(this,"useXR",v("USE_XR")),h(this,"localCapabilities",void 0),h(this,"localCandidateCount",0),h(this,"allCandidatesReceived",!1),h(this,"remoteCodecs",void 0),h(this,"dataStreamChannelMap",new Map),h(this,"establishPromise",void 0),h(this,"mutex",new Ae("NVExtentionsConnection-mutex")),h(this,"rtcMedia",void 0),this.store=e,this.peerConnection=n,this.statsFilter=Hd(this.peerConnection,v("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=An(e.sdp),s=await Zp({filterRTX:!v("USE_PUB_RTX")&&!v("USE_SUB_RTX"),filterVideoFec:v("FILTER_VIDEO_FEC"),filterAudioFec:v("FILTER_AUDIO_FEC"),filterVideoCodec:v("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=s,this.initialOffer=e,Qd(Qd({},n),{},{rtpCapabilities:s,offerSDP:e.sdp})}catch(e){throw new w(R.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t,e,n,s,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new P1({remoteIceParameters:t,remoteDtlsParameters:e,candidates:n,remoteRTPCapabilities:s,remoteSetup:r,localCapabilities:Do(this.localCapabilities),cname:o});const a=this.remoteSDP.toString(),c=Ht.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(p=>p.media.mediaType==="audio");d&&bn(d),this.useXR&&Ga(c);const l=Ht.print(c),u=this.logSDPExchange(l||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u==null||u(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new w(R.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,e){if(this.remoteCodecs=e,!this.remoteSDP)return void E.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(e));if(this.remoteSDP.updateRemoteCodec(t,e,this.store.codec)){const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}else E.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(t){var e,n,s,r;(e=this.remoteSDP)===null||e===void 0||e.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((r=this.remoteSDP)===null||r===void 0||r.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(n=this.remoteSDP)===null||n===void 0||n.preloadRemoteMedia(2);const o=(s=this.remoteSDP)===null||s===void 0?void 0:s.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),E.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,e,n){var s=this;return vi(function*(){const r=yield at(s.mutex.lock("From NVExtentionsConnection.send"));try{if(!s.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];t.forEach(f=>{const g=s.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});o.push(g)}),Nt()&&v("SIMULCAST")===!0&&(yield at(s.applySimulcastForFirefox(o,t)));const a=yield at(s.peerConnection.createOffer()),c=s.remoteSDP.predictReceivingMids(t.length),d=s.mungSendOfferSDP(a.sdp,t,c),l=Ht.parse(d),u=c.map(f=>{const g=l.mediaDescriptions.find(C=>C.attributes.mid===f);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return zp(g,v("USE_PUB_RTX"))});let p;try{p=yield u}catch(f){p=[],s.remoteSDP.receive(t,e,n,p);const g=s.remoteSDP.toString();throw yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield at(s.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield at(s.stopSending(c,!0)),f}s.remoteSDP.receive(t,e,n,p);const _=s.remoteSDP.toString(),S=s.logSDPExchange(d,"offer","local","send");return yield at(s.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield at(s.applySimulcastEncodings(o,t)),yield at(s.applySendEncodings(o,t)),S==null||S(_),yield at(s.peerConnection.setRemoteDescription({type:"answer",sdp:_})),o.map((f,g)=>{const C=c[g];return{localSSRC:u[g],id:C,transceiver:f}})}catch(o){throw o instanceof w?o:new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(t,e){const n=e?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const s=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(s.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");s.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const r=await this.peerConnection.createOffer(),o=this.logSDPExchange(r.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o==null||o(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(s){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(s.toString()))}finally{n&&n()}}async createDataChannels(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(t);return n&&n.readyState==="open"?E.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,n)),void e.forEach(s=>{s._updateOriginDataChannel(n)})}catch(n){throw n instanceof w?n:new w(R.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(n.toString()))}}async stopDataChannels(t){try{const e=this.dataStreamChannelMap.get(t);return e==null||e.close(),void this.dataStreamChannelMap.delete(t)}catch(e){throw e instanceof w?e:new w(R.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(t,e,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(t,e,n,s);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,r,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),E.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else E.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===r);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:r}}catch(r){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(r.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:e,needExchangeSDP:n}=this.remoteSDP.batchSend(t);if(n){const s=this.remoteSDP.toString(),r=this.logSDPExchange(s,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();r==null||r(o.sdp||""),await this.peerConnection.setLocalDescription(o),E.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else E.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return e.map(s=>{const r=this.peerConnection.getTransceivers().find(o=>o.mid===s);if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:s}})}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const e=this.remoteSDP.toString(),n=this.logSDPExchange(e,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const s=await this.peerConnection.createAnswer();n==null||n(s.sdp||""),await this.peerConnection.setLocalDescription(s)}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(o=>{o.direction="inactive"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const e=this.peerConnection.getTransceivers().filter(o=>o.mid&&t.indexOf(o.mid)!==-1);if(e.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");e.map(async(o,a)=>{o.direction="sendonly"});const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(t);const r=this.remoteSDP.toString();s==null||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new w(R.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var e=this;return vi(function*(){const n=yield at(e.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!e.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ot().supportPCSetConfiguration){const d=e.peerConnection.getConfiguration(),l=t===Ue.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(E.debug("restartICE change iceTransportPolicy from [".concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,e.peerConnection.setConfiguration(d))}else if(t===Ue.RELAY)return;t!==Ue.RELAY&&e.remoteSDP.updateCandidates(t);const s=yield at(e.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const r=An(s.sdp),{remoteIceParameters:o}=yield r.iceParameters;e.remoteSDP.restartICE(o);const a=e.remoteSDP.toString(),c=e.logSDPExchange(s.sdp||"","offer","local","restartICE");yield at(e.peerConnection.setLocalDescription(s)),c==null||c(a),yield at(e.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(s){E.warning("restart ICE failed, abort operation",s)}finally{n()}})()}close(){var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),s=this.mungSendOfferSDP(n.sdp,[e],[t]);this.remoteSDP.updateRecvMedia(t,e);const r=this.remoteSDP.toString(),o=this.logSDPExchange(s,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:s}),o==null||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new w(R.EXCHANGE_SDP_FAILED,n.toString())}}async updateSendParameters(t,e){const n=this.peerConnection.getTransceivers().filter(s=>s.mid===t);n.length===1&&(this.isVP8Simulcast(e)?Nt()||await this.applySimulcastEncodings(n,[e]):await this.applySendEncodings(n,[e]))}setStatsRemoteVideoIsReady(t,e){this.statsFilter.setVideoIsReady2(t,e)}async replaceTrack(t,e){const n=this.peerConnection.getTransceivers().find(s=>s.mid===e);n&&await n.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if((t=this.peerConnection.currentLocalDescription)===null||t===void 0||!t.sdp||!this.localCapabilities)throw new Error;return Qd(Qd({},An(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,E.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,E.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},v("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ro(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...Be.turnServerConfigToIceServers(t.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...Be.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(n=>{n.security?n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(ks(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!v("FORCE_TURN_TCP")&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),e}async applySendEncodings(t,e){try{if(!Ot().supportSetRtpSenderParameters||t.length!==e.length)return;for(let u=0;u<t.length;u++){const p=t[u],_=e[u];if(_&&_ instanceof dt){var n,s,r;if(this.isVP8Simulcast(_))continue;const S={},f={};switch(_._optimizationMode){case"motion":S.degradationPreference="maintain-framerate";break;case"detail":S.degradationPreference="maintain-resolution";break;default:S.degradationPreference="balanced"}var o,a,c,d;if((n=_._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&(f.maxBitrate=1e3*((o=_._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)),q(s=_._hints).call(s,Mt.LOW_STREAM)&&((a=_._encoderConfig)!==null&&a!==void 0&&a.frameRate&&(f.maxFramerate=Ui(_._encoderConfig.frameRate)),(c=_._encoderConfig)!==null&&c!==void 0&&c.scaleResolutionDownBy&&((d=_._encoderConfig)===null||d===void 0?void 0:d.scaleResolutionDownBy)>1&&(f.scaleResolutionDownBy=_._encoderConfig.scaleResolutionDownBy)),v("DSCP_TYPE")&&vs()){var l;const y=v("DSCP_TYPE");q(l=["very-low","low","medium","high"]).call(l,y)&&(f.networkPriority=y)}const g=p.sender.getParameters(),C=(r=g.encodings)===null||r===void 0?void 0:r[0];Nt()&&!C&&(S.encodings=[f]),C&&Object.assign(C,f),Object.assign(g,S),await p.sender.setParameters(g)}}}catch{E.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,e,n){const s=Ht.parse(t);return e.forEach((r,o)=>{const a=n[o],c=s.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Hs(c,r),Qp(c,r,this.store.codec))}),Ht.print(s)}mungReceiveAnswerSDP(t,e,n){const s=Ht.parse(t),r=s.mediaDescriptions.find(o=>o.attributes.mid===e);return r&&n===J.AUDIO&&r.media.mediaType==="audio"&&bn(r),this.useXR&&Ga(s),Ht.print(s)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var e;(e=this.onFirstAudioReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var e;(e=this.onFirstVideoReceived)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var e;(e=this.onFirstAudioDecoded)===null||e===void 0||e.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,e,n)=>{var s;(s=this.onFirstVideoDecoded)===null||s===void 0||s.call(this,t,e,n)},this.statsFilter.onSelectedLocalCandidateChanged=(t,e)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,e)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,t,e)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var e;(e=this.onFirstVideoDecodedTimeout)===null||e===void 0||e.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,e){if(t.length===e.length)for(let c=0;c<t.length;c++){var n,s,r,o,a;const d=t[c],l=e[c];if(l instanceof dt&&!q(n=l._hints).call(n,Mt.LOW_STREAM)&&(s=l._encoderConfig)!==null&&s!==void 0&&s.bitrateMax&&((r=l._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const _=d.sender.getParameters();await d.sender.setParameters(Object.assign(_,u))}}}async applySimulcastEncodings(t,e){if(!Nt()&&t.length===e.length)for(let n=0;n<t.length;n++){const s=e[n];if(s instanceof dt&&this.isVP8Simulcast(s)){const r=t[n],o={},a={high:1e3*(s._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=r.sender.getParameters();await r.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var e,n,s,r,o;return!!(t instanceof dt&&v("SIMULCAST")&&this.store.codec==="vp8"&&!q(e=t._hints).call(e,Mt.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((s=t._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,e,n,s){if(v("SDP_LOGGING"))return E.upload("exchanging ".concat(n," ").concat(e," SDP during NVExtentionsConnection.").concat(s,`
`),t),e==="offer"?r=>{this.logSDPExchange(r,"answer",n==="local"?"remote":"local",s)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const e=this.remoteSDP.getSSRC(t);return e==null?void 0:e[0].ssrcId}setConfiguration(t){if(Ot().supportPCSetConfiguration){const e=Be.resolvePCConfiguration(t);this.peerConnection.setConfiguration(e)}}}function gi(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("From NVExtentionsConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function DI(i){var t,e,n,s=2;for(typeof Symbol<"u"&&(e=TI,n=Symbol.iterator);s--;){if(e&&(t=i[e])!=null)return t.call(i);if(n&&(t=i[n])!=null)return new Zd(t.call(i));e="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Zd(i){function t(e){if(Object(e)!==e)return P.reject(new TypeError(e+" is not an object."));var n=e.done;return P.resolve(e.value).then(function(s){return{value:s,done:n}})}return Zd=function(e){this.s=e,this.n=e.next},Zd.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return n===void 0?P.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return n===void 0?P.reject(e):t(n.apply(this.s,arguments))}},new Zd(i)}U([gi,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Be.prototype,"connect",null),U([gi,T("design:type",Function),T("design:paramtypes",[Array,Array]),T("design:returntype",P)],Be.prototype,"updateRemoteRTPCapabilities",null),U([gi,T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Be.prototype,"updateRemoteConnect",null),U([gi,T("design:type",Function),T("design:paramtypes",[Object,Array]),T("design:returntype",P)],Be.prototype,"createDataChannels",null),U([gi,T("design:type",Function),T("design:paramtypes",[String,Array,String,Object]),T("design:returntype",P)],Be.prototype,"receive",null),U([gi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Be.prototype,"batchReceive",null),U([gi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Be.prototype,"stopReceiving",null),U([gi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Be.prototype,"muteRemote",null),U([gi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Be.prototype,"unmuteRemote",null),U([gi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Be.prototype,"muteLocal",null),U([gi,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Be.prototype,"unmuteLocal",null),U([gi,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Be.prototype,"close",null),U([gi,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Be.prototype,"updateEncoderConfig",null),U([gi,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Be.prototype,"updateSendParameters",null),U([gi,T("design:type",Function),T("design:paramtypes",[xe,String]),T("design:returntype",P)],Be.prototype,"replaceTrack",null),U([gi,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Be.prototype,"getRemoteSSRC",null);class Se extends pd{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,e){super(t,e),h(this,"store",void 0),h(this,"peerConnection",void 0),h(this,"cname",void 0),h(this,"mutex",new Ae("DataChannelConnection-mutex")),h(this,"dataChannel",void 0),h(this,"_p2pConnection",void 0),h(this,"establishPromise",void 0),h(this,"_nvMedia",void 0),this.store=e,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Se.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new Be(t,e,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;const e=(t=this._nvMedia)===null||t===void 0?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(e)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,e,n,s,r,o){return this.cname=o,await this._p2pConnection.connect(t,e,n,s,r,o),await new P((a,c)=>{const d=setTimeout(()=>{this.closeSignal(),c(new w(R.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(n))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=l=>{this.closeSignal(),c(l)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,e){return this._p2pConnection.updateRemoteRTPCapabilities(t,e)}send(t,e,n){var s=this;return vi(function*(){const r=yield at(s.mutex.lock("From DataChannelConnection.send"));try{return yield*zd(DI(s._p2pConnection.send(t,e,n)))}finally{r()}})()}async stopSending(t,e){return this._p2pConnection.stopSending(t,e)}async createDataChannels(t,e){return this._p2pConnection.createDataChannels(t,e)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,e,n,s){return this._nvMedia?(E.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,e,this.cname)):(E.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,e,n,s))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var e=this;return vi(function*(){return yield*zd(DI(e._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var e;(e=this._nvMedia)===null||e===void 0||e.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,e){return await this._p2pConnection.updateEncoderConfig(t,e)}async updateSendParameters(t,e){return await this._p2pConnection.updateSendParameters(t,e)}setStatsRemoteVideoIsReady(t,e){this._p2pConnection.setStatsRemoteVideoIsReady(t,e)}async replaceTrack(t,e){return await this._p2pConnection.replaceTrack(t,e)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,e,n,s){if(v("SDP_LOGGING"))return E.upload("exchanging ".concat(n," ").concat(e," SDP during DataChannelConnection.").concat(s,`
`),t),e==="offer"?r=>{this.logSDPExchange(r,"answer",n==="local"?"remote":"local",s)}:void 0}static resolvePCConfiguration(t){const e={iceServers:[]};return t.iceServers?e.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ro(t.turnServer.servers)?e.iceServers=t.turnServer.servers:(e.iceServers&&e.iceServers.push(...Se.turnServerConfigToIceServers(t.turnServer.servers)),v("USE_TURN_SERVER_OF_GATEWAY")&&e.iceServers&&t.turnServer.serversFromGateway&&e.iceServers.push(...Se.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),v("FORCE_TURN_TCP")?e.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(e.iceTransportPolicy="relay")}))),e}static turnServerConfigToIceServers(t){const e=[];return t.forEach(n=>{n.security?n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(ks(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!v("FORCE_TURN_TCP")&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&e.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),e}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var e;return(e=this.onICEConnectionStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var e;return(e=this.onConnectionStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var e;return(e=this.onDTLSTransportStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var e;return(e=this.onDTLSTransportError)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var e;return(e=this.onICETransportStateChange)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var e;return(e=this.onFirstAudioReceived)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var e;return(e=this.onFirstVideoReceived)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var e;return(e=this.onFirstAudioDecoded)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,e,n)=>{var s;return(s=this.onFirstVideoDecoded)===null||s===void 0?void 0:s.call(this,t,e,n)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var e;return(e=this.onFirstVideoDecodedTimeout)===null||e===void 0?void 0:e.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,e)=>{var n;return(n=this.onSelectedLocalCandidateChanged)===null||n===void 0?void 0:n.call(this,t,e)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,e)=>{var n;return(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0?void 0:n.call(this,t,e)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}}function Ki(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function PI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function Js(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?PI(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):PI(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}function LI(i){var t,e,n,s=2;for(typeof Symbol<"u"&&(e=TI,n=Symbol.iterator);s--;){if(e&&(t=i[e])!=null)return t.call(i);if(n&&(t=i[n])!=null)return new $d(t.call(i));e="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function $d(i){function t(e){if(Object(e)!==e)return P.reject(new TypeError(e+" is not an object."));var n=e.done;return P.resolve(e.value).then(function(s){return{value:s,done:n}})}return $d=function(e){this.s=e,this.n=e.next},$d.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return n===void 0?P.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return n===void 0?P.reject(e):t(n.apply(this.s,arguments))}},new $d(i)}U([Ki,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Se.prototype,"connect",null),U([Ki,T("design:type",Function),T("design:paramtypes",[Array,Array]),T("design:returntype",P)],Se.prototype,"updateRemoteRTPCapabilities",null),U([Ki,T("design:type",Function),T("design:paramtypes",[Object,Array]),T("design:returntype",P)],Se.prototype,"createDataChannels",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String,Array,String,Object]),T("design:returntype",P)],Se.prototype,"receive",null),U([Ki,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Se.prototype,"stopReceiving",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Se.prototype,"muteRemote",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Se.prototype,"unmuteRemote",null),U([Ki,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Se.prototype,"muteLocal",null),U([Ki,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Se.prototype,"unmuteLocal",null),U([Ki,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],Se.prototype,"close",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Se.prototype,"updateEncoderConfig",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String,xe]),T("design:returntype",P)],Se.prototype,"updateSendParameters",null),U([Ki,T("design:type",Function),T("design:paramtypes",[xe,String]),T("design:returntype",P)],Se.prototype,"replaceTrack",null),U([Ki,T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],Se.prototype,"getRemoteSSRC",null);class Ne extends Wt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(tt.StateChange,e,this._state)}constructor(t,e){super(),h(this,"store",void 0),h(this,"statsUploader",void 0),h(this,"connection",void 0),h(this,"localTrackMap",new Map),h(this,"remoteUserMap",new Map),h(this,"localDataChannels",[]),h(this,"remoteDataChannelMap",new Map),h(this,"pendingLocalTracks",[]),h(this,"pendingRemoteTracks",[]),h(this,"pendingLocalDataChannels",[]),h(this,"pendingRemoteDataChannels",[]),h(this,"statsCollector",void 0),h(this,"isPlanB",!1),h(this,"shouldForwardP2PCreation",void 0),h(this,"iceFailedCount",0),h(this,"dtlsFailedCount",0),h(this,"mutex",new Ae("P2PChannel-mutex")),h(this,"_state",vt.Disconnected),h(this,"_pcStatsUploadType",v("NEW_ICE_RESTART")?yn.FIRST_CONNECTION:yn.OLD_FIRST_CONNECTION),h(this,"_isInRestartIce",!1),h(this,"_isStartRestartIce",!1),h(this,"_restartStates",["disconnected","failed"]),h(this,"_restartTimer",void 0),h(this,"_isFirstConnected",!0),h(this,"handleMuteLocalTrack",async(n,s,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==vt.Connected)return void r(new M(R.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const a=this.filterTobeMutedTracks(n);if(a.length===0)return void s();const c=a.find(l=>l[0]==="videoLowTrack");c&&c[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(a.map(l=>{let[,{id:u}]=l;return u}));const d=this.createMuteMessage(a);await Dt(this,tt.RequestMuteLocal,d),s()}catch(a){r(a)}finally{o()}}),h(this,"handleUnmuteLocalTrack",async(n,s,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==vt.Connected)return void r(new M(R.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const a=this.filterTobeUnmutedTracks(n);if(a.length===0)return void s();const c=a.find(l=>l[0]==="videoLowTrack");if(c){const l=c[1];if(l.track._originMediaStreamTrack.stop(),!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding){const u=n._mediaStreamTrack.clone();l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u}else{const u=$p(n,pr(this,tt.RequestLowStreamParameter));l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u}await new P((u,p)=>{this.handleReplaceTrack(l.track,u,p,!0)})}await this.connection.unmuteLocal(a.map(l=>{let[,{id:u}]=l;return u}));const d=this.createUnmuteMessage(a);await Dt(this,tt.RequestUnmuteLocal,d),s()}catch(a){r(a)}finally{o()}}),h(this,"handleUpdateVideoEncoder",async(n,s,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const a=this.localTrackMap.get(V.LocalVideoTrack);if(!this.connection||!a||a.track!==n||this.state!==vt.Connected)return void s();const{id:c,track:d}=a;await this.connection.updateSendParameters(c,d),await this.connection.updateEncoderConfig(c,d),this.emit(tt.UpdateVideoEncoder,d),s()}catch(a){r(a)}finally{o()}}),h(this,"handleSetOptimizationMode",async(n,s,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const a=this.localTrackMap.get(V.LocalVideoTrack);if(!this.connection||!a||a.track!==n||this.state!==vt.Connected)return;const{id:c,track:d}=a;await this.connection.updateSendParameters(c,d),s()}catch(a){r(a)}finally{o()}}),h(this,"handleReplaceTrack",async(n,s,r,o)=>{let a;E.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var c;const l=Array.from(this.localTrackMap.entries()).find(u=>{let[,{track:p}]=u;return n===p});if(!this.connection||!l||this.state!==vt.Connected)return void s();if(await((c=this.connection)===null||c===void 0?void 0:c.replaceTrack(n,l[1].id)),this.isPlanB){const u=l[1];u.id=n._mediaStreamTrack.id,this.localTrackMap.set(l[0],u)}if(l[0]===V.LocalVideoTrack&&!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding){const u=this.localTrackMap.get(V.LocalVideoLowTrack);if(u){const p=n._mediaStreamTrack.clone();u.track._originMediaStreamTrack.stop(),u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p,await new P((_,S)=>{this.handleReplaceTrack(u.track,_,S,!0)})}}s()}catch(l){r(l)}finally{var d;(d=a)===null||d===void 0||d()}}),h(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats())}),h(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),h(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),h(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),h(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new pI(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Ot().supportUnifiedPlan||v("CHROME_FORCE_PLAN_B")&&vs(),this.shouldForwardP2PCreation=v("FORWARD_P2P_CREATION")&&Ot().supportPCSetConfiguration&&function(){const n=Hc();return n===_e.ANDROID||n===_e.IOS||n===_e.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Se({},this.store):this.isPlanB?new Oe({},this.store):new Qt({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var n;this.state=vt.New;const s=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!s||(s&&this.connection&&(E.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Se(t,this.store):this.isPlanB?new Oe(t,this.store):new Qt(t,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=v("NEW_ICE_RESTART")?yn.FIRST_CONNECTION:yn.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t,e,n,s,r,o){if(!this.connection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Se?this.connection.updateRemoteConnect(s):(this.store.peerConnectionStart(),await this.connection.connect(t,e,n,s,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=vt.Connected)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[a]=r;return q(o=[V.LocalVideoLowTrack,V.LocalVideoTrack]).call(o,a)}),n=e.map(r=>{let[,{id:o}]=r;return o}),s=e.map(r=>{let[o]=r;return o});if(this.connection instanceof Qt){if(z.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(s),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!q(t).call(t,this.store.codec)){const r=["vp8","h264"].find(o=>q(t).call(t,o));r&&(this.store.codec=r,E.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}async preConnect(t,e,n,s,r,o){if(!this.connection)throw new M(R.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const a=await this.connection.connect(t,e,n,s,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=vt.Connected,a}getEstablishParams(){if(this.connection instanceof Se)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(t){if(!this.connection){if(this.state===vt.Disconnected)throw new M(R.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const n=t.filter(s=>this.pendingLocalDataChannels.findIndex(r=>r.id===s.id)!==-1);return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(n))}const e=this.filterTobePublishedDataChannels(t);e.length!==0&&(e.forEach(n=>{const s=Date.now();this.store.publish(n.id.toString(),"datachannel",s)}),await this.connection.createDataChannels(this.store.uid,e),e.forEach(n=>{this.localDataChannels.push(n);const s=Date.now();this.store.publish(n.id+"","datachannel",void 0,s)}))}publish(t,e,n){var s=this;return vi(function*(){const r=yield at(s.mutex.lock("From P2PChannel.publish"));try{if(!s.connection||s.state!==vt.Connected){if(s.state===vt.Disconnected)throw new M(R.UNEXPECTED_ERROR,"PeerConnection already disconnected.");s.throwIfTrackTypeNotMatch(t);const a=t.filter(c=>s.pendingLocalTracks.indexOf(c)===-1);return void(s.pendingLocalTracks=s.pendingLocalTracks.concat(a))}s.store.pubId=s.store.pubId+1,Ve.markPublishStart(s.store.clientId,s.store.pubId);const o=s.filterTobePublishedTracks(t,e,n);if(o.length===0)return void(yield at(s.tryToUnmuteAudio(t)));yield*zd(LI(s.doPublish(s.connection,o)))}finally{r()}})()}doPublish(t,e){var n=this;return vi(function*(){e.forEach(l=>{let{track:u,type:p}=l;const _=Date.now();n.store.publish(u.getTrackId(),p===V.LocalAudioTrack?"audio":"video",_)}),n.bindLocalTrackEvents(e);const s=yield at(t.send(e.map(l=>{let{track:u}=l;return u}),n.store.codec,n.store.audioCodec)),r=(yield at(s.next())).value,o=n.createGatewayPublishMessage(e,r);let a;try{a=yield o}catch(l){throw s.throw(l),(l==null?void 0:l.code)===R.WS_ABORT&&e.forEach(u=>{let{track:p}=u;n.pendingLocalTracks.indexOf(p)===-1&&n.pendingLocalTracks.push(p)}),n.unbindLocalTrackEvents(e),l}const c=n.mapPubResToRemoteConfig(o,a),d=(yield at(s.next(c))).value;e.forEach(l=>{let{type:u}=l;n.statsCollector.addLocalStats(u)}),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach(l=>{let{track:u,type:p}=l;const _=Date.now();n.store.publish(u.getTrackId(),p===V.LocalAudioTrack?"audio":"video",void 0,_)})})()}async updateVideoStreamParameter(t,e){const n=this.localTrackMap.get(e);if(!n)return;if(!(n.track instanceof dt))return E.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof Qt||this.connection instanceof Oe))return E.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,r=function(o,a){const c={};return o.height&&o.width&&(c.scaleResolutionDownBy=Jh(o,a)),c.maxFramerate=o.framerate?Ui(o.framerate):void 0,c.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,c}(t,s);if(s._encoderConfig||(s._encoderConfig={}),e!==V.LocalVideoLowTrack||!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(s._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const o=s._originMediaStreamTrack;if(!o.canvas)return E.warn("[".concat(s.getTrackId(),"] no canvas on track"));(function(a,c){const d=a.canvas;c.width&&(d.width=Ui(c.width)),c.height&&(d.height=Ui(c.height)),c.framerate&&(d.stopCapture&&d.stopCapture(),d.stopCapture=up(()=>{!d.startCapture&&d.stopCapture&&d.stopCapture(),d.startCapture&&d.startCapture()},Ui(c.framerate)))})(o,t)}r.maxBitrate!=null&&(s._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(s._encoderConfig.frameRate&&typeof s._encoderConfig.frameRate=="object"?s._encoderConfig.frameRate.max=r.maxFramerate:s._encoderConfig.frameRate={max:r.maxFramerate}),E.debug("[".concat(s.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(s._encoderConfig))),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(t){var e=this;return vi(function*(){if(!e.connection||e.state!==vt.Connected)return;const n=yield at(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=e.localTrackMap.get(V.LocalVideoTrack);if(!r)throw new M(R.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(V.LocalVideoLowTrack))throw new M(R.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(r.track,t),type:V.LocalVideoLowTrack}];if(yield*zd(LI(e.doPublish(e.connection,o))),r.track.muted||!r.track.enabled){var s;const a=(s=e.localTrackMap.get(V.LocalVideoLowTrack))===null||s===void 0?void 0:s.id;a!==void 0&&(yield at(e.connection.muteLocal([a])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(E.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await re(this,tt.RequestRePublish,this.pendingLocalTracks),this.emit(tt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(E.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await re(this,tt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:n,kind:s}=this.pendingRemoteTracks[e];(s!==J.AUDIO||n._audio_added_&&n._audioSSRC)&&(s!==J.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await re(this,tt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===J.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:n}=e;this.emit(tt.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==vt.Connected)return void t.forEach(s=>{const r=this.pendingLocalTracks.indexOf(s);r!==-1&&this.pendingLocalTracks.splice(r,1)});const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find(s=>s[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==vt.Connected)return void t.forEach(n=>{const s=this.pendingLocalDataChannels.indexOf(n);s!==-1&&this.pendingLocalDataChannels.splice(s,1)});const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(n=>{const s=this.localDataChannels.indexOf(n);s!==-1&&this.localDataChannels.splice(s,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==vt.Connected)return;const t=this.localTrackMap.get(V.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[V.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map(s=>{let[,{id:r}]=s;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(s=>{let[r,{track:o}]=s;return{type:r,track:o}})),e.forEach(s=>{let[r]=s;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==vt.Connected)throw new M(R.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=e.filter(s=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(s.id))});if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach(s=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(s.id,s):this.remoteDataChannelMap.set(t,new Map([[s.id,s]]));const o=this.pendingRemoteDataChannels.findIndex(a=>{let{user:c,id:d}=a;return c.uid===t.uid&&d===s.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(s=>s.id)}async subscribe(t,e,n,s,r){var o;if(!this.connection||this.state!==vt.Connected)throw new M(R.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let a,c,d;if(r){const p=r.find(S=>{let{stream_type:f}=S;return f===e});if(!p)throw new M(R.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const _=await this.connection.receive(e,p.ssrcs,String(t._uintid),p.attributes);this.connection instanceof Qt&&(d=_.transceiver),a=_.track,c=_.id}else{const p=await this.connection.receive(e,[{ssrcId:n,rtx:s}],String(t._uintid),void 0);this.connection instanceof Qt&&(d=p.transceiver),a=p.track,c=p.id}e===J.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(a):(t._audioTrack=new pn(a,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),d&&t._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(a):(t._videoTrack=new Fn(a,t.uid,t._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),d&&t._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(t,t._videoTrack));const l=this.remoteUserMap.get(t);l?l.set(e,c):this.remoteUserMap.set(t,new Map([[e,c]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const u=this.pendingRemoteTracks.findIndex(p=>{let{user:_,kind:S}=p;return _.uid===t.uid&&e===S});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(tt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==vt.Connected)throw new M(R.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(n=>{var s;let{user:r,mediaType:o}=n;return!((s=this.remoteUserMap.get(r))!==null&&s!==void 0&&s.has(o))});const e=await this.connection.batchReceive(t.map(n=>{let{user:s,mediaType:r,ssrcId:o,rtxSsrcId:a}=n;return{kind:r,ssrcMsg:[{ssrcId:o,rtx:a}],mslabel:String(s._uintid)}}));t.forEach((n,s)=>{let{user:r,mediaType:o}=n;const{track:a,id:c,transceiver:d}=e[s];o===J.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(a):(r._audioTrack=new pn(a,r.uid,r._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),d&&r._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(a):(r._videoTrack=new Fn(a,r.uid,r._uintid,this.store),E.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),d&&r._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(r,r._videoTrack));const l=this.remoteUserMap.get(r);l?l.set(o,c):this.remoteUserMap.set(r,new Map([[o,c]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const u=this.pendingRemoteTracks.findIndex(p=>{let{user:_,kind:S}=p;return _.uid===r.uid&&o===S});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(tt.MediaReconnectEnd,r.uid))})}async unsubscribe(t,e,n){const s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return e!==void 0?c.uid===t.uid&&e===d:c.uid===t.uid});if(s.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),this.connection&&this.state===vt.Connected||n||s.forEach(a=>{let{kind:c}=a;var d;if(c===J.AUDIO)(d=t._audioTrack)===null||d===void 0||d._destroy(),t._audioTrack=void 0;else if(c===J.VIDEO){var l;(l=t._videoTrack)===null||l===void 0||l._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==vt.Connected)return;const r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map(a=>{let[,{id:c}]=a;return c}));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(a=>{let[c,{kind:d}]=a;var l,u;if(d===J.VIDEO&&c._videoSSRC&&((l=this.connection)===null||l===void 0||l.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),d===J.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),n||((u=c._videoTrack)===null||u===void 0||u._destroy(),c._videoTrack=void 0);else if(d===J.AUDIO){var p;this.unbindRemoteTrackEvents(c._audioTrack),!n&&((p=c._audioTrack)===null||p===void 0||p._destroy(),c._audioTrack=void 0)}}),o}async unsubscribeDataChannel(t,e){if(e.forEach(r=>{const o=this.pendingRemoteDataChannels.findIndex(a=>a.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach(r=>{r._close()});const s=this.remoteDataChannelMap.get(t);return n.forEach(r=>{s&&s.delete(r.id)}),s&&s.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map(r=>r.id)}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:r,mediaType:o}of t){const a=this.pendingRemoteTracks.filter(c=>{let{user:d,kind:l}=c;return o!==void 0?d.uid===r.uid&&o===l:d.uid===r.uid});a.forEach(c=>{const d=this.pendingRemoteTracks.indexOf(c);this.pendingRemoteTracks.splice(d,1)}),e=e.concat(a)}if(!this.connection||this.state!==vt.Connected)return void e.forEach(r=>{let{user:o,kind:a}=r;var c;if(a===J.AUDIO)(c=o._audioTrack)===null||c===void 0||c._destroy(),o._audioTrack=void 0;else if(a===J.VIDEO){var d;(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0}});const n=mr(t).call(t,(r,o)=>{let{user:a,mediaType:c}=o;const d=this.filterTobeUnSubscribedTracks(a,c);return r.concat(d)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(r=>{let[,{id:o}]=r;return o}));const s=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(r=>{let[o,{kind:a}]=r;var c,d;if(a===J.VIDEO&&o._videoSSRC&&((c=this.connection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===J.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0;else if(a===J.AUDIO){var l;this.unbindRemoteTrackEvents(o._audioTrack),(l=o._audioTrack)===null||l===void 0||l._destroy(),o._audioTrack=void 0}}),s}async muteRemote(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void E.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const s=e===J.VIDEO?t._videoSSRC:t._audioSSRC;s!==void 0&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void E.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||E.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(V.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ce){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(s=>{let[r]=s;return r!==V.LocalAudioTrack}).filter(s=>{let[r]=s;return!(t&&r===V.LocalVideoLowTrack)}).map(s=>{let[,{track:r}]=s;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[s]=n;return!(t&&s===V.LocalVideoLowTrack)}).map(n=>{let[,{track:s}]=n;return s})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,s,r){if(t){const a=this.localTrackMap.get(V.LocalAudioTrack),c=s?this.localTrackMap.get(V.LocalVideoLowTrack):this.localTrackMap.get(V.LocalVideoTrack);z.publish(this.store.sessionId,{eventElapse:Ve.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(Mt.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const a=n.find(d=>d instanceof Ct),c=s?(o=this.localTrackMap.get(V.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(d=>d instanceof dt);z.publish(this.store.sessionId,{eventElapse:Ve.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:a==null?void 0:a.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(Mt.SCREEN_TRACK))!==-1,audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,s){const r=s===J.VIDEO?n._videoSSRC:n._audioSSRC;r&&z.subscribe(this.store.sessionId,{succ:t,ec:e,video:s===J.VIDEO,audio:s===J.AUDIO,peerid:n.uid,subscribeRequestid:s===J.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ve.measureFromSubscribeStart(this.store.clientId,r)})}reset(){E.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Ae("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Se({},this.store):this.isPlanB?new Oe({},this.store):new Qt({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(V.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ce){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=vt.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(V.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(V.LocalVideoTrack);if(t)return{width:t.track._videoWidth||0,height:t.track._videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof dt||e&&e.track instanceof Ct?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(Di(e=this.remoteUserMap).call(e)).find(s=>s.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[s]=n;return{uid:s.uid,level:s.audioTrack?100*s.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(V.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=ta(t).call(t,(n,s)=>n.level-s.level),t}async disconnectForReconnect(){this.connection&&(E.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=vt.Reconnecting,v("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Se({},this.store):this.isPlanB?new Oe({},this.store):new Qt({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[n,{track:s}]=t;switch(n){case V.LocalVideoTrack:q(e=s._hints).call(e,Mt.LOW_STREAM)?s.close():this.pendingLocalTracks.push(s);break;case V.LocalAudioTrack:s instanceof ce?this.pendingLocalTracks=this.pendingLocalTracks.concat(s.trackList):this.pendingLocalTracks.push(s);case V.LocalVideoLowTrack:}}),this.emit(tt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Di(n).call(n)).forEach(s=>{this.setPendingRemoteMedia(e,s)}),this.emit(tt.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,n]=t;Array.from(Di(n).call(n)).forEach(s=>{this.setPendingRemoteDataChannel(e,s)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),E.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const n of this.pendingRemoteDataChannels){const{user:s,id:r}=n;if((t instanceof Le?t.uid:t)===s.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:s,kind:r}=n;if((t instanceof Le?t.uid:t)===s.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return vi(function*(){if(!e.connection||e.state!==vt.Connected||e.connection instanceof Se)return;const n=yield at(e.mutex.lock("From P2PChannel.restartICE"));let s;try{s=yield at(e.connection.restartICE(t));const o=yield at(s.next());if(o.done)return;const a=o.value,c=yield a;switch(e.reportPCDisconnectedOrFailed(t),t){case Ue.TCP:e._pcStatsUploadType=yn.TCP_RESTART;break;case Ue.RELAY:e._pcStatsUploadType=yn.RELAY_RESTART;break;default:e._pcStatsUploadType=yn.OLD_RESTART}e._isInRestartIce=!0,s.next(c)}catch(o){var r;(r=s)===null||r===void 0||r.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(V.LocalVideoTrack),n=this.localTrackMap.get(V.LocalAudioTrack),s=t.videoSend.find(S=>S.ssrc===(e==null?void 0:e.ssrcs[0].ssrcId)),r=t.audioSend.find(S=>S.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId));if(!s||!r)return 1;const o=Ci(this,tt.NeedSignalRTT),a=s?s.rttMs:void 0,c=r?r.rttMs:void 0,d=a&&c?(a+c)/2:a||c,l=(d&&o?(d+o)/2:d||o)||0,u=100*t.sendPacketLossRate*.7/50+.3*l/1500,p=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,_=e==null?void 0:e.track;if(_&&_._encoderConfig&&_._hints.indexOf(Mt.SCREEN_TRACK)===-1){const S=_._encoderConfig.bitrateMax,f=t.bitrate.actualEncoded;if(S&&f){const g=(1e3*S-f)/(1e3*S);return PS[g<.15?0:g<.3?1:g<.45?2:g<.6?3:4][p]}}return p}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[s]=n;const r=s._audioSSRC,o=s._videoSSRC,a=t.audioRecv.find(f=>f.ssrc===r),c=t.videoRecv.find(f=>f.ssrc===o);if(!a&&!c)return void(e+=1);const d=Ci(this,tt.NeedSignalRTT),l=t.rtt,u=(l&&d?(l+d)/2:l||d)||0,p=a?a.jitterMs:void 0,_=t.recvPacketLossRate;let S=.7*_*100/50+.3*u/1500;p&&(S=.6*_*100/50+.2*u/1500+.2*p/400),e+=S<.1?1:S<.17?2:S<.36?3:S<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new P((e,n)=>{this.handleMuteLocalTrack(t,e,n)})}filterTobePublishedTracks(t,e,n){const s=[],r=Ot(),o=this.getAllTracks();t=oo(t=t.filter(d=>o.indexOf(d)===-1));let a=!1,c=!1;for(const d of t){if(d instanceof dt&&(this.localTrackMap.has(V.LocalVideoTrack)||a?new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(s.push({track:d,type:V.LocalVideoTrack}),a=!0),e)){const l=this.getLowVideoTrack(d,n);s.push({track:l,type:V.LocalVideoLowTrack})}if(d instanceof Ct){const l=this.localTrackMap.get(V.LocalAudioTrack);if(l){if(!(l.track instanceof ce))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(c){const u=s.find(p=>{let{type:_}=p;return _===V.LocalAudioTrack});if(!(u.track instanceof ce))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(d)}else{if(!r.webAudioMediaStreamDest||d instanceof ce||d._bypassWebAudio)s.push({track:d,type:V.LocalAudioTrack});else{const u=new ce;u.addAudioTrack(d),s.push({track:u,type:V.LocalAudioTrack})}c=!0}}}return s}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=oo(t=t.filter(s=>n.indexOf(s)!==-1));for(const s of t){if(s instanceof Ct){const r=this.localTrackMap.get(V.LocalAudioTrack);if(!r)continue;r.track instanceof ce?(r.track.removeAudioTrack(s),this.unbindLocalAudioTrackEvents(s),r.track.trackList.length===0&&(e.push([V.LocalAudioTrack,r]),r.track.close())):e.push([V.LocalAudioTrack,r])}if(s instanceof dt){const r=this.localTrackMap.get(V.LocalVideoTrack);if(!r)continue;e.push([V.LocalVideoTrack,r]);const o=this.localTrackMap.get(V.LocalVideoLowTrack);o&&e.push([V.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=oo(t)).filter(e=>this.localDataChannels.findIndex(n=>n.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=oo(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:s}=e;switch(s){case V.LocalVideoTrack:n.addListener(K.GET_STATS,this.handleGetLocalVideoStats),n.addListener(K.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(K.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(K.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),n.addListener(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case V.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case V.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof ce?t.trackList.forEach(n=>{n.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(K.GET_STATS,this.handleGetLocalAudioStats),n.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(K.GET_STATS,this.handleGetLocalAudioStats),t.addListener(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(K.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:s}]=e;return{track:s,type:n}})),t.forEach(e=>{let{track:n,type:s}=e;switch(s){case V.LocalVideoTrack:n.off(K.GET_STATS,this.handleGetLocalVideoStats),n.off(K.GET_RTC_STATS,this.handleGetRTCStats),n.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(K.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(K.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),n.off(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case V.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case V.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof ce?t.trackList.forEach(e=>{e.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(K.GET_STATS,this.handleGetLocalAudioStats),e.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(K.GET_STATS,this.handleGetLocalAudioStats),t.off(K.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(K.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(K.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(K.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(K.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Fn&&e.addListener(K.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof pn&&e.addListener(K.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(K.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(J.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(J.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,s)=>{var r;let o,a,{track:c,type:d}=n;switch(d){case V.LocalAudioTrack:o=St.Audio,a={dtx:c instanceof yr&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case V.LocalVideoTrack:o=q(r=c._hints).call(r,Mt.SCREEN_TRACK)?St.Screen:St.High,a=Js(Js({},$S(c)),{},{codec:this.store.codec});break;case V.LocalVideoLowTrack:o=St.Low,a=Js(Js({},$S(c)),{},{codec:this.store.codec})}return{stream_type:o,attributes:a,ssrcs:e[s]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}assignLocalTracks(t,e){t.forEach((n,s)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:e[s].id,ssrcs:e[s].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(tt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),v("NEW_ICE_RESTART")){var n;if(q(n=this._restartStates).call(n,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const s=a=>{(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")&&(E.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(a)),Ci(this,tt.QueryClientConnectionState)==="CONNECTED"&&this.emit(tt.RequestRestartICE,a))},r=()=>{t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="checking"&&t.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),E.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(tt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},o=v("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(v("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ot().supportPCSetConfiguration)s(Ue.RELAY),this._restartTimer=window.setTimeout(r,o);else if(Nt())s(Ue.UDP),this._restartTimer=window.setTimeout(r,4e3);else{if(s(Ue.TCP),Ot().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{s(Ue.RELAY),this._restartTimer=window.setTimeout(r,o)},o));this._restartTimer=window.setTimeout(r,o)}},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&v("ICE_RESTART")&&Ci(this,tt.QueryClientConnectionState)==="CONNECTED"&&this.emit(tt.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(tt.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(E.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(tt.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),z.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Yt.TRACER}).onSuccess(),this.emit(tt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===e);var r;s&&(this.store.subscribe(s.uid,"audio",void 0,void 0,void 0,Date.now()),(r=s.audioTrack)===null||r===void 0||r.emit(Cr.FIRST_FRAME_DECODED),z.firstRemoteFrame(this.store.sessionId,me.FIRST_AUDIO_DECODE,Ft.FIRST_AUDIO_DECODE,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(r=>r._audioSSRC===e);s&&z.firstRemoteFrame(this.store.sessionId,me.FIRST_AUDIO_RECEIVED,Ft.FIRST_AUDIO_RECEIVED,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,s)=>{this.reportVideoFirstFrameDecoded(e,n,s)},t.onFirstVideoReceived=e=>{var n;const s=Array.from(Di(n=this.remoteUserMap).call(n)).find(r=>r._videoSSRC===e);s&&z.firstRemoteFrame(this.store.sessionId,me.FIRST_VIDEO_RECEIVED,Ft.FIRST_VIDEO_RECEIVED,{peer:s._uintid,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const s=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&s===r||this.emit(tt.ConnectionTypeChange,s),E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Ms(n))," -> ").concat(JSON.stringify(Ms(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{E.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Ms(n))," -> ").concat(JSON.stringify(Ms(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(V.LocalAudioTrack);if(t instanceof Ct&&(n==null?void 0:n.track)instanceof ce)return n.track.isActive||e.push([V.LocalAudioTrack,n]),e;const s=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(s&&(e.push(s),s[0]===V.LocalVideoTrack)){const r=this.localTrackMap.get(V.LocalVideoLowTrack);r&&e.push([V.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(V.LocalAudioTrack);if(t instanceof Ct&&(n==null?void 0:n.track)instanceof ce)return n.track.isActive&&e.push([V.LocalAudioTrack,n]),e;const s=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(s)if(s[0]===V.LocalVideoTrack){e.push(s);const r=this.localTrackMap.get(V.LocalVideoLowTrack);r&&e.push([V.LocalVideoLowTrack,r])}else e.push(s);return e}createMuteMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}createUnmuteMessage(t){return t.map(e=>{var n;let s,[r,{track:o,ssrcs:a,id:c}]=e;switch(r){case V.LocalAudioTrack:s=St.Audio;break;case V.LocalVideoTrack:s=q(n=o._hints).call(n,Mt.SCREEN_TRACK)?St.Screen:St.High;break;case V.LocalVideoLowTrack:s=St.Low}return{stream_type:s,ssrcs:a,mid:c}})}filterTobeUnSubscribedTracks(t,e){const n=[],s=this.remoteUserMap.get(t);if(!s)return n;if(e){const r=s.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(s.entries()).forEach(r=>{let[o,a]=r;n.push([t,{kind:o,id:a}])});return n}filterTobeUnSubscribedDataChannels(t,e){const n=[];return e.forEach(s=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(s.id)&&n.push(s)}),n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[s,{kind:r,id:o}]=n;switch(r){case J.VIDEO:return void(s._videoSSRC&&e.push({stream_type:J.VIDEO,ssrcId:s._videoSSRC}));case J.AUDIO:return void(s._audioSSRC&&e.push({stream_type:J.AUDIO,ssrcId:s._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(n=>{let[s,{kind:r}]=n;if(e.has(s)){let o=e.get(s);r===J.VIDEO?o|=ue.Video:o|=ue.Audio,e.set(s,o)}else r===J.VIDEO?e.set(s,ue.Video):e.set(s,ue.Audio)}),{users:Array.from(e.entries()).map(n=>{let[s,r]=n;return{stream_id:s.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:s}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(s),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(t){const e=this.localTrackMap.get(V.LocalVideoTrack),n=this.localTrackMap.get(V.LocalVideoLowTrack);e&&await e.track.setBitrateLimit(t.uplink),n&&t.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e){return t.map((n,s)=>{var r;let{stream_type:o}=n;return(r=e.find(a=>{let{stream_type:c}=a;return o===c}))===null||r===void 0?void 0:r.attributes})}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof Ct){var e;const s=this.filterTobeUnmutedTracks(t[n]);if(s.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(s.map(o=>{let[,{id:a}]=o;return a})));const r=this.createUnmuteMessage(s);return void await Dt(this,tt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(tt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(tt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await ye($c(this.dtlsFailedCount,ae)),this.emit(tt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await re(this,tt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(tt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(V.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof dt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof dt).length>1)throw new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof Ct).length>1&&(t.some(e=>e instanceof Ct&&e._bypassWebAudio)||!Ot().webAudioMediaStreamDest))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof dt&&this.pendingLocalTracks.some(n=>n instanceof dt))throw new M(R.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof Ct&&this.pendingLocalTracks.some(n=>n instanceof Ct)&&(!Ot().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Ct&&n._bypassWebAudio)))throw new M(R.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!v("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ot().supportDualStreamEncoding,s=Js(Js({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=n?t._mediaStreamTrack.clone():$p(t,s);const o=Pt(8,"track-low-"),a=new dt(r,Js(Js({},n&&{scaleResolutionDownBy:Jh(s,t)}),{},{frameRate:s.framerate,bitrateMax:s.bitrate,bitrateMin:s.bitrate}),void 0,void 0,o);return a.on(So.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,Us.LOW_STREAM)}),a._hints.push(Mt.LOW_STREAM),t.addListener(K.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Qt){var r,o,a,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:u,peerConnectionState:p}=this.connection,{local:_,remote:S}=await this.connection.getSelectedCandidatePair();z.pcStats(this.store.sessionId,{startTime:d,eventElapse:t-d||0,iceconnectionsate:l,dtlsstate:u,connectionstate:p,intSucc:e?1:2,error:s,selectedLocalCandidateProtocol:(r=_==null?void 0:_.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=_.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(_.address,":").concat(_.port),selectedRemoteCandidateProtocol:(a=S.protocol)!==null&&a!==void 0?a:"",selectedRemoteCandidateType:(c=S.candidateType)!==null&&c!==void 0?c:"",selectedRemoteCandidateAddress:"".concat(S.address,":").concat(S.port),restartCnt:n})}}reportVideoFirstFrameDecoded(t,e,n,s){var r;const o=Array.from(Di(r=this.remoteUserMap).call(r)).find(a=>a._videoSSRC===t);if(o){s||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,c=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");z.firstRemoteVideoDecode(this.store.sessionId,me.FIRST_VIDEO_DECODE,Ft.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Ve.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:s?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return!1;const s=this.remoteUserMap.get(t);if(!s)return!1;const r=s.get(e);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(t){E.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(t)),this.state===vt.Connected?(E.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=t===ud.datachannel?new Se({},this.store):this.isPlanB?new Oe({},this.store):new Qt({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===V.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Us.LOW_STREAM):n._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof Qt&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===yn.TCP_RESTART&&t===Ue.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,yn.DISCONNECTED_OR_FAILED)))}}function ze(i,t,e){const n=i[t];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return e.value=async function(){const s=this.mutex,r=await s.lock("From P2PChannel.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await n.apply(this,a)}finally{r()}},e}function L1(i){let t=UI();return function(e,n){let s=e.appId;s!==void 0&&(It(n,10),Kn(n,s));let r=e.cid;r!==void 0&&(It(n,16),It(n,r));let o=e.cname;o!==void 0&&(It(n,26),Kn(n,o));let a=e.deviceId;a!==void 0&&(It(n,34),Kn(n,a));let c=e.elapse;c!==void 0&&(It(n,40),zs(n,c));let d=e.fileSize;d!==void 0&&(It(n,48),zs(n,ko(d)));let l=e.height;l!==void 0&&(It(n,56),zs(n,ko(l)));let u=e.jpg;u!==void 0&&(It(n,66),It(n,u.length),function(Ai,x){let G=Mo(Ai,x.length);Ai.bytes.set(x,G)}(n,u));let p=e.networkType;p!==void 0&&(It(n,72),zs(n,ko(p)));let _=e.osType;_!==void 0&&(It(n,80),zs(n,ko(_)));let S=e.requestId;S!==void 0&&(It(n,90),Kn(n,S));let f=e.sdkVersion;f!==void 0&&(It(n,98),Kn(n,f));let g=e.sequence;g!==void 0&&(It(n,104),zs(n,ko(g)));let C=e.sid;C!==void 0&&(It(n,114),Kn(n,C));let y=e.timestamp;y!==void 0&&(It(n,120),zs(n,y));let A=e.uid;A!==void 0&&(It(n,128),It(n,A));let k=e.vid;k!==void 0&&(It(n,136),It(n,k));let O=e.width;O!==void 0&&(It(n,144),zs(n,ko(O)));let N=e.service;N!==void 0&&(It(n,152),It(n,N));let L=e.callbackData;L!==void 0&&(It(n,162),Kn(n,L));let D=e.jpgEncryption;D!==void 0&&(It(n,168),It(n,D));let F=e.requestType;F!==void 0&&(It(n,176),It(n,F));let j=e.scorePorn;j!==void 0&&(It(n,185),c_(n,j));let it=e.scoreSexy;it!==void 0&&(It(n,193),c_(n,it));let ct=e.scoreNeutral;ct!==void 0&&(It(n,201),c_(n,ct));let Ut=e.scene;Ut!==void 0&&(It(n,208),It(n,Ut));let he=e.ossFilePrefix;he!==void 0&&(It(n,218),Kn(n,he));let Bt=e.serviceVendor;if(Bt!==void 0)for(let Ai of Bt){It(n,226);let x=UI();U1(Ai,x),It(n,x.limit),B1(n,x),F1(x)}}(i,t),function(e){let n=e.bytes,s=e.limit;return n.length===s?n:n.subarray(0,s)}(t)}function k1(i){return function(e){let n={};t:for(;!xI(e);){let s=Yn(e);switch(s>>>3){case 0:break t;case 1:n.code=Yn(e);break;case 2:n.msg=VI(e,Yn(e));break;case 3:{let r=x1(e);n.data=M1(e),e.limit=r;break}default:kI(e,7&s)}}return n}({bytes:t=i,offset:0,limit:t.length});var t}function M1(i){let t={};t:for(;!xI(i);){let e=Yn(i);switch(e>>>3){case 0:break t;case 1:t.requestId=VI(i,Yn(i));break;case 2:t.requestType=Yn(i)>>>0;break;case 3:t.scorePorn=a_(i);break;case 4:t.scoreSexy=a_(i);break;case 5:t.scoreNeutral=a_(i);break;case 6:t.requestScene=Yn(i)>>>0;break;case 7:t.scene=Yn(i)>>>0;break;default:kI(i,7&e)}}return t}function U1(i,t){let e=i.service;e!==void 0&&(It(t,8),It(t,e));let n=i.vendor;n!==void 0&&(It(t,16),It(t,n));let s=i.token;s!==void 0&&(It(t,26),Kn(t,s));let r=i.callbackUrl;r!==void 0&&(It(t,34),Kn(t,r))}function x1(i){let t=Yn(i),e=i.limit;return i.limit=i.offset+t,e}function kI(i,t){switch(t){case 0:for(;128&FI(i););break;case 2:r_(i,Yn(i));break;case 5:r_(i,4);break;case 1:r_(i,8);break;default:throw new Error("Unimplemented type: "+t)}}U([ze,T("design:type",Function),T("design:paramtypes",[Object,Boolean]),T("design:returntype",P)],Ne.prototype,"startP2PConnection",null),U([ze,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Ne.prototype,"connect",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",void 0)],Ne.prototype,"updateRemoteRTPCapabilities",null),U([ze,T("design:type",Function),T("design:paramtypes",[Object,Object,Array,Object,String,String]),T("design:returntype",P)],Ne.prototype,"preConnect",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Ne.prototype,"publishDataChannel",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Ne.prototype,"unpublish",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Ne.prototype,"unpublishDataChannel",null),U([ze,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],Ne.prototype,"unpublishLowStream",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,Array]),T("design:returntype",P)],Ne.prototype,"subscribeDataChannel",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String,Number,Number,Array]),T("design:returntype",P)],Ne.prototype,"subscribe",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Ne.prototype,"massSubscribe",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String,Boolean]),T("design:returntype",P)],Ne.prototype,"unsubscribe",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,Array]),T("design:returntype",P)],Ne.prototype,"unsubscribeDataChannel",null),U([ze,T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],Ne.prototype,"massUnsubscribe",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Ne.prototype,"muteRemote",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Ne.prototype,"unmuteRemote",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String]),T("design:returntype",P)],Ne.prototype,"hasRemoteMediaWithLock",null),U([ze,T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],Ne.prototype,"disconnectForReconnect",null),U([ze,T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],Ne.prototype,"updateBitrateLimit",null),U([ze,T("design:type",Function),T("design:paramtypes",[Le,String,Number]),T("design:returntype",P)],Ne.prototype,"remoteMediaSsrcChanged",null);let V1=new Float32Array(1);new Uint8Array(V1.buffer);let s_=new Float64Array(1),Ti=new Uint8Array(s_.buffer);function ko(i){return{low:i|=0,high:i>>31,unsigned:i>=0}}let MI=[];function UI(){const i=MI.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}function F1(i){MI.push(i)}function r_(i,t){if(i.offset+t>i.limit)throw new Error("Skip past limit");i.offset+=t}function xI(i){return i.offset>=i.limit}function Mo(i,t){let e=i.bytes,n=i.offset,s=i.limit,r=n+t;if(r>e.length){let o=new Uint8Array(2*r);o.set(e),i.bytes=o}return i.offset=r,r>s&&(i.limit=r),n}function o_(i,t){let e=i.offset;if(e+t>i.limit)throw new Error("Read past limit");return i.offset+=t,e}function VI(i,t){let e=o_(i,t),n=String.fromCharCode,s=i.bytes,r="ï¿½",o="";for(let a=0;a<t;a++){let c,d,l,u,p=s[a+e];128&p?(224&p)==192?a+1>=t?o+=r:(c=s[a+e+1],(192&c)!=128?o+=r:(u=(31&p)<<6|63&c,u<128?o+=r:(o+=n(u),a++))):(240&p)==224?a+2>=t?o+=r:(c=s[a+e+1],d=s[a+e+2],(49344&(c|d<<8))!=32896?o+=r:(u=(15&p)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=r:(o+=n(u),a+=2))):(248&p)==240?a+3>=t?o+=r:(c=s[a+e+1],d=s[a+e+2],l=s[a+e+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=r:(u=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=r:(u-=65536,o+=n(55296+(u>>10),56320+(1023&u)),a+=3))):o+=r:o+=n(p)}return o}function Kn(i,t){let e=t.length,n=0;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}It(i,n);let s=Mo(i,n),r=i.bytes;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?r[s++]=a:(a<2048?r[s++]=a>>6&31|192:(a<65536?r[s++]=a>>12&15|224:(r[s++]=a>>18&7|240,r[s++]=a>>12&63|128),r[s++]=a>>6&63|128),r[s++]=63&a|128)}}function B1(i,t){let e=Mo(i,t.limit),n=i.bytes,s=t.bytes;for(let r=0,o=t.limit;r<o;r++)n[r+e]=s[r]}function FI(i){return i.bytes[o_(i,1)]}function BI(i,t){let e=Mo(i,1);i.bytes[e]=t}function a_(i){let t=o_(i,8),e=i.bytes;return Ti[0]=e[t++],Ti[1]=e[t++],Ti[2]=e[t++],Ti[3]=e[t++],Ti[4]=e[t++],Ti[5]=e[t++],Ti[6]=e[t++],Ti[7]=e[t++],s_[0]}function c_(i,t){let e=Mo(i,8),n=i.bytes;s_[0]=t,n[e++]=Ti[0],n[e++]=Ti[1],n[e++]=Ti[2],n[e++]=Ti[3],n[e++]=Ti[4],n[e++]=Ti[5],n[e++]=Ti[6],n[e++]=Ti[7]}function Yn(i){let t,e=0,n=0;do t=FI(i),e<32&&(n|=(127&t)<<e),e+=7;while(128&t);return n}function It(i,t){for(t>>>=0;t>=128;)BI(i,127&t|128),t>>>=7;BI(i,t)}function zs(i,t){let e=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,r=s===0?n===0?e<16384?e<128?1:2:e<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,o=Mo(i,r),a=i.bytes;switch(r){case 10:a[o+9]=s>>>7&1;case 9:a[o+8]=r!==9?128|s:127&s;case 8:a[o+7]=r!==8?n>>>21|128:n>>>21&127;case 7:a[o+6]=r!==7?n>>>14|128:n>>>14&127;case 6:a[o+5]=r!==6?n>>>7|128:n>>>7&127;case 5:a[o+4]=r!==5?128|n:127&n;case 4:a[o+3]=r!==4?e>>>21|128:e>>>21&127;case 3:a[o+2]=r!==3?e>>>14|128:e>>>14&127;case 2:a[o+1]=r!==2?e>>>7|128:e>>>7&127;case 1:a[o]=r!==1?128|e:127&e}}function jI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}const j1=new Map([["moderation",1],["supervise",2]]);class tl extends Wt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(ge.CONNECTION_STATE_CHANGE,e,t)}get inspectType(){return this._inspectType}set inspectType(t){var e;this._inspectMode=mr(e=t.map(n=>j1.get(n)||0)).call(e,(n,s)=>n+s),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),h(this,"name","AgoraRTCVideoContentInspect"),h(this,"_connectionState",ki.CONNECTING),h(this,"_innerConnectionState",void 0),h(this,"sequence",0),h(this,"inspectStartTime",void 0),h(this,"workerManagerConnection",void 0),h(this,"workerConnection",void 0),h(this,"workerMessageLengthLimit",void 0),h(this,"inspectIntervalMinimum",void 0),h(this,"qualityRatio",void 0),h(this,"_connectInfo",void 0),h(this,"_cancelTokenSource",hi.CancelToken.source()),h(this,"_retryConfig",void 0),h(this,"wmSequence",0),h(this,"inspectInterval",void 0),h(this,"inspectTimer",null),h(this,"ossFilePrefix",void 0),h(this,"extraInfo",void 0),h(this,"_inspectType",void 0),h(this,"_inspectMode",void 0),h(this,"_quality",1),h(this,"qualityTimer",null),h(this,"_inspectId",void 0),h(this,"_needWorkUrlOnly",!1),h(this,"inspectImage",()=>{if(this.connectionState!==ki.CONNECTED)throw new w(R.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===ki.CONNECTED?this.requestToInspectImage():E.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Pt(5,"inspect-"),this.workerMessageLengthLimit=v("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=v("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=v("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Ta("worker-manager-"+this._inspectId,ae),this.on(ge.STATE_CHANGE,(e,n)=>{this._innerConnectionState=e,E.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Mi[e]," ").concat(n||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Ta("worker-"+this._inspectId,ae),this.handleWorkerEvents()}async init(t,e){this.emit(ge.STATE_CHANGE,Mi.CONNECT_AP),this._connectInfo=t;const n=this._cancelTokenSource.token;return this._retryConfig=e,new P((s,r)=>{this.on(ge.CONNECTION_STATE_CHANGE,(o,a)=>{a===ki.CONNECTED&&s()}),this.requestAP(t,n,e).then(o=>{this.connectWorkerManager(o)}).catch(o=>{r(o)})})}async requestAP(t,e,n){const s=v("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),r=await function(a,c,d,l){let{appId:u,areaCode:p,cname:_,sid:S,token:f,uid:g}=c;mo++;const C="image_moderation_api",y={service_name:C,json_body:JSON.stringify({appId:u,areaCode:p,cname:_,command:"allocateEdge",requestId:mo,seq:mo,sid:S,token:f,ts:Date.now(),uid:g+""})};let A,k,O=a[0];return Cn(async()=>{A=Date.now();const N=await ss(O,{data:y,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(k=Date.now()-A,N.code!==0){const j=new w(R.UNEXPECTED_RESPONSE,"image inspect ap error, code"+N.code,{retry:!0,responseTime:k});throw E.error(j.toString()),j}const L=JSON.parse(N.json_body);if(L.code!==200){const j=new w(R.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(L.code,", reason: ").concat(L.reason),{code:L.code,responseTime:k});throw E.error(j.toString()),j}if(!L.servers||!Array.isArray(L.servers)||L.servers.length===0){const j=new w(R.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:L.code,responseTime:k});throw E.error(j.toString()),j}const D=v("VIDEO_INSPECT_WORKER_MANAGER_HOST"),F=v("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:L.servers.map(j=>{let{address:it,wss:ct}=j;if(it&&ct)return"wss://".concat(it.replace(/\./g,"-"),".").concat(D,":").concat(F||ct)}).filter(j=>!!j),workerToken:L.workerToken,vid:L.vid,responseTime:k}},(N,L)=>(z.apworkerEvent(S,{success:!0,sc:200,serviceName:C,responseDetail:JSON.stringify(N.addressList),firstSuccess:L===0,responseTime:k,serverIp:a[L%a.length]}),!1),(N,L)=>(z.apworkerEvent(S,{success:!1,sc:N.data&&N.data.code||200,serviceName:C,responseTime:k,serverIp:a[L%a.length]}),!!(N.code!==R.OPERATION_ABORTED&&N.code!==R.UNEXPECTED_RESPONSE||N.data&&N.data.retry)&&(O=a[(L+1)%a.length],!0)),l)}(s,t,e,n);this.emit(ge.STATE_CHANGE,Mi.AP_CONNECTED);const{addressList:o}=r;return this.wmSequence++,o}async connectWorkerManager(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=e,this.emit(ge.STATE_CHANGE,Mi.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(et.CONNECTED,async()=>{this.emit(ge.STATE_CHANGE,Mi.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(et.CLOSED,()=>{this._innerConnectionState<Mi.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(et.FAILED,()=>{this._innerConnectionState<Mi.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(et.RECONNECTING,()=>{this._innerConnectionState<Mi.GET_WORKER_MANAGER_RESPONSE&&E.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(et.ON_MESSAGE,async t=>{this.emit(ge.STATE_CHANGE,Mi.GET_WORKER_MANAGER_RESPONSE);const e=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(t.data);if(n.code!==200)throw E.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new w(R.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&e))throw E.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new w(R.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const s=v("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,r=e.replace(/:\d+\/?$/,":".concat(s));this.emit(ge.STATE_CHANGE,Mi.CONNECT_WORKER,r),this._needWorkUrlOnly?this.emit(ge.REQUEST_NEW_WORKER_URL,r):await this.connectWorker(r)}}),this.workerManagerConnection.on(et.WILL_RECONNECT,(t,e,n)=>{n(t)}),this.workerManagerConnection.on(et.REQUEST_NEW_URLS,(t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)})}handleWorkerEvents(){this.workerConnection.on(et.CONNECTED,async()=>{this.emit(ge.STATE_CHANGE,Mi.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=ki.CONNECTED}),this.workerConnection.on(et.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const n=k1(new Uint8Array(t.data));if(v("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&E.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(ge.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var e;const s={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},r=mr(e=Object.keys(s)).call(e,(a,c)=>s[a]>s[c]?a:c,"porn"),o=Object.keys(s).find(a=>a===r);this.emit(ge.INSPECT_RESULT,o)}else this.emit(ge.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(ge.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else E.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(ge.INSPECT_RESULT,void 0,new w(R.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(et.CLOSED,()=>{this.connectionState=ki.CLOSED}),this.workerConnection.on(et.FAILED,()=>{this.connectionState=ki.CLOSED}),this.workerConnection.on(et.RECONNECTING,()=>{this.connectionState=this.connectionState===ki.CONNECTED?ki.RECONNECTING:ki.CONNECTING}),this.workerConnection.on(et.WILL_RECONNECT,(t,e,n)=>{t==="recover"&&n(t),n("tryNext")}),this.workerConnection.on(et.REQUEST_NEW_URLS,(t,e)=>{this.workerManagerConnection.close(),this.once(ge.REQUEST_NEW_WORKER_URL,n=>{t([n])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n=>{this.connectWorkerManager(n,!0)}).catch(n=>{e(n)})})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;const t=Ci(this,ge.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(ge.INSPECT_RESULT,void 0,new w(R.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(t,e);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(ge.INSPECT_RESULT,void 0,new w(R.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,e){let{appId:n,cname:s,cid:r,vid:o,sid:a,uid:c}=e;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await zR(l,n,s),p=this.sequence+"-"+r+"-"+c+"-"+d+"-"+Pt(12,""),_={appId:n,cid:r,cname:s,deviceId:"",elapse:tl.intToLong(Number(d-this.inspectStartTime)),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:p,sdkVersion:"4.20.0",sequence:this.sequence,sid:a,timestamp:tl.intToLong(d),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete _.callbackData,this.ossFilePrefix===void 0&&delete _.ossFilePrefix;const S=L1(_);if(S.byteLength<this.workerMessageLengthLimit){if(v("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const f=function(g){for(var C=1;C<arguments.length;C++){var y=arguments[C]!=null?arguments[C]:{};C%2?jI(Object(y),!0).forEach(function(A){h(g,A,y[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(y)):jI(Object(y)).forEach(function(A){Object.defineProperty(g,A,Object.getOwnPropertyDescriptor(y,A))})}return g}({},_);delete f.jpg,E.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return S}{const f=this.quality*this.qualityRatio;return this.quality=f,await this.generateRequestData(t,{appId:n,cname:s,cid:r,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=ki.CLOSED,this.emit(ge.STATE_CHANGE,Mi.CLOSED)}}function G1(i){let t=function(){const e=K1.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,n){let s=e.appId;s!==void 0&&(se(n,10),Xs(n,s));let r=e.cid;r!==void 0&&(se(n,16),se(n,r));let o=e.cname;o!==void 0&&(se(n,26),Xs(n,o));let a=e.deviceId;a!==void 0&&(se(n,34),Xs(n,a));let c=e.elapse;c!==void 0&&(se(n,40),Qs(n,c));let d=e.fileSize;d!==void 0&&(se(n,48),Qs(n,Uo(d)));let l=e.height;l!==void 0&&(se(n,56),Qs(n,Uo(l)));let u=e.jpg;u!==void 0&&(se(n,66),se(n,u.length),WI(n,u));let p=e.networkType;p!==void 0&&(se(n,72),Qs(n,Uo(p)));let _=e.osType;_!==void 0&&(se(n,80),Qs(n,Uo(_)));let S=e.requestId;S!==void 0&&(se(n,90),Xs(n,S));let f=e.sdkVersion;f!==void 0&&(se(n,98),Xs(n,f));let g=e.sequence;g!==void 0&&(se(n,104),Qs(n,Uo(g)));let C=e.sid;C!==void 0&&(se(n,114),Xs(n,C));let y=e.timestamp;y!==void 0&&(se(n,120),Qs(n,y));let A=e.uid;A!==void 0&&(se(n,128),se(n,A));let k=e.vid;k!==void 0&&(se(n,136),se(n,k));let O=e.width;O!==void 0&&(se(n,144),Qs(n,Uo(O)));let N=e.service;N!==void 0&&(se(n,152),se(n,N));let L=e.callbackData;L!==void 0&&(se(n,162),se(n,L.length),WI(n,L));let D=e.ticket;D!==void 0&&(se(n,170),Xs(n,D));let F=e.vendorConfigs;F!==void 0&&(se(n,178),Xs(n,F))}(i,t),function(e){let n=e.bytes,s=e.limit;return n.length===s?n:n.subarray(0,s)}(t)}function W1(i){return function(e){let n={};t:for(;!Y1(e);){let s=qa(e);switch(s>>>3){case 0:break t;case 1:n.code=qa(e);break;case 2:n.msg=HI(e,qa(e));break;case 3:n.requestId=HI(e,qa(e));break;case 4:n.timestamp=q1(e,!1);break;default:H1(e,7&s)}}return n}({bytes:t=i,offset:0,limit:t.length});var t}function H1(i,t){switch(t){case 0:for(;128&Tn(i););break;case 2:d_(i,qa(i));break;case 5:d_(i,4);break;case 1:d_(i,8);break;default:throw new Error("Unimplemented type: "+t)}}function Uo(i){return{low:i|=0,high:i>>31,unsigned:i>=0}}let K1=[];function d_(i,t){if(i.offset+t>i.limit)throw new Error("Skip past limit");i.offset+=t}function Y1(i){return i.offset>=i.limit}function el(i,t){let e=i.bytes,n=i.offset,s=i.limit,r=n+t;if(r>e.length){let o=new Uint8Array(2*r);o.set(e),i.bytes=o}return i.offset=r,r>s&&(i.limit=r),n}function GI(i,t){let e=i.offset;if(e+t>i.limit)throw new Error("Read past limit");return i.offset+=t,e}function WI(i,t){let e=el(i,t.length);i.bytes.set(t,e)}function HI(i,t){let e=GI(i,t),n=String.fromCharCode,s=i.bytes,r="ï¿½",o="";for(let a=0;a<t;a++){let c,d,l,u,p=s[a+e];128&p?(224&p)==192?a+1>=t?o+=r:(c=s[a+e+1],(192&c)!=128?o+=r:(u=(31&p)<<6|63&c,u<128?o+=r:(o+=n(u),a++))):(240&p)==224?a+2>=t?o+=r:(c=s[a+e+1],d=s[a+e+2],(49344&(c|d<<8))!=32896?o+=r:(u=(15&p)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=r:(o+=n(u),a+=2))):(248&p)==240?a+3>=t?o+=r:(c=s[a+e+1],d=s[a+e+2],l=s[a+e+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=r:(u=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=r:(u-=65536,o+=n(55296+(u>>10),56320+(1023&u)),a+=3))):o+=r:o+=n(p)}return o}function Xs(i,t){let e=t.length,n=0;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}se(i,n);let s=el(i,n),r=i.bytes;for(let o=0;o<e;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<e&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?r[s++]=a:(a<2048?r[s++]=a>>6&31|192:(a<65536?r[s++]=a>>12&15|224:(r[s++]=a>>18&7|240,r[s++]=a>>12&63|128),r[s++]=a>>6&63|128),r[s++]=63&a|128)}}function Tn(i){return i.bytes[GI(i,1)]}function KI(i,t){let e=el(i,1);i.bytes[e]=t}function qa(i){let t,e=0,n=0;do t=Tn(i),e<32&&(n|=(127&t)<<e),e+=7;while(128&t);return n}function se(i,t){for(t>>>=0;t>=128;)KI(i,127&t|128),t>>>=7;KI(i,t)}function q1(i,t){let e,n=0,s=0,r=0;return e=Tn(i),n=127&e,128&e&&(e=Tn(i),n|=(127&e)<<7,128&e&&(e=Tn(i),n|=(127&e)<<14,128&e&&(e=Tn(i),n|=(127&e)<<21,128&e&&(e=Tn(i),s=127&e,128&e&&(e=Tn(i),s|=(127&e)<<7,128&e&&(e=Tn(i),s|=(127&e)<<14,128&e&&(e=Tn(i),s|=(127&e)<<21,128&e&&(e=Tn(i),r=127&e,128&e&&(e=Tn(i),r|=(127&e)<<7))))))))),{low:n|s<<28,high:s>>>4|r<<24,unsigned:t}}function Qs(i,t){let e=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,r=s===0?n===0?e<16384?e<128?1:2:e<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,o=el(i,r),a=i.bytes;switch(r){case 10:a[o+9]=s>>>7&1;case 9:a[o+8]=r!==9?128|s:127&s;case 8:a[o+7]=r!==8?n>>>21|128:n>>>21&127;case 7:a[o+6]=r!==7?n>>>14|128:n>>>14&127;case 6:a[o+5]=r!==6?n>>>7|128:n>>>7&127;case 5:a[o+4]=r!==5?128|n:127&n;case 4:a[o+3]=r!==4?e>>>21|128:e>>>21&127;case 3:a[o+2]=r!==3?e>>>14|128:e>>>14&127;case 2:a[o+1]=r!==2?e>>>7|128:e>>>7&127;case 1:a[o]=r!==1?128|e:127&e}}const YI={},qI={},il=4294967296,JI=il*il,zI=JI/2,l_=QI(0,!0),XI=QI(0),J1=xo(0,-2147483648,!1),z1=xo(-1,2147483647,!1),X1=xo(-1,-1,!0);function QI(i,t){let e,n,s;return t?(s=0<=(i>>>=0)&&i<256)&&(n=qI[i],n)?n:(e=xo(i,0,!0),s&&(qI[i]=e),e):(s=-128<=(i|=0)&&i<128)&&(n=YI[i],n)?n:(e=xo(i,i<0?-1:0,!1),s&&(YI[i]=e),e)}function xo(i,t,e){return{low:0|i,high:0|t,unsigned:!!e}}function Q1(i,t){if(isNaN(i))return t?l_:XI;if(t){if(i<0)return l_;if(i>=JI)return X1}else{if(i<=-zI)return J1;if(i+1>=zI)return z1}return i<0?t?l_:XI:xo(i%il|0,i/il|0,t)}function ZI(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}class u_ extends Wt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const e=this._connectionState;this._connectionState=t,this.emit(Xi.CONNECTION_STATE_CHANGE,t,e)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var e;super(),h(this,"name","AgoraRTCImageModeration"),h(this,"_connectionState",Ii.CONNECTING),h(this,"_sequence",0),h(this,"_moderationStartTime",void 0),h(this,"_workerConnection",void 0),h(this,"_workerMessageLengthLimit",void 0),h(this,"_qualityRatio",void 0),h(this,"_connectInfo",void 0),h(this,"_cancelTokenSource",hi.CancelToken.source()),h(this,"_retryConfig",void 0),h(this,"_moderationInterval",void 0),h(this,"_moderationTimer",null),h(this,"_moderationMode",1),h(this,"_quality",1),h(this,"_qualityTimer",null),h(this,"_ticket",void 0),h(this,"_moderationIntervalMinimum",void 0),h(this,"_uploadFailedNum",0),h(this,"_uploadNum",0),h(this,"_uploadTimer",null),h(this,"_extraInfo",void 0),h(this,"_vendor",""),h(this,"_encoder",new TextEncoder),h(this,"_moderationId",void 0),h(this,"inspectImage",()=>{if(this.connectionState!==Ii.CONNECTED)throw new w(R.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Ii.CONNECTED?this.requestToInspectImage():E.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Pt(5,"image-moderation-"),this._workerMessageLengthLimit=v("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=v("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(e=t.interval)!==null&&e!==void 0?e:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=v("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Ta("worker-"+this._moderationId,ae),this.on(Xi.STATE_CHANGE,(n,s)=>{E.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Ps[n]," ").concat(s||""))}),this.handleWorkerEvents()}async init(t,e){this.emit(Xi.STATE_CHANGE,Ps.CONNECT_AP),this._connectInfo=t;const n=this._cancelTokenSource.token;return this._retryConfig=e,new P((s,r)=>{this.on(Xi.CONNECTION_STATE_CHANGE,(o,a)=>{o===Ii.CONNECTED&&s()}),this.requestAP(t,n,e).then(o=>{this.connectWorker(o)}).catch(o=>{r(o)})})}updateConfig(t){var e;this._moderationInterval=(e=t.interval)!==null&&e!==void 0?e:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),E.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===Ii.CONNECTED&&this.inspectImage()}async requestAP(t,e,n){const s=v("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),r=await function(c,d,l,u){let{appId:p,areaCode:_,cname:S,sid:f,token:g,uid:C}=d;mo++;const y="moderation_plugin",A={service_name:y,json_body:JSON.stringify({appId:p,areaCode:_,cname:S,command:"allocateEdge",requestId:mo,seq:mo,sid:f,appToken:g,ts:Date.now(),uid:C+""})};let k,O,N=c[0];return Cn(async()=>{k=Date.now();const L=await ss(N,{data:A,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(O=Date.now()-k,L.code!==0){const j=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+L.code,{retry:!0,responseTime:O});throw E.error(j.toString()),j}const D=JSON.parse(L.json_body);if(D.code!==200){const j=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(D.code,", reason: ").concat(D.reason),{code:D.code,responseTime:O});throw E.error(j.toString()),j}if(!D.servers||!Array.isArray(D.servers)||D.servers.length===0){const j=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:D.code,responseTime:O});throw E.error(j.toString()),j}if(!D.servers.some(j=>!!j.wss)){const j=new w(R.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:D.code,responseTime:O});throw E.error(j.toString()),j}const F=v("IMAGE_MODERATION_WORKER_HOST");return{addressList:D.servers.map(j=>{let{address:it,wss:ct}=j;if(it&&ct)return"wss://".concat(it.replace(/\./g,"-"),".").concat(F,":").concat(ct,"/moderation")}).filter(j=>!!j),workerToken:D.workerToken,vid:D.vid,ticket:D.appTicket,responseTime:O}},(L,D)=>(z.apworkerEvent(f,{success:!0,sc:200,serviceName:y,responseDetail:JSON.stringify(L.addressList),firstSuccess:D===0,responseTime:O,serverIp:c[D%c.length]}),!1),(L,D)=>(z.apworkerEvent(f,{success:!1,sc:L.data&&L.data.code||200,serviceName:y,responseTime:O,serverIp:c[D%c.length]}),!!(L.code!==R.OPERATION_ABORTED&&L.code!==R.UNEXPECTED_RESPONSE||L.data&&L.data.retry)&&(N=c[(D+1)%c.length],!0)),u)}(s,t,e,n);this.emit(Xi.STATE_CHANGE,Ps.AP_CONNECTED);const{addressList:o,ticket:a}=r;return this._ticket=a,o}async connectWorker(t){this.emit(Xi.STATE_CHANGE,Ps.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(et.CONNECTED,async()=>{this.emit(Xi.STATE_CHANGE,Ps.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Ii.CONNECTED}),this._workerConnection.on(et.CLOSED,()=>{this.connectionState=Ii.CLOSED}),this._workerConnection.on(et.FAILED,()=>{this.connectionState=Ii.CLOSED}),this._workerConnection.on(et.RECONNECTING,()=>{this.connectionState=this.connectionState===Ii.CONNECTED?Ii.RECONNECTING:Ii.CONNECTING}),this._workerConnection.on(et.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const e=W1(new Uint8Array(t.data));v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(e)),this._uploadNum++,e.code===void 0||e.code===0||(this._uploadFailedNum++,E.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(e.code,", msg is ").concat(e.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{z.reportApiInvoke(this._connectInfo.sid||null,{name:le.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,e.code],tag:Yt.TRACER}).onError(new w(R.IMAGE_MODERATION_UPLOAD_FAILED,e.msg)),this._uploadTimer=null},v("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else E.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(et.WILL_RECONNECT,(t,e,n)=>{t==="recover"&&n(t),n("tryNext")}),this._workerConnection.on(et.REQUEST_NEW_URLS,(t,e)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(e)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=Ci(this,Xi.CLIENT_LOCAL_VIDEO_TRACK),e={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(t,e);this._workerConnection.sendMessage(n,!0,!0)}else v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&E.debug("Only the track being published can be inspected")}async generateRequestData(t,e){let{appId:n,cname:s,cid:r,vid:o,sid:a,uid:c}=e;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await zR(l,n,s),p=this._sequence+"-"+r+"-"+c+"-"+d+"-"+Pt(12,""),_={appId:n,cid:r,cname:s,deviceId:"",elapse:u_.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:p,sdkVersion:"4.20.0",sequence:this._sequence,sid:a,timestamp:Q1(d),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete _.callbackData;const S=G1(_);if(S.byteLength<this._workerMessageLengthLimit){if(v("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const f=function(g){for(var C=1;C<arguments.length;C++){var y=arguments[C]!=null?arguments[C]:{};C%2?ZI(Object(y),!0).forEach(function(A){h(g,A,y[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(y)):ZI(Object(y)).forEach(function(A){Object.defineProperty(g,A,Object.getOwnPropertyDescriptor(y,A))})}return g}({},_);delete f.jpg,E.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(f))}return S}{const f=this.quality*this._qualityRatio;return this.quality=f,await this.generateRequestData(t,{appId:n,cname:s,cid:r,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hi.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Ii.CLOSED,this.emit(Xi.STATE_CHANGE,Ps.CLOSED)}}function $I(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function tv(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?$I(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):$I(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}const Z1=Date.now(),$1=20,h_=new Map,nl=new Map;async function ev(i){const t=h_.get(i),e=Array.isArray(t)&&t[t.length-1],n=nl.get(i);if(!e)return void(n.isSyncing=!1);const s={uid:e.uid,payload:Xc(e.payload)};n.firstRecvTs===0&&(n.firstRecvTs=e.recvTs,n.firstSendTs=e.sendTs);const r=e.sendTs-n.firstSendTs,o=r-(Date.now()-n.firstRecvTs);o>0&&(n.firstRecvTs=Date.now()-r);let a=e.mediaDelay+o;a<=0?(t.pop(),iv(e.context,s),a=0):a=Math.min(a,$1),setTimeout(()=>t.length&&ev(i),a)}function iv(i,t){i.safeEmit(_t.STREAM_MESSAGE,t.uid,t.payload),i.onStreamMessage&&i.onStreamMessage(t)}function tU(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,e=arguments.length>2?arguments[2]:void 0;if(!i.syncWithAudio)return iv(e,{uid:i.uid,payload:Xc(i.payload)});const n="".concat(e.id,"-").concat(i.uid),s=h_.get(n)||[],r=s.findIndex(d=>i.sendTs>=d.sendTs),o=tv(tv({},i),{},{context:e,mediaDelay:t,recvTs:Date.now()});r===-1?s.push(o):s.splice(r,0,o),h_.set(n,s);let a=!1;var c;nl.has(n)?a=!((c=nl.get(n))===null||c===void 0||!c.isSyncing):nl.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||ev(n)}const eU=ft().name;function iU(){return!function(i,t,e){const n=ft();if(n.os!==_e.IOS||!n.osVersion)return!1;const s=n.osVersion.split(".");return e?t&&Number(s[0])===i&&Number(s[1])<t||Number(s[0])<i:t?Number(s[0])===i&&Number(s[1])<=t||Number(s[0])<i:Number(s[0])<=i}(16,0,!0)&&!function(i,t,e){const n=ft();if(n.name!==Rt.SAFARI||!n.osVersion)return!1;const s=n.version.split(".");return e?t&&Number(s[0])===i&&Number(s[1])<t||Number(s[0])<i:t?Number(s[0])===i&&Number(s[1])<=t||Number(s[0])<i:Number(s[0])<=i}(16,0,!0)}function nv(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function hs(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?nv(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):nv(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}Ae.setLogger(E);class At extends Wt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t){let e;if(super(),h(this,"store",void 0),h(this,"_uid",void 0),h(this,"_channelName",void 0),h(this,"_uintUid",void 0),h(this,"_users",[]),h(this,"_config",void 0),h(this,"_clientId",void 0),h(this,"_appId",void 0),h(this,"_sessionId",null),h(this,"_key",void 0),h(this,"_rtmConfig",{}),h(this,"_joinInfo",void 0),h(this,"_gateway",void 0),h(this,"_statsCollector",void 0),h(this,"_configDistribute",void 0),h(this,"_leaveMutex",new Ae("client-leave")),h(this,"_publishMutex",new Ae("client-publish")),h(this,"_renewTokenMutex",new Ae("client-renewtoken")),h(this,"_subscribeMutex",new Ae("client-subscribe")),h(this,"_encryptionMode","none"),h(this,"_encryptionSecret",null),h(this,"_encryptionSalt",null),h(this,"_proxyServer",void 0),h(this,"_turnServer",{servers:[],mode:"auto"}),h(this,"_cloudProxyServerMode","disabled"),h(this,"_isDualStreamEnabled",!1),h(this,"_defaultStreamFallbackType",void 0),h(this,"_lowStreamParameter",void 0),h(this,"_streamFallbackTypeCacheMap",new Map),h(this,"_remoteStreamTypeCacheMap",new Map),h(this,"_axiosCancelSource",hi.CancelToken.source()),h(this,"_audioVolumeIndicationInterval",void 0),h(this,"_networkQualityInterval",void 0),h(this,"_userOfflineTimeout",void 0),h(this,"_streamRemovedTimeout",void 0),h(this,"_injectStreamingClient",void 0),h(this,"_liveTranscodeStreamingClient",void 0),h(this,"_liveRawStreamingClient",void 0),h(this,"_channelMediaRelayClient",void 0),h(this,"_networkQualitySensitivity","normal"),h(this,"_p2pChannel",void 0),h(this,"_useLocalAccessPoint",!1),h(this,"_setLocalAPVersion",void 0),h(this,"_joinAndNotLeaveYet",!1),h(this,"_numberOfJoinCount",0),h(this,"_remoteDefaultVideoStreamType",void 0),h(this,"_inspect",void 0),h(this,"_moderation",void 0),h(this,"_license",void 0),h(this,"_pendingPublishedUsers",[]),h(this,"ntpAlignErrorCount",0),h(this,"remoteInboundOffset",0),h(this,"_handleLocalTrackEnable",(n,s,r)=>{this.publish(n,!1).then(s).catch(r)}),h(this,"_handleLocalTrackDisable",(n,s,r)=>{this.unpublish(n).then(s).catch(r)}),h(this,"_handleUserOnline",n=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(n.uid,this.channelName))return void E.debug("[".concat(n.uid,"] will be ignored in local"));this.isStringUID&&typeof n.uid!="string"&&E.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find(r=>r.uid===n.uid);if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(_t.USER_JOINED,s));else{const r=new Le(n.uid,n.uint_id||n.uid);this._users.push(r),E.debug("[".concat(this._clientId,"] user online"),n.uid),this.safeEmit(_t.USER_JOINED,r)}}),h(this,"_handleUserOffline",n=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(n.uid,this.channelName))return;const s=this._users.find(r=>r.uid===n.uid);s&&(this._handleRemoveStream(n),this._handleRemoveDataChannels(n),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:Jc(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),E.debug("[".concat(this._clientId,"] user offline"),n.uid,"reason:",n.reason),this.safeEmit(_t.USER_LEAVED,s,n.reason))}),h(this,"_handleAddAudioOrVideoStream",(n,s,r,o,a,c,d)=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(s,this.channelName))return;const l=this._users.find(p=>p.uid===s);if(!l)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));E.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(n)),this.store.subscribe(l.uid,n,void 0,void 0,void 0,Date.now());const u=n==="audio"?l.hasAudio:l.hasVideo;l._uintid||(l._uintid=a||s),n==="audio"?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,n==="audio"?(l._audio_added_=!0,r!==void 0&&(l._audioSSRC=r),o!==void 0&&(l._cname=o),c&&(l._audioOrtc=c)):(l._video_added_=!0,r!==void 0&&(l._videoSSRC=r),o!==void 0&&(l._cname=o),d!==void 0&&(l._rtxSsrcId=d),c&&(l._videoOrtc=c)),(n==="audio"?l.hasAudio:l.hasVideo)&&!u&&(E.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(n)),this.safeEmit(_t.USER_PUBLISHED,l,n)),n==="video"?z.onGatewayStream(this._sessionId,me.ON_ADD_VIDEO_STREAM,Ft.ON_ADD_VIDEO_STREAM,{peer:a||s,ssrc:l._videoSSRC}):z.onGatewayStream(this._sessionId,me.ON_ADD_AUDIO_STREAM,Ft.ON_ADD_AUDIO_STREAM,{peer:a||s,ssrc:l._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(l,n,r).then(p=>{if(p&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(l.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ne))return this._p2pChannel.unsubscribe(l,n,!0).then(()=>this._subscribe(l,n,!0).catch(_=>{E.error("[".concat(this._clientId,"] resubscribe error"),_.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(l,n)&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,n,!0).catch(p=>{E.error("[".concat(this._clientId,"] resubscribe error"),p.toString())}))}),h(this,"_handleRemoveStream",n=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(n.uid,this.channelName))return;const s=this._users.find(o=>o.uid===n.uid);if(!s)return void E.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));E.debug("[".concat(this._clientId,"] stream removed with uid ").concat(n.uid));let r=()=>{};s.hasAudio&&s.hasVideo?r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(_t.USER_UNPUBLISHED,s,"audio"),E.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(_t.USER_UNPUBLISHED,s,"video")}:s.hasVideo?r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(_t.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(r=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(_t.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof Ne&&this._p2pChannel.unsubscribe(s).then(o=>{if(o)return this._gateway.unsubscribe(o,s.uid)}),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),z.onGatewayStream(this._sessionId,me.ON_REMOVE_STREAM,Ft.ON_REMOVE_STREAM,{peer:n.uint_id||n.uid}),r()}),h(this,"_handleSetStreamLocalEnable",(n,s,r)=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(s,this.channelName))return;const o=this._users.find(d=>d.uid===s);if(!o)return void E.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));E.debug("[".concat(this._clientId,"] local ").concat(n," ").concat(r?"enabled":"disabled"," with uid ").concat(s));const a=n==="audio"?o.hasAudio:o.hasVideo;if(n==="audio"){o._trust_audio_enabled_state_=!0;const d=o._audio_enabled_;if(o._audio_enabled_=r,o._audio_enabled_===d)return;{const l=o._audio_enabled_?"enable-local-audio":"disable-local-audio";E.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(l)),this.safeEmit(_t.USER_INFO_UPDATED,s,l)}}else{o._trust_video_enabled_state_=!0;const d=o._video_enabled_;if(o._video_enabled_=r,o._video_enabled_===d)return;{const l=o._video_enabled_?"enable-local-video":"disable-local-video";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(l)),this.safeEmit(_t.USER_INFO_UPDATED,s,l)}}const c=n==="audio"?o.hasAudio:o.hasVideo;return a!==c?!a&&c?(E.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(n)),void this.safeEmit(_t.USER_PUBLISHED,o,n)):(n==="video"&&o._videoTrack&&o._videoTrack._destroy(),n==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,n),E.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(n)),void this.safeEmit(_t.USER_UNPUBLISHED,o,n)):void 0}),h(this,"_handleMuteStream",(n,s,r)=>{if(v("BLOCK_LOCAL_CLIENT")&&gr(n,this.channelName))return;E.debug("[".concat(this._clientId,"] receive mute message"),n,s,r);const o=this._users.find(d=>d.uid===n);if(!o)return void E.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(n));const a=s==="audio"?o.hasAudio:o.hasVideo;if(s==="audio"){o._trust_audio_mute_state_=!0;const d=o._audio_muted_;if(o._audio_muted_=r,o._audio_muted_===d)return;{const l=o._audio_muted_?"mute-audio":"unmute-audio";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(l)),this.safeEmit(_t.USER_INFO_UPDATED,n,l)}}else{o._trust_video_mute_state_=!0;const d=o._video_muted_;if(o._video_muted_=r,o._video_muted_===d)return;{const l=o._video_muted_?"mute-video":"unmute-video";E.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(l)),this.safeEmit(_t.USER_INFO_UPDATED,n,l)}}const c=s==="audio"?o.hasAudio:o.hasVideo;if(a!==c){if(!a&&c)return(s==="audio"?o._audioSSRC:o._videoSSRC)?(E.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(s)),void this.safeEmit(_t.USER_PUBLISHED,o,s)):void E.warning("[".concat(this._clientId,"] remote user ").concat(n," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),s==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,s),E.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(s)),this.safeEmit(_t.USER_UNPUBLISHED,o,s)}}),h(this,"_handleP2PLost",async n=>{E.debug("[".concat(this._clientId,"] receive p2p lost"),n),parseInt(n.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():E.warning("[".concat(this._clientId,"] P2PLost stream not found"),n)}),h(this,"_handleTokenWillExpire",()=>{E.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(_t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),h(this,"_handleBeforeUnload",n=>{n.type==="beforeunload"&&n.returnValue!==void 0&&n.returnValue!==""||(this.leave(),E.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),h(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(_t.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const n={downlinkNetworkQuality:0,uplinkNetworkQuality:0};n.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),n.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(_t.NETWORK_QUALITY,n)}),h(this,"_handleP2PAddAudioOrVideoStream",(n,s,r,o)=>{const a=this._users.find(d=>d.uid===s);if(!a)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));E.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(n)),this.store.subscribe(a.uid,n,void 0,void 0,void 0,Date.now());const c=n==="audio"?a.hasAudio:a.hasVideo;n==="audio"?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,n==="audio"?(a._audio_added_=!0,r!==void 0&&(a._audioSSRC=r),o!==void 0&&(a._audioMid=o)):(a._video_added_=!0,r!==void 0&&(a._videoSSRC=r),o!==void 0&&(a._videoMid=o)),(n==="audio"?a.hasAudio:a.hasVideo)&&!c&&(E.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(n)),this.safeEmit(_t.USER_PUBLISHED,a,n)),this._p2pChannel.hasPendingRemoteMedia(a,n)&&(E.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,n,!0).catch(d=>{E.error("[".concat(this._clientId,"] resubscribe error"),d.toString())}))}),this._config=t,this._clientId=Pt(5,"client-"),this.store=new XL(t.codec,t.audioCodec,t.mode,this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),E.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Ji," build: ").concat(Lh,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{TT(t.clientRoleOptions),e=Object.assign({},t.clientRoleOptions)}catch(n){E.warning("[".concat(this._clientId,"] ").concat(n.toString()))}this._statsCollector=new Ha(this.store),this._statsCollector.onStatsException=(n,s,r)=>{E.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(n,", msg: ").concat(s,", uid: ").concat(r)),this.safeEmit(_t.EXCEPTION,{code:n,msg:s,uid:r})},this._statsCollector.onUploadPublishDuration=(n,s,r,o)=>{const a=this._users.find(c=>c.uid===n);a&&z.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:s,videoPublishDuration:r,peer:a._uintid})},this.store.useDataChannel=Ot().supportDataChannel&&v("SIGNAL_CHANNEL"),this.store.useP2P=t.mode==="p2p",this._gateway=new Pk(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||ae,httpRetryConfig:t.httpRetryConfig||ae,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:e}),this._configDistribute=new jk,this.store.useP2P?(this._p2pChannel=new Te(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Ne(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,n,s,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],a=arguments.length>6&&arguments[6]!==void 0&&arguments[6];wt("JOIN_GATEWAY_USE_443PORT_ONLY",o),wt("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const c=this._gateway.signal.websocket;return c instanceof ga&&(c.use443PortOnly=o,c.tryDoubleDomain=a),async function(d,l,u){Gc.get(d)||Gc.set(d,[]),Wc.get(d)||Wc.set(d,l),Ln.get(d)||Ln.set(d,0);const p=Gc.get(d),_=Wc.get(d);if(!p||!_)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Ln.get(d)===_){const y=da();p.push(y),await y.promise}Ln.set(d,Ln.get(d)+1);for(var S=arguments.length,f=new Array(S>3?S-3:0),g=3;g<S;g++)f[g-3]=arguments[g];const C=await u(...f);return Ln.set(d,Ln.get(d)-1),Ln.get(d)===_-1&&p.length>0&&(p[0].resolve(),p.shift()),Ln.get(d)===0&&(Gc.set(d,[]),Wc.set(d,0),Ln.set(d,0)),C}("client.join",v("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,s,r)}async join(t,e,n,s,r){const o=++this._numberOfJoinCount;this.store.joinStart(),s&&(this.store.uid=s);const a=zL(),c=IS()?window.isSecureContext:"Browser Not Support";(!IS()&&!a||!window.isSecureContext)&&E.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");const d=lh();this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),E.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const l=z.reportApiInvoke(d,{name:le.JOIN,options:[t,e,n,s],states:{isHttps:a,isSecureContext:c},tag:Yt.TRACER});z.setAppId(t);try{if(!n&&n!==null)throw new w(R.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Me(n,"token",1,2047),Me(t,"appid",1,2047),xh(e),s&&Vh(s),r&&Me(r,"optionalInfo",1,2047)}catch(f){throw l.onError(f),f}if(E.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._leaveMutex.isLocked&&(E.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),E.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const f=new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw l.onError(f),f}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const u=hs(hs({},this._rtmConfig),{},{clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof s!="string"?s:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof s=="string"&&(u.stringUid=s,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await sL(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:e,appId:t,stringUid:u.stringUid});const p=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&p===this._sessionId&&z.joinChannelTimeout(this._sessionId,5)},5e3);try{var _;let f;const g=u.cloudProxyServer;if(q(_=["proxy3","proxy4","proxy5"]).call(_,g)){const O=v("PROXY_SERVER_TYPE3");Array.isArray(O)?u.proxyServer=O[0]:u.proxyServer=O}if(z.setProxyServer(u.proxyServer),E.setProxyServer(u.proxyServer),this.store.requestAPStart(),u.stringUid&&!u.uid){let O;[O,f]=await P.all([_R(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||ae,this.store),pR(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ae,!0,this.store)]),E.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(O)),u.uid=O,f.gatewayInfo.uid=O,f.gatewayInfo.res.uid=O}else f=await pR(u,this._axiosCancelSource.token,this._config.httpRetryConfig||ae,!0,this.store);if(!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(fa.UPDATE_BITRATE_LIMIT,O=>{this._p2pChannel.updateBitrateLimit(O)})},0),this._key=n||t;const C=f.gatewayInfo,y=u.uid?u.uid:C.uid;this._joinInfo=hs(hs({},u),{},{cid:C.cid,uid:y,vid:C.vid,apResponse:C.res,uni_lbs_ip:C.uni_lbs_ip,gatewayAddrs:C.gatewayAddrs}),this.store.intUid=y;const A=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(A),this._appId=t,this._channelName=u.cname,this._uid=A,this.store.uid=A,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Xe()?"beforeunload":"pagehide",this._handleBeforeUnload)},0);const k=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return E.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(k)),setTimeout(()=>{E.startUpload()},5e3),this.store.joinEnd(),S=this,q(Os).call(Os,S)||Os.push(S),A}catch(f){const g=Array.isArray(f)?f[0]:f;throw g&&g.code===R.OPERATION_ABORTED?E.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),g):E.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),g),g.code!==R.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(g),g}var S}_joinGateway(){if(!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!v("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(t=>t).catch(t=>{if(t.code===R.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,pt.FALLBACK),t;if(t.code===R.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,pt.FALLBACK),t;throw t}).then(t=>{if(t instanceof w){if(t.code===R.INIT_WEBSOCKET_TIMEOUT){if(E.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=v("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const s=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),r=s.slice(s.length-2).join(".");e.forEach(o=>{this._joinInfo&&q(o).call(o,r)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const n=v("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return n&&n[1]&&n[1]!=="443"&&E.setProxyServer(this._joinInfo.proxyServer),v("STATS_COLLECTOR_PORT").toString()!=="443"&&z.setProxyServer(this._joinInfo.proxyServer),z.reportApiInvoke(this._sessionId,{name:le.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:Yt.TRACER}).onSuccess(),this.safeEmit(_t.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),v("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(s=>{"forceturn"in s&&(s.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(E.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new w(R.INVALID_OPERATION);return z.reportApiInvoke(this._sessionId,{name:le.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Yt.TRACER}).onSuccess(),this._joinGateway()}return t}).then(t=>t)}async leave(){E.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Xe()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const n=Os.indexOf(e);n!==-1&&Os.splice(n,1)}(this);const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return E.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED"),E.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof xe))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new w(R.INVALID_PARAMS,"param list is empty");const n=t;if(this._gateway.role==="audience")throw new w(R.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof xe))throw new w(R.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new w(R.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}E.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach(r=>{const o=this._configDistribute.getBitrateLimit();r instanceof dt&&o&&r.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),E.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw E.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{s()}}async _publishDataChannel(t){bt(t.id,"id",0,65535,!0),ys(t.ordered,"ordered"),Me(t.metadata,"metadata",0,512),E.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(s=>s.id===t.id)!==-1)throw new w(R.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&v("FORCE_TURN")&&!v("TURN_ENABLE_TCP")&&!v("TURN_ENABLE_UDP"))throw new w(R.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=new jC(t);await this._p2pChannel.publishDataChannel([n]);try{const s={streamId:t.id,ordered:t.ordered,maxRetransmits:v("DATASTREAM_MAX_RETRANSMITS"),metadata:t.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,s,!0)}catch(s){if(s.code!==R.DISCONNECT_P2P)throw s}return await n._waitTillOpen(),E.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw E.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof xe))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);E.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(s=>"".concat(s.getTrackId()," "))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Te){const s=await this._p2pChannel.unpublish(e);s&&await this._gateway.sendExtensionMessage(Jt.UNPUBLISH,{unpubMsg:s},!0)}else{const s=await this._p2pChannel.unpublish(e);s&&await this._gateway.unpublish(s,this._uid),E.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(s){throw E.error("[".concat(this._clientId,"] unpublish error"),s.toString()),s}finally{n&&n()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),E.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(n=>"".concat(n.id," "))," "));const e=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),E.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(s=>"".concat(s.id))))}catch(n){throw E.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e()}}async subscribe(t,e,n){return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(Ee(e,"mediaType",["audio","video"]),this._p2pChannel instanceof Te)throw new w(R.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=e===J.AUDIO,s=e===J.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:a,rtxSsrcId:c,cname:d,uint_id:l}=await this._gateway.presubscribe(t,e,!0);if(o==null)throw new w(R.UNEXPECTED_RESPONSE,"no ssrc id");let u=this._users.find(_=>_.uid===t);u||(u=new Le(t,l||t),u._is_pre_created=!0,this._users.push(u)),d&&(u._cname=d),u._uintid||(u._uintid=l||t),n&&(u._audioSSRC=o,u._audio_pre_subscribed=!0,a&&(u._audioOrtc=a)),s&&(u._videoSSRC=o,u._video_pre_subscribed=!0,a&&(u._videoOrtc=a),c!=null&&(u._rtxSsrcId=c)),E.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(u,e,o,c,a);const p=n?u._audioTrack:u._videoTrack;if(!p)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0),s&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0),p}catch(o){throw E.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{r()}}async _subscribeDataChannel(t,e){var n;if(bt(e,"channelId",0,65535,!0),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new w(R.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new w(R.INVALID_REMOTE_USER,"user is not published");const s=(n=t._dataChannels)===null||n===void 0?void 0:n.find(a=>a.id===e);if(!s)throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new w(R.REMOTE_USER_IS_NOT_PUBLISHED);const r=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(t,[s]);if(a&&q(a).call(a,s.id))try{var o;if(!s._originDataChannelId)throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new w(R.REMOTE_USER_IS_NOT_PUBLISHED);const c={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:(o=s.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(t.uid,c,!0)}catch(c){if((c==null?void 0:c.code)!==R.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[s]),c;await this._p2pChannel.unsubscribeDataChannel(t,[s]),this._p2pChannel.setPendingRemoteDataChannel(t,s.id)}return await s._waitTillOpen(),E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),s}finally{r()}}async _p2pSubscribe(t,e,n){if(Ee(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(r=>r===t)){const r=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),r}if(!t.hasAudio&&!t.hasVideo){const r=new w(R.INVALID_REMOTE_USER,"user is not published");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),r}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const r=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),r}const s=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const o=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this._p2pChannel instanceof Te&&await this._p2pChannel.subscribe(t,e,o,a)}catch(o){throw o}E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(o=>{E.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});const r=e==="audio"?t._audioTrack:t._videoTrack;if(!r)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user object");return r}catch(r){throw E.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),r),r}finally{s()}}async _subscribe(t,e,n){if(this._p2pChannel instanceof Te)return this._p2pSubscribe(t,e);if(Ee(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){const d=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){const d=new w(R.INVALID_REMOTE_USER,"user is not published");throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const d=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let s=e==="audio"?t._audioSSRC:t._videoSSRC,r=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?J.AUDIO:J.VIDEO,ssrcId:s};const c=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==s&&(s=l,r=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?J.AUDIO:J.VIDEO,ssrcId:s}),Ve.markSubscribeStart(this.store.clientId,s),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,s,o,r);try{await this._gateway.subscribe(t.uid,a,!0)}catch(u){if((u==null?void 0:u.code)!==R.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),u;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l==null?void 0:l.code,t,e),l}E.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(l=>{E.warning("[".concat(this._clientId,"] auto set fallback failed"),l)});const d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new w(R.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw E.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if($n(t,"subscribeList"),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),n=new Map,s=await this._subscribeMutex.lock();E.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(c=>{let{user:d,mediaType:l}=c;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(l)}).join("; ")));const r=(t=[...t]).map(c=>{let{user:d,mediaType:l}=c;return{user:d,mediaType:l}}),o=await this._p2pChannel.globalLock();try{var a;for(let d=t.length-1;d>=0;d--){const l=t[d],{user:u,mediaType:p}=l;if(Ee(p,"mediaType",["audio","video"]),!u){const f=new w(R.INVALID_PARAMS,"user property does not exist in subscribeList item");throw E.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),f}if(!this._users.find(f=>f===u)){const f=new w(R.INVALID_REMOTE_USER,"user is not in the channel");E.error("[".concat(this._clientId,"] can not massSubscribe ").concat(u.uid,", this user is not in the channel")),r[d].error=f,t.splice(d,1);continue}if(p==="audio"&&(!u.hasAudio||u._audioSSRC===void 0)||p==="video"&&(!u.hasVideo||u._videoSSRC===void 0)){const f=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);E.error("[".concat(this._clientId,"] can not subscribe ").concat(u.uid," with mediaType ").concat(p,", remote user is not published")),r[d].error=f,t.splice(d,1);continue}const _=ue.Video|ue.LwoVideo,S=n.get(u);if(S){if(p==="video"?S&_:S&ue.Audio){t.splice(d,1),E.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(u.uid,", mediaType:").concat(p," twice"));continue}n.set(u,S|(p==="video"?_:ue.Audio))}else n.set(u,p==="video"?_:ue.Audio)}for(let d=t.length-1;d>=0;d--){const l=t[d],{user:u,mediaType:p}=l,_=ue.Video|ue.LwoVideo;if(this._p2pChannel.hasRemoteMedia(u,p)){await this._p2pChannel.unmuteRemoteNoLock(u,p);const S=n.get(u);n.set(u,p==="video"?S^_:S^ue.Audio),t.splice(d,1)}}this.store.massSubscribe(t.map(d=>({userId:d.user.uid,type:d.mediaType})),e);const c=mr(a=Array.from(n.entries())).call(a,(d,l)=>{let[u,p]=l;if(p===0)return d;const _={stream_id:u.uid,stream_type:p};return p&ue.Audio&&(_.audio_ssrc=u._audioSSRC),p&ue.Video&&(_.video_ssrc=u._videoSSRC),d.push(_),d},[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map(l=>{let{user:u,mediaType:p}=l;return{user:u,mediaType:p,ssrcId:p===J.VIDEO?u._videoSSRC:u._audioSSRC,rtxSsrcId:p===J.VIDEO?u._rtxSsrcId:void 0}}));const d=new Map;if(c.length>0){const l=await this._gateway.subscribeAll(c,!0);((l==null?void 0:l.users)||[]).forEach(u=>{let{stream_id:p,video_error_code:_,audio_error_code:S,error_code:f}=u;(_||S||f)&&d.set(p,{video_error_code:_,audio_error_code:S,error_code:f})})}if(Array.from(d.entries()).length>0){const l=Array.from(d.entries()).map(u=>{let p,[_,S]=u;return S.error_code||S.video_error_code&&S.audio_error_code?p=void 0:S.video_error_code?p=J.VIDEO:S.audio_error_code&&(p=J.AUDIO),{user:this.remoteUsers.find(f=>f.uid===_),mediaType:p}});await this._p2pChannel.massUnsubscribeNoLock(l)}for(const l of r){const u=d.get(l.user.uid);if(u){const p=u.error_code||l.mediaType==="audio"&&u.audio_error_code||l.mediaType==="video"&&u.video_error_code;if(p){const _=Sr(p);E.error("user:".concat(l.user.uid," mediaType:").concat(l.mediaType," has massSubscribe error ").concat(_.desc)),l.error=new w(R.SUBSCRIBE_FAILED,"code ".concat(p,": ").concat(_.desc))}}l.error||(l.mediaType==="video"?l.track=l.user.videoTrack:l.track=l.user.audioTrack)}return this.store.massSubscribe(r.filter(l=>!l.error).map(l=>({userId:l.user.uid,type:l.mediaType})),void 0,Date.now()),r.forEach(l=>{var u;z.subscribe(this.store.sessionId,{succ:!!l.error,ec:((u=l.error)===null||u===void 0?void 0:u.code)||null,video:l.mediaType===J.VIDEO,audio:l.mediaType===J.AUDIO,peerid:l.user.uid,subscribeRequestid:l.mediaType===J.VIDEO?l.user._videoSSRC:l.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e)},!0)}),E.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(l=>{let{user:u,mediaType:p}=l;return"user: ".concat(u==null?void 0:u.uid,", mediaType: ").concat(p)}).join("; "))),r}catch(d){throw await this._p2pChannel.massUnsubscribeNoLock(t),d}}finally{o(),s()}}async unsubscribe(t,e,n){if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&Ee(e,"mediaType",["audio","video"]),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(r=>r===t)){const r=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}E.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const s=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Te)await this._p2pChannel.unsubscribe(t,e);else{const r=await this._p2pChannel.unsubscribe(t,e);r&&await this._gateway.unsubscribe(r,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&Jc(this._users,t),E.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(r){if(r.code===R.DISCONNECT_P2P)return void E.warning("disconnecting p2p, abort unsubscribe request.");throw E.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}finally{s()}}async _unsubscribeDataChannel(t,e){if(e&&bt(e,"id",0,65535,!0),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(s=>s===t)){const s=new w(R.INVALID_REMOTE_USER,"user is not in the channel");throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),s}let n;if(typeof e=="number"){const s=t._dataChannels.find(r=>r.id===e);s&&(n=[s])}else n=t._dataChannels;if(n===void 0){const s=new w(R.REMOTE_USER_IS_NOT_PUBLISHED);throw E.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),s}E.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(n.map(s=>s.id)));try{const s=await this._p2pChannel.unsubscribeDataChannel(t,n);s&&await this._gateway.unsubscribeDataChannel(s,t.uid),E.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(s))}catch(s){if(s.code===R.DISCONNECT_P2P)return void E.warning("disconnecting p2p, abort unsubscribe request.");throw E.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),s.toString()),s}}async massUnsubscribe(t){if($n(t,"unsubscribeList"),!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");E.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(n=>{let{user:s,mediaType:r}=n;return"user: ".concat(s==null?void 0:s.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];const e=new Map;for(let n=t.length-1;n>=0;n--){const{user:s,mediaType:r}=t[n];if(!s){const a=new w(R.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw E.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(Ee(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===s)){E.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),t.splice(n,1);continue}const o=ue.Video|ue.LwoVideo;if(e.has(s)){const a=e.get(s);let c;switch(r){case"video":c=a&o;break;case"audio":c=a&ue.Audio;break;default:c=a&(ue.Audio|o)}if(c){E.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(r," twice.")),t.splice(n,1);continue}r?r==="audio"?e.set(s,a|ue.Audio):r==="video"&&e.set(s,a|o):e.set(s,a|ue.Audio|o)}else r?r==="audio"?e.set(s,ue.Audio):r==="video"&&e.set(s,o):e.set(s,ue.Audio|o)}try{const n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),E.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(s=>{let{user:r,mediaType:o}=s;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===R.DISCONNECT_P2P)return void E.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw E.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){(function(n){if(!n)throw new M(R.INVALID_PARAMS);Kt(n.width)||oh(n.width,"streamParameter.width"),Kt(n.height)||oh(n.height,"streamParameter.height"),Kt(n.framerate)||oh(n.framerate,"streamParameter.framerate"),Kt(n.bitrate)||bt(n.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&E.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),E.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,V.LocalVideoLowTrack)}async enableDualStream(){if(!Ot().supportDualStream)throw z.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new w(R.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new w(R.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw z.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,z.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),E.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(V.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw z.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,z.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),E.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if(function(n){Ee(n,"role",["audience","host"])}(t),e&&TT(e),this.mode==="rtc"||this.mode==="p2p")throw E.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new w(R.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new w(R.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new w(R.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(t,e),this._config.role=t,E.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(Me(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,z.setProxyServer(this._proxyServer),E.setProxyServer(this._proxyServer),E.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy")}if(ro(t))return this._turnServer={servers:t,mode:"original-manual"},void E.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>gT(n)),this._turnServer={servers:t,mode:"manual"},E.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"you should set license before join channel");if(Me(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new w(R.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,E.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new w(R.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new w(R.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new w(R.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,E.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new w(R.INVALID_OPERATION,"Stop proxy server after leave channel");z.setProxyServer(),E.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",E.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new w(R.INVALID_PARAMS,"accessPoints is required.");$n(t.accessPoints.serverList,"accessPoints.serverList"),Me(t.accessPoints.domain,"accessPoints.domain");const e=(_,S)=>{bt(_,S,0,65535,!0)};let n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new w(R.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");v("CLOSE_AFB_FOR_LOCAL_AP")&&(wt("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),wt("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(_=>s.test(_)?"".concat(_.replace(/\./g,"-"),".").concat(r):_),a=o.map(_=>"".concat(_,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,wt("WEBCS_DOMAIN",a),wt("WEBCS_DOMAIN_BACKUP_LIST",a),wt("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?($n(t.report.hostname,"report.hostname"),wt("EVENT_REPORT_DOMAIN",t.report.hostname[0]),wt("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(wt("EVENT_REPORT_DOMAIN",o[0]),wt("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let c=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),c=t.report.port),wt("STATS_COLLECTOR_PORT",c),t.report?wt("ENABLE_EVENT_REPORT",!0):wt("ENABLE_EVENT_REPORT",!1);let d="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?($n(t.log.hostname,"log.hostname"),d=t.log.hostname[0]):d=o[0];let l=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),l=t.log.port),wt("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let u=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?($n(t.cds.hostname,"cds.hostname"),u=t.cds.hostname):u=o;let p=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),p=t.cds.port),wt("CDS_AP",u.map(_=>"".concat(_,":").concat(p))),t.cds?wt("ENABLE_CONFIG_DISTRIBUTE",!0):wt("ENABLE_CONFIG_DISTRIBUTE",!1),E.info("set local access point v2 success")}setLocalAccessPoints(t,e){if($n(t,"serverList"),Me(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new w(R.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(s=>n.test(s)?"".concat(s.replace(/\./g,"-"),".").concat(e):s),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,wt("WEBCS_DOMAIN",t),wt("WEBCS_DOMAIN_BACKUP_LIST",t),wt("GATEWAY_DOMAINS",[e]),wt("EVENT_REPORT_DOMAIN",t[0]),wt("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),wt("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),E.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(Ee(t,"streamType",[0,1]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw E.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else E.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){Ee(e,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const n=this._users.find(s=>s.uid===t);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw E.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}E.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){Ee(e,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(n){throw E.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}E.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,n){(function(r){Ee(r,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Me(e,"secret");const s=["aes-128-gcm2","aes-256-gcm2"];if(q(s).call(s,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new w(R.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new w(R.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||E.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=ao(n))}async renewToken(t){if(Me(t,"token",1,2047),!this._key||!this._joinInfo)throw new w(R.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const n=await this._renewTokenMutex.lock();try{if(v("USE_NEW_TOKEN")){E.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const s=await Bk(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ae);E.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:s})}else E.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});E.debug("[".concat(this._clientId,"] renewToken success"))}catch(s){throw this._key=e,this._joinInfo.token=e,E.error("[".concat(this._clientId,"] renewToken failed"),s.toString()),s}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?E.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(_t.VOLUME_INDICATOR,t)},v("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new w(R.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new w(R.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new w(R.LIVE_STREAMING_TASK_CONFLICT);const n=e?fe.TRANSCODE:fe.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient(fe.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(t));if(!e.length)throw new w(R.INVALID_PARAMS,"can not find live streaming url to stop");await P.all(e.map(n=>n&&n.stopLiveStreamingTask(t)))}async addInjectStreamUrl(t,e){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const n=this._createLiveStreamingClient(fe.INJECT);n.setInjectStreamConfig(e,0),await n.startLiveStreamingTask(t,fe.INJECT)}async removeInjectStreamUrl(){var t;const e=this._createLiveStreamingClient(fe.INJECT),n=Array.from(In(t=e.streamingTasks).call(t)).find(s=>s.mode===fe.INJECT);if(!this._joinInfo||!n)throw new w(R.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(n.url)}async startChannelMediaRelay(t){gI(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){gI(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const n=new TextEncoder;t.payload=n.encode(t.payload)}if(new Blob([t.payload]).size>1024)throw new w(R.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(Q.DATA_STREAM,{payload:ao(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-Z1},!e)}sendMetadata(t){if(!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new w(R.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Q.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:ao(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(ZL),!this._joinInfo)throw new w(R.INVALID_OPERATION,"can not send custom report, not joined");await z.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(t,e){Ee(e.spatialLayer,"spatialLayer",[0,1,2,3]),Ee(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(n){throw E.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:n}=t;if(ys(e,"apRTM"),bt(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,E.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(E.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=hi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Ae("client-publish"),this._subscribeMutex=new Ae("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;const s=t||lh();t?E.debug("[".concat(this._clientId,"] new Session ").concat(s)):E.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(s));const r=t?"":this._sessionId||"";this._sessionId=s,this.store.sessionId=s;const o={lts:new Date().getTime(),mode:this.mode,stringUid:(e==null?void 0:e.stringUid)||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};e?z.sessionInit(this._sessionId,hs({cname:e.channel,appid:e.appId},o)):this._joinInfo?z.sessionInit(this._sessionId,hs({cname:this._joinInfo.cname,appid:this._joinInfo.appId},o)):this._gateway.joinInfo&&z.sessionInit(this._sessionId,hs({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=s),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=s)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&v("FORCE_TURN")&&!v("TURN_ENABLE_TCP")&&!v("TURN_ENABLE_UDP"))throw new w(R.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");E.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Te){const s=(await n.next()).value;if(s){try{await this._gateway.sendExtensionMessage(Jt.PUBLISH,s,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const s=(await n.next()).value;if(s){var e;let r;try{r=await this._gateway.publish(this._uid,s,!0)}catch(o){if(o.code!==R.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of t)r instanceof dt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,t),(n==null?void 0:n.code)===R.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new w(R.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new w(R.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));E.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),s=(await n.next()).value;if(s){var e;let r;try{r=await this._gateway.publish(this._uid,s,!0)}catch(o){if(o.code!==R.DISCONNECT_P2P)throw n.throw(o),o}n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,void 0,!0),(n==null?void 0:n.code)===R.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){if(!this._joinInfo||!this._appId)return new w(R.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const e=()=>new O1(this._joinInfo,this._config.websocketRetryConfig||ae,this._config.httpRetryConfig||ae),n=s=>{s.onLiveStreamError=(r,o)=>{z.reportApiInvoke(this._sessionId,{name:le.ON_LIVE_STREAM_ERROR,options:[r,o],tag:Yt.TRACER}).onSuccess(),this.safeEmit(_t.LIVE_STREAMING_ERROR,r,o)},s.onLiveStreamWarning=(r,o)=>{z.reportApiInvoke(this._sessionId,{name:le.ON_LIVE_STREAM_WARNING,options:[r,o],tag:Yt.TRACER}).onSuccess(),this.safeEmit(_t.LIVE_STREAMING_WARNING,r,o)},s.on(Eo.REQUEST_WORKER_MANAGER_LIST,(r,o,a)=>{if(!this._joinInfo)return a(new w(R.INVALID_OPERATION,"can not find join info to get worker manager"));mR(r,this._joinInfo,this._axiosCancelSource.token,ae).then(o).catch(a)})};switch(t){case fe.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=e(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case fe.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=e(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case fe.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=e(),this._injectStreamingClient.on(Eo.REQUEST_WORKER_MANAGER_LIST,(s,r,o)=>{if(!this._joinInfo)return o(new w(R.INVALID_OPERATION,"can not find join info to get worker manager"));mR(s,this._joinInfo,this._axiosCancelSource.token,ae).then(r).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(s,r,o)=>{this.safeEmit(_t.INJECT_STREAM_STATUS,s,r,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new w(R.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:e}=this.getLocalVideoStats(),n={width:t,height:e};this._channelMediaRelayClient=new D1(this._joinInfo,this._clientId,this._config.websocketRetryConfig||ae,this._config.httpRetryConfig||ae,n),this._channelMediaRelayClient.on("state",s=>{s===si.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(_t.CHANNEL_MEDIA_RELAY_STATE,s)}),this._channelMediaRelayClient.on("event",s=>{this.safeEmit(_t.CHANNEL_MEDIA_RELAY_EVENT,s)}),this._statsCollector.onStatsChanged=(s,r)=>{var o;s==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(r))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:n,deleted:s}=t,r=[];Array.isArray(n)&&n.length>0&&n.forEach(o=>{const{uid:a,stream_id:c,ordered:d,max_retrans_times:l,metadata:u}=o,p=this._users.find(_=>_._uintid===a);if(!p)return void E.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(E.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(a)),q(r).call(r,p)||r.push(p),p._uintid||(p._uintid=a),p._dataChannels.findIndex(_=>_.id===o.stream_id)===-1){const _={id:c,ordered:!!d,maxRetransmits:l,metadata:u},S=new a1(_);p._dataChannels.push(S),E.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published datachannel")),e||this.safeEmit(_t.USER_PUBLISHED,p,"datachannel",_)}this._p2pChannel.hasPendingRemoteDataChannel(p,o.stream_id)&&(E.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(p.uid," after reconnect.")),this._subscribeDataChannel(p,o.stream_id).catch(_=>{E.error("[".concat(this._clientId,"] resubscribe datachannel error"),_.toString())}))}),e&&(this.safeEmit(_t.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach(o=>{const{uid:a,stream_id:c}=o,d=this._users.find(u=>u._uintid===a);if(!d)return void E.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const l=d._dataChannels.find(u=>u.id===o.stream_id);l&&(E.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(a)),this._p2pChannel.unsubscribeDataChannel(d,[l]).then(u=>{if(d._dataChannels=d._dataChannels.filter(p=>p!==l),u)return this._gateway.unsubscribeDataChannel(u,d.uid)}),E.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished datachannel ,id:").concat(l.id)),this.safeEmit(_t.USER_UNPUBLISHED,d,"datachannel",l._config))})}_handleRemoveDataChannels(t){const e=this._users.find(n=>n.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){E.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{E.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(s=>{this.safeEmit(_t.USER_UNPUBLISHED,e,"datachannel",s._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(s=>{if(s)return this._gateway.unsubscribeDataChannel(s,e.uid)}),n()}}else E.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(qt.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(qt.CONNECTION_STATE_CHANGE,(t,e,n)=>{var s;if(n===pt.FALLBACK)return;const r=()=>{this.safeEmit(_t.CONNECTION_STATE_CHANGE,t,e,n)};if(z.reportApiInvoke(this._sessionId||((s=this._gateway.joinInfo)===null||s===void 0?void 0:s.sid)||null,{name:le.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:Yt.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),E.info("[".concat(this._clientId,"] connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((a,c)=>{this._gateway.setStreamFallbackOption(c,a).catch(d=>{E.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),d)})}),this._remoteStreamTypeCacheMap.forEach((a,c)=>{this._gateway.setRemoteVideoStreamType(c,a).catch(d=>{E.warning("[".concat(this._clientId,"] auto set remote stream type failed"),d)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{E.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{E.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{E.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(E.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,J.AUDIO,!1)),a._trust_video_mute_state_||(E.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,J.VIDEO,!1)),a._trust_audio_enabled_state_||(E.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(E.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(E.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(E.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(E.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}r()}),this._gateway.on(qt.REQUEST_NEW_GATEWAY_LIST,(t,e)=>{if(!this._joinInfo)return e(new w(R.UNEXPECTED_ERROR,"can not recover, no join info"));ip(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||ae,this.store).then(n=>{this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const s=[];n.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r;const[a,c]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?s.push({proxy:this._joinInfo.proxyServer,host:a,port:c}):s.push({host:a,port:c})}),t(s)}).catch(e)}),this._gateway.on(qt.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(_t.NETWORK_QUALITY,t)}),this._gateway.on(qt.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(_t.STREAM_TYPE_CHANGED,t,e),z.reportApiInvoke(this._sessionId,{name:le.STREAM_TYPE_CHANGE,options:[t,e],tag:Yt.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(qt.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(qt.NEED_RENEW_SESSION,()=>{this._startSession()}),this._gateway.on(qt.REQUEST_P2P_CONNECTION_PARAMS,async(t,e,n)=>{try{e(await this._p2pChannel.startP2PConnection(t))}catch(s){n(s)}}),this._gateway.on(qt.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;const{dtlsParameters:n,iceParameters:s,candidates:r,rtpCapabilities:o,setup:a,cname:c}=aI(t.ortc,e);this._p2pChannel.connect(s,n,r,o,a,c)}),this._gateway.on(qt.REQUEST_DC_CONNECTION_PARAMS,t=>{t(this._p2pChannel.getEstablishParams())}),this._gateway.on(qt.RESET_SIGNAL,t=>{this._p2pChannel.resetConnection(t),this._handleGatewaySignalEvents()}),this._gateway.on(qt.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(qt.DATACHANNEL_PRECONNECT,async(t,e,n,s)=>{var r,o,a,c,d,l;await this._p2pChannel.startP2PConnection({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},!0);const u=function(p,_){let S;return _&&_.ip&&typeof _.port=="number"?(S=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:_.ip,port:_.port.toString(),type:"host",extension:{}}],E.debug("Using remote candidate from AP ".concat(_.ip,":").concat(_.port)),_.ip6&&(S.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:_.ip6,port:_.port.toString(),type:"host",extension:{}}),E.debug("Using IPV6 remote candidate from AP ".concat(_.ip6,":").concat(_.port)))):S=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:p.ip,port:p.port.toString(),type:"host",extension:{}}],S}(t,e);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cert),icePwd:"".concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cid,"_").concat((d=this._joinInfo)===null||d===void 0?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(l=v("FINGERPRINT"))!==null&&l!==void 0?l:t.fingerprint}]},u,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(s)})}_handleGatewaySignalEvents(){this._gateway.signal.on(nt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(nt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(nt.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(nt.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(nt.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(nt.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams,deleted:[]},!0)}),this._gateway.signal.on(nt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(nt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(nt.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,J.AUDIO,!0)),this._gateway.signal.on(nt.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,J.AUDIO,!1)),this._gateway.signal.on(nt.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,J.VIDEO,!0)),this._gateway.signal.on(nt.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,J.VIDEO,!1)),this._gateway.signal.on(nt.RECEIVE_METADATA,t=>{const e=Xc(t.metadata);this.safeEmit(_t.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(nt.ON_DATA_STREAM,async t=>{if(!t)return;let e=0;if(t.ordered||t.syncWithAudio){const n=this._p2pChannel.getStats(),s=this.remoteUsers.find(o=>o.uid===t.uid),r=n==null?void 0:n.audioRecv.find(o=>o.ssrc===(s==null?void 0:s._audioSSRC));e=r==null?void 0:r.jitterBufferMs}e==null&&(e=0),tU(t,e,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(nt.ON_CRYPT_ERROR,()=>{pa(()=>{E.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(_t.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(nt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(nt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{E.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,pt.TOKEN_EXPIRE),this.safeEmit(_t.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(nt.ON_STREAM_FALLBACK_UPDATE,t=>{E.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(_t.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(nt.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),E.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(nt.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(nt.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(H.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case Q.PUBLISH:{if(!e)return;const r=e.ortc;if(r){var n,s;const o=r.some(d=>{let{stream_type:l}=d;return l===St.Audio}),a=r.some(d=>{let{stream_type:l}=d;return l!==St.Audio}),c=r.some(d=>{let{stream_type:l}=d;return l===St.Screen||l===St.ScreenLow});e.state==="offer"&&z.publish(this._joinInfo.sid,{eventElapse:Ve.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:R.TIMEOUT,audio:o,video:a,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:o?(n=r.find(d=>{let{stream_type:l}=d;return l===St.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:a?(s=r.find(d=>{let{stream_type:l}=d;return l!==St.Audio}))===null||s===void 0||(s=s.ssrcs[0])===null||s===void 0?void 0:s.ssrcId.toString():void 0})}break}case Q.SUBSCRIBE:e&&z.subscribe(this._joinInfo.sid,{succ:!1,ec:R.TIMEOUT,audio:e.stream_type===J.AUDIO,video:e.stream_type===J.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:Ve.measureFromSubscribeStart(this.store.clientId,e.ssrcId)})}}),this._gateway.signal.on(nt.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(nt.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;v("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(s=>!gr(s.string_id||s.stream_id,this.channelName)));const e=[],n=[];for(const s of t.users){let r=this._users.find(u=>u._uintid===s.stream_id);r?r._trust_in_room_=!0:(r=new Le(s.string_id||s.stream_id,s.stream_id),this._users.push(r),this.getListeners(_t.PUBLISHED_USER_LIST).length===0&&(E.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(_t.USER_JOINED,r)));const o=ue.Audio&s.stream_type,a=(ue.Video|ue.LwoVideo)&s.stream_type,c=(65280&s.stream_type)!=0,d=o&&r.hasAudio,l=a&&r.hasVideo;a&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=s.video_ssrc,r._rtxSsrcId=s.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=s.audio_ssrc),o&&!d&&this.getListeners(_t.PUBLISHED_USER_LIST).length===0&&(E.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(_t.USER_PUBLISHED,r,"audio")),a&&!l&&this.getListeners(_t.PUBLISHED_USER_LIST).length===0&&(E.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(_t.USER_PUBLISHED,r,"video")),(o&&!d||a&&!l||c)&&e.push(r),a&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(E.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(s=>"user: ".concat(s.user.uid,", mediaType: ").concat(s.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(s=>{E.error("[".concat(this._clientId,"] mass resubscribe error"),s.toString())})),this.getListeners(_t.PUBLISHED_USER_LIST).length>0?v("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(E.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(s=>s.uid).join(", "))),this.safeEmit(_t.PUBLISHED_USER_LIST,e)):E.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(s=>s.uid).join(", ")))}),this._gateway.signal.on(nt.ON_RTP_CAPABILITY_CHANGE,t=>{const{video_codec:e}=t;this._p2pChannel instanceof Ne&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(n=>n.toLowerCase()).filter(n=>{var s;return q(s=Object.keys(ws)).call(s,n)}))})}_handleP2PEvents(){this._gateway.signal.on(nt.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Jt.PUBLISH,(t,e,n)=>{const{uid:s}=t;t.forEach(r=>{const{kind:o,ssrcs:a,mid:c,isMuted:d}=r;this._handleP2PAddAudioOrVideoStream(o,s,a[0].ssrcId,c);const l=this._users.find(u=>u.uid===s);return l&&this._p2pChannel instanceof Te?this._p2pChannel.mockSubscribe(l,o,a[0].ssrcId,c).then(()=>{e()}).catch(n):e(),this._handleMuteStream(s,o,!!d)})}),this._gateway.signal.on(Jt.CALL,async(t,e,n)=>{if(this._p2pChannel instanceof Te)try{var s;e(await this._p2pChannel.startP2P({turnServer:(s=this._joinInfo)===null||s===void 0?void 0:s.turnServer},t))}catch(r){n(r)}}),this._gateway.signal.on(H.P2P_CONNECTION,async t=>{this._p2pChannel instanceof Te&&await this._p2pChannel.p2pConnect(t)}),this._gateway.signal.on(Jt.UNPUBLISH,async(t,e,n)=>{if(this._p2pChannel instanceof Te){const{unpubMsg:s,uid:r}=t,o=this._users.find(a=>a.uid===r);if(!o)return E.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{s.forEach(async a=>{let{stream_type:c}=a;const d=c===St.Audio?J.AUDIO:J.VIDEO;await this._p2pChannel.unsubscribe(o,d),this._handleMuteStream(r,d,!0)}),e()}catch(a){n(a)}}}),this._gateway.signal.on(Jt.CONTROL,async(t,e)=>{const{action:n}=t;switch(n){case xn.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,J.VIDEO,!0);break;case xn.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,J.AUDIO,!0);break;case xn.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,J.VIDEO,!1);break;case xn.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,J.AUDIO,!1)}}),this._gateway.signal.on(Jt.RESTART_ICE,async(t,e,n)=>{if(this._p2pChannel instanceof Te)try{const{direction:s,iceParameter:r}=t;s!==He.SEND_ONLY||r?e(await this._p2pChannel.restartICE(s,r)):(this._p2pChannel.handleDisconnect(s),e())}catch(s){n(s)}}),this._gateway.signal.on(Jt.CANDIDATE,t=>{if(this._p2pChannel instanceof Te){const{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n)}}),this._p2pChannel.on(tt.RequestP2PRestartICE,async(t,e,n)=>{try{const{direction:s}=t;e(await this._gateway.sendExtensionMessage(Jt.RESTART_ICE,t,s===He.SEND_ONLY))}catch(s){n(s)}}),this._p2pChannel.on(tt.LocalCandidate,t=>{this._gateway.sendExtensionMessage(Jt.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(tt.RequestP2PMuteLocal,async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(Jt.CONTROL,t,!0),e()}catch(s){n(s)}}),this._p2pChannel.on(tt.RequestP2PUnmuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(s){s.code===R.DISCONNECT_P2P?e():n(s)}else e()}),this._p2pChannel.on(tt.RequestP2PMuteRemote,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(s){s.code===R.DISCONNECT_P2P?e():n(s)}else e()}),this._p2pChannel.on(tt.StateChange,(t,e)=>{e===vt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(tt.RequestMuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(s){s.code===R.DISCONNECT_P2P?e():n(s)}else e()}),this._p2pChannel.on(tt.RequestUnmuteLocal,async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(s){s.code===R.DISCONNECT_P2P?e():n(s)}else e()}),this._p2pChannel.on(tt.RequestRePublish,(t,e,n)=>{this.publish(t,!1).then(e).catch(n)}),this._p2pChannel.on(tt.RequestRePublishDataChannel,(t,e,n)=>{P.all(t.map(async s=>{await this._p2pChannel.publishDataChannel([s]);const r={streamId:s.id,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:s.metadata,channelId:s._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,r,!0)}catch(o){if(o.code!==R.DISCONNECT_P2P)throw o}})).then(e).catch(n)}),this._p2pChannel.on(tt.RequestReSubscribe,async(t,e,n)=>{try{for(const{user:s,kind:r}of t)r===J.VIDEO?await this.subscribe(s,"video"):await this.subscribe(s,"audio");e()}catch(s){n(s)}}),this._p2pChannel.on(tt.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(tt.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(tt.MediaReconnectStart,t=>{this.safeEmit(_t.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(tt.MediaReconnectEnd,t=>{this.safeEmit(_t.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(tt.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(tt.RequestRestartICE,async t=>{if(this._p2pChannel instanceof Te)return;const e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;const s=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:s})}catch(a){return void e.throw(a)}const{iceParameters:o}=function(a){const c=a.iceParameters;return{iceParameters:{iceUfrag:c.iceUfrag,icePwd:c.icePwd}}}(r);await e.next({remoteIceParameters:o})}),this._p2pChannel.on(tt.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(tt.RequestReconnectPC,async()=>{var t;const{iceParameters:e,dtlsParameters:n,rtpCapabilities:s}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:s}),{dtlsParameters:a,iceParameters:c,candidates:d,rtpCapabilities:l,setup:u,cname:p}=aI(r,o);await this._p2pChannel.connect(c,a,d,l,u,p),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(tt.RequestUnpublishForReconnectPC,async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n()}),this._p2pChannel.on(tt.P2PLost,()=>{this.safeEmit(_t.P2P_LOST,this.store.uid)}),this._p2pChannel.on(tt.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(tt.ConnectionTypeChange,t=>{this.safeEmit(_t.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(tt.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(tt.QueryClientConnectionState,t=>{t(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!t)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!t.inspectType||!Array.isArray(t.inspectType))throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const e=[...new Set(t.inspectType)];e.forEach(n=>{var s;if(!q(s=["supervise","moderation"]).call(s,n))throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(n," is not a valid inspect type."))}),t.inspectType=e}if(t&&t.extraInfo&&t.extraInfo.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const e=new tl(t);this._inspect=e,this.handleVideoInspectEvents(this._inspect),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},ae)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(ys(t,"enabled"),t){if(!e)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(bt(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(e&&e.vendor&&e.vendor.length>1024)throw new w(R.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(e);const n=new u_(e);this._moderation=n,this.handleImageModerationEvents(this._moderation),await n.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},ae)}catch(n){throw Array.isArray(n)?n[0]:n}}else{if(!this._moderation)throw new w(R.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}}setP2PTransport(t){if(function(e){Ee(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new w(R.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,E.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}handleImageModerationEvents(t){t.on(Xi.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(_t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===Ii.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new w(R.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(Xi.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}handleVideoInspectEvents(t){t.on(ge.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(_t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===ki.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(_t.CONTENT_INSPECT_ERROR,new w(R.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(ge.INSPECT_RESULT,(e,n)=>{var s;if((n==null?void 0:n.code)===R.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return E.debug("Stop inspect content because that has left channel"),this==null||(s=this._inspect)===null||s===void 0||s.close(),void(this._inspect=void 0);this.safeEmit(_t.CONTENT_INSPECT_RESULT,e,n)}),t.on(ge.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return E.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){ys(t,"enabled"),wt("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}}U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"leave",null),U([$({argsMap:(i,t)=>{if(!Array.isArray(t)){if(!(t instanceof xe))return[t];t=[t]}return t.map(e=>e?Object(e).toString():"null")}}),T("design:type",Function),T("design:paramtypes",[Object,Boolean]),T("design:returntype",P)],At.prototype,"publish",null),U([$({argsMap:(i,t)=>(t||(t=[]),t instanceof jC?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map(e=>e.getTrackId())))}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"unpublish",null),U([$({argsMap:(i,t,e,n)=>[t.uid,e,n]}),T("design:type",Function),T("design:paramtypes",[Le,String,Number]),T("design:returntype",P)],At.prototype,"subscribe",null),U([$({argsMap:(i,t,e)=>[t,e]}),T("design:type",Function),T("design:paramtypes",[Object,String]),T("design:returntype",P)],At.prototype,"presubscribe",null),U([$({argsMap:(i,t)=>t.map(e=>{let{user:n,mediaType:s}=e;return[n==null?void 0:n.uid,s]})}),T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],At.prototype,"massSubscribe",null),U([$({argsMap:(i,t,e,n)=>[t.uid,e,n]}),T("design:type",Function),T("design:paramtypes",[Le,String,Number]),T("design:returntype",P)],At.prototype,"unsubscribe",null),U([$({argsMap:(i,t)=>t.map(e=>{let{user:n,mediaType:s}=e;return{uid:n==null?void 0:n.uid,mediaType:s}})}),T("design:type",Function),T("design:paramtypes",[Array]),T("design:returntype",P)],At.prototype,"massUnsubscribe",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"setLowStreamParameter",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"enableDualStream",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"disableDualStream",null),U([$(),T("design:type",Function),T("design:paramtypes",[String,Object]),T("design:returntype",P)],At.prototype,"setClientRole",null),U([$(),T("design:type",Function),T("design:paramtypes",[String,Boolean]),T("design:returntype",void 0)],At.prototype,"setProxyServer",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object,Boolean]),T("design:returntype",void 0)],At.prototype,"setTurnServer",null),U([$(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",void 0)],At.prototype,"setLicense",null),U([$(),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",void 0)],At.prototype,"startProxyServer",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],At.prototype,"stopProxyServer",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",void 0)],At.prototype,"setLocalAccessPointsV2",null),U([$(),T("design:type",Function),T("design:paramtypes",[Array,String]),T("design:returntype",void 0)],At.prototype,"setLocalAccessPoints",null),U([$(),T("design:type",Function),T("design:paramtypes",[Number]),T("design:returntype",P)],At.prototype,"setRemoteDefaultVideoStreamType",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object,Number]),T("design:returntype",P)],At.prototype,"setRemoteVideoStreamType",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object,Number]),T("design:returntype",P)],At.prototype,"setStreamFallbackOption",null),U([$({argsMap:(i,t)=>[t]}),T("design:type",Function),T("design:paramtypes",[String,String,Uint8Array]),T("design:returntype",void 0)],At.prototype,"setEncryptionConfig",null),U([$(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],At.prototype,"renewToken",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",void 0)],At.prototype,"enableAudioVolumeIndicator",null),U([$(),T("design:type",Function),T("design:paramtypes",[String,Boolean]),T("design:returntype",P)],At.prototype,"startLiveStreaming",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"setLiveTranscoding",null),U([$(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",P)],At.prototype,"stopLiveStreaming",null),U([$(),T("design:type",Function),T("design:paramtypes",[String,Object]),T("design:returntype",P)],At.prototype,"addInjectStreamUrl",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"removeInjectStreamUrl",null),U([$(),T("design:type",Function),T("design:paramtypes",[Jd]),T("design:returntype",P)],At.prototype,"startChannelMediaRelay",null),U([$(),T("design:type",Function),T("design:paramtypes",[Jd]),T("design:returntype",P)],At.prototype,"updateChannelMediaRelay",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"stopChannelMediaRelay",null),U([$({argsMap:(i,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"sendCustomReportMessage",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object,Object]),T("design:returntype",P)],At.prototype,"pickSVCLayer",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"setRTMConfig",null),U([$(),T("design:type",Function),T("design:paramtypes",[Object]),T("design:returntype",P)],At.prototype,"enableContentInspect",null),U([$(),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",P)],At.prototype,"disableContentInspect",null),U([$(),T("design:type",Function),T("design:paramtypes",[Boolean,Object]),T("design:returntype",P)],At.prototype,"setImageModeration",null),U([$(),T("design:type",Function),T("design:paramtypes",[String]),T("design:returntype",void 0)],At.prototype,"setP2PTransport",null),U([$({reportResult:!0}),T("design:type",Function),T("design:paramtypes",[]),T("design:returntype",Array)],At.prototype,"getJoinChannelServiceRecords",null),U([$(),T("design:type",Function),T("design:paramtypes",[Boolean]),T("design:returntype",P)],At.prototype,"setPublishAudioFilterEnabled",null);class Ja{constructor(t,e){h(this,"id",0),h(this,"element",void 0),h(this,"peerPair",void 0),h(this,"context",void 0),h(this,"audioPlayerElement",void 0),h(this,"audioTrack",void 0),Ja.count+=1,this.id=Ja.count,this.element=t,this.context=e}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const e=document.createElement("audio");e.srcObject=new MediaStream([t.track]),e.play(),this.audioPlayerElement=e}}async switchSdp(){if(!this.peerPair)return;const t=async(n,s)=>{const r=s==="offer"?await n.createOffer():await n.createAnswer();return await n.setLocalDescription(r),n.iceGatheringState==="complete"?n.localDescription:new P(o=>{n.onicegatheringstatechange=()=>{n.iceGatheringState==="complete"&&o(n.localDescription)}})},e=async(n,s)=>await n.setRemoteDescription(s);try{const n=await t(this.peerPair[0],"offer");await e(this.peerPair[1],n);const s=await t(this.peerPair[1],"answer");await e(this.peerPair[0],s)}catch(n){throw new w(R.LOCAL_AEC_ERROR,n.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let e;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),e=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(e)}catch(s){throw new w(R.LOCAL_AEC_ERROR,s.toString()).print()}if(!e)throw new w(R.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=e.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,e=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(e),await this.switchSdp()}close(){E.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}h(Ja,"count",0);const nU=window.AudioContext||window.webkitAudioContext;class sv{constructor(){h(this,"units",[]),h(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return E.debug("the system does not need to process local aec"),-1;this.context||(this.context=new nU);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new Ja(t,this.context),this.units.push(e)),e.startEchoCancellation(),E.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return ft().name!==Rt.SAFARI}}U([$({report:z}),T("design:type",Function),T("design:paramtypes",[HTMLAudioElement]),T("design:returntype",Number)],sv.prototype,"processExternalMediaAEC",null);const sU=new sv;function rv(i,t){var e=Object.keys(i);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(i);t&&(n=n.filter(function(s){return Object.getOwnPropertyDescriptor(i,s).enumerable})),e.push.apply(e,n)}return e}function ov(i){for(var t=1;t<arguments.length;t++){var e=arguments[t]!=null?arguments[t]:{};t%2?rv(Object(e),!0).forEach(function(n){h(i,n,e[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(e)):rv(Object(e)).forEach(function(n){Object.defineProperty(i,n,Object.getOwnPropertyDescriptor(e,n))})}return i}const p_=window||document;function av(i){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!p_)return;const e=de._cspEventHandlerPointer;if(e&&t)return void console.error(e,t);const n=s=>{if(!(s&&s.blockedURI&&(de.onSecurityPolicyViolation||de.getListeners(ln.SECURITY_POLICY_VIOLATION).length>0)))return;const r=s.blockedURI;v("CSP_DETECTED_HOSTNAME_LIST").some(o=>q(r).call(r,o))&&(de.onSecurityPolicyViolation&&typeof de.onSecurityPolicyViolation=="function"&&de.onSecurityPolicyViolation(s),de.getListeners(ln.SECURITY_POLICY_VIOLATION).length>0&&de.safeEmit(ln.SECURITY_POLICY_VIOLATION,s))};e&&p_.removeEventListener("securitypolicyviolation",e),(t||i&&typeof i=="function"||de.getListeners(ln.SECURITY_POLICY_VIOLATION).length>0)&&p_.addEventListener("securitypolicyviolation",n),de._cspEventHandlerPointer=n}wt("PROCESS_ID","process-".concat(Pt(8,""),"-").concat(Pt(4,""),"-").concat(Pt(4,""),"-").concat(Pt(4,""),"-").concat(Pt(12,""))),function(){let i;try{i=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void E.error("Error loading sdk config",t.message)}if(i)try{const t=JSON.parse(window.atob(i)),e=Date.now();E.debug("Loading global parameters from cache",t),Object.keys(t).forEach(n=>{if(Object.prototype.hasOwnProperty.call(ii,n)){const{value:s,expires:r}=t[n];if(r&&r<=e)return;bs[n]=s,ii[n]=s}})}catch(t){E.error("Error loading mutableParamsCache: ".concat(i),t.message)}}(),Array.isArray(bs.AREAS)&&bs.AREAS.length>0&&Zh(bs.AREAS,!0);const cv=(i,t,e)=>{E.debug("setParameter key:".concat(i,", value:").concat(JSON.stringify(t))),wt(i,t,e)},de=function(i){const t=new Wt,e=i,n={getListeners:t.getListeners.bind(t),on:(s,r)=>(function(o,a){o===ln.SECURITY_POLICY_VIOLATION&&av(a,!0)}(s,r),t.on.bind(t)(s,r)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return ov(ov({},e),n)}({__TRACK_LIST__:To,VERSION:Ji,BUILD:Lh,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:cv,getParameter:v,getSupportedCodec:async function(){let i={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const e=(await t.createOffer()).sdp;if(!e)return i;t.close(),t=null,i=function(n){const s={video:[],audio:[]};return n.match(/ VP8/i)&&s.video.push("VP8"),n.match(/ VP9/i)&&s.video.push("VP9"),n.match(/ AV1/i)&&s.video.push("AV1"),n.match(/ H264/i)&&s.video.push("H264"),n.match(/ H265/i)&&s.video.push("H265"),n.match(/ opus/i)&&s.audio.push("OPUS"),n.match(/ PCMU/i)&&s.audio.push("PCMU"),n.match(/ PCMA/i)&&s.audio.push("PCMA"),n.match(/ G722/i)&&s.audio.push("G722"),s}(e)}catch(t){throw new w(R.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return i},checkSystemRequirements:function(){const i=z.reportApiInvoke(null,{name:le.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Yt.TRACER});let t=!1;try{const r=window.RTCPeerConnection,o=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;t=!!(r&&o&&a)}catch(r){return E.error("check system requirement failed: ",r),!1}let e=!1;const n=ft();n.name===Rt.CHROME&&Number(n.version)>=58&&(!nL()||iL())&&(e=!0),n.name===Rt.FIREFOX&&Number(n.version)>=56&&(e=!0),n.name===Rt.OPERA&&Number(n.version)>=45&&(e=!0),n.name===Rt.SAFARI&&Number(n.version)>=11&&(e=!0),(dT()||ft().name===Rt.QQ)&&(e=!0),E.debug("checkSystemRequirements, api:",t,"browser",e);const s=t&&e;return i.onSuccess(s),s},getDevices:function(i){return Fi.enumerateDevices(!0,!0,i)},getMicrophones:function(i){return Fi.getRecordingDevices(i)},getCameras:function(i){return Fi.getCamerasDevices(i)},getElectronScreenSources:OR,getPlaybackDevices:function(i){return Fi.getSpeakers(i)},createClient:function(){var i;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const e=z.reportApiInvoke(null,{name:le.CREATE_CLIENT,options:[t],tag:Yt.TRACER});try{(function(n){Ee(n.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Ee(n.mode,"config.mode",["rtc","live","p2p"]),n.audioCodec!==void 0&&Ee(n.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),n.proxyServer!==void 0&&Me(n.proxyServer,"config.proxyServer",1,1e4),n.turnServer!==void 0&&gT(n.turnServer),n.httpRetryConfig!==void 0&&fT(n.httpRetryConfig),n.websocketRetryConfig!==void 0&&fT(n.websocketRetryConfig)})(t)}catch(n){throw e.onError(n),n}return iU()||(t.codec==="vp9"&&(t.codec="vp8",E.debug("browser not support vp9, force use vp8")),wt("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),e.onSuccess(),new At(hs(hs({forceWaitGatewayResponse:!0},t),{},{role:q(i=["rtc","p2p"]).call(i,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_CAM_VIDEO_TRACK,options:[Od({},i)]}),e=wd(i),n=Pt(8,"track-cam-");let s=null;const r=i.encoderConfig==="720p_auto";E.info("start create camera video track with config",JSON.stringify(i),"trackId",n);try{s=(await Vi({video:e},n)).getVideoTracks()[0]||null}catch(a){throw t.onError(a),a}if(!s){const a=new M(R.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(a),a.throw(E)}i.optimizationMode&&Sp(n,s,i,Vn(i.encoderConfig));const o=new Fs(s,i,e,i.scalabiltyMode?Rd(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,n);return r&&o.startMonitorStats(),t.onSuccess(o.getTrackId()),E.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(i){const t=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_CUSTOM_VIDEO_TRACK,options:[i]}),e=new dt(i.mediaStreamTrack,{width:i.width,height:i.height,frameRate:i.frameRate,bitrateMax:i.bitrateMax,bitrateMin:i.bitrateMin},i.scalabiltyMode?Rd(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,Pt(8,"track-cus-"),[Mt.CUSTOM_TRACK]);return t.onSuccess(e.getTrackId()),E.info("create custom video track success with config",i,"trackId",e.getTrackId()),e},createScreenVideoTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const e=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_SCREEN_VIDEO_TRACK,options:[Od({},i),t]}),n=i.encoderConfig==="720p_auto";i.encoderConfig?typeof i.encoderConfig=="string"||i.encoderConfig.width&&i.encoderConfig.height||(i.encoderConfig.width={max:1920},i.encoderConfig.height={max:1080}):i.encoderConfig="1080p_2";const s=function(u){const p={};u.screenSourceType&&(p.mediaSource=u.screenSourceType),u.extensionId&&la()&&(p.extensionId=u.extensionId);const{displaySurface:_,selfBrowserSurface:S,surfaceSwitching:f,systemAudio:g}=u;(sh(107)||sT(107)||rT(93))&&(_&&(Ee(_,"displaySurface",["browser","window","monitor"]),p.displaySurface=_),S?(Ee(S,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=S):p.selfBrowserSurface="include",f&&(Ee(f,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=f)),(sh(105)||sT(105)||rT(91))&&g&&(Ee(g,"systemAudio",["exclude","include"]),p.systemAudio=g),u.electronScreenSourceId&&(p.sourceId=u.electronScreenSourceId);const C=u.encoderConfig?sp(u.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:C?C.width:void 0,maxHeight:C?C.height:void 0},C&&(C.frameRate&&(typeof C.frameRate=="number"?(p.mandatory.maxFrameRate=C.frameRate,p.mandatory.minFrameRate=C.frameRate):(p.mandatory.maxFrameRate=C.frameRate.max||C.frameRate.ideal||C.frameRate.exact||void 0,p.mandatory.minFrameRate=C.frameRate.min||C.frameRate.ideal||C.frameRate.exact||void 0),p.frameRate=C.frameRate),C.width&&(p.width=C.width),C.height&&(p.height=C.height)),p}(i),r=Pt(8,"track-scr-v-");let o=null,a=null;const c=Ot();if(!c.supportShareAudio&&t==="enable"){const u=new M(R.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return e.onError(u),u.throw(E)}E.info("start create screen video track with config",i,"withAudio",t,"trackId",r);try{const u=await Vi({screen:s,screenAudio:t==="auto"?c.supportShareAudio:t==="enable"},r);o=u.getVideoTracks()[0]||null,a=u.getAudioTracks()[0]||null}catch(u){throw e.onError(u),u}if(!o){const u=new M(R.UNEXPECTED_ERROR,"can not find track in media stream");return e.onError(u),u.throw(E)}if(!a&&t==="enable"){o&&o.stop();const u=new M(R.SHARE_AUDIO_NOT_ALLOWED);return e.onError(u),u.throw(E)}i.optimizationMode||(i.optimizationMode="detail"),i.optimizationMode&&(Sp(r,o,i,i.encoderConfig&&sp(i.encoderConfig)||void 0),i.encoderConfig&&typeof i.encoderConfig!="string"&&(i.encoderConfig.bitrateMin=i.encoderConfig.bitrateMax));const d=new dt(o,i.encoderConfig?sp(i.encoderConfig):{},i.scalabiltyMode?Rd(i.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},i.optimizationMode,r,[Mt.SCREEN_TRACK]);if(n&&d.startMonitorStats(),!a)return e.onSuccess(d.getTrackId()),E.info("create screen video track success","video:",d.getTrackId()),d;const l=new Ct(a,void 0,Pt(8,"track-scr-a-"),!1,!0);return e.onSuccess([d.getTrackId(),l.getTrackId()]),E.info("create screen video track success","video:",d.getTrackId(),"audio:",l.getTrackId()),[d,l]},createMicrophoneAndCameraTracks:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const e=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_MIC_AND_CAM_TRACKS,options:[i,t]}),n=t.encoderConfig==="720p_auto",s=wd(t),r=jR(i),o=Pt(8,"track-mic-"),a=Pt(8,"track-cam-");let c=null,d=null;E.info("start create camera video track(".concat(a,") and microphone audio track(").concat(o,") with config, audio: ").concat(JSON.stringify(i),", video: ").concat(JSON.stringify(t)));try{const p=await Vi({audio:r,video:s},"".concat(o,"-").concat(a));c=p.getAudioTracks()[0],d=p.getVideoTracks()[0]}catch(p){throw e.onError(p),p}if(!c||!d){const p=new M(R.UNEXPECTED_ERROR,"can not find tracks in media stream");return e.onError(p),p.throw(E)}t.optimizationMode&&Sp(a,d,t,Vn(t.encoderConfig));const l=new yr(c,i,r,o),u=new Fs(d,t,s,t.scalabiltyMode?Rd(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,a);return n&&u.startMonitorStats(),e.onSuccess([l.getTrackId(),u.getTrackId()]),E.info("create camera video track(".concat(a,") and microphone audio track(").concat(o,") success")),[l,u]},createMicrophoneAudioTrack:async function(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_MIC_AUDIO_TRACK,options:[i]}),e=jR(i),n=Pt(8,"track-mic-");let s=null;E.info("start create microphone audio track with config",JSON.stringify(i),"trackId",n);try{s=(await Vi({audio:e},n)).getAudioTracks()[0]||null}catch(o){throw t.onError(o),o}if(!s){const o=new M(R.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(o),o.throw(E)}const r=new yr(s,i,e,n);return t.onSuccess(r.getTrackId()),E.info("create microphone audio track success, trackId:",n),r},createCustomAudioTrack:function(i){const t=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_CUSTOM_AUDIO_TRACK,options:[i]}),e=new Ct(i.mediaStreamTrack,i.encoderConfig?Cd(i.encoderConfig):{},Pt(8,"track-cus-"),!1,!0);return E.info("create custom audio track success with config",i,"trackId",e.getTrackId()),t.onSuccess(e.getTrackId()),e},createBufferSourceAudioTrack:async function(i){var t;const{cacheOnlineFile:e,encoderConfig:n}=i;let{source:s}=i;const r={source:s instanceof AudioBuffer?"AudioBuffer":s instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":s,cacheOnlineFile:e,encoderConfig:n},o=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CREATE_BUFFER_AUDIO_TRACK,options:[r]});if(v("DISABLE_WEBAUDIO"))throw new M(R.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=Pt(8,"track-buf-");E.info("start create buffer source audio track with config",JSON.stringify(r),"trackId",a);const c=s;if(!(s instanceof AudioBuffer))try{s=await tM(s,e)}catch(u){return o.onError(u),u.throw(E)}const d=new $k(s),l=new Vs(c,d,n?Cd(n):{},a);return E.info("create buffer source audio track success, trackId:",a),o.onSuccess(l.getTrackId()),l},setAppType:function(i){if(E.debug("setAppType: ".concat(i)),!(Number.isInteger(i)&&i>=0))throw E.debug("Invalid appType"),new w(R.INVALID_PARAMS,"invalid app type",i);wt("APP_TYPE",Math.floor(i))},setLogLevel:function(i){E.setLogLevel(i)},enableLogUpload:function(){v("USE_NEW_LOG")?wt("UPLOAD_LOG",!0):E.enableLogUpload()},disableLogUpload:function(){v("USE_NEW_LOG")?wt("UPLOAD_LOG",!1):E.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new Jd},checkAudioTrackIsActive:async function(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const e=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(i instanceof Ct||i instanceof pn)){const c=new w(R.INVALID_TRACK,"the parameter is not a audio track");return e.onError(c),c.throw()}t&&t<1e3&&(t=1e3);const n=i instanceof Ct?i.getTrackLabel():"remote_track",s=i.getVolumeLevel();let r=s,o=s;const a=Date.now();return new P(c=>{const d=setInterval(()=>{const l=i.getVolumeLevel();r=l>r?l:r,o=l<o?l:o;const u=r-o>1e-4,p=Date.now()-a;if(u||p>t){clearInterval(d);const _=u,S={duration:p,deviceLabel:n,maxVolumeLevel:r,result:_};E.info("[track-".concat(i.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(S))),e.onSuccess(S),c(_)}},200)})},checkVideoTrackIsActive:async function(i){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const e=z.reportApiInvoke(null,{tag:Yt.TRACER,name:le.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(i instanceof dt||i instanceof Fn)){const u=new w(R.INVALID_TRACK,"the parameter is not a video track");return e.onError(u),u.throw()}t&&t<1e3&&(t=1e3);const n=i instanceof dt?i.getTrackLabel():"remote_track",s=i.getMediaStreamTrack(!0),r=document.createElement("video");r.style.width="1px",r.style.height="1px",r.setAttribute("muted",""),r.muted=!0,r.setAttribute("playsinline",""),r.controls=!1,(Xe()||Kc())&&(r.style.opacity="0.01",r.style.position="fixed",r.style.left="0",r.style.top="0",document.body.appendChild(r)),r.srcObject=new MediaStream([s]),r.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const u=Date.now();a=await function(p,_,S,f){let g,C=0,y=null;return new P((A,k)=>{function O(){C>f&&g&&(g(),A(C));const N=S.getContext("2d");if(!N){const F=new w(R.UNEXPECTED_ERROR,"can not get canvas 2d context.");return E.error(F.toString()),void k(F)}N.drawImage(p,0,0,160,120);const L=N.getImageData(0,0,S.width,S.height),D=Math.floor(L.data.length/3);if(y){for(let F=0;F<D;F+=3)if(L.data[F]!==y[F])return C+=1,void(y=L.data);y=L.data}else y=L.data}setTimeout(()=>{g&&(g(),A(C))},_),g=up(()=>{O()},30)})}(r,t,o,4),c=Date.now()-u}catch(u){throw e.onError(u),u}eU===Rt.SAFARI&&(r.pause(),r.remove()),r.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:n,result:d};return E.info("[track-".concat(i.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),e.onSuccess(l),d},setArea:Zh,audioElementPlayCenter:mi,resumeAudioContext:function(){mi.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(i){sU.processExternalMediaAEC(i)},registerExtensions:function(i){const t=v("PLUGIN_INFO")||[];i.forEach(e=>{"name"in e&&!q(t).call(t,e.name)&&t.push(e.name);const n=e;n.__registered__=!0,n.logger.hookLog=E.extLog,n.reporter.hookApiInvoke=z.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach(s=>{n.parameters[s]=v(s)})}),cv("PLUGIN_INFO",t)},ChannelMediaRelayError:Ds,ChannelMediaRelayEvent:vn,ChannelMediaRelayState:si,RemoteStreamFallbackType:op,RemoteStreamType:rp,ConnectionDisconnectedReason:pt,AudienceLatencyLevelType:dh,AREAS:mt});return Object.defineProperties(de,{onAudioAutoplayFailed:{get:()=>Bi.onAudioAutoplayFailed,set:i=>{Bi.onAudioAutoplayFailed=i}},onAutoplayFailed:{get:()=>Bi.onAutoplayFailed,set:i=>{Bi.onAutoplayFailed=i}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>de._onSecurityPolicyViolation,set(i){de._onSecurityPolicyViolation=i,av(i)}},__CLIENT_LIST__:{get:()=>v("SHOW_GLOBAL_CLIENT_LIST")?Os:[]}}),Fi.on(rs.CAMERA_DEVICE_CHANGED,i=>{E.info("camera device changed",JSON.stringify(i)),de.onCameraChanged&&de.onCameraChanged(i),de.safeEmit(ln.CAMERA_CHANGED,i)}),Fi.on(rs.RECORDING_DEVICE_CHANGED,i=>{E.info("microphone device changed",JSON.stringify(i)),de.onMicrophoneChanged&&de.onMicrophoneChanged(i),de.safeEmit(ln.MICROPHONE_CHANGED,i)}),Fi.on(rs.PLAYOUT_DEVICE_CHANGED,i=>{E.debug("playout device changed",JSON.stringify(i)),de.onPlaybackDeviceChanged&&de.onPlaybackDeviceChanged(i),de.safeEmit(ln.PLAYBACK_DEVICE_CHANGED,i)}),mi.onAutoplayFailed=()=>{E.info("detect audio element autoplay failed"),Bi.onAudioAutoplayFailed&&Bi.onAudioAutoplayFailed()},yt.on("autoplay-failed",()=>{E.info("detect webaudio autoplay failed"),Bi.onAudioAutoplayFailed&&Bi.onAudioAutoplayFailed(),de.safeEmit(ln.AUTOPLAY_FAILED)}),yt.on(Re.STATE_CHANGE,(i,t)=>{E.info("audio context state changed: ".concat(t," => ").concat(i)),de.onAudioContextStateChanged&&de.onAudioContextStateChanged(i,t),de.safeEmit(ln.AUDIO_CONTEXT_STATE_CHANGED,i,t)}),oe.on(ts.NETWORK_STATE_CHANGE,(i,t)=>{E.info("[network-indicator] network state changed, ".concat(t," => ").concat(i))}),window&&(window.__ARTC__=de),de})})(lv);var oU=lv.exports;const E_=rU(oU),uv="e3e3ecd881d7462994dc0043ddbfa0f9",hv=null,pv=Math.floor(Math.random()*2032),aU=String(Math.floor(Math.random()*2032)),cU=()=>{const Lt=window.location.search,Zt=new URLSearchParams(Lt);if(Zt.get("room"))return Zt.get("room").toLowerCase()};let Xa=cU()||null;document.getElementById("form").roomname.value=Xa;let tr={localAudioTrack:null,remoteAudioTracks:{}},za=!0,Jn,Ur,Bo;const dU=async Lt=>{Ur=AgoraRTM.createInstance(uv),await Ur.login({uid:aU,token:hv}),Bo=Ur.createChannel(Xa),await Bo.join(),await Ur.addOrUpdateLocalUserAttributes({name:Lt,userRtcUid:pv.toString()}),mU(),window.addEventListener("beforeunload",Ev),Bo.on("MemberJoined",_U),Bo.on("MemberLeft",EU)},lU=async()=>{Jn=E_.createClient({mode:"rtc",codec:"vp8"}),Jn.on("user-published",hU),Jn.on("user-left",pU),await Jn.join(uv,Xa,hv,pv),tr.localAudioTrack=await E_.createMicrophoneAudioTrack(),tr.localAudioTrack.setMuted(za),await Jn.publish(tr.localAudioTrack),uU()};let uU=async()=>{E_.setParameter("AUDIO_VOLUME_INDICATION_INTERVAL",200),Jn.enableAudioVolumeIndicator(),Jn.on("volume-indicator",Lt=>{Lt.forEach(Zt=>{console.log(`UID ${Zt.uid} Level ${Zt.level}`);try{let di=document.getElementsByClassName(`user-rtc-${Zt.uid}`)[0];Zt.level>=80?di.style.boxShadow="0 0 30px #00ff00":Zt.level>=60&&Zt.level<80?di.style.boxShadow="0 0 20px #00ff00":Zt.level>=50&&Zt.level<60?di.style.boxShadow="0 0 10px #00ff00":Zt.level>=40&&Zt.level<50?di.style.boxShadow="0 0 7px #00ff00":di.style.boxShadow="0 0 3px #fff"}catch(di){console.error(di)}})})},hU=async(Lt,Zt)=>{await Jn.subscribe(Lt,Zt),Zt=="audio"&&(tr.remoteAudioTracks[Lt.uid]=[Lt.audioTrack],Lt.audioTrack.play())},pU=async Lt=>{delete tr.remoteAudioTracks[Lt.uid]},_U=async Lt=>{let{name:Zt,userRtcUid:di}=await Ur.getUserAttributesByKeys(Lt,["name","userRtcUid"]),Ri=`
  <div class="speaker user-rtc-${di}" id="${Lt}">
      <p>${Zt}</p>
  </div>`;document.getElementById("members").insertAdjacentHTML("beforeend",Ri)},EU=async Lt=>{document.getElementById(Lt).remove()},mU=async()=>{let Lt=await Bo.getMembers();for(let Zt=0;Lt.length>Zt;Zt++){let{name:di,userRtcUid:Ri}=await Ur.getUserAttributesByKeys(Lt[Zt],["name","userRtcUid"]),xt=`
    <div class="speaker user-rtc-${Ri}" id="${Lt[Zt]}">
        <p>${di}</p>
    </div>`;document.getElementById("members").insertAdjacentHTML("beforeend",xt)}};const fU=async Lt=>{za?(Lt.target.src="icons/mic.svg",Lt.target.style.backgroundColor="#b3de24",za=!1):(Lt.target.src="icons/mic-off.svg",Lt.target.style.backgroundColor="rgba(102, 109, 101, 0.801)",za=!0),tr.localAudioTrack.setMuted(za)};let _v=document.getElementById("form");const gU=async Lt=>{Lt.preventDefault(),Xa=Lt.target.roomname.value.toLowerCase(),window.history.replaceState(null,null,`?room=${Xa}`),lU();let Zt=Lt.target.displayname.value;dU(Zt),_v.style.display="none",document.getElementById("room-header").style.display="flex"};let Ev=async()=>{await Bo.leave(),await Ur.logout()},TU=async()=>{tr.localAudioTrack.stop(),tr.localAudioTrack.close(),Jn.unpublish(),Jn.leave(),Ev(),document.getElementById("form").style.display="block",document.getElementById("room-header").style.display="none",document.getElementById("members").innerHTML=""};_v.addEventListener("submit",gU);document.getElementById("leave-icon").addEventListener("click",TU);document.getElementById("mic-icon").addEventListener("click",fU);
